<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expedição & Controle (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f172a', // Slate 900
                            800: '#1e293b', // Slate 800
                            700: '#334155', // Slate 700
                            600: '#475569', // Slate 600
                            input: '#1e293b',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .sidebar { transition: width 0.3s ease-in-out; }
        .sidebar-text { transition: opacity 0.3s ease-in-out; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            inset: 0;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(2px);
        }
        
        .form-input {
            background-color: #1e293b;
            border-color: #334155;
            color: white;
        }
        .form-input:focus { 
            border-color: #6366f1; 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25); 
            outline: none;
        }
        
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        
        .searchable-container { position: relative; }
        .searchable-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;
            max-height: 200px; overflow-y: auto; 
            border: 1px solid #334155;
            background-color: #1e293b; 
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        .searchable-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #334155; }
        .searchable-item:last-child { border-bottom: none; }
        .searchable-item:hover { background-color: #334155; }
    </style>
</head>
<body class="antialiased">

    <!-- Loading -->
    <div id="loading-overlay" class="fixed inset-0 z-[101] flex items-center justify-center bg-dark-900">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-20 bg-slate-950 border-r border-slate-800 text-gray-300 flex flex-col items-center py-6 space-y-6 sidebar hover:w-64 group shadow-2xl z-20">
            <div class="mb-4 text-center w-full overflow-hidden">
                <i class="fa-solid fa-truck-fast fa-2xl text-indigo-500"></i>
                <span class="ml-3 text-xl font-bold whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text align-middle text-white">Expedição</span>
            </div>
            
            <nav class="flex-1 w-full space-y-2 px-3">
                <a href="#" onclick="navigateTo('dashboard')" id="nav-dashboard" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all nav-item text-gray-400 hover:text-white">
                    <i class="fa-solid fa-chart-line w-6 text-center text-lg"></i>
                    <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Dashboard</span>
                </a>
                <a href="#" onclick="navigateTo('entry')" id="nav-entry" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all nav-item text-gray-400 hover:text-white">
                    <i class="fa-solid fa-boxes-packing w-6 text-center text-lg"></i>
                    <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Entrada</span>
                </a>
                <a href="#" onclick="navigateTo('output')" id="nav-output" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all nav-item text-gray-400 hover:text-white">
                    <i class="fa-solid fa-dolly w-6 text-center text-lg"></i>
                    <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Expedição</span>
                </a>
                <a href="#" onclick="navigateTo('inventory')" id="nav-inventory" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all nav-item text-gray-400 hover:text-white">
                    <i class="fa-solid fa-warehouse w-6 text-center text-lg"></i>
                    <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Estoque</span>
                </a>
                 <a href="#" onclick="navigateTo('history')" id="nav-history" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all nav-item text-gray-400 hover:text-white">
                    <i class="fa-solid fa-clock-rotate-left w-6 text-center text-lg"></i>
                    <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Histórico</span>
                </a>
            </nav>
            
            <div class="w-full px-3 mb-4">
                <a href="#" onclick="navigateTo('settings')" id="nav-settings" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all nav-item text-gray-400 hover:text-white">
                    <i class="fa-solid fa-gear w-6 text-center text-lg"></i>
                    <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Configurações</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 overflow-y-auto bg-dark-900 relative">
            
            <!-- Dashboard -->
            <div id="screen-dashboard" class="screen animate-fade-in">
                <h1 class="text-3xl font-bold text-white mb-2">Dashboard</h1>
                <p class="text-gray-400 mb-8 italic text-sm">"Não se gerencia o que não se mede."</p>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Cards -->
                    <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Produtos</p>
                                <h3 class="text-3xl font-bold text-white mt-2" id="dash-total-items">0</h3>
                            </div>
                            <div class="p-3 bg-indigo-500/10 rounded-xl text-indigo-400"><i class="fa-solid fa-box fa-xl"></i></div>
                        </div>
                    </div>
                    <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Volume Total</p>
                                <h3 class="text-3xl font-bold text-white mt-2" id="dash-total-qty">0</h3>
                            </div>
                            <div class="p-3 bg-emerald-500/10 rounded-xl text-emerald-400"><i class="fa-solid fa-cubes fa-xl"></i></div>
                        </div>
                    </div>
                    <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Saídas Hoje</p>
                                <h3 class="text-3xl font-bold text-white mt-2" id="dash-today-out">0</h3>
                            </div>
                            <div class="p-3 bg-blue-500/10 rounded-xl text-blue-400"><i class="fa-solid fa-truck-ramp-box fa-xl"></i></div>
                        </div>
                    </div>
                    <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-red-900/30 cursor-pointer hover:bg-dark-700 transition-colors" onclick="filterExpiringDashboard()">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Vencendo (30d)</p>
                                <h3 class="text-3xl font-bold text-white mt-2" id="dash-expiring">0</h3>
                            </div>
                            <div class="p-3 bg-red-500/10 rounded-xl text-red-400"><i class="fa-solid fa-triangle-exclamation fa-xl"></i></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700">
                        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-history text-gray-500"></i> Últimas Saídas</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-500 uppercase bg-dark-900/50">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">Destino</th>
                                        <th class="px-4 py-3">Produto</th>
                                        <th class="px-4 py-3 text-right rounded-r-lg">Qtd</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-table-out" class="divide-y divide-dark-700"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700">
                        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-clock text-red-400"></i> Próximos Vencimentos</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-500 uppercase bg-dark-900/50">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">Produto</th>
                                        <th class="px-4 py-3">Lote</th>
                                        <th class="px-4 py-3 text-right rounded-r-lg">Validade</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-table-expiring" class="divide-y divide-dark-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entrada -->
            <div id="screen-entry" class="screen hidden animate-fade-in">
                <h1 class="text-3xl font-bold text-white mb-6">Entrada de Produto Acabado</h1>
                <div class="bg-dark-800 p-8 rounded-2xl shadow-xl border border-dark-700 max-w-3xl mx-auto">
                    <form id="form-entry">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2 relative">
                                <label class="block text-sm font-medium text-gray-400 mb-2">Produto (Nome ou Código)</label>
                                <div id="entry-product-search" class="searchable-container">
                                    <input type="text" id="entry-name" required class="w-full form-input rounded-xl p-3 border" placeholder="Digite para buscar..." autocomplete="off">
                                    <div class="searchable-dropdown hidden" id="entry-dropdown"></div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Código (SKU)</label>
                                <input type="number" id="entry-code" required class="w-full form-input rounded-xl p-3 border" placeholder="Ex: 10050">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Setor</label>
                                <div class="flex gap-2">
                                    <select id="entry-sector" required class="w-full form-input rounded-xl p-3 border">
                                        <option value="">Selecione...</option>
                                    </select>
                                    <button type="button" onclick="navigateTo('settings')" class="bg-dark-700 hover:bg-dark-600 text-white p-3 rounded-xl transition">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Lote</label>
                                <input type="number" id="entry-batch" required class="w-full form-input rounded-xl p-3 border" placeholder="Lote da Produção">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Quantidade</label>
                                <input type="number" id="entry-qty" required min="0.01" step="0.01" class="w-full form-input rounded-xl p-3 border">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Data Fabricação</label>
                                <input type="date" id="entry-mfg" required class="w-full form-input rounded-xl p-3 border">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Data Validade</label>
                                <input type="date" id="entry-exp" required class="w-full form-input rounded-xl p-3 border">
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-indigo-500/20 transition-all transform hover:scale-105 flex items-center">
                                <i class="fa-solid fa-check mr-2"></i> Confirmar Entrada
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Expedição (Saída com Carrinho) -->
            <div id="screen-output" class="screen hidden animate-fade-in">
                <h1 class="text-3xl font-bold text-white mb-6">Expedição (Saída)</h1>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Painel 1: Destino e Seleção -->
                    <div class="lg:col-span-1 bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700 h-fit">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Destino (Loja/Cliente)</label>
                        <input type="text" id="output-destination" class="w-full form-input rounded-xl p-3 mb-6" placeholder="Para onde vai a carga?" list="clients-list">
                        <datalist id="clients-list"></datalist>

                        <hr class="border-dark-700 mb-6">

                        <h2 class="text-lg font-bold text-white mb-4">Adicionar Item</h2>
                        <div class="relative mb-6">
                            <input type="text" id="output-search" class="w-full form-input rounded-xl p-3 pl-10" placeholder="Buscar produto...">
                            <i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-500"></i>
                            <div id="output-search-results" class="absolute w-full bg-dark-800 border border-dark-600 mt-1 rounded-xl shadow-2xl max-h-48 overflow-y-auto hidden z-20"></div>
                        </div>

                        <div id="selected-product-info" class="hidden p-4 bg-indigo-900/20 rounded-xl border border-indigo-500/30 mb-6">
                            <h3 class="font-bold text-indigo-300 text-lg" id="sp-name">Produto</h3>
                            <div class="flex justify-between mt-2 text-sm">
                                <span class="text-gray-400">Cód: <span id="sp-code" class="text-white"></span></span>
                                <span class="text-gray-400">Total: <span id="sp-total" class="text-white font-bold">0</span></span>
                            </div>
                            <input type="hidden" id="sp-id">
                        </div>
                    </div>

                    <!-- Painel 2: Lotes -->
                    <div class="lg:col-span-2 bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700 relative min-h-[300px]">
                        <div id="output-overlay" class="absolute inset-0 bg-dark-900/80 backdrop-blur-sm z-10 flex flex-col items-center justify-center text-gray-500 rounded-2xl border border-dark-700">
                            <i class="fa-solid fa-arrow-left text-4xl mb-4 opacity-50"></i>
                            <span>Selecione um produto para ver os lotes</span>
                        </div>

                        <div class="flex justify-between items-end mb-4">
                            <h2 class="text-lg font-bold text-white">Seleção de Lotes (FIFO)</h2>
                            <span class="text-xs text-indigo-400 bg-indigo-900/30 px-2 py-1 rounded">Ideal: > 75% Shelf Life</span>
                        </div>

                        <div class="overflow-x-auto rounded-xl border border-dark-700 mb-4">
                            <table class="w-full text-sm text-left text-gray-300">
                                <thead class="bg-dark-900 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-3">Lote</th>
                                        <th class="px-4 py-3 text-center">Validade</th>
                                        <th class="px-4 py-3 text-center">Status</th>
                                        <th class="px-4 py-3 text-right">Disp.</th>
                                        <th class="px-4 py-3 text-right w-32">Saída</th>
                                    </tr>
                                </thead>
                                <tbody id="output-batches-list" class="divide-y divide-dark-700"></tbody>
                            </table>
                        </div>

                        <div class="flex justify-end">
                            <button id="btn-add-to-cart" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2" disabled>
                                <i class="fa-solid fa-plus"></i> Adicionar à Carga
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Painel 3: Carrinho de Carga -->
                <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-truck-loading text-emerald-500"></i> Itens na Carga
                    </h2>
                    <div class="overflow-x-auto rounded-xl border border-dark-700 mb-6">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="bg-dark-900 text-gray-400 uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3">Produto</th>
                                    <th class="px-4 py-3">Lote</th>
                                    <th class="px-4 py-3 text-right">Qtd</th>
                                    <th class="px-4 py-3 text-center">Autorização</th>
                                    <th class="px-4 py-3 text-center">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="cart-list" class="divide-y divide-dark-700">
                                <tr><td colspan="5" class="p-4 text-center text-gray-500">Carga vazia. Adicione itens acima.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="finalizeOutput()" id="btn-finalize" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-green-900/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-105 flex items-center gap-2" disabled>
                            <i class="fa-solid fa-check-double"></i> Finalizar Expedição
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estoque -->
            <div id="screen-inventory" class="screen hidden animate-fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-white">Estoque Geral</h1>
                    <button onclick="exportToExcelDetailed()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl shadow-lg flex items-center gap-2 transition-all">
                        <i class="fa-solid fa-file-excel"></i> Exportar Detalhado
                    </button>
                </div>

                <div class="bg-dark-800 p-4 rounded-2xl shadow-lg border border-dark-700 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-500"></i>
                            <input type="text" id="inv-search" class="w-full form-input pl-10 rounded-xl p-3" placeholder="Buscar...">
                        </div>
                        <div>
                            <select id="inv-filter-sector" class="w-full form-input rounded-xl p-3">
                                <option value="">Todos os Setores</option>
                            </select>
                        </div>
                        <button onclick="sortInventory('expiry')" class="bg-dark-700 hover:bg-dark-600 text-gray-300 px-4 py-2 rounded-xl border border-dark-600 transition">
                            <i class="fa-solid fa-sort-numeric-down mr-2"></i> Validade
                        </button>
                        <button onclick="sortInventory('quantity')" class="bg-dark-700 hover:bg-dark-600 text-gray-300 px-4 py-2 rounded-xl border border-dark-600 transition">
                            <i class="fa-solid fa-arrow-down-9-1 mr-2"></i> Quantidade
                        </button>
                    </div>
                </div>

                <div class="bg-dark-800 rounded-2xl shadow-lg border border-dark-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300" id="inventory-table">
                            <thead class="text-xs text-gray-500 uppercase bg-dark-900/50">
                                <tr>
                                    <th class="px-6 py-4">Código</th>
                                    <th class="px-6 py-4">Produto</th>
                                    <th class="px-6 py-4">Setor</th>
                                    <th class="px-6 py-4 text-right">Total</th>
                                    <th class="px-6 py-4 text-center">Próx. Validade</th>
                                    <th class="px-6 py-4 text-center">Status</th>
                                    <th class="px-6 py-4 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-list" class="divide-y divide-dark-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Histórico -->
            <div id="screen-history" class="screen hidden animate-fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-white">Histórico</h1>
                    <button onclick="exportOutputReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl shadow-lg flex items-center gap-2 transition-all">
                        <i class="fa-solid fa-file-invoice-dollar"></i> Relatório de Saídas (BI)
                    </button>
                </div>
                
                <div class="bg-dark-800 rounded-2xl shadow-lg border border-dark-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-500 uppercase bg-dark-900/50">
                                <tr>
                                    <th class="px-6 py-4">Data</th>
                                    <th class="px-6 py-4">Tipo</th>
                                    <th class="px-6 py-4">Produto</th>
                                    <th class="px-6 py-4">Lote</th>
                                    <th class="px-6 py-4">Destino</th>
                                    <th class="px-6 py-4">Responsável</th>
                                    <th class="px-6 py-4 text-right">Qtd</th>
                                </tr>
                            </thead>
                            <tbody id="history-list" class="divide-y divide-dark-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Configurações -->
            <div id="screen-settings" class="screen hidden animate-fade-in">
                <h1 class="text-3xl font-bold text-white mb-6">Configurações</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-dark-800 p-8 rounded-2xl shadow-lg border border-dark-700">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-list-check text-indigo-500"></i> Setores
                        </h3>
                        <form id="form-sector" class="flex gap-2 mb-4">
                            <input type="text" id="new-sector-name" class="flex-1 form-input rounded-xl p-2 uppercase" placeholder="Novo Setor" required>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700">Add</button>
                        </form>
                        <ul id="settings-sectors-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                    </div>

                    <div class="bg-dark-800 p-8 rounded-2xl shadow-lg border border-dark-700">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-database text-blue-500"></i> Dados
                        </h3>
                        <div class="space-y-3">
                            <button onclick="backupData()" class="w-full bg-blue-600/20 text-blue-400 hover:bg-blue-600/30 font-bold py-3 px-4 rounded-xl border border-blue-500/30 flex items-center justify-center transition">
                                <i class="fa-solid fa-download mr-2"></i> Backup
                            </button>
                            <div class="relative">
                                <input type="file" id="restore-file" class="hidden" accept=".json" onchange="restoreData(this)">
                                <button onclick="document.getElementById('restore-file').click()" class="w-full bg-orange-500/20 text-orange-400 hover:bg-orange-500/30 font-bold py-3 px-4 rounded-xl border border-orange-500/30 flex items-center justify-center transition">
                                    <i class="fa-solid fa-upload mr-2"></i> Restaurar
                                </button>
                            </div>
                            <button onclick="clearDatabase()" class="w-full bg-red-500/10 text-red-500 hover:bg-red-500/20 font-bold py-3 px-4 rounded-xl border border-red-500/30 transition mt-4">
                                Apagar Tudo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Detalhes/Lotes -->
    <div id="modal-batches" class="modal">
        <div class="bg-dark-800 rounded-2xl shadow-2xl border border-dark-600 p-6 max-w-3xl w-full m-4">
            <div class="flex justify-between items-center mb-4 border-b border-dark-700 pb-4">
                <h2 class="text-xl font-bold text-white" id="modal-product-title">Detalhes</h2>
                <button onclick="closeModal('modal-batches')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="overflow-y-auto max-h-[60vh]">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="bg-dark-900 text-xs uppercase text-gray-400 sticky top-0">
                        <tr>
                            <th class="px-4 py-3">Lote</th>
                            <th class="px-4 py-3">Qtd</th>
                            <th class="px-4 py-3">Val.</th>
                            <th class="px-4 py-3 text-center">Status</th>
                            <th class="px-4 py-3 text-center">Excluir</th>
                        </tr>
                    </thead>
                    <tbody id="modal-batches-list" class="divide-y divide-dark-700"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Editar Produto -->
    <div id="modal-edit-product" class="modal">
        <div class="bg-dark-800 rounded-2xl shadow-2xl border border-dark-600 p-6 max-w-md w-full m-4">
            <h2 class="text-xl font-bold text-white mb-4">Editar Produto</h2>
            <input type="hidden" id="edit-prod-id">
            <label class="block text-gray-400 text-sm mb-1">Nome</label>
            <input type="text" id="edit-prod-name" class="w-full form-input rounded-xl p-3 mb-3">
            <label class="block text-gray-400 text-sm mb-1">Código (SKU)</label>
            <input type="number" id="edit-prod-code" class="w-full form-input rounded-xl p-3 mb-3">
            <label class="block text-gray-400 text-sm mb-1">Setor</label>
            <select id="edit-prod-sector" class="w-full form-input rounded-xl p-3 mb-6"></select>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('modal-edit-product')" class="px-4 py-2 rounded-xl border border-dark-600 text-gray-300">Cancelar</button>
                <button onclick="saveProductEdit()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-bold">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Autorização -->
    <div id="modal-auth" class="modal">
        <div class="bg-dark-800 rounded-2xl shadow-2xl border-2 border-red-600 p-6 max-w-md w-full m-4 text-center">
            <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-triangle-exclamation text-3xl text-red-500"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2">Atenção: Validade Curta!</h2>
            <p class="text-gray-400 mb-6">Este lote tem menos de 75% de vida útil. Identifique o responsável pela liberação.</p>
            <input type="text" id="auth-name" class="w-full form-input rounded-xl p-3 mb-6 border-red-500/50 focus:border-red-500" placeholder="Nome do Responsável">
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal('modal-auth')" class="px-6 py-2 rounded-xl border border-dark-600 text-gray-300 hover:bg-dark-700">Cancelar</button>
                <button onclick="confirmAddToCartAuth()" class="px-6 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700 font-bold">Liberar</button>
            </div>
        </div>
    </div>

    <div id="notification" class="fixed top-5 right-5 z-[100] hidden text-white py-3 px-6 rounded-xl shadow-2xl border border-white/10 transform transition-all duration-300 translate-y-[-20px] opacity-0 font-medium">
        <span id="notif-msg">Msg</span>
    </div>

    <script>
        // --- CORE & DB ---
        const DB_NAME = 'ExpedicaoDB_Dark_Pro';
        const DB_VERSION = 1;
        let db;

        const initDB = () => new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                db = e.target.result;
                if(!db.objectStoreNames.contains('products')) {
                    const store = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('code', 'code', { unique: false });
                }
                if(!db.objectStoreNames.contains('batches')) {
                    const store = db.createObjectStore('batches', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('productId', 'productId', { unique: false });
                }
                if(!db.objectStoreNames.contains('movements')) {
                    const store = db.createObjectStore('movements', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('date', 'date', { unique: false });
                }
                if(!db.objectStoreNames.contains('sectors')) db.createObjectStore('sectors', { keyPath: 'id', autoIncrement: true });
            };
            req.onsuccess = (e) => { db = e.target.result; resolve(db); };
            req.onerror = () => reject('Erro DB');
        });

        const dbAction = (store, mode, cb) => new Promise((resolve, reject) => {
            const tx = db.transaction(store, mode);
            const req = cb(tx.objectStore(store));
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });

        let products=[], batches=[], movements=[], sectors=[];
        let outputCart = []; // Carrinho de Expedição
        let showExpiringOnly = false;
        let pendingCartItem = null; // Item esperando autorização

        async function loadData() {
            try {
                products = await dbAction('products', 'readonly', s => s.getAll());
                batches = await dbAction('batches', 'readonly', s => s.getAll());
                movements = await dbAction('movements', 'readonly', s => s.getAll());
                sectors = await dbAction('sectors', 'readonly', s => s.getAll());
                sectors.sort((a,b) => a.name.localeCompare(b.name));
                
                updateDashboard();
                updateInventoryTable();
                updateHistoryTable();
                updateSectorSelects();
                renderSectorManager();
                document.getElementById('loading-overlay').classList.add('hidden');
            } catch(e) { console.error(e); }
        }

        // --- UTILS ---
        function calculateShelfLifeStatus(mfgDateStr, expDateStr) {
            const mfg = new Date(mfgDateStr + 'T00:00:00');
            const exp = new Date(expDateStr + 'T00:00:00');
            const today = new Date(); today.setHours(0,0,0,0);
            const totalLife = exp - mfg;
            const remaining = exp - today;
            if (totalLife <= 0) return { percent: 0, canSend: false };
            if (remaining < 0) return { percent: 0, canSend: false };
            const percent = (remaining / totalLife) * 100;
            return { percent: percent, canSend: percent >= 75 };
        }
        function parsePtBrDate(str) {
            if(!str || str === 'N/A') return new Date(8640000000000000); 
            const [d, m, y] = str.split('/'); return new Date(y, m - 1, d);
        }
        function showNotification(msg, err) {
            const n = document.getElementById('notification');
            document.getElementById('notif-msg').textContent = msg;
            n.className = `fixed top-5 right-5 z-[100] text-white py-3 px-6 rounded-xl shadow-2xl border border-white/10 transform transition-all duration-300 ${err?'bg-red-600':'bg-emerald-600'}`;
            n.classList.remove('hidden','translate-y-[-20px]','opacity-0');
            setTimeout(() => n.classList.add('translate-y-[-20px]','opacity-0'), 3000);
        }
        window.closeModal = (id) => document.getElementById(id).style.display='none';

        // --- EXPEDIÇÃO: CARRINHO (NOVO) ---
        function renderOutputBatches(productId) {
            const tbody = document.getElementById('output-batches-list'); tbody.innerHTML = '';
            const prodBatches = batches.filter(b => b.productId === productId && b.qty > 0).sort((a, b) => new Date(a.expDate) - new Date(b.expDate));
            if(prodBatches.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-red-400">Sem estoque.</td></tr>'; document.getElementById('btn-add-to-cart').disabled = true; return; }
            document.getElementById('btn-add-to-cart').disabled = false;

            prodBatches.forEach(b => {
                const sl = calculateShelfLifeStatus(b.mfgDate, b.expDate);
                const isCritical = !sl.canSend; 
                const warningIcon = isCritical ? '<i class="fa-solid fa-triangle-exclamation text-red-500 ml-2" title="Requer Autorização"></i>' : '';
                tbody.innerHTML += `
                    <tr class="border-b border-dark-700 hover:bg-dark-700/50">
                        <td class="px-4 py-3 font-mono">${b.code}</td>
                        <td class="px-4 py-3 text-center text-gray-400">${new Date(b.expDate).toLocaleDateString('pt-BR')}</td>
                        <td class="px-4 py-3 text-center ${isCritical?'text-red-400':'text-green-400'}">${sl.percent.toFixed(0)}% ${warningIcon}</td>
                        <td class="px-4 py-3 text-right text-emerald-400 font-bold">${b.qty.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right">
                            <input type="number" data-batch-id="${b.id}" max="${b.qty}" min="0" step="0.01" data-critical="${isCritical}" class="w-24 form-input text-right p-1 rounded border border-dark-600 focus:border-indigo-500 batch-qty-input" placeholder="0">
                        </td>
                    </tr>`;
            });
        }

        document.getElementById('btn-add-to-cart').addEventListener('click', () => {
            const dest = document.getElementById('output-destination').value;
            if(!dest) { showNotification('Informe o Destino!', true); return; }
            
            const inputs = document.querySelectorAll('.batch-qty-input');
            let tempItems = [];
            let needsAuth = false;

            inputs.forEach(i => {
                const q = parseFloat(i.value);
                if(q > 0) {
                    const batchId = parseInt(i.dataset.batchId);
                    const batch = batches.find(b => b.id === batchId);
                    const prod = products.find(p => p.id === batch.productId);
                    const isCritical = i.dataset.critical === 'true';
                    if (isCritical) needsAuth = true;
                    
                    if(q > batch.qty) { showNotification(`Qtd excedente no lote ${batch.code}`, true); return; }
                    
                    tempItems.push({ 
                        productName: prod.name, batchCode: batch.code, batchId: batch.id, productId: prod.id, qty: q, critical: isCritical 
                    });
                }
            });

            if(tempItems.length === 0) return;

            if(needsAuth) {
                pendingCartItem = tempItems;
                document.getElementById('modal-auth').style.display = 'flex';
                document.getElementById('auth-name').value = '';
                document.getElementById('auth-name').focus();
            } else {
                addToCart(tempItems, null);
            }
        });

        window.confirmAddToCartAuth = () => {
            const name = document.getElementById('auth-name').value.trim();
            if(!name) { alert('Nome obrigatório!'); return; }
            closeModal('modal-auth');
            addToCart(pendingCartItem, name);
        }

        function addToCart(items, authName) {
            items.forEach(item => {
                outputCart.push({ ...item, authorizedBy: item.critical ? authName : null });
            });
            renderCart();
            // Reset Batch Inputs
            document.querySelectorAll('.batch-qty-input').forEach(i => i.value = '');
            // Reset Product Selection
            document.getElementById('output-overlay').classList.remove('hidden');
            document.getElementById('selected-product-info').classList.add('hidden');
            document.getElementById('output-batches-list').innerHTML = '';
            document.getElementById('output-search').value = '';
            showNotification('Adicionado à Carga!');
        }

        function renderCart() {
            const tbody = document.getElementById('cart-list'); tbody.innerHTML = '';
            if(outputCart.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Carga vazia.</td></tr>';
                document.getElementById('btn-finalize').disabled = true;
                return;
            }
            document.getElementById('btn-finalize').disabled = false;
            
            outputCart.forEach((item, idx) => {
                tbody.innerHTML += `
                    <tr class="border-b border-dark-700">
                        <td class="px-4 py-2">${item.productName}</td>
                        <td class="px-4 py-2 font-mono text-gray-400">${item.batchCode}</td>
                        <td class="px-4 py-2 text-right font-bold">${item.qty}</td>
                        <td class="px-4 py-2 text-center text-xs text-orange-400">${item.authorizedBy || '-'}</td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="removeFromCart(${idx})" class="text-red-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        window.removeFromCart = (idx) => { outputCart.splice(idx, 1); renderCart(); }

        window.finalizeOutput = async () => {
            const dest = document.getElementById('output-destination').value;
            if(!outputCart.length) return;
            
            try {
                for(let item of outputCart) {
                    // Re-fetch batch to ensure qty is current
                    const batch = await dbAction('batches', 'readonly', s => s.get(item.batchId));
                    if(!batch || batch.qty < item.qty) throw new Error(`Lote ${item.batchCode} sem estoque suficiente.`);
                    
                    batch.qty -= item.qty;
                    await dbAction('batches', 'readwrite', s => s.put(batch));
                    
                    await dbAction('movements', 'readwrite', s => s.add({
                        type: 'saida', productId: item.productId, batchId: item.batchId,
                        qty: item.qty, date: new Date().toISOString(), destination: dest, authorizedBy: item.authorizedBy
                    }));

                    const prod = await dbAction('products', 'readonly', s => s.get(item.productId));
                    prod.total -= item.qty;
                    await dbAction('products', 'readwrite', s => s.put(prod));
                }
                
                showNotification('Expedição Finalizada com Sucesso!', false);
                outputCart = [];
                renderCart();
                document.getElementById('output-destination').value = '';
                loadData();
            } catch(e) {
                console.error(e);
                showNotification(e.message || 'Erro ao finalizar', true);
            }
        }

        // --- ESTOQUE: EDIÇÃO E EXCLUSÃO ---
        function updateInventoryTable() {
            const tbody = document.getElementById('inventory-list'); tbody.innerHTML = '';
            let filtered = products.filter(p => p.total > 0 || batches.some(b => b.productId === p.id && b.qty > 0));
            const sectorVal = document.getElementById('inv-filter-sector').value;
            const searchVal = document.getElementById('inv-search').value.toLowerCase();
            
            if (showExpiringOnly) {
                const limit = new Date(); limit.setDate(limit.getDate() + 30);
                filtered = filtered.filter(p => batches.some(b => b.productId === p.id && b.qty > 0 && new Date(b.expDate) <= limit));
            }
            if (sectorVal) filtered = filtered.filter(p => p.sector === sectorVal);
            if (searchVal) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchVal) || (p.code && p.code.toString().toLowerCase().includes(searchVal)));

            filtered.forEach(p => {
                const prodBatches = batches.filter(b => b.productId === p.id && b.qty > 0).sort((a,b) => new Date(a.expDate) - new Date(b.expDate));
                let nextExpiry = prodBatches.length > 0 ? new Date(prodBatches[0].expDate).toLocaleDateString('pt-BR') : 'N/A';
                
                const tr = document.createElement('tr');
                tr.className = 'border-b border-dark-700 hover:bg-dark-700/50 transition-colors';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-mono text-gray-400 text-xs">${p.code || '-'}</td>
                    <td class="px-6 py-4 font-medium text-white">${p.name}</td>
                    <td class="px-6 py-4 text-gray-400">${p.sector || '-'}</td>
                    <td class="px-6 py-4 text-right font-bold text-white">${p.total.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center text-gray-300">${nextExpiry}</td>
                    <td class="px-6 py-4 text-center text-gray-400">-</td>
                    <td class="px-6 py-4 text-center flex gap-2 justify-center">
                        <button onclick="showBatchDetails(${p.id})" class="text-indigo-400 hover:text-indigo-300 p-2" title="Ver Lotes"><i class="fa-solid fa-eye"></i></button>
                        <button onclick="editProduct(${p.id})" class="text-blue-400 hover:text-blue-300 p-2" title="Editar Produto"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteProduct(${p.id})" class="text-red-400 hover:text-red-300 p-2" title="Excluir Produto"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.editProduct = async (id) => {
            const p = await dbAction('products', 'readonly', s => s.get(id));
            if(!p) return;
            document.getElementById('edit-prod-id').value = p.id;
            document.getElementById('edit-prod-name').value = p.name;
            document.getElementById('edit-prod-code').value = p.code;
            
            // Populate sectors in edit modal
            const secSelect = document.getElementById('edit-prod-sector');
            secSelect.innerHTML = sectors.map(s => `<option value="${s.name}" ${s.name===p.sector?'selected':''}>${s.name}</option>`).join('');
            
            document.getElementById('modal-edit-product').style.display = 'flex';
        }

        window.saveProductEdit = async () => {
            const id = parseInt(document.getElementById('edit-prod-id').value);
            const p = await dbAction('products', 'readonly', s => s.get(id));
            p.name = document.getElementById('edit-prod-name').value;
            p.code = Number(document.getElementById('edit-prod-code').value);
            p.sector = document.getElementById('edit-prod-sector').value;
            await dbAction('products', 'readwrite', s => s.put(p));
            closeModal('modal-edit-product');
            loadData();
            showNotification('Produto Atualizado!');
        }

        window.deleteProduct = async (id) => {
            if(confirm('ATENÇÃO: Isso excluirá o produto e TODOS os seus lotes e histórico. Confirmar?')) {
                // Delete batches
                const prodBatches = batches.filter(b => b.productId === id);
                for(let b of prodBatches) await dbAction('batches', 'readwrite', s => s.delete(b.id));
                // Delete product
                await dbAction('products', 'readwrite', s => s.delete(id));
                loadData();
                showNotification('Produto Excluído.');
            }
        }

        window.deleteBatch = async (batchId, productId) => {
            if(confirm('Excluir este lote? O total do estoque será ajustado.')) {
                const batch = await dbAction('batches', 'readonly', s => s.get(batchId));
                const prod = await dbAction('products', 'readonly', s => s.get(productId));
                prod.total -= batch.qty;
                await dbAction('products', 'readwrite', s => s.put(prod));
                await dbAction('batches', 'readwrite', s => s.delete(batchId));
                closeModal('modal-batches');
                loadData();
                showNotification('Lote Excluído.');
            }
        }

        function showBatchDetails(productId) {
            const product = products.find(p => p.id === productId);
            document.getElementById('modal-product-title').textContent = `${product.name}`;
            const tbody = document.getElementById('modal-batches-list'); tbody.innerHTML = '';
            const prodBatches = batches.filter(b => b.productId === productId && b.qty > 0).sort((a,b) => new Date(a.expDate) - new Date(b.expDate));
            prodBatches.forEach(b => {
                const sl = calculateShelfLifeStatus(b.mfgDate, b.expDate);
                tbody.innerHTML += `
                    <tr class="border-b border-dark-700">
                        <td class="px-4 py-3 font-mono text-gray-300">${b.code}</td>
                        <td class="px-4 py-3 font-bold text-white">${b.qty.toFixed(2)}</td>
                        <td class="px-4 py-3 text-gray-400">${new Date(b.expDate).toLocaleDateString('pt-BR')}</td>
                        <td class="px-4 py-3 text-center ${sl.canSend?'text-green-500':'text-red-500'}">${sl.canSend ? 'OK' : 'Baixa %'}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="deleteBatch(${b.id}, ${productId})" class="text-red-500 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
            document.getElementById('modal-batches').style.display = 'flex';
        }

        // --- DASHBOARD, SETTINGS, EXPORTS (Mantidos) ---
        // (Código de suporte igual ao anterior para manter consistência)
        
        // Output Search
        document.getElementById('output-search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const dd = document.getElementById('output-search-results');
            dd.innerHTML = '';
            if(!term) { dd.classList.add('hidden'); return; }
            const res = products.filter(p => p.name.toLowerCase().includes(term) || (p.code && p.code.toString().includes(term)));
            if(res.length) {
                dd.classList.remove('hidden');
                res.forEach(p => {
                    const d = document.createElement('div');
                    d.className = 'p-3 hover:bg-dark-700 cursor-pointer border-b border-dark-700 last:border-0 text-gray-300';
                    d.innerHTML = `<span class="font-bold text-white">${p.name}</span> <span class="text-xs text-gray-500 float-right">Estoque: ${p.total}</span>`;
                    d.onclick = () => {
                        document.getElementById('sp-name').textContent=p.name; document.getElementById('sp-code').textContent=p.code;
                        document.getElementById('sp-total').textContent=p.total.toFixed(2); document.getElementById('sp-id').value=p.id;
                        document.getElementById('output-overlay').classList.add('hidden');
                        renderOutputBatches(p.id); dd.classList.add('hidden'); document.getElementById('output-search').value='';
                    };
                    dd.appendChild(d);
                });
            } else dd.classList.add('hidden');
        });

        // Entry Logic
        document.getElementById('entry-name').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const dd = document.getElementById('entry-dropdown'); dd.innerHTML = '';
            if(!term) { dd.classList.add('hidden'); return; }
            const filtered = products.filter(p => p.name.toLowerCase().includes(term) || (p.code && p.code.toString().toLowerCase().includes(term)));
            if(filtered.length) {
                dd.classList.remove('hidden');
                filtered.forEach(p => {
                    const d = document.createElement('div');
                    d.className = 'searchable-item flex justify-between text-sm text-gray-300';
                    d.innerHTML = `<span>${p.name}</span> <span class="text-gray-500 text-xs">${p.code||''}</span>`;
                    d.onclick = () => {
                        document.getElementById('entry-name').value = p.name;
                        const cInfo = document.getElementById('entry-code');
                        cInfo.value = p.code||''; cInfo.readOnly = true; cInfo.classList.add('bg-dark-700','text-gray-500');
                        document.getElementById('entry-sector').value = p.sector||'';
                        dd.classList.add('hidden');
                    };
                    dd.appendChild(d);
                });
            } else dd.classList.add('hidden');
        });
        document.getElementById('entry-name').addEventListener('change', (e) => {
            if(!e.target.value) { const c = document.getElementById('entry-code'); c.readOnly=false; c.classList.remove('bg-dark-700','text-gray-500'); c.value=''; }
        });
        document.getElementById('form-entry').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('entry-name').value.trim();
            const code = Number(document.getElementById('entry-code').value);
            const sector = document.getElementById('entry-sector').value;
            const bCode = document.getElementById('entry-batch').value.trim();
            const qty = parseFloat(document.getElementById('entry-qty').value);
            const mfg = document.getElementById('entry-mfg').value;
            const exp = document.getElementById('entry-exp').value;
            try {
                let prod = products.find(p => p.code === code);
                if(prod) { if(prod.name!==name || prod.sector!==sector) { prod.name=name; prod.sector=sector; await dbAction('products','readwrite',s=>s.put(prod)); } }
                else { const id = await dbAction('products','readwrite',s=>s.add({name,code,sector,total:0})); prod={id,name,code,sector,total:0}; products.push(prod); }
                let batch = batches.find(b => b.productId===prod.id && b.code===bCode);
                let bId;
                if(batch) { batch.qty+=qty; batch.mfgDate=mfg; batch.expDate=exp; await dbAction('batches','readwrite',s=>s.put(batch)); bId=batch.id; }
                else { bId = await dbAction('batches','readwrite',s=>s.add({productId:prod.id, code:bCode, qty, mfgDate:mfg, expDate:exp})); }
                prod.total+=qty; await dbAction('products','readwrite',s=>s.put(prod));
                await dbAction('movements','readwrite',s=>s.add({type:'entrada', productId:prod.id, batchId:bId, qty, date:new Date().toISOString(), destination:'-'}));
                showNotification('Entrada OK!', false); e.target.reset(); loadData();
            } catch(x) { console.error(x); showNotification('Erro', true); }
        });

        // Dashboard & Exports
        function updateDashboard() {
            document.getElementById('dash-total-items').textContent = products.filter(p=>p.total>0).length;
            document.getElementById('dash-total-qty').textContent = products.reduce((a,b)=>a+b.total,0).toFixed(0);
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dash-today-out').textContent = movements.filter(m=>m.type==='saida'&&m.date.startsWith(today)).length;
            const limit = new Date(); limit.setDate(limit.getDate()+30);
            document.getElementById('dash-expiring').textContent = batches.filter(b=>b.qty>0 && new Date(b.expDate)<=limit).length;
            const tOut = document.getElementById('dash-table-out'); tOut.innerHTML='';
            movements.filter(m=>m.type==='saida').sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5).forEach(m=>{
                const p = products.find(x=>x.id===m.productId);
                tOut.innerHTML+=`<tr class="border-b border-dark-700"><td class="px-4 py-2">${m.destination}</td><td class="px-4 py-2 text-gray-400 text-xs">${p?p.name:'?'}</td><td class="px-4 py-2 text-right font-bold text-white">${m.qty}</td></tr>`;
            });
            const tExp = document.getElementById('dash-table-expiring'); tExp.innerHTML='';
            batches.filter(b=>b.qty>0).sort((a,b)=>new Date(a.expDate)-new Date(b.expDate)).slice(0,5).forEach(b=>{
                const p = products.find(x=>x.id===b.productId);
                tExp.innerHTML+=`<tr class="border-b border-dark-700"><td class="px-4 py-2 text-white">${p?p.name:'?'}</td><td class="px-4 py-2 text-gray-500 text-xs">${b.code}</td><td class="px-4 py-2 text-right text-red-400 font-mono">${new Date(b.expDate).toLocaleDateString('pt-BR').slice(0,5)}</td></tr>`;
            });
        }
        function updateHistoryTable() {
            const tb = document.getElementById('history-list'); tb.innerHTML='';
            movements.sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,50).forEach(m=>{
                const p = products.find(x=>x.id===m.productId)||{}; const b = batches.find(x=>x.id===m.batchId)||{};
                const isEntry = m.type==='entrada';
                tb.innerHTML+=`<tr class="border-b border-dark-700 hover:bg-dark-700/50"><td class="px-6 py-4 text-xs text-gray-500">${new Date(m.date).toLocaleString('pt-BR')}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${isEntry?'bg-green-500/10 text-green-400':'bg-blue-500/10 text-blue-400'}">${m.type.toUpperCase()}</span></td><td class="px-6 py-4 text-white">${p.name||'?'}</td><td class="px-6 py-4 text-xs font-mono text-gray-400">${b.code||'?'}</td><td class="px-6 py-4 text-gray-400">${m.destination||'-'}</td><td class="px-6 py-4 text-gray-400 text-xs">${m.authorizedBy || '-'}</td><td class="px-6 py-4 text-right font-bold text-white">${m.qty.toFixed(2)}</td></tr>`;
            });
        }
        window.exportToExcelDetailed = () => {
            const dataToExport = []; const sortedProducts = [...products].sort((a, b) => a.name.localeCompare(b.name));
            sortedProducts.forEach(prod => { const prodBatches = batches.filter(b => b.productId === prod.id && b.qty > 0);
                if (prodBatches.length > 0) { prodBatches.sort((a, b) => new Date(a.expDate) - new Date(b.expDate));
                    prodBatches.forEach(batch => { const sl = calculateShelfLifeStatus(batch.mfgDate, batch.expDate);
                        dataToExport.push({ "Código": Number(prod.code) || prod.code, "Produto": prod.name, "Setor": prod.sector || '', "Lote": Number(batch.code) || batch.code, "Qtd": batch.qty, "Fabricação": parsePtBrDate(new Date(batch.mfgDate).toLocaleDateString('pt-BR')), "Validade": parsePtBrDate(new Date(batch.expDate).toLocaleDateString('pt-BR')), "Vida Útil (%)": sl.percent.toFixed(1) + '%' }); }); } });
            if(dataToExport.length === 0) { showNotification("Nada para exportar", true); return; }
            const ws = XLSX.utils.json_to_sheet(dataToExport, { dateNF: "dd/mm/yyyy" }); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Estoque_Detalhado"); XLSX.writeFile(wb, "Estoque_Expedicao_Detalhado.xlsx"); showNotification("Excel gerado!");
        }
        window.exportOutputReport = () => {
            const dataToExport = []; const outputMoves = movements.filter(m => m.type === 'saida');
            if(outputMoves.length === 0) { showNotification("Nenhuma saída.", true); return; }
            outputMoves.sort((a,b) => new Date(a.date) - new Date(b.date)); const days = ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];
            outputMoves.forEach(m => { const dateObj = new Date(m.date); const prod = products.find(p => p.id === m.productId) || {name:'-', code:'-'}; const batch = batches.find(b => b.id === m.batchId) || {code:'-'};
                dataToExport.push({ "Data": dateObj, "Dia": days[dateObj.getDay()], "Hora": dateObj.toLocaleTimeString('pt-BR'), "Produto": prod.name, "Código": Number(prod.code)||prod.code, "Lote": Number(batch.code)||batch.code, "Destino": m.destination, "Qtd": m.qty, "Autorizado": m.authorizedBy || '-' }); });
            const ws = XLSX.utils.json_to_sheet(dataToExport, { dateNF: "dd/mm/yyyy" }); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Saidas_BI"); XLSX.writeFile(wb, "Relatorio_Saidas.xlsx"); showNotification("Relatório gerado!");
        }
        window.navigateTo = (s) => { document.querySelectorAll('.screen').forEach(e=>e.classList.add('hidden')); document.getElementById('screen-'+s).classList.remove('hidden'); if(s==='inventory'){showExpiringOnly=false; updateInventoryTable();} }
        window.filterExpiringDashboard = () => { showExpiringOnly=true; navigateTo('inventory'); }
        document.getElementById('form-sector').addEventListener('submit', async(e)=>{ e.preventDefault(); const n = document.getElementById('new-sector-name').value.toUpperCase(); if(sectors.some(s=>s.name===n)) return; await dbAction('sectors','readwrite',s=>s.add({name:n})); e.target.reset(); loadData(); });
        function renderSectorManager() { const l = document.getElementById('settings-sectors-list'); l.innerHTML=''; sectors.forEach(s=>{ l.innerHTML+=`<li class="flex justify-between bg-dark-700 p-3 rounded text-gray-300 mb-2"><span>${s.name}</span><button onclick="delSector(${s.id})" class="text-red-400"><i class="fa-solid fa-trash"></i></button></li>` }); }
        window.delSector = async(id) => { await dbAction('sectors','readwrite',s=>s.delete(id)); loadData(); }
        function updateSectorSelects() { const opts = '<option value="">Selecione...</option>' + sectors.map(s=>`<option value="${s.name}">${s.name}</option>`).join(''); document.getElementById('entry-sector').innerHTML=opts; document.getElementById('edit-prod-sector').innerHTML=opts; document.getElementById('inv-filter-sector').innerHTML='<option value="">Todos</option>'+opts; }
        window.backupData = () => { const b=new Blob([JSON.stringify({products,batches,movements,sectors})],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup_pro.json'; a.click(); }
        window.restoreData = (i) => { const r=new FileReader(); r.onload=async(e)=>{ try{const d=JSON.parse(e.target.result); await Promise.all(['products','batches','movements','sectors'].map(n=>dbAction(n,'readwrite',s=>s.clear()))); for(let k in d) for(let i of d[k]) await dbAction(k,'readwrite',s=>s.add(i)); loadData(); showNotification('Restaurado!'); }catch(x){showNotification('Erro',true);} }; r.readAsText(i.files[0]); }
        window.clearDatabase = async() => { if(confirm('Zerar tudo?')) { await Promise.all(['products','batches','movements','sectors'].map(n=>dbAction(n,'readwrite',s=>s.clear()))); loadData(); } }
        window.sortInventory = (k) => { const rows = Array.from(document.querySelectorAll('#inventory-list tr')); rows.sort((a,b) => { if(k==='quantity') { const vA = parseFloat(a.children[3].innerText.replace(',', '.')); const vB = parseFloat(b.children[3].innerText.replace(',', '.')); return vB - vA; } if(k==='expiry') { const vA = parsePtBrDate(a.children[4].innerText); const vB = parsePtBrDate(b.children[4].innerText); return vA - vB; } return 0; }); const tb = document.getElementById('inventory-list'); tb.innerHTML=''; rows.forEach(r=>tb.appendChild(r)); }
        document.getElementById('inv-search').addEventListener('input', () => { showExpiringOnly = false; updateInventoryTable(); });
        document.getElementById('inv-filter-sector').addEventListener('change', () => { showExpiringOnly = false; updateInventoryTable(); });

        initDB().then(loadData);
    </script>
</body>
</html>
