<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expedição & Controle (PRO)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569', input: '#1e293b', border: '#334155' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .sidebar { transition: width 0.3s ease-in-out; }
        .sidebar-text { transition: opacity 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .modal { display: none; position: fixed; z-index: 50; inset: 0; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(2px); }
        .form-input { background-color: #1e293b; border-color: #334155; color: white; }
        .form-input:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25); outline: none; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .searchable-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; max-height: 200px; overflow-y: auto; border: 1px solid #334155; background-color: #1e293b; border-radius: 0 0 0.375rem 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .searchable-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #334155; }
        .searchable-item:hover { background-color: #334155; }
    </style>
</head>
<body class="antialiased h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-20 bg-slate-950 border-r border-slate-800 text-gray-300 flex flex-col items-center py-6 space-y-6 sidebar hover:w-64 group shadow-2xl z-20">
        <div class="mb-4 text-center w-full overflow-hidden flex items-center justify-center group-hover:justify-start px-4">
            <i class="fa-solid fa-truck-fast fa-2xl text-indigo-500"></i>
            <span class="ml-3 text-xl font-bold whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text text-white">Logística</span>
        </div>
        
        <nav class="flex-1 w-full space-y-2 px-3">
            <a href="#" onclick="navigateTo('dashboard')" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all text-gray-400 hover:text-white group-hover:justify-start justify-center">
                <i class="fa-solid fa-chart-pie w-6 text-center text-lg"></i>
                <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Dashboard</span>
            </a>
            <a href="#" onclick="navigateTo('orders')" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all text-gray-400 hover:text-white group-hover:justify-start justify-center">
                <i class="fa-solid fa-clipboard-list w-6 text-center text-lg"></i>
                <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Pedidos</span>
            </a>
            <a href="#" onclick="navigateTo('entry')" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all text-gray-400 hover:text-white group-hover:justify-start justify-center">
                <i class="fa-solid fa-box-open w-6 text-center text-lg"></i>
                <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Entrada</span>
            </a>
            <a href="#" onclick="navigateTo('inventory')" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all text-gray-400 hover:text-white group-hover:justify-start justify-center">
                <i class="fa-solid fa-warehouse w-6 text-center text-lg"></i>
                <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Estoque</span>
            </a>
             <a href="#" onclick="navigateTo('stores')" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all text-gray-400 hover:text-white group-hover:justify-start justify-center">
                <i class="fa-solid fa-store w-6 text-center text-lg"></i>
                <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Lojas</span>
            </a>
            <a href="#" onclick="navigateTo('settings')" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition-all text-gray-400 hover:text-white group-hover:justify-start justify-center">
                <i class="fa-solid fa-gear w-6 text-center text-lg"></i>
                <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text font-medium">Config</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 md:p-8 overflow-y-auto bg-dark-900 relative">
        
        <!-- Dashboard -->
        <div id="screen-dashboard" class="screen animate-fade-in">
            <h1 class="text-3xl font-bold text-white mb-2">Visão Geral</h1>
            <p class="text-gray-400 mb-8 italic text-sm">"Não se gerencia o que não se mede."</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Card 24h (Pedidos) -->
                <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-l-4 border-l-emerald-500 border-dark-700">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Pedidos (24h)</p>
                            <h3 class="text-4xl font-bold text-white mt-2" id="dash-vol-24h">0</h3>
                            <p class="text-sm text-gray-500 mt-1">entrega hoje/amanhã</p>
                        </div>
                        <div class="p-3 bg-emerald-500/10 rounded-xl text-emerald-400"><i class="fa-solid fa-stopwatch fa-xl"></i></div>
                    </div>
                </div>
                <!-- Card 48h (Pedidos) -->
                <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-l-4 border-l-blue-500 border-dark-700">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Pedidos (48h+)</p>
                            <h3 class="text-4xl font-bold text-white mt-2" id="dash-vol-48h">0</h3>
                            <p class="text-sm text-gray-500 mt-1">entrega futura</p>
                        </div>
                        <div class="p-3 bg-blue-500/10 rounded-xl text-blue-400"><i class="fa-solid fa-calendar-day fa-xl"></i></div>
                    </div>
                </div>
                <!-- Card Ruptura (Interativo) -->
                <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-l-4 border-l-red-500 border-dark-700 cursor-pointer hover:bg-dark-700 transition-all transform hover:scale-[1.02]" onclick="openShortageModal()" title="Clique para ver detalhes">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Produtos em Falta</p>
                            <h3 class="text-4xl font-bold text-white mt-2" id="dash-shortage">0</h3>
                            <p class="text-sm text-red-400 mt-1 flex items-center gap-1"><i class="fa-solid fa-hand-pointer text-xs"></i> Ver detalhes</p>
                        </div>
                        <div class="p-3 bg-red-500/10 rounded-xl text-red-400"><i class="fa-solid fa-triangle-exclamation fa-xl"></i></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-clipboard-list text-indigo-500"></i> Pedidos Pendentes</h2>
                        <button onclick="navigateTo('orders')" class="text-xs text-indigo-400 hover:text-indigo-300">Ver Todos</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-500 uppercase bg-dark-900/50">
                                <tr>
                                    <th class="px-4 py-3">Loja</th>
                                    <th class="px-4 py-3 text-center">Data Entrega</th>
                                    <th class="px-4 py-3 text-right">Volume</th>
                                </tr>
                            </thead>
                            <tbody id="dash-table-orders" class="divide-y divide-dark-700"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700">
                    <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-circle-exclamation text-red-500"></i> Alerta de Ruptura (Prioridade)</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-500 uppercase bg-dark-900/50">
                                <tr>
                                    <th class="px-4 py-3">Produto</th>
                                    <th class="px-4 py-3 text-right">Saldo</th>
                                    <th class="px-4 py-3 text-right text-orange-400">Prazo Limite</th>
                                </tr>
                            </thead>
                            <tbody id="dash-table-shortage" class="divide-y divide-dark-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pedidos (Order Management) -->
        <div id="screen-orders" class="screen hidden animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-white">Gestão de Pedidos</h1>
                <div class="flex gap-2">
                    <button onclick="showNewOrderModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl shadow-lg flex items-center gap-2 transition-all">
                        <i class="fa-solid fa-plus"></i> Novo Pedido
                    </button>
                    <button onclick="exportOrders()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl shadow-lg flex items-center gap-2 transition-all">
                        <i class="fa-solid fa-file-excel"></i> Exportar
                    </button>
                </div>
            </div>

            <!-- Pending Orders List -->
            <div class="grid grid-cols-1 gap-6" id="orders-container">
                <!-- Orders will be injected here -->
            </div>
        </div>

        <!-- Entrada Simplificada -->
        <div id="screen-entry" class="screen hidden animate-fade-in">
            <h1 class="text-3xl font-bold text-white mb-6">Entrada de Estoque</h1>
            <div class="bg-dark-800 p-8 rounded-2xl shadow-xl border border-dark-700 max-w-2xl mx-auto">
                <form id="form-entry">
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-sm font-medium text-gray-400">Produto</label>
                        <button type="button" onclick="clearEntryForm()" class="text-xs text-indigo-400 hover:text-white underline">Limpar / Novo Produto</button>
                    </div>
                    <div class="mb-6 relative">
                        <input type="text" id="entry-name" class="w-full form-input rounded-xl p-3 border" placeholder="Buscar produto ou digitar novo..." autocomplete="off" required>
                        <div id="entry-dropdown" class="searchable-dropdown hidden"></div>
                        <input type="hidden" id="entry-prod-id">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Código (SKU)</label>
                            <input type="text" id="entry-code" class="w-full form-input rounded-xl p-3 border" placeholder="Ex: 10050" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Setor</label>
                             <select id="entry-sector" class="w-full form-input rounded-xl p-3 border">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Data de Entrada</label>
                            <input type="date" id="entry-date" class="w-full form-input rounded-xl p-3 border" required>
                        </div>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-400 mb-2">Quantidade</label>
                                <input type="number" id="entry-qty" min="0.01" step="0.01" class="w-full form-input rounded-xl p-3 border text-2xl font-bold text-green-400" placeholder="0.00" required>
                            </div>
                            <div class="w-1/3">
                                <label class="block text-sm font-medium text-gray-400 mb-2">Unid.</label>
                                <select id="entry-uom" class="w-full form-input rounded-xl p-3 border text-lg font-bold">
                                    <option value="UND">UND</option>
                                    <option value="KG">KG</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-check"></i> Confirmar Entrada
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Estoque -->
        <div id="screen-inventory" class="screen hidden animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-white">Estoque & Ruptura</h1>
                <button onclick="exportInventory()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl shadow-lg flex items-center gap-2">
                    <i class="fa-solid fa-file-excel"></i> Exportar
                </button>
            </div>

            <div class="bg-dark-800 p-4 rounded-2xl shadow-lg border border-dark-700 mb-6 flex gap-4">
                <div class="relative flex-1">
                    <i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-500"></i>
                    <input type="text" id="inv-search" class="w-full form-input pl-10 rounded-xl p-3" placeholder="Buscar por nome ou código...">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="inv-check-shortage" class="w-5 h-5 rounded bg-dark-700 border-gray-600 text-red-600 focus:ring-red-500">
                    <label for="inv-check-shortage" class="text-gray-300 cursor-pointer">Apenas Faltas</label>
                </div>
            </div>

            <div class="bg-dark-800 rounded-2xl shadow-lg border border-dark-700 overflow-hidden">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-500 uppercase bg-dark-900/50">
                        <tr>
                            <th class="px-6 py-4">Cód</th>
                            <th class="px-6 py-4">Produto</th>
                            <th class="px-6 py-4">Setor</th>
                            <th class="px-6 py-4">Ult. Entrada</th>
                            <th class="px-6 py-4 text-right text-gray-400">Físico</th>
                            <th class="px-6 py-4 text-right text-blue-400">Reservado</th>
                            <th class="px-6 py-4 text-right font-bold">Saldo</th>
                            <th class="px-6 py-4 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list" class="divide-y divide-dark-700"></tbody>
                </table>
            </div>
        </div>

        <!-- Lojas -->
        <div id="screen-stores" class="screen hidden animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-white">Cadastro de Lojas</h1>
                <div class="relative">
                    <input type="file" id="import-store-file" class="hidden" accept=".csv, .xlsx, .xls" onchange="handleStoreFile(this)">
                    <button onclick="document.getElementById('import-store-file').click()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl shadow-lg flex items-center gap-2 transition-all">
                        <i class="fa-solid fa-file-import"></i> Importar Planilha
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-dark-800 p-6 rounded-2xl shadow-lg border border-dark-700 h-fit">
                    <h3 class="text-xl font-bold text-white mb-4">Nova Loja</h3>
                    <form id="form-store">
                        <label class="block text-gray-400 text-sm mb-1">Nome da Loja</label>
                        <input type="text" id="store-name" class="w-full form-input rounded-xl p-2 mb-3" required>
                        <label class="block text-gray-400 text-sm mb-1">Cód/CNPJ (Opcional)</label>
                        <input type="text" id="store-code" class="w-full form-input rounded-xl p-2 mb-3">
                        <label class="block text-gray-400 text-sm mb-1">Endereço/Cidade</label>
                        <input type="text" id="store-city" class="w-full form-input rounded-xl p-2 mb-4">
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl">Salvar Loja</button>
                    </form>
                </div>
                <div class="md:col-span-2 space-y-4" id="stores-list"></div>
            </div>
        </div>

        <!-- Settings -->
        <div id="screen-settings" class="screen hidden animate-fade-in">
            <h1 class="text-3xl font-bold text-white mb-6">Configurações</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-dark-800 p-8 rounded-2xl shadow-lg border border-dark-700">
                    <h3 class="text-xl font-bold text-white mb-4">Gerenciar Setores</h3>
                    <form id="form-sector" class="flex gap-2 mb-6">
                        <input type="text" id="new-sector-name" class="flex-1 form-input rounded-xl p-2 uppercase" placeholder="Novo Setor" required>
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700">Add</button>
                    </form>
                    
                    <h4 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">Setores Cadastrados</h4>
                    <div class="bg-dark-900 rounded-xl border border-dark-700 overflow-hidden">
                        <ul id="settings-sectors-list" class="divide-y divide-dark-700 max-h-60 overflow-y-auto"></ul>
                    </div>
                </div>
                <div class="bg-dark-800 p-8 rounded-2xl shadow-lg border border-dark-700">
                    <h3 class="text-xl font-bold text-white mb-4">Gerenciar Dados</h3>
                    <div class="space-y-4">
                        <!-- Import Inventory Button -->
                        <div class="relative">
                            <input type="file" id="import-inventory-file" class="hidden" accept=".csv, .xlsx, .xls, .pdf, .png, .jpg, .jpeg" onchange="handleInventoryFile(this)">
                            <button onclick="document.getElementById('import-inventory-file').click()" class="w-full bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600/30 font-bold py-3 px-4 rounded-xl border border-emerald-500/30 flex items-center justify-center transition">
                                <i class="fa-solid fa-file-import mr-2"></i> Importar Inventário (CSV/Excel/Img)
                            </button>
                        </div>

                        <hr class="border-dark-700 my-4">

                        <button onclick="backupData()" class="w-full bg-blue-600/20 text-blue-400 hover:bg-blue-600/30 font-bold py-3 px-4 rounded-xl border border-blue-500/30 flex items-center justify-center transition">
                            <i class="fa-solid fa-download mr-2"></i> Baixar Backup (JSON)
                        </button>
                        
                        <div class="relative">
                            <input type="file" id="restore-file" class="hidden" accept=".json" onchange="restoreData(this)">
                            <button onclick="document.getElementById('restore-file').click()" class="w-full bg-orange-500/20 text-orange-400 hover:bg-orange-500/30 font-bold py-3 px-4 rounded-xl border border-orange-500/30 flex items-center justify-center transition">
                                <i class="fa-solid fa-upload mr-2"></i> Restaurar Dados
                            </button>
                        </div>
                        
                        <hr class="border-dark-700 my-4">
                        
                        <button onclick="clearDatabase()" class="w-full bg-red-500/10 text-red-500 hover:bg-red-500/20 font-bold py-3 px-4 rounded-xl border border-red-500/30 transition">
                            <i class="fa-solid fa-trash mr-2"></i> Apagar Tudo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Importação Inventário -->
    <div id="modal-import-preview" class="modal">
        <div class="bg-dark-800 rounded-2xl shadow-2xl border border-emerald-500/30 p-6 max-w-2xl w-full m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-clipboard-check text-emerald-500"></i> Confirmar Importação
                </h2>
                <button onclick="closeModal('modal-import-preview')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <p class="text-gray-400 mb-4 text-sm">
                Arquivo: <span id="import-filename" class="text-white font-bold"></span><br>
                Setor Detectado: <span id="import-sector" class="text-emerald-400 font-bold uppercase"></span>
            </p>

            <div class="mb-6">
                <label class="block text-gray-400 text-sm mb-2 font-bold">Ação Desejada:</label>
                <div class="space-y-2">
                    <label class="flex items-center p-3 rounded-xl border border-dark-600 bg-dark-900 cursor-pointer hover:bg-dark-700">
                        <input type="radio" name="import-action" value="full" class="text-emerald-500 focus:ring-emerald-500 h-4 w-4" checked>
                        <div class="ml-3">
                            <span class="block text-white font-medium">Atualizar Estoque e Cadastro</span>
                            <span class="block text-xs text-gray-500">Cadastra novos produtos, setores e atualiza a quantidade em estoque com base na planilha.</span>
                        </div>
                    </label>
                    <label class="flex items-center p-3 rounded-xl border border-dark-600 bg-dark-900 cursor-pointer hover:bg-dark-700">
                        <input type="radio" name="import-action" value="register_only" class="text-blue-500 focus:ring-blue-500 h-4 w-4">
                        <div class="ml-3">
                            <span class="block text-white font-medium">Apenas Cadastrar Produtos</span>
                            <span class="block text-xs text-gray-500">Adiciona produtos novos e setores ao sistema, mas mantém o estoque zerado ou inalterado.</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="bg-dark-900 rounded-xl p-4 border border-dark-700 mb-6">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <span class="block text-2xl font-bold text-white" id="import-count-new">0</span>
                        <span class="text-xs text-gray-500 uppercase">Novos Produtos</span>
                    </div>
                    <div>
                        <span class="block text-2xl font-bold text-white" id="import-count-update">0</span>
                        <span class="text-xs text-gray-500 uppercase">Itens na Planilha</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="closeModal('modal-import-preview')" class="bg-dark-700 hover:bg-dark-600 text-white px-5 py-2.5 rounded-xl transition">Cancelar</button>
                <button onclick="confirmInventoryImport()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold px-6 py-2.5 rounded-xl shadow-lg transition flex items-center gap-2">
                    <i class="fa-solid fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Importação Lojas -->
    <div id="modal-import-stores" class="modal">
        <div class="bg-dark-800 rounded-2xl shadow-2xl border border-emerald-500/30 p-6 max-w-lg w-full m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-store text-emerald-500"></i> Importar Lojas
                </h2>
                <button onclick="closeModal('modal-import-stores')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="bg-dark-900 rounded-xl p-4 border border-dark-700 mb-6 text-center">
                <i class="fa-solid fa-file-csv text-4xl text-gray-600 mb-2"></i>
                <p class="text-gray-400 text-sm">Lojas encontradas na planilha:</p>
                <span class="block text-4xl font-bold text-white mt-2" id="import-stores-count">0</span>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="closeModal('modal-import-stores')" class="bg-dark-700 hover:bg-dark-600 text-white px-5 py-2.5 rounded-xl transition">Cancelar</button>
                <button onclick="confirmStoreImport()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold px-6 py-2.5 rounded-xl shadow-lg transition flex items-center gap-2">
                    <i class="fa-solid fa-check"></i> Importar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ruptura Completa -->
    <div id="modal-shortage" class="modal">
        <div class="bg-dark-800 rounded-2xl shadow-2xl border border-red-600/50 p-6 max-w-4xl w-full m-4 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation text-red-500"></i> Relatório de Ruptura (Faltas)
                </h2>
                <button onclick="closeModal('modal-shortage')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="overflow-y-auto flex-1 bg-dark-900 rounded-xl border border-dark-700">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="bg-dark-800 text-xs text-gray-500 uppercase sticky top-0">
                        <tr>
                            <th class="px-6 py-4">Produto</th>
                            <th class="px-6 py-4">Setor</th>
                            <th class="px-6 py-4 text-right">Saldo Devedor</th>
                            <th class="px-6 py-4 text-right text-orange-400">Prazo Limite</th>
                        </tr>
                    </thead>
                    <tbody id="modal-shortage-list" class="divide-y divide-dark-700"></tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeModal('modal-shortage')" class="bg-dark-700 hover:bg-dark-600 text-white px-6 py-2 rounded-xl transition">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Produto Completo -->
    <div id="modal-edit-product" class="modal">
        <div class="bg-dark-800 rounded-2xl shadow-2xl border border-indigo-500/30 p-6 max-w-lg w-full m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Editar Produto</h2>
                <button onclick="closeModal('modal-edit-product')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <input type="hidden" id="edit-prod-id">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-1">Nome do Produto</label>
                    <input type="text" id="edit-prod-name" class="w-full form-input rounded-xl p-3">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Código (SKU)</label>
                        <input type="text" id="edit-prod-code" class="w-full form-input rounded-xl p-3">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Setor</label>
                        <select id="edit-prod-sector" class="w-full form-input rounded-xl p-3"></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Estoque Físico</label>
                        <input type="number" id="edit-prod-qty" step="0.01" class="w-full form-input rounded-xl p-3 font-bold text-emerald-400">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Unidade</label>
                        <select id="edit-prod-uom" class="w-full form-input rounded-xl p-3">
                            <option value="UND">UND</option>
                            <option value="KG">KG</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">Última Entrada</label>
                    <input type="date" id="edit-prod-date" class="w-full form-input rounded-xl p-3">
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button onclick="closeModal('modal-edit-product')" class="bg-dark-700 hover:bg-dark-600 text-white px-5 py-2.5 rounded-xl transition">Cancelar</button>
                <button onclick="saveProductEdit()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 py-2.5 rounded-xl shadow-lg transition">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- Modal Novo Pedido -->
    <div id="modal-new-order" class="modal">
        <div class="bg-dark-800 rounded-2xl shadow-2xl border border-dark-600 p-6 max-w-4xl w-full m-4 h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Novo Pedido de Expedição</h2>
                <button onclick="closeModal('modal-new-order')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label class="block text-gray-400 text-sm mb-1">Loja Destino</label>
                    <select id="order-store-select" class="w-full form-input rounded-xl p-3"></select>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">Data de Entrega</label>
                    <input type="date" id="order-delivery-date" class="w-full form-input rounded-xl p-3">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">Ação</label>
                    <button onclick="finalizeOrderCreation()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg">Salvar Pedido</button>
                </div>
            </div>

            <hr class="border-dark-700 mb-6">

            <div class="flex-1 flex flex-col md:flex-row gap-6 overflow-hidden">
                <!-- Product Selector -->
                <div class="md:w-1/3 flex flex-col">
                    <div class="relative mb-4">
                        <input type="text" id="order-prod-search" class="w-full form-input rounded-xl p-3 pl-10" placeholder="Buscar produto...">
                        <i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-500"></i>
                        <div id="order-prod-results" class="hidden absolute top-full left-0 right-0 bg-dark-700 border border-dark-600 z-50 max-h-48 overflow-y-auto rounded-b-xl shadow-xl"></div>
                    </div>
                    <div id="order-selected-prod" class="bg-dark-900 p-4 rounded-xl border border-dark-700 hidden mb-4">
                        <h4 class="font-bold text-white mb-1" id="osp-name">Produto</h4>
                        <p class="text-xs text-gray-400 mb-3">Cód: <span id="osp-code"></span> | Disp: <span id="osp-stock" class="text-emerald-400"></span> <span id="osp-uom" class="text-xs text-gray-500"></span></p>
                        <div class="flex gap-2">
                            <input type="number" id="osp-qty" class="w-full form-input rounded-xl p-2" placeholder="Qtd">
                            <button onclick="addItemToOrderCart()" class="bg-emerald-600 text-white px-4 rounded-xl"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Cart -->
                <div class="md:w-2/3 bg-dark-900 rounded-xl border border-dark-700 flex flex-col">
                    <div class="p-3 border-b border-dark-700 bg-dark-800 rounded-t-xl flex justify-between">
                        <span class="font-bold text-gray-300">Itens do Pedido</span>
                        <span class="text-sm text-gray-500" id="order-cart-count">0 itens</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead><tr class="text-xs uppercase bg-dark-800"><th class="p-2">Produto</th><th class="p-2 text-right">Qtd</th><th class="p-2 text-center">X</th></tr></thead>
                            <tbody id="order-cart-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-5 right-5 z-[100] hidden text-white py-3 px-6 rounded-xl shadow-2xl border border-white/10 transform transition-all duration-300 translate-y-[-20px] opacity-0 font-medium">
        <span id="notif-msg">Msg</span>
    </div>

    <script>
        // --- DB & STATE ---
        const DB_NAME = 'ExpedicaoLiteDB_3'; // Bumped version to ensure clean slate for new fields if needed
        const DB_VERSION = 1;
        let db;
        let products = [], stores = [], orders = [], sectors = [];
        let orderCart = [];
        let importPreviewData = { newItems: [], updatedItems: [], sector: '', batchesFound: [] };
        let importStoreData = [];

        const initDB = () => new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                db = e.target.result;
                if(!db.objectStoreNames.contains('products')) db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                if(!db.objectStoreNames.contains('stores')) db.createObjectStore('stores', { keyPath: 'id', autoIncrement: true });
                if(!db.objectStoreNames.contains('orders')) db.createObjectStore('orders', { keyPath: 'id', autoIncrement: true }); 
                if(!db.objectStoreNames.contains('sectors')) db.createObjectStore('sectors', { keyPath: 'id', autoIncrement: true });
                if(!db.objectStoreNames.contains('batches')) db.createObjectStore('batches', { keyPath: 'id', autoIncrement: true });
            };
            req.onsuccess = (e) => { db = e.target.result; resolve(db); };
            req.onerror = () => reject('Erro DB');
        });

        const dbAction = (store, mode, cb) => new Promise((resolve, reject) => {
            const tx = db.transaction(store, mode);
            const req = cb(tx.objectStore(store));
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });

        async function loadData() {
            products = await dbAction('products', 'readonly', s => s.getAll());
            stores = await dbAction('stores', 'readonly', s => s.getAll());
            orders = await dbAction('orders', 'readonly', s => s.getAll());
            sectors = await dbAction('sectors', 'readonly', s => s.getAll());
            
            updateDashboard();
            updateOrdersList();
            updateInventoryTable();
            updateStoreList();
            updateSectorSelects();
            renderSectorList(); // Now explicitly calling this
        }

        // --- UTILS ---
        function showNotification(msg, err=false) {
            const n = document.getElementById('notification');
            document.getElementById('notif-msg').textContent = msg;
            n.className = `fixed top-5 right-5 z-[100] text-white py-3 px-6 rounded-xl shadow-2xl border border-white/10 transform transition-all duration-300 ${err?'bg-red-600':'bg-emerald-600'}`;
            n.classList.remove('hidden','translate-y-[-20px]','opacity-0');
            setTimeout(() => n.classList.add('translate-y-[-20px]','opacity-0'), 3000);
        }
        window.closeModal = (id) => document.getElementById(id).style.display='none';
        window.navigateTo = (s) => { 
            document.querySelectorAll('.screen').forEach(e=>e.classList.add('hidden')); 
            document.getElementById('screen-'+s).classList.remove('hidden'); 
            if(s === 'inventory') updateInventoryTable();
            if(s === 'entry') document.getElementById('entry-date').valueAsDate = new Date();
        };

        // --- IMPORT LOGIC (INVENTORY) ---
        window.handleInventoryFile = (input) => {
            const file = input.files[0];
            if(!file) return;

            // Check file type
            const ext = file.name.split('.').pop().toLowerCase();
            if (['png', 'jpg', 'jpeg', 'pdf'].includes(ext)) {
                alert("AVISO: A leitura automática de imagens/PDF requer serviços de OCR em nuvem (não disponíveis nesta versão offline).\n\nPara importação automática, por favor converta sua tabela para Excel (.xlsx) ou CSV.");
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1}); // Array of Arrays

                processInventoryData(rows, file.name);
                input.value = ''; // Reset
            };
            reader.readAsArrayBuffer(file);
        };

        function processInventoryData(rows, filename) {
            let sectorName = "Geral";
            const knownSectors = ["CONFEITARIA", "PÃES CONGELADOS", "PÃES ESPECIAIS", "SALGADOS", "PÃO DE QUEIJO", "PÃES PRE ASSADOS"];

            for (const s of knownSectors) {
                if (filename.toUpperCase().includes(s)) { sectorName = s; break; }
            }

            if (sectorName === "Geral") {
                for(let i=0; i < Math.min(rows.length, 10); i++) {
                    const rowStr = rows[i] ? rows[i].join(' ').toUpperCase() : '';
                    for (const s of knownSectors) {
                        if (rowStr.includes(s + " INVENTARIO") || rowStr.includes(s)) { sectorName = s; break; }
                    }
                    if (sectorName !== "Geral") break;
                }
            }

            let headerIndex = -1;
            for(let i=0; i<rows.length; i++) {
                if(rows[i] && rows[i].some(cell => cell && typeof cell === 'string' && cell.trim().toUpperCase() === 'CÓD')) {
                    headerIndex = i; break;
                }
            }

            if(headerIndex === -1) {
                showNotification("Cabeçalho 'CÓD' não encontrado.", true);
                return;
            }

            const header = rows[headerIndex].map(h => String(h).trim().toUpperCase());
            const colCod = header.findIndex(h => h === 'CÓD');
            const colProd = header.findIndex(h => h === 'PRODUTO');
            const colTotal = header.findIndex(h => h.includes('TOTAL'));

            const batchColumns = [];
            header.forEach((h, idx) => {
                if ((h.includes('LOTE') || h.includes('VAL')) && !h.includes('TOTAL')) {
                    if (header[idx+1] && header[idx+1].includes('QTD')) {
                        batchColumns.push({ colLote: idx, colQtd: idx+1 });
                    }
                }
            });

            const aggregatedItems = {}; 

            for(let i = headerIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if(!row || !row[colCod] || !row[colProd]) continue;

                const rawCode = row[colCod];
                const code = String(rawCode).trim();
                const name = String(row[colProd]).trim();
                
                if(!code || code === 'undefined' || name === '') continue; 

                let totalQty = 0;
                const productBatches = [];

                batchColumns.forEach(pair => {
                    const loteVal = row[pair.colLote];
                    const qtdVal = parseFloat(row[pair.colQtd]);

                    if (loteVal && qtdVal > 0) {
                        const strVal = String(loteVal).trim();
                        let batchCode = 'S/L';
                        let batchDate = '';

                        const dateRegex = /(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/;
                        const dateMatch = strVal.match(dateRegex);

                        if (dateMatch) {
                            batchDate = dateMatch[0];
                            const remainder = strVal.replace(batchDate, '').replace(/[\-\/]/g, '').trim();
                            if (remainder.length > 0) batchCode = remainder;
                        } else {
                            batchCode = strVal;
                        }

                        productBatches.push({ code: batchCode, date: batchDate, qty: qtdVal });
                        totalQty += qtdVal;
                    }
                });

                if (totalQty === 0 && colTotal !== -1 && row[colTotal]) {
                    totalQty = parseFloat(row[colTotal]) || 0;
                }

                if (aggregatedItems[code]) {
                    aggregatedItems[code].qty += totalQty;
                    aggregatedItems[code]._batches.push(...productBatches);
                } else {
                    aggregatedItems[code] = {
                        name: name,
                        code: code,
                        qty: totalQty,
                        sector: sectorName,
                        uom: 'UND', 
                        lastEntryDate: new Date().toISOString(),
                        _batches: productBatches
                    };
                }
            }

            const newItems = [];
            const updatedItems = [];

            Object.values(aggregatedItems).forEach(itemData => {
                const exists = products.find(p => p.code == itemData.code || p.name === itemData.name);
                if(exists) {
                    updatedItems.push({ ...exists, ...itemData, id: exists.id }); 
                } else {
                    newItems.push(itemData);
                }
            });

            importPreviewData = { newItems, updatedItems, sector: sectorName };
            
            document.getElementById('import-filename').innerText = filename;
            document.getElementById('import-sector').innerText = sectorName;
            document.getElementById('import-count-new').innerText = newItems.length;
            document.getElementById('import-count-update').innerText = updatedItems.length;
            document.getElementById('modal-import-preview').style.display = 'flex';
        }

        window.confirmInventoryImport = async () => {
            try {
                const action = document.querySelector('input[name="import-action"]:checked').value;
                const isFullImport = action === 'full';

                if(!sectors.find(s => s.name === importPreviewData.sector)) {
                    await dbAction('sectors', 'readwrite', s => s.add({ name: importPreviewData.sector }));
                }

                const processItem = async (item, isNew) => {
                    const itemToSave = { ...item };
                    
                    if (!isFullImport) {
                        if (isNew) {
                            itemToSave.qty = 0;
                        } else {
                            const original = products.find(p => p.id === item.id);
                            if (original) itemToSave.qty = original.qty; 
                        }
                    } 
                    
                    const batchList = item._batches || [];
                    delete itemToSave._batches;

                    if (isNew) {
                        const newId = await dbAction('products', 'readwrite', s => s.add(itemToSave));
                        if (isFullImport && batchList.length > 0) {
                            for (let b of batchList) {
                                await dbAction('batches', 'readwrite', s => s.add({ 
                                    productId: newId, 
                                    code: b.code, 
                                    qty: b.qty, 
                                    expDate: b.date 
                                }));
                            }
                        }
                    } else {
                        await dbAction('products', 'readwrite', s => s.put(itemToSave));
                    }
                };

                for(let item of importPreviewData.newItems) await processItem(item, true);
                for(let item of importPreviewData.updatedItems) await processItem(item, false);

                closeModal('modal-import-preview');
                showNotification(isFullImport ? 'Inventário e Estoque Atualizados!' : 'Cadastro Atualizado!');
                loadData();
            } catch (e) {
                console.error(e);
                showNotification('Erro ao importar dados.', true);
            }
        };

        // --- IMPORT LOGIC (STORES) ---
        window.handleStoreFile = (input) => {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1}); 
                processStoreData(rows);
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        function processStoreData(rows) {
            let headerIndex = -1;
            // Search for header row
            for(let i=0; i<rows.length; i++) {
                const rowStr = rows[i].join(' ').toUpperCase();
                // Check for keywords from the user's specific file format (Prioritize FANTASIA/CODIGO)
                if(rowStr.includes('FANTASIA') || rowStr.includes('RAZÃO') || rowStr.includes('RAZAO') || rowStr.includes('CODIGO')) {
                    headerIndex = i;
                    break;
                }
                // Fallback for generic files
                if(rowStr.includes('LOJA') || rowStr.includes('NOME') || rowStr.includes('CLIENTE')) {
                    headerIndex = i;
                    break;
                }
            }

            if(headerIndex === -1) {
                showNotification("Cabeçalho não encontrado. Procure por colunas 'Fantasia', 'Código' ou 'Nome'.", true);
                return;
            }

            const header = rows[headerIndex].map(h => String(h).toUpperCase());
            
            // Column Mapping Priorities
            const colFantasia = header.findIndex(h => h.includes('FANTASIA'));
            const colRazao = header.findIndex(h => h.includes('RAZÃO') || h.includes('RAZAO') || h.includes('SOCIAL'));
            const colNameGeneric = header.findIndex(h => h.includes('NOME') || h.includes('LOJA') || h.includes('CLIENTE'));
            
            const colCode = header.findIndex(h => h.includes('COD') || h.includes('CNPJ') || h.includes('ID'));
            const colCity = header.findIndex(h => h.includes('CIDADE') || h.includes('MUNIC') || h.includes('ENDERE'));

            importStoreData = [];

            for(let i = headerIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if(!row) continue;

                // Name Resolution: Fantasia > Generic Name > Razão Social
                let name = '';
                if (colFantasia !== -1 && row[colFantasia]) {
                    name = String(row[colFantasia]).trim();
                }
                
                // Fallbacks if Fantasia is missing
                if (!name && colNameGeneric !== -1 && row[colNameGeneric]) {
                    name = String(row[colNameGeneric]).trim();
                }
                if (!name && colRazao !== -1 && row[colRazao]) {
                    name = String(row[colRazao]).trim();
                }

                const code = colCode !== -1 && row[colCode] ? String(row[colCode]).trim() : '';
                const city = colCity !== -1 && row[colCity] ? String(row[colCity]).trim() : '';

                if(name) {
                    importStoreData.push({ name, code, city });
                }
            }

            document.getElementById('import-stores-count').innerText = importStoreData.length;
            document.getElementById('modal-import-stores').style.display = 'flex';
        }

        window.confirmStoreImport = async () => {
            try {
                for(let store of importStoreData) {
                    // Check duplicate by name or code
                    const exists = stores.find(s => s.name === store.name || (store.code && s.code === store.code));
                    if(!exists) {
                        await dbAction('stores', 'readwrite', s => s.add(store));
                    }
                }
                closeModal('modal-import-stores');
                showNotification('Lojas importadas com sucesso!');
                loadData();
            } catch(e) {
                console.error(e);
                showNotification('Erro ao importar lojas', true);
            }
        }

        // --- CORE LOGIC ---

        // 1. STORES
        document.getElementById('form-store').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('store-name').value.trim();
            const code = document.getElementById('store-code').value.trim();
            const city = document.getElementById('store-city').value.trim();
            await dbAction('stores', 'readwrite', s => s.add({ name, code, city }));
            e.target.reset();
            loadData();
            showNotification('Loja cadastrada!');
        });

        function updateStoreList() {
            const container = document.getElementById('stores-list');
            container.innerHTML = stores.map(s => `
                <div class="bg-dark-800 p-4 rounded-xl border border-dark-700 flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-white">${s.name}</h4>
                        <p class="text-sm text-gray-500">${s.city || '-'} | ${s.code || '-'}</p>
                    </div>
                    <button onclick="deleteStore(${s.id})" class="text-red-500 hover:bg-dark-700 p-2 rounded"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
            
            const opts = '<option value="">Selecione...</option>' + stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('order-store-select').innerHTML = opts;
        }

        window.deleteStore = async (id) => {
            if(confirm('Excluir loja?')) { await dbAction('stores', 'readwrite', s => s.delete(id)); loadData(); }
        }

        // 2. ENTRY & PRODUCTS
        window.clearEntryForm = () => {
            document.getElementById('entry-name').value = '';
            document.getElementById('entry-code').value = '';
            document.getElementById('entry-sector').value = '';
            document.getElementById('entry-prod-id').value = '';
            document.getElementById('entry-qty').value = '';
            document.getElementById('entry-date').valueAsDate = new Date();
            // Enable UOM select
            const uomSelect = document.getElementById('entry-uom');
            uomSelect.disabled = false;
            uomSelect.value = 'UND';
            document.getElementById('entry-dropdown').classList.add('hidden');
        };

        document.getElementById('entry-name').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const dd = document.getElementById('entry-dropdown');
            dd.innerHTML = ''; dd.classList.add('hidden');
            if(!term) return;
            
            const matches = products.filter(p => p.name.toLowerCase().includes(term) || (p.code && p.code.includes(term)));
            if(matches.length > 0) {
                dd.classList.remove('hidden');
                matches.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'searchable-item text-gray-300 flex justify-between';
                    div.innerHTML = `<span>${p.name}</span><span class="text-xs text-gray-500">${p.code}</span>`;
                    div.onclick = () => {
                        document.getElementById('entry-name').value = p.name;
                        document.getElementById('entry-code').value = p.code;
                        document.getElementById('entry-sector').value = p.sector;
                        document.getElementById('entry-prod-id').value = p.id;
                        
                        // Set and lock UOM for existing products
                        const uomSelect = document.getElementById('entry-uom');
                        if(p.uom) {
                            uomSelect.value = p.uom;
                            uomSelect.disabled = true;
                        } else {
                            uomSelect.disabled = false;
                        }

                        dd.classList.add('hidden');
                    };
                    dd.appendChild(div);
                });
            }
        });

        document.getElementById('form-entry').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('entry-name').value.trim();
            const code = document.getElementById('entry-code').value.trim() || Date.now().toString().slice(-6); 
            const sector = document.getElementById('entry-sector').value;
            const qty = parseFloat(document.getElementById('entry-qty').value);
            const date = document.getElementById('entry-date').value;
            const uom = document.getElementById('entry-uom').value;
            const id = document.getElementById('entry-prod-id').value;

            if(id) {
                // Update existing
                const prod = products.find(p => p.id == id);
                prod.qty = (prod.qty || 0) + qty;
                prod.name = name; prod.sector = sector; 
                prod.code = code; 
                prod.lastEntryDate = date;
                if(!prod.uom) prod.uom = uom; // Set if missing
                await dbAction('products', 'readwrite', s => s.put(prod));
            } else {
                // New product
                await dbAction('products', 'readwrite', s => s.add({ name, code, sector, qty: qty, uom: uom, lastEntryDate: date }));
            }
            e.target.reset();
            clearEntryForm(); // Reset UOM state
            showNotification('Estoque Atualizado!');
            loadData();
        });

        // 3. ORDERS (24h/48h)
        window.showNewOrderModal = () => {
            orderCart = [];
            renderOrderCart();
            document.getElementById('order-delivery-date').valueAsDate = new Date(new Date().setDate(new Date().getDate() + 1)); // Default tomorrow
            document.getElementById('modal-new-order').style.display = 'flex';
        };

        document.getElementById('order-prod-search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const res = document.getElementById('order-prod-results');
            res.innerHTML = ''; res.classList.add('hidden');
            if(!term) return;

            const matches = products.filter(p => p.name.toLowerCase().includes(term));
            if(matches.length) {
                res.classList.remove('hidden');
                matches.forEach(p => {
                    const d = document.createElement('div');
                    d.className = 'p-3 hover:bg-dark-600 cursor-pointer border-b border-dark-600 text-gray-200';
                    d.innerHTML = `${p.name} <span class="float-right text-xs text-emerald-400 font-mono">${p.qty.toFixed(2)} ${p.uom || ''}</span>`;
                    d.onclick = () => {
                        document.getElementById('osp-name').textContent = p.name;
                        document.getElementById('osp-code').textContent = p.code;
                        document.getElementById('osp-stock').textContent = p.qty.toFixed(2);
                        document.getElementById('osp-uom').textContent = p.uom || 'UND';
                        document.getElementById('order-selected-prod').classList.remove('hidden');
                        document.getElementById('order-selected-prod').dataset.id = p.id;
                        document.getElementById('osp-qty').focus();
                        res.classList.add('hidden');
                        document.getElementById('order-prod-search').value = '';
                    };
                    res.appendChild(d);
                });
            }
        });

        window.addItemToOrderCart = () => {
            const container = document.getElementById('order-selected-prod');
            const id = parseInt(container.dataset.id);
            const qty = parseFloat(document.getElementById('osp-qty').value);
            const prod = products.find(p => p.id === id);

            if(!qty || qty <= 0) return showNotification('Qtd inválida', true);
            
            const existing = orderCart.find(i => i.id === id);
            if(existing) existing.qty += qty;
            else orderCart.push({ id, name: prod.name, code: prod.code, qty, uom: prod.uom });

            document.getElementById('osp-qty').value = '';
            container.classList.add('hidden');
            renderOrderCart();
        };

        function renderOrderCart() {
            const tb = document.getElementById('order-cart-list');
            tb.innerHTML = orderCart.map((i, idx) => `
                <tr class="border-b border-dark-700">
                    <td class="p-2 text-white">${i.name}</td>
                    <td class="p-2 text-right font-mono text-emerald-400">${i.qty} <span class="text-xs text-gray-500">${i.uom||''}</span></td>
                    <td class="p-2 text-center"><button onclick="orderCart.splice(${idx},1);renderOrderCart()" class="text-red-500">&times;</button></td>
                </tr>
            `).join('');
            document.getElementById('order-cart-count').textContent = `${orderCart.length} itens`;
        }

        window.finalizeOrderCreation = async () => {
            const storeId = document.getElementById('order-store-select').value;
            const deliveryDate = document.getElementById('order-delivery-date').value;
            
            if(!storeId) return showNotification('Selecione a Loja', true);
            if(!deliveryDate) return showNotification('Selecione Data Entrega', true);
            if(orderCart.length === 0) return showNotification('Carrinho vazio', true);

            const store = stores.find(s => s.id == storeId);
            
            const order = {
                storeId: parseInt(storeId),
                storeName: store.name,
                deliveryDate: deliveryDate,
                status: 'pending',
                date: new Date().toISOString(), // Created At
                items: orderCart
            };

            await dbAction('orders', 'readwrite', s => s.add(order));
            closeModal('modal-new-order');
            showNotification('Pedido Criado!');
            loadData();
        };

        // --- DYNAMIC ORDER TYPE LOGIC ---
        function getOrderType(order) {
            if (!order.deliveryDate) return order.type || '24h'; // Fallback
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // Parse delivery date (YYYY-MM-DD)
            const parts = order.deliveryDate.split('-');
            const delivery = new Date(parts[0], parts[1]-1, parts[2]); // Local Year, Month, Day
            
            const diffMs = delivery - today;
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays <= 1) return '24h'; // Today or Tomorrow
            return '48h'; // 2+ Days
        }

        // Manage Orders
        function updateOrdersList() {
            const div = document.getElementById('orders-container');
            const pending = orders.filter(o => o.status === 'pending').sort((a,b) => new Date(a.deliveryDate || a.date) - new Date(b.deliveryDate || b.date));
            
            if(pending.length === 0) {
                div.innerHTML = '<div class="text-center text-gray-500 py-10">Nenhum pedido pendente.</div>';
                return;
            }

            div.innerHTML = pending.map(o => {
                const totalItems = o.items.reduce((a,b)=>a+b.qty,0);
                const type = getOrderType(o);
                const badgeColor = type === '24h' ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30' : 'bg-blue-500/20 text-blue-400 border-blue-500/30';
                
                const displayDate = o.deliveryDate ? new Date(o.deliveryDate + 'T00:00:00').toLocaleDateString() : 'Sem Data';

                return `
                <div class="bg-dark-800 rounded-2xl shadow-lg border border-dark-700 p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="border ${badgeColor} px-3 py-1 rounded-lg text-xs font-bold uppercase">${type}</span>
                            <span class="text-gray-500 text-xs"><i class="fa-regular fa-clock"></i> Entrega: ${displayDate}</span>
                        </div>
                        <h3 class="text-xl font-bold text-white">${o.storeName}</h3>
                        <p class="text-gray-400 text-sm mt-1">${totalItems} unidades em ${o.items.length} produtos</p>
                    </div>
                    
                    <div class="flex gap-3">
                         <button onclick="deleteOrder(${o.id})" class="px-4 py-2 text-red-400 hover:bg-red-500/10 rounded-xl transition">Cancelar</button>
                        <button onclick="shipOrder(${o.id})" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-xl shadow-lg font-bold flex items-center gap-2">
                            <i class="fa-solid fa-truck-ramp-box"></i> Expedir
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        window.deleteOrder = async (id) => {
            if(confirm('Cancelar este pedido?')) { await dbAction('orders', 'readwrite', s => s.delete(id)); loadData(); }
        }

        window.shipOrder = async (orderId) => {
            if(!confirm('Confirmar expedição? O estoque será baixado.')) return;
            try {
                // Fetch fresh order
                const order = await dbAction('orders', 'readonly', s => s.get(orderId));
                if(!order) throw new Error('Pedido não encontrado');
                if(order.status === 'shipped') throw new Error('Já expedido');

                for(let item of order.items) {
                    // Fetch fresh product
                    const product = await dbAction('products', 'readonly', s => s.get(item.id));
                    if(product) {
                        // Ensure numerical operation
                        const currentQty = Number(product.qty) || 0;
                        const qtyToDeduct = Number(item.qty) || 0;
                        
                        product.qty = currentQty - qtyToDeduct;
                        
                        // Update product
                        await dbAction('products', 'readwrite', s => s.put(product));
                    }
                }
                
                // Update Order Status
                order.status = 'shipped';
                order.shippedDate = new Date().toISOString();
                await dbAction('orders', 'readwrite', s => s.put(order));
                
                showNotification('Expedido com sucesso!');
                loadData();
            } catch(e) {
                console.error(e);
                showNotification('Erro ao expedir: ' + e.message, true);
            }
        };

        // 4. INVENTORY & DASHBOARD
        function getDemandInfo(prodId) {
            let totalDemand = 0;
            let earliestDeadline = null;

            orders.filter(o => o.status === 'pending').forEach(order => {
                const item = order.items.find(i => i.id === prodId);
                if (item) {
                    totalDemand += item.qty;
                    let deadline;
                    if (order.deliveryDate) {
                        deadline = new Date(order.deliveryDate + 'T23:59:59');
                    } else {
                        // Fallback legacy
                        const orderDate = new Date(order.date);
                        const hoursToAdd = order.type === '24h' ? 24 : 48;
                        deadline = new Date(orderDate.getTime() + hoursToAdd * 60 * 60 * 1000);
                    }
                    
                    if (!earliestDeadline || deadline < earliestDeadline) {
                        earliestDeadline = deadline;
                    }
                }
            });
            return { totalDemand, earliestDeadline };
        }

        function updateInventoryTable() {
            const tbody = document.getElementById('inventory-list');
            const search = document.getElementById('inv-search').value.toLowerCase();
            const onlyShortage = document.getElementById('inv-check-shortage').checked;
            
            tbody.innerHTML = '';

            let filtered = products.filter(p => p.name.toLowerCase().includes(search) || (p.code && p.code.includes(search)));

            filtered.forEach(p => {
                const { totalDemand } = getDemandInfo(p.id);
                const balance = (p.qty || 0) - totalDemand;
                const isShortage = balance < 0;
                const uom = p.uom || 'UND';
                const lastEntry = p.lastEntryDate ? new Date(p.lastEntryDate).toLocaleDateString() : '-';

                if(onlyShortage && !isShortage) return;

                const tr = document.createElement('tr');
                tr.className = 'border-b border-dark-700 hover:bg-dark-700/50';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-mono text-gray-500">${p.code || '-'}</td>
                    <td class="px-6 py-4 font-medium text-white">${p.name} <span class="text-xs text-gray-500 ml-1">(${uom})</span></td>
                    <td class="px-6 py-4 text-gray-400 text-xs">${p.sector || '-'}</td>
                    <td class="px-6 py-4 text-gray-400 text-xs">${lastEntry}</td>
                    <td class="px-6 py-4 text-right text-gray-300">${(p.qty||0).toFixed(2)}</td>
                    <td class="px-6 py-4 text-right text-blue-400 font-bold">${totalDemand > 0 ? totalDemand.toFixed(2) : '-'}</td>
                    <td class="px-6 py-4 text-right font-bold ${isShortage ? 'text-red-500' : 'text-emerald-500'}">${balance.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="editProduct(${p.id})" class="text-gray-400 hover:text-white p-2" title="Editar Detalhes"><i class="fa-solid fa-pen"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        document.getElementById('inv-search').addEventListener('input', updateInventoryTable);
        document.getElementById('inv-check-shortage').addEventListener('change', updateInventoryTable);

        // --- NEW EDIT FEATURE (Menu Completo) ---
        window.editProduct = async (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;

            document.getElementById('edit-prod-id').value = p.id;
            document.getElementById('edit-prod-name').value = p.name;
            document.getElementById('edit-prod-code').value = p.code;
            document.getElementById('edit-prod-qty').value = p.qty;
            document.getElementById('edit-prod-date').value = p.lastEntryDate || '';
            document.getElementById('edit-prod-uom').value = p.uom || 'UND';
            
            // Populate Sectors
            const secSelect = document.getElementById('edit-prod-sector');
            secSelect.innerHTML = '<option value="">Selecione...</option>' + sectors.map(s => `<option value="${s.name}" ${s.name===p.sector?'selected':''}>${s.name}</option>`).join('');

            document.getElementById('modal-edit-product').style.display = 'flex';
        }

        window.saveProductEdit = async () => {
            const id = parseInt(document.getElementById('edit-prod-id').value);
            const p = products.find(x => x.id === id);
            
            p.name = document.getElementById('edit-prod-name').value;
            p.code = document.getElementById('edit-prod-code').value;
            p.sector = document.getElementById('edit-prod-sector').value;
            p.qty = parseFloat(document.getElementById('edit-prod-qty').value);
            p.uom = document.getElementById('edit-prod-uom').value;
            p.lastEntryDate = document.getElementById('edit-prod-date').value;

            await dbAction('products', 'readwrite', s => s.put(p));
            closeModal('modal-edit-product');
            loadData();
            showNotification('Produto Atualizado!');
        }

        function getRelativeTime(deadline) {
            if(!deadline) return '-';
            const now = new Date();
            const diffMs = deadline - now;
            const diffHrs = Math.ceil(diffMs / (1000 * 60 * 60));
            
            if (diffMs < 0) return `<span class="text-red-500 font-bold">ATRASADO (${Math.abs(diffHrs)}h)</span>`;
            if (diffHrs <= 12) return `<span class="text-orange-400 font-bold">${diffHrs}h restantes</span>`;
            return `<span class="text-gray-400">${diffHrs}h restantes</span>`;
        }

        // --- NEW SHORTAGE MODAL ---
        window.openShortageModal = () => {
            const shortageItems = [];
            products.forEach(p => {
                const { totalDemand, earliestDeadline } = getDemandInfo(p.id);
                const balance = (p.qty || 0) - totalDemand;
                if(balance < 0) {
                    shortageItems.push({ 
                        name: p.name, 
                        sector: p.sector || '-',
                        balance, 
                        deadlineText: getRelativeTime(earliestDeadline),
                        deadlineRaw: earliestDeadline
                    });
                }
            });
            
            // Sort by urgency
            shortageItems.sort((a,b) => (a.deadlineRaw || new Date(9999,11,31)) - (b.deadlineRaw || new Date(9999,11,31)));

            const tb = document.getElementById('modal-shortage-list');
            tb.innerHTML = shortageItems.length 
                ? shortageItems.map(i => `
                    <tr class="border-b border-dark-700 hover:bg-dark-700/50">
                        <td class="px-6 py-4 text-white font-medium">${i.name}</td>
                        <td class="px-6 py-4 text-gray-400 text-xs">${i.sector}</td>
                        <td class="px-6 py-4 text-right text-red-500 font-bold">${i.balance.toFixed(2)}</td>
                        <td class="px-6 py-4 text-right text-xs">${i.deadlineText}</td>
                    </tr>`).join('')
                : '<tr><td colspan="4" class="p-6 text-center text-gray-500">Nenhum produto em falta!</td></tr>';

            document.getElementById('modal-shortage').style.display = 'flex';
        };

        function updateDashboard() {
            const pendingOrders = orders.filter(o => o.status === 'pending');
            
            // Pedidos Counts (Dynamic)
            let count24 = 0;
            let count48 = 0;

            pendingOrders.forEach(o => {
                const type = getOrderType(o);
                if (type === '24h') count24++;
                else count48++;
            });
            
            document.getElementById('dash-vol-24h').innerText = count24;
            document.getElementById('dash-vol-48h').innerText = count48;

            // Shortage Calc
            let shortageCount = 0;
            const shortageItems = [];

            products.forEach(p => {
                const { totalDemand, earliestDeadline } = getDemandInfo(p.id);
                const balance = (p.qty || 0) - totalDemand;
                if(balance < 0) {
                    shortageCount++;
                    shortageItems.push({ 
                        name: p.name, 
                        balance, 
                        uom: p.uom || 'UND',
                        deadline: earliestDeadline,
                        deadlineText: getRelativeTime(earliestDeadline)
                    });
                }
            });

            document.getElementById('dash-shortage').innerText = shortageCount;

            const tOrders = document.getElementById('dash-table-orders');
            tOrders.innerHTML = pendingOrders.slice(0, 5).map(o => `
                <tr class="border-b border-dark-700">
                    <td class="px-4 py-2 text-white">${o.storeName}</td>
                    <td class="px-4 py-2 text-center"><span class="text-xs px-2 py-0.5 rounded ${getOrderType(o)=='24h'?'bg-emerald-900 text-emerald-400':'bg-blue-900 text-blue-400'}">${o.deliveryDate ? o.deliveryDate.split('-').reverse().join('/') : '-'}</span></td>
                    <td class="px-4 py-2 text-right text-gray-300 font-bold">${o.items.reduce((a,b)=>a+b.qty,0)}</td>
                </tr>
            `).join('');

            const tShort = document.getElementById('dash-table-shortage');
            shortageItems.sort((a,b) => (a.deadline || new Date(9999,11,31)) - (b.deadline || new Date(9999,11,31)));

            tShort.innerHTML = shortageItems.slice(0, 5).map(i => `
                <tr class="border-b border-dark-700">
                    <td class="px-4 py-2 text-white text-xs">${i.name} <span class="text-gray-500">(${i.uom})</span></td>
                    <td class="px-4 py-2 text-right text-red-500 font-bold">${i.balance.toFixed(2)}</td>
                    <td class="px-4 py-2 text-right text-xs">${i.deadlineText}</td>
                </tr>
            `).join('');
        }

        // --- SECTORS & SETTINGS ---
        document.getElementById('form-sector').addEventListener('submit', async(e)=>{ 
            e.preventDefault(); 
            const n = document.getElementById('new-sector-name').value.toUpperCase(); 
            await dbAction('sectors','readwrite',s=>s.add({name:n})); 
            loadData(); 
            e.target.reset(); 
            showNotification('Setor Adicionado');
        });

        function updateSectorSelects(){ 
            const opts = '<option value="">Selecione...</option>' + sectors.map(s => `<option value="${s.name}">${s.name}</option>`).join(''); 
            document.getElementById('entry-sector').innerHTML = opts; 
            document.getElementById('edit-prod-sector').innerHTML = opts;
        }

        function renderSectorList() {
            const list = document.getElementById('settings-sectors-list');
            list.innerHTML = sectors.map(s => `
                <li class="flex justify-between items-center p-3 text-sm hover:bg-dark-800 transition">
                    <span class="text-gray-300 font-medium">${s.name}</span>
                    <button onclick="deleteSector(${s.id})" class="text-gray-500 hover:text-red-500 transition px-2">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </li>
            `).join('');
        }

        window.deleteSector = async (id) => {
            if(confirm('Excluir este setor?')) {
                await dbAction('sectors', 'readwrite', s => s.delete(id));
                loadData();
            }
        }

        // --- BACKUP & RESTORE ---
        window.backupData = async () => {
            const data = {
                products,
                stores,
                orders,
                sectors,
                version: DB_VERSION,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_expedicao_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Backup baixado!');
        };

        window.restoreData = (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!confirm(`Restaurar backup de ${new Date(data.timestamp).toLocaleString()}? Isso substituirá todos os dados atuais.`)) {
                        input.value = ''; // Reset input
                        return;
                    }

                    await Promise.all(['products', 'stores', 'orders', 'sectors'].map(name => 
                        dbAction(name, 'readwrite', s => s.clear())
                    ));

                    if (data.products) for (let i of data.products) await dbAction('products', 'readwrite', s => s.add(i));
                    if (data.stores) for (let i of data.stores) await dbAction('stores', 'readwrite', s => s.add(i));
                    if (data.orders) for (let i of data.orders) await dbAction('orders', 'readwrite', s => s.add(i));
                    if (data.sectors) for (let i of data.sectors) await dbAction('sectors', 'readwrite', s => s.add(i));

                    showNotification('Dados restaurados com sucesso!');
                    loadData();
                } catch (error) {
                    console.error(error);
                    showNotification('Erro ao restaurar arquivo.', true);
                }
                input.value = ''; 
            };
            reader.readAsText(file);
        };

        window.clearDatabase = async() => { 
            if(confirm('ATENÇÃO: Isso apagará TODOS os dados. Continuar?')) { 
                await Promise.all(['products','stores','orders','sectors'].map(n=>dbAction(n,'readwrite',s=>s.clear()))); 
                loadData(); 
                showNotification('Banco de dados limpo', true);
            } 
        }
        
        // EXPORTS
         window.exportInventory = () => {
            const data = products.map(p => {
                const { totalDemand } = getDemandInfo(p.id);
                return {
                    "Código": p.code,
                    "Produto": p.name,
                    "Setor": p.sector,
                    "Ultima Entrada": p.lastEntryDate ? new Date(p.lastEntryDate).toLocaleDateString() : '-',
                    "Unidade": p.uom || 'UND',
                    "Estoque Físico": p.qty || 0,
                    "Reservado (Pedidos)": totalDemand,
                    "Saldo": (p.qty || 0) - totalDemand,
                    "Status": ((p.qty||0) - totalDemand < 0) ? "RUPTURA" : "OK"
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Estoque");
            XLSX.writeFile(wb, "Relatorio_Estoque_Ruptura.xlsx");
        }

        window.exportOrders = () => {
            const data = [];
            orders.forEach(o => {
                o.items.forEach(i => {
                    data.push({
                        "ID Pedido": o.id,
                        "Data": new Date(o.date).toLocaleDateString(),
                        "Loja": o.storeName,
                        "Tipo": o.type,
                        "Status": o.status,
                        "Produto": i.name,
                        "Qtd": i.qty,
                        "Unidade": i.uom || 'UND'
                    });
                });
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
            XLSX.writeFile(wb, "Relatorio_Pedidos.xlsx");
        }

        initDB().then(loadData);
    </script>
</body>
</html>
