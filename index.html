<!DOCTYPE html>
<html lang="pt-BR" class="dark" style="color-scheme: dark;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Controle de Estoque e Produ칞칚o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                    colors: {
                        ios: {
                            bg: '#000000', card: '#1c1c1e', cardHover: '#2c2c2e', blue: '#0a84ff',
                            green: '#30d158', red: '#ff453a', orange: '#ff9f0a', text: '#ffffff',
                            textMuted: 'rgba(235, 235, 245, 0.6)', border: '#38383a', input: '#2c2c2e'
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer components {
            body { @apply bg-ios-bg text-ios-text font-sans antialiased; }
            .card { @apply bg-ios-card p-4 sm:p-6 rounded-2xl shadow-sm border border-ios-border; }
            .title-lg { @apply text-2xl sm:text-3xl font-bold text-white mb-4 sm:mb-6 tracking-tight; }
            .title-md { @apply text-lg sm:text-xl font-semibold text-white mb-3 sm:mb-4 tracking-tight; }
            .form-label { @apply block text-sm font-medium text-ios-textMuted mb-1; }
            .form-input { @apply block w-full bg-ios-input text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-ios-blue transition-all border border-ios-border/50; }
            .btn-primary { @apply bg-ios-blue hover:opacity-90 text-white font-semibold py-3 px-5 rounded-xl transition-all flex items-center justify-center; }
            .btn-secondary { @apply bg-ios-cardHover hover:bg-gray-700 text-white font-semibold py-3 px-5 rounded-xl transition-all border border-ios-border flex items-center justify-center; }
            .btn-danger { @apply bg-ios-red hover:opacity-90 text-white font-semibold py-3 px-5 rounded-xl transition-all flex items-center justify-center; }
            .btn-success { @apply bg-ios-green hover:opacity-90 text-white font-semibold py-3 px-5 rounded-xl transition-all flex items-center justify-center; }
            .table-container { @apply overflow-x-auto rounded-xl border border-ios-border bg-ios-card w-full; }
            .base-table { @apply min-w-full w-full text-sm text-left text-ios-textMuted; }
            .base-thead { @apply text-xs uppercase bg-ios-cardHover text-gray-400 border-b border-ios-border; }
            .base-tr { @apply border-b border-ios-border hover:bg-ios-cardHover transition-colors; }
            .base-th { @apply px-4 sm:px-5 py-3 sm:py-4 font-semibold whitespace-nowrap; }
            .base-td { @apply px-4 sm:px-5 py-3 sm:py-4 whitespace-nowrap sm:whitespace-normal; }
            .stat-icon { @apply p-3 rounded-xl flex items-center justify-center w-12 h-12 text-xl; }
            .modal-content { @apply bg-ios-card border border-ios-border rounded-3xl shadow-2xl p-4 sm:p-6 w-full transform transition-all max-h-[90vh] overflow-y-auto; }
            .badge { @apply text-xs font-semibold px-2 py-1 rounded-md; }
            
            /* Home Grid Menu Button */
            .menu-window { @apply flex flex-col items-center justify-center p-4 sm:p-8 bg-ios-card border border-ios-border rounded-3xl shadow-lg hover:bg-ios-cardHover active:scale-95 sm:hover:scale-105 transition-all duration-300 cursor-pointer text-center; }
            .menu-window i { @apply text-3xl sm:text-5xl mb-2 sm:mb-4 text-ios-blue drop-shadow-md; }
            .menu-window span { @apply font-bold text-white text-xs sm:text-lg tracking-wide leading-tight; }
        }
    </style>
    <style>
        .sidebar { transition: width 0.3s ease-in-out; }
        .modal { display: none; position: fixed; z-index: 50; inset: 0; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); padding: 1rem; }
        .table-header-sortable { cursor: pointer; user-select: none; }
        .table-header-sortable:hover { color: #ffffff; }
        
        .searchable-container { position: relative; width: 100%; }
        .searchable-dropdown { 
            position: absolute; top: 100%; left: 0; right: 0; z-index: 9999; max-height: 280px; 
            overflow-y: auto; background-color: #2c2c2e; border: 1px solid #38383a; 
            border-radius: 0.75rem; box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-top: 4px;
        }
        .searchable-item { padding: 0.85rem 1rem; cursor: pointer; color: #ffffff; border-bottom: 1px solid #38383a; transition: background-color 0.2s; }
        .searchable-item:last-child { border-bottom: none; }
        .searchable-item:hover { background-color: #0a84ff; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #48484a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #636366; }

        .toggle-status { appearance: none; width: 40px; height: 20px; background: #38383a; border-radius: 20px; position: relative; cursor: pointer; outline: none; transition: background 0.3s; }
        .toggle-status::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-status:checked { background: #30d158; }
        .toggle-status:checked::after { transform: translateX(20px); }
        
        #reader video { border-radius: 0.75rem; object-fit: cover; }
    </style>
</head>
<body class="bg-ios-bg text-ios-text font-sans antialiased flex h-screen overflow-hidden w-full relative">

    <div id="loading-overlay" class="fixed inset-0 z-[99999] hidden flex-col items-center justify-center bg-black bg-opacity-80 backdrop-blur-md transition-opacity">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-ios-cardHover border-t-ios-blue mb-4"></div>
        <p class="text-ios-textMuted font-medium" id="loading-text">Processando...</p>
    </div>

    <div id="notification-modal" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[999999] hidden py-3 px-6 rounded-full shadow-2xl font-semibold text-white transition-all text-sm backdrop-blur-md text-center max-w-sm"></div>

    <!-- Tela de Login -->
    <div id="login-wrapper" class="absolute inset-0 z-[999] flex flex-col items-center justify-center bg-ios-bg text-center px-4 hidden">
        <div class="card max-w-md w-full py-10 px-6 border border-ios-border/50 shadow-2xl">
            <div class="w-20 h-20 rounded-2xl bg-ios-blue flex items-center justify-center text-white font-bold text-4xl shadow-lg shadow-ios-blue/30 mx-auto mb-6"><i class="fa-solid fa-layer-group"></i></div>
            <h2 class="title-lg mb-2 text-white">Acesso Restrito</h2>
            <p class="text-ios-textMuted mb-8 text-sm">Fa칞a login com sua conta Google para sincronizar com o banco de dados da f치brica (Firebase).</p>
            <button type="button" id="btn-login-google" class="btn-primary w-full py-4 text-lg font-bold"><i class="fa-brands fa-google mr-2"></i>Entrar com o Google</button>
            <button type="button" id="btn-bypass-login" class="btn-secondary w-full py-3 mt-4 text-sm"><i class="fa-solid fa-flask mr-2"></i>Testar sem Login (Visualiza칞칚o)</button>
            <div id="mensagem-erro" class="text-ios-red mt-4 font-medium text-sm text-left bg-ios-red/10 p-3 rounded-lg hidden"></div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="app-wrapper" class="flex flex-col md:flex-row h-screen overflow-hidden w-full hidden">
        
        <!-- HEADER MOBILE (Vis칤vel apenas em telas pequenas) -->
        <header class="md:hidden flex items-center justify-between p-4 bg-ios-bg border-b border-ios-border z-40 shrink-0">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-xl bg-ios-blue flex items-center justify-center text-white font-bold text-sm shadow-lg shadow-ios-blue/30"><i class="fa-solid fa-layer-group"></i></div>
                <span class="font-bold text-lg text-white tracking-tight">Estoque OS</span>
            </div>
            <button type="button" id="btn-sair-mobile" class="text-ios-red hover:text-red-400 p-2 shrink-0 bg-ios-red/10 rounded-lg transition-colors"><i class="fa-solid fa-right-from-bracket"></i></button>
        </header>

        <!-- Sidebar Menu (Desktop) -->
        <aside class="hidden md:flex w-20 lg:w-64 bg-[#000000] border-r border-ios-border flex-col py-6 transition-all duration-300 z-40 shrink-0">
            <div class="px-4 mb-8 flex items-center justify-center lg:justify-start cursor-pointer" onclick="navTo('home')">
                <div class="w-10 h-10 rounded-xl bg-ios-blue flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-ios-blue/30"><i class="fa-solid fa-layer-group"></i></div>
                <span class="ml-3 font-bold text-xl text-white hidden lg:block tracking-tight">Estoque OS</span>
            </div>
            <nav class="flex-1 w-full px-3 space-y-2 overflow-y-auto">
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-white bg-ios-card transition-all" data-target="home"><i class="fa-solid fa-house w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">In칤cio</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="consulta"><i class="fa-solid fa-magnifying-glass w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Consulta R치pida</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="inventory"><i class="fa-solid fa-boxes-stacked w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Estoque Geral</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="barcodes"><i class="fa-solid fa-barcode w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">C칩d. Barras</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="locations"><i class="fa-solid fa-map-location-dot w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Endere칞amento</span></a>
                
                <div class="border-t border-ios-border my-2 mx-2"></div>
                
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all relative" data-target="picking">
                    <i class="fa-solid fa-dolly w-6 text-center text-lg text-ios-orange"></i>
                    <span class="ml-3 hidden lg:block font-medium text-ios-orange">Separa칞칚o (Picking)</span>
                    <span id="badge-nav-picking" class="absolute top-3 right-3 w-2.5 h-2.5 bg-ios-orange rounded-full animate-pulse hidden"></span>
                </a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all relative" data-target="production">
                    <i class="fa-solid fa-hammer w-6 text-center text-lg"></i>
                    <span class="ml-3 hidden lg:block font-medium">Produ칞칚o (OP)</span>
                    <span id="badge-nav-prod" class="absolute top-3 right-3 w-2.5 h-2.5 bg-ios-blue rounded-full animate-pulse hidden"></span>
                </a>
                
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="purchasing">
                    <i class="fa-solid fa-cart-shopping w-6 text-center text-lg" style="color:#32ade6;"></i>
                    <span class="ml-3 hidden lg:block font-medium">Compras/Pedidos</span>
                </a>

                <div class="border-t border-ios-border my-2 mx-2"></div>
                
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="settings"><i class="fa-solid fa-database w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Banco de Dados</span></a>
            </nav>
            <div class="mt-auto w-full px-3 pt-4 border-t border-ios-border">
                <button type="button" id="btn-show-alerts" class="p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all relative text-left">
                    <i class="fa-solid fa-bell w-6 text-center text-lg text-ios-red"></i>
                    <span class="ml-3 hidden lg:block font-medium">Alertas</span>
                    <span id="badge-nav-alerts" class="absolute top-3 right-3 bg-ios-red text-white text-[10px] px-2 py-0.5 rounded-full hidden font-bold shadow-sm shadow-ios-red/50">0</span>
                </button>
                <div class="flex items-center justify-between mt-4 px-2 py-3 bg-ios-card rounded-xl border border-ios-border/50">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-ios-blue/20 text-ios-blue flex items-center justify-center shrink-0"><i class="fa-solid fa-user text-xs"></i></div>
                        <span id="nome-usuario" class="text-xs text-white font-bold truncate">...</span>
                    </div>
                    <button type="button" id="btn-sair" class="text-ios-red hover:text-red-400 p-2 shrink-0 bg-ios-red/10 rounded-lg transition-colors" title="Sair do Sistema"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </aside>

        <!-- Conte칰do Principal -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-10 pb-24 md:pb-6 relative w-full h-full">
            
            <!-- Home / Janelas de Menu -->
            <div id="screen-home" class="screen-panel w-full max-w-6xl mx-auto">
                <h1 class="title-lg mb-6 sm:mb-8 text-center text-white text-3xl sm:text-4xl tracking-tight hidden md:block">Menu Principal</h1>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-6 mb-8 sm:mb-10">
                    <button type="button" class="menu-window nav-btn" data-target="consulta">
                        <i class="fa-solid fa-magnifying-glass" style="color:#32ade6;"></i><span>Consulta R치pida</span>
                    </button>
                    <button type="button" class="menu-window nav-btn" data-target="entry">
                        <i class="fa-solid fa-box-open"></i><span>Entrada (Massa)</span>
                    </button>
                    <button type="button" class="menu-window nav-btn" data-target="inventory">
                        <i class="fa-solid fa-boxes-stacked" style="color:#30d158;"></i><span>Estoque Atual</span>
                    </button>
                    <button type="button" class="menu-window nav-btn" data-target="locations">
                        <i class="fa-solid fa-map-location-dot" style="color:#5e5ce6;"></i><span>Endere칞amento</span>
                    </button>
                    
                    <button type="button" class="menu-window nav-btn" data-target="barcodes">
                        <i class="fa-solid fa-barcode" style="color:#bf5af2;"></i><span>C칩d. Barras</span>
                    </button>
                    <button type="button" class="menu-window nav-btn" data-target="purchasing">
                        <i class="fa-solid fa-cart-shopping" style="color:#32ade6;"></i><span>Compras</span>
                    </button>
                    <button type="button" class="menu-window nav-btn" data-target="recipes">
                        <i class="fa-solid fa-book-bookmark" style="color:#ff375f;"></i><span>Fichas T칠cnicas</span>
                    </button>
                    <button type="button" class="menu-window nav-btn relative" data-target="picking">
                        <i class="fa-solid fa-dolly text-ios-orange"></i><span class="text-ios-orange">Separa칞칚o</span>
                    </button>

                    <button type="button" class="menu-window nav-btn" data-target="production">
                        <i class="fa-solid fa-hammer" style="color:#ff9f0a;"></i><span>Ordens Prod.</span>
                    </button>
                    <button type="button" class="menu-window nav-btn" data-target="requisitions">
                        <i class="fa-solid fa-arrow-right-from-bracket" style="color:#ff453a;"></i><span>Baixa Avulsa</span>
                    </button>
                    <button type="button" class="menu-window nav-btn" data-target="adjustments">
                        <i class="fa-solid fa-sliders" style="color:#64d2ff;"></i><span>Ajuste Lotes</span>
                    </button>
                    <button type="button" class="menu-window nav-btn" data-target="settings">
                        <i class="fa-solid fa-database" style="color:#98989d;"></i><span>Banco Dados</span>
                    </button>
                </div>

                <!-- Recebimentos do Dia -->
                <div class="border-t border-ios-border pt-6 sm:pt-8 mb-6">
                    <h2 class="title-md mb-4 text-ios-blue"><i class="fa-solid fa-truck-ramp-box mr-2"></i>游닍 Entregas Previstas Hoje</h2>
                    <div id="home-incoming-orders" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="text-center pb-8 border-t border-ios-border/50 pt-8 mt-4">
                    <p class="text-xs text-ios-textMuted italic max-w-lg mx-auto">"N칚o se gerencia o que n칚o se mede, n칚o se mede o que n칚o se define, n칚o se define o que n칚o se entende e n칚o h치 sucesso no que n칚o se gerencia."</p>
                </div>
            </div>

            <!-- Consulta R치pida (Universal) -->
            <div id="screen-consulta" class="screen-panel hidden max-w-4xl mx-auto">
                <h1 class="title-lg">Consulta R치pida</h1>
                <div class="card mb-6">
                    <p class="text-sm text-ios-textMuted mb-4">Leia um c칩digo de barras, c칩digo interno do produto ou c칩digo de um endere칞o para ver o saldo e localiza칞칚o.</p>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <div class="flex gap-2 w-full">
                            <input type="text" id="consulta-input" class="form-input flex-1 font-mono text-lg" placeholder="Bipar c칩digo..." autocomplete="off">
                            <button type="button" id="btn-consulta-scan" class="bg-ios-blue text-white p-3 sm:p-4 rounded-xl hover:bg-blue-600 transition shadow-lg shrink-0"><i class="fa-solid fa-camera text-xl sm:text-2xl"></i></button>
                        </div>
                        <button type="button" id="btn-consulta-search" class="btn-secondary w-full sm:w-auto px-8 mt-2 sm:mt-0">Consultar</button>
                    </div>
                </div>
                <div id="consulta-results" class="space-y-6">
                    <div class="card flex flex-col items-center justify-center py-16 sm:py-20 text-center border-dashed">
                        <i class="fa-solid fa-magnifying-glass text-5xl sm:text-6xl text-ios-cardHover mb-4"></i>
                        <p class="text-ios-textMuted text-sm sm:text-base">Aguardando leitura...</p>
                    </div>
                </div>
            </div>

            <!-- C칩digos de Barras -->
            <div id="screen-barcodes" class="screen-panel hidden max-w-4xl mx-auto">
                <h1 class="title-lg">Cadastro de C칩digo de Barras</h1>
                <div class="card mb-8">
                    <p class="text-sm text-ios-textMuted mb-6">Vincule os c칩digos de barras das embalagens f칤sicas aos produtos internos. Um mesmo produto pode ter v치rios EANs similares.</p>
                    <form id="barcode-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative">
                            <div class="z-50">
                                <label class="form-label">Produto do Sistema</label>
                                <div id="barcode-searchable-container" class="searchable-container"></div>
                            </div>
                            <div class="z-40">
                                <label class="form-label">C칩digo de Barras (Novo)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="barcode-input" required class="form-input font-mono" placeholder="Digite ou leia o c칩digo...">
                                    <button type="button" id="btn-scan-barcode" class="bg-ios-blue text-white p-3 rounded-xl hover:bg-blue-600 transition shrink-0"><i class="fa-solid fa-camera text-xl"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="btn-primary px-8 w-full md:w-auto"><i class="fa-solid fa-link mr-2"></i>Vincular C칩digo</button>
                        </div>
                    </form>
                </div>
                
                <h2 class="title-md mt-10 mb-4">Produtos Mapeados</h2>
                <div class="table-container">
                    <table class="base-table">
                        <thead class="base-thead"><tr><th class="base-th">Produto</th><th class="base-th">C칩d Interno</th><th class="base-th">C칩digos de Barras (EANs)</th><th class="base-th text-center">Gest칚o</th></tr></thead>
                        <tbody id="barcodes-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Compras / Pedidos -->
            <div id="screen-purchasing" class="screen-panel hidden">
                <h1 class="title-lg mb-0 text-ios-blue"><i class="fa-solid fa-cart-shopping mr-3"></i>Compras</h1>
                <p class="text-ios-textMuted text-sm mb-6 mt-1 hidden sm:block">Acompanhe a dura칞칚o do estoque visualmente, baseando-se no tanque de reserva (estoque m칤nimo) e no prazo de entrega do fornecedor.</p>
                <div class="mb-6 flex gap-4 mt-4 sm:mt-0">
                    <input type="text" id="search-purchasing" class="form-input w-full md:w-1/2" placeholder="Buscar fornecedor ou item..." autocomplete="off">
                </div>
                <div id="purchasing-container" class="space-y-6 sm:space-y-8"></div>
            </div>

            <!-- Endere칞amento (Locations) -->
            <div id="screen-locations" class="screen-panel hidden max-w-5xl mx-auto">
                <h1 class="title-lg">Endere칞amento</h1>
                <div class="flex flex-col md:flex-row gap-6 mb-8">
                    <div class="w-full md:w-1/3 card self-start">
                        <h2 class="title-md mb-4 text-lg">Buscar Local</h2>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="location-search-input" class="form-input font-mono" placeholder="C칩d: RUA-A-01">
                            <button type="button" id="btn-scan-location" class="bg-ios-blue text-white p-3 rounded-xl hover:bg-blue-600 shrink-0"><i class="fa-solid fa-camera"></i></button>
                        </div>
                        <button type="button" id="btn-search-location" class="btn-secondary w-full">Pesquisar / Abrir</button>
                    </div>
                    
                    <div class="w-full md:w-2/3">
                        <div id="location-details-panel" class="card hidden mb-6 border-ios-blue shadow-lg shadow-ios-blue/10">
                            <div class="flex justify-between items-start mb-6 border-b border-ios-border pb-4">
                                <div>
                                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-1" id="loc-detail-name">Nome do Local</h2>
                                    <p class="text-ios-blue font-mono font-bold bg-ios-blue/10 px-2 py-1 rounded inline-block text-sm sm:text-base" id="loc-detail-code">CODIGO</p>
                                </div>
                                <div class="flex gap-2">
                                    <button type="button" id="btn-edit-location" class="text-ios-blue bg-ios-blue/10 p-2 sm:p-3 rounded-xl hover:bg-ios-blue/20 transition-colors" title="Editar Endere칞o"><i class="fa-solid fa-pen"></i></button>
                                    <button type="button" id="btn-delete-location" class="text-ios-red bg-ios-red/10 p-2 sm:p-3 rounded-xl hover:bg-ios-red/20 transition-colors" title="Apagar Endere칞o"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                                <h3 class="text-sm font-semibold text-ios-textMuted uppercase">Lotes Neste Endere칞o</h3>
                                <button type="button" id="btn-add-batch-to-loc" class="text-ios-green bg-ios-green/10 px-4 py-2 rounded-xl font-bold hover:bg-ios-green/20 text-sm transition-colors w-full sm:w-auto"><i class="fa-solid fa-plus mr-1"></i>Alocar Lote Aqui</button>
                            </div>
                            <div class="table-container max-h-64 overflow-y-auto">
                                <table class="base-table">
                                    <thead class="base-thead"><tr><th class="base-th">Produto</th><th class="base-th">Lote</th><th class="base-th">Qtd</th><th class="base-th text-center">Retirar</th></tr></thead>
                                    <tbody id="loc-batches-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Estado Vazio e Forms... -->
                        <div id="location-create-panel" class="card hidden border-ios-orange border-dashed">
                            <h2 class="title-md mb-2 text-ios-orange">Local n칚o cadastrado!</h2>
                            <p class="text-sm text-ios-textMuted mb-6">O c칩digo n칚o existe. Deseja registrar este novo endere칞o?</p>
                            <form id="location-form" class="space-y-4">
                                <div><label class="form-label">C칩digo Lida/Digitado</label><input type="text" id="loc-form-code" required readonly class="form-input bg-ios-bg text-ios-textMuted font-mono"></div>
                                <div><label class="form-label">Nome de Identifica칞칚o (Ex: Prateleira B N칤vel 2)</label><input type="text" id="loc-form-name" required class="form-input"></div>
                                <div class="flex flex-col sm:flex-row justify-end gap-3 mt-4">
                                    <button type="button" id="btn-cancel-loc" class="btn-secondary">Cancelar</button>
                                    <button type="submit" class="btn-primary">Criar Endere칞o</button>
                                </div>
                            </form>
                        </div>
                        
                        <div id="location-empty-state" class="card flex flex-col items-center justify-center py-16 sm:py-20 text-center border-dashed">
                            <i class="fa-solid fa-map-location-dot text-5xl sm:text-6xl text-ios-cardHover mb-4"></i>
                            <p class="text-ios-textMuted text-sm sm:text-base">Busque ou leia o c칩digo de barras de um local para gerenciar o estoque nele.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entrada em Massa -->
            <div id="screen-entry" class="screen-panel hidden">
                <h1 class="title-lg">Entrada (Massa)</h1>
                
                <div class="card mb-6">
                    <h2 class="title-md mb-4 text-base sm:text-lg">Adicionar Item  Lista de Entrada</h2>
                    <form id="entry-form">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-5 items-end">
                            <div class="md:col-span-1 relative z-50">
                                <label class="form-label">Buscar / Bipar Produto</label>
                                <div class="flex gap-2">
                                    <div id="entry-searchable-container" class="searchable-container flex-1"></div>
                                    <button type="button" id="btn-scan-entry-code" class="bg-ios-blue text-white p-3 rounded-xl hover:bg-blue-600 transition shrink-0"><i class="fa-solid fa-camera"></i></button>
                                </div>
                            </div>
                            <div class="md:col-span-1">
                                <label class="form-label">Quantidade</label>
                                <input type="number" name="quantity" required min="0.01" step="0.01" class="form-input text-ios-blue font-bold">
                            </div>
                            <div class="sm:col-span-2 md:col-span-1 mt-2 sm:mt-0">
                                <button type="submit" class="btn-secondary w-full"><i class="fa-solid fa-plus mr-2"></i>Adicionar Lote</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                        <h2 class="title-md mb-0">Lista de Recebimento</h2>
                        <button type="button" id="btn-save-bulk-entry" class="btn-primary shadow-lg shadow-ios-blue/20 w-full sm:w-auto"><i class="fa-solid fa-check-double mr-2"></i>Efetivar Entradas</button>
                    </div>
                    <div class="table-container overflow-visible">
                        <table class="base-table min-w-full">
                            <thead class="base-thead">
                                <tr>
                                    <th class="base-th w-1/4">Produto</th>
                                    <th class="base-th w-24">Qtd</th>
                                    <th class="base-th">Lote (Auto/Manual)</th>
                                    <th class="base-th w-32">Validade</th>
                                    <th class="base-th w-40">Endere칞o (Opcional)</th>
                                    <th class="base-th w-12 text-center"><i class="fa-solid fa-trash"></i></th>
                                </tr>
                            </thead>
                            <tbody id="bulk-entry-list" class="divide-y divide-ios-border">
                                <tr><td colspan="6" class="base-td text-center text-ios-textMuted py-8">Nenhum item na lista. Busque e adicione acima.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Estoque -->
            <div id="screen-inventory" class="screen-panel hidden">
                <h1 class="title-lg">Estoque Atual</h1>
                <div class="card p-0 overflow-hidden border-none bg-transparent">
                    <div class="flex flex-wrap gap-2 sm:gap-3 mb-5 p-1">
                        <input type="text" id="search-inventory" placeholder="Pesquisar itens..." class="form-input w-full md:w-64">
                        <div class="flex gap-2 w-full md:w-auto">
                            <select id="type-filter" class="form-input flex-1 md:w-auto text-sm">
                                <option value="">Tipos</option>
                                <option value="insumo">Insumos</option>
                                <option value="semi_acabado">Semi-acabados</option>
                            </select>
                            <select id="supplier-filter" class="form-input flex-1 md:w-auto text-sm"><option value="">Fornecedores</option></select>
                        </div>
                        <button type="button" id="btn-export-excel" class="btn-secondary w-full md:w-auto md:ml-auto"><i class="fa-solid fa-file-excel mr-2 text-ios-green"></i>Exportar</button>
                    </div>
                    <div class="table-container">
                        <table class="base-table">
                            <thead class="base-thead">
                                <tr>
                                    <th class="base-th table-header-sortable" data-sort="name">Produto <i class="fa-solid fa-sort ml-1 text-ios-textMuted"></i></th>
                                    <th class="base-th hidden sm:table-cell">Tipo</th>
                                    <th class="base-th hidden md:table-cell table-header-sortable" data-sort="supplier">Fornecedor <i class="fa-solid fa-sort ml-1 text-ios-textMuted"></i></th>
                                    <th class="base-th text-right table-header-sortable" data-sort="totalQuantity">Saldo <i class="fa-solid fa-sort ml-1 text-ios-textMuted"></i></th>
                                    <th class="base-th table-header-sortable" data-sort="expiry">Validade <i class="fa-solid fa-sort ml-1 text-ios-textMuted"></i></th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Receitas -->
            <div id="screen-recipes" class="screen-panel hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h1 class="title-lg mb-0 text-2xl sm:text-3xl">Fichas T칠cnicas</h1>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
                        <input type="text" id="search-recipe" placeholder="Buscar..." class="form-input w-full sm:w-64">
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button type="button" id="btn-export-recipe-book" class="btn-secondary flex-1 sm:flex-none"><i class="fa-solid fa-file-pdf text-ios-red sm:mr-2"></i><span class="hidden sm:inline">Livro PDF</span></button>
                            <button type="button" id="btn-new-recipe" class="btn-primary flex-1 sm:flex-none"><i class="fa-solid fa-plus mr-2"></i>Criar</button>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col lg:flex-row gap-6">
                    <div class="w-full lg:w-1/4 card self-start overflow-x-auto lg:overflow-visible">
                        <h2 class="text-sm font-semibold text-ios-textMuted uppercase mb-3">Categorias</h2>
                        <ul id="recipe-categories-list" class="flex lg:flex-col gap-2 space-y-0 lg:space-y-1 w-max lg:w-full"></ul>
                    </div>
                    <div id="recipes-grid" class="w-full lg:w-3/4 grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5 self-start"></div>
                </div>
            </div>

            <!-- Separa칞칚o (Picking) -->
            <div id="screen-picking" class="screen-panel hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="title-lg mb-0 text-ios-orange"><i class="fa-solid fa-dolly mr-3 hidden sm:inline-block"></i>Kitting / Separa칞칚o</h1>
                        <p class="text-ios-textMuted mt-1 text-xs sm:text-sm">Acompanhe o check-list do que j치 foi separado em cada linha.</p>
                    </div>
                </div>
                <div id="picking-lines-container" class="space-y-6"></div>
            </div>

            <!-- Produ칞칚o (OP) -->
            <div id="screen-production" class="screen-panel hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h1 class="title-lg mb-0">Ordens de Produ칞칚o</h1>
                    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                        <button type="button" id="btn-confirm-production" class="btn-success w-full sm:w-auto"><i class="fa-solid fa-check-double mr-2"></i>Efetivar OPs</button>
                        <button type="button" id="btn-new-production-order" class="btn-primary w-full sm:w-auto"><i class="fa-solid fa-plus mr-2"></i>Nova OP</button>
                    </div>
                </div>
                <div class="card mb-5 flex flex-wrap gap-4 items-center border-l-4 border-l-ios-blue">
                    <label class="text-sm font-medium text-ios-textMuted"><i class="fa-solid fa-filter mr-2"></i>Data OP:</label>
                    <input type="date" id="search-po-by-date" class="form-input w-full sm:w-auto py-2">
                </div>
                <div id="production-orders-list" class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-5"></div>
            </div>

            <!-- Requisi칞칫es -->
            <div id="screen-requisitions" class="screen-panel hidden">
                <h1 class="title-lg">Baixa Avulsa</h1>
                <div class="card max-w-4xl mx-auto">
                    <form id="requisition-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5 mb-6">
                            <div><label class="form-label">Destino / Motivo</label><input type="text" id="requisition-reason" required class="form-input" placeholder="Ex: Quebra, Teste"></div>
                            <div><label class="form-label">Solicitante</label><input type="text" id="requisition-responsible" required class="form-input" placeholder="Nome"></div>
                        </div>
                        <div class="border-t border-ios-border pt-4">
                            <h3 class="title-md text-sm uppercase text-ios-textMuted mb-4">Itens da Requisi칞칚o</h3>
                            <div id="requisition-items-container" class="space-y-3 mb-5"></div>
                            <button type="button" id="add-requisition-item-btn" class="text-ios-blue hover:text-blue-400 font-medium text-sm flex items-center bg-ios-bg px-3 py-2 rounded-lg border border-ios-border w-max"><i class="fa-solid fa-circle-plus mr-2 text-lg"></i>Adicionar Insumo</button>
                        </div>
                        <div class="mt-8 flex justify-end"><button type="submit" class="btn-primary w-full md:w-auto">Confirmar Sa칤da Avulsa</button></div>
                    </form>
                </div>
            </div>

            <!-- Ajustes -->
            <div id="screen-adjustments" class="screen-panel hidden">
                <h1 class="title-lg">Ajuste Manual de Lote</h1>
                <div class="card max-w-2xl mx-auto">
                    <form id="adjustment-form" class="space-y-5">
                        <div class="z-50 relative"><label class="form-label">Buscar Produto</label><div id="adjustment-searchable-container" class="searchable-container"></div></div>
                        <div><label class="form-label">Selecionar Lote F칤sico</label><select id="adjustment-batch" required class="form-input"><option value="">Aguardando produto...</option></select></div>
                        <div><label class="form-label">Nova Quantidade Real (F칤sica)</label><input type="number" id="adjustment-new-quantity" required min="0" step="0.01" class="form-input text-lg font-bold text-ios-blue"></div>
                        <div><label class="form-label">Motivo do Ajuste</label><input type="text" id="adjustment-reason" required class="form-input" placeholder="Ex: Recontagem de invent치rio"></div>
                        <div><label class="form-label">Respons치vel</label><input type="text" id="adjustment-responsible" required class="form-input"></div>
                        <div class="mt-8 flex justify-end"><button type="submit" class="btn-primary w-full md:w-auto">Registrar Ajuste</button></div>
                    </form>
                </div>
            </div>

            <!-- Configura칞칫es e Banco de Dados -->
            <div id="screen-settings" class="screen-panel hidden max-w-3xl mx-auto">
                <h1 class="title-lg">Banco de Dados</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                    <div class="card border-ios-blue border">
                        <h2 class="title-md text-ios-blue"><i class="fa-solid fa-download mr-2"></i>Backup de Dados</h2>
                        <p class="text-sm text-ios-textMuted mb-6">Baixe um arquivo JSON com todas as informa칞칫es atuais do banco de dados (Nuvem).</p>
                        <button type="button" id="btn-download-db" class="btn-primary w-full"><i class="fa-solid fa-cloud-arrow-down mr-2"></i>Fazer Backup Seguro</button>
                    </div>
                    <div class="card border-ios-red border">
                        <h2 class="title-md text-ios-red"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Zerar Sistema</h2>
                        <p class="text-sm text-ios-textMuted mb-6">Aten칞칚o! Esta a칞칚o apaga irreversivelmente TODOS os produtos, lotes e hist칩rico do Firebase.</p>
                        <button type="button" id="btn-clear-db" class="btn-danger w-full"><i class="fa-solid fa-skull-crossbones mr-2"></i>Formatar Tudo</button>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- MOBILE BOTTOM NAV (Vis칤vel apenas em telas pequenas) -->
        <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-[#000000]/95 backdrop-blur-xl border-t border-ios-border flex justify-around items-center pt-2 pb-[max(1rem,env(safe-area-inset-bottom))] px-1 z-[45]">
            <a href="#" class="nav-item-mobile flex flex-col items-center py-2 px-3 text-ios-blue w-1/4 text-center transition-colors" data-target="home">
                <i class="fa-solid fa-house text-xl mb-1"></i><span class="text-[10px] font-bold">In칤cio</span>
            </a>
            <a href="#" class="nav-item-mobile flex flex-col items-center py-2 px-3 text-ios-textMuted hover:text-white w-1/4 text-center transition-colors" data-target="consulta">
                <i class="fa-solid fa-magnifying-glass text-xl mb-1"></i><span class="text-[10px] font-bold">Consulta</span>
            </a>
            <a href="#" class="nav-item-mobile flex flex-col items-center py-2 px-3 text-ios-textMuted hover:text-white w-1/4 text-center transition-colors relative" data-target="picking">
                <i class="fa-solid fa-dolly text-xl mb-1"></i><span class="text-[10px] font-bold">Picking</span>
                <span id="badge-nav-picking-mobile" class="absolute top-1 right-3 w-2.5 h-2.5 bg-ios-orange rounded-full animate-pulse hidden border-2 border-black"></span>
            </a>
            <button type="button" id="btn-show-alerts-mobile" class="flex flex-col items-center py-2 px-3 text-ios-textMuted hover:text-white w-1/4 text-center transition-colors relative">
                <i class="fa-solid fa-bell text-xl mb-1"></i><span class="text-[10px] font-bold">Alertas</span>
                <span id="badge-nav-alerts-mobile" class="absolute top-1 right-2 bg-ios-red text-white text-[9px] px-1.5 py-0.5 rounded-full hidden font-bold border border-black shadow">0</span>
            </button>
        </nav>
        
    </div>

    <!-- Modais Flutuantes -->

    <!-- Modal Nova Ficha/Receita -->
    <div id="recipe-modal" class="modal z-[6000]">
        <div class="modal-content max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6 border-b border-ios-border pb-4">
                <h2 id="recipe-modal-title" class="title-md mb-0 text-ios-blue flex items-center"><i class="fa-solid fa-book-bookmark mr-3"></i>Nova Receita</h2>
                <button type="button" class="text-ios-textMuted hover:text-white text-4xl ml-2 close-modal leading-none" data-target="recipe-modal">&times;</button>
            </div>
            <form id="recipe-form" class="space-y-6">
                <input type="hidden" id="edit-recipe-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Nome da Ficha / Produto Final</label>
                        <input type="text" id="recipe-name" required class="form-input" placeholder="Ex: P칚o de Queijo">
                    </div>
                    <div>
                        <label class="form-label">Categoria / Linha</label>
                        <input type="text" id="recipe-category" required class="form-input" placeholder="Ex: Salgados">
                    </div>
                </div>
                <div class="flex flex-col gap-3 bg-ios-cardHover p-4 rounded-xl border border-ios-border">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="recipe-is-semi" class="w-6 h-6 sm:w-5 sm:h-5 accent-ios-orange">
                        <label for="recipe-is-semi" class="text-white font-medium cursor-pointer text-sm sm:text-base">칄 um Semi-acabado (Gera estoque)</label>
                    </div>
                    <div id="yield-wrapper" class="hidden pl-2 sm:pl-8 border-l-2 border-ios-orange mt-2">
                        <label class="form-label text-ios-orange mb-1 text-xs sm:text-sm">Rendimento F칤sico Padr칚o (Quantos gera?)</label>
                        <input type="number" step="0.0001" id="recipe-yield" class="form-input w-full sm:w-1/2" value="1" placeholder="Ex: 50">
                    </div>
                </div>
                
                <div class="border-t border-ios-border pt-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                        <h3 class="text-sm font-semibold text-ios-textMuted uppercase">Ingredientes</h3>
                        <button type="button" id="add-ingredient-btn" class="text-ios-blue hover:text-white font-medium text-sm flex items-center bg-ios-blue/20 hover:bg-ios-blue px-3 py-2 rounded-lg transition-colors w-full sm:w-auto justify-center"><i class="fa-solid fa-plus mr-1"></i> Adicionar Insumo</button>
                    </div>
                    <div id="ingredients-container" class="space-y-3"></div>
                </div>
                <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4 border-t border-ios-border mt-6">
                    <button type="button" class="btn-secondary close-modal px-6 w-full sm:w-auto" data-target="recipe-modal">Cancelar</button>
                    <button type="submit" class="btn-primary px-8 w-full sm:w-auto"><i class="fa-solid fa-save mr-2"></i>Salvar Receita</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nova Ordem de Produ칞칚o -->
    <div id="production-order-modal" class="modal z-[6000]">
        <div class="modal-content max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6 border-b border-ios-border pb-4">
                <h2 class="title-md mb-0 text-white flex items-center text-lg sm:text-xl"><i class="fa-solid fa-hammer mr-2 sm:mr-3 text-ios-orange"></i>Nova OP</h2>
                <button type="button" class="text-ios-textMuted hover:text-white text-4xl ml-2 close-modal leading-none" data-target="production-order-modal">&times;</button>
            </div>
            <form id="production-order-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-5 relative">
                    <div class="z-50 md:col-span-2">
                        <label class="form-label">Qual ficha ser치 produzida?</label>
                        <div id="po-recipe-searchable-container" class="searchable-container"></div>
                    </div>
                    <div>
                        <label class="form-label">Data Programada</label>
                        <input type="date" id="po-date" required class="form-input">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 sm:gap-5 items-end">
                    <div>
                        <label class="form-label">Multiplicador (Qtd Receitas)</label>
                        <input type="number" step="0.01" id="po-quantity" required class="form-input font-bold text-xl text-center text-ios-blue py-3 sm:py-4" value="1" min="0.01">
                    </div>
                    <div class="md:col-span-3 flex items-center gap-3 bg-ios-cardHover hover:bg-ios-red/10 transition-colors p-3 sm:p-4 rounded-xl border border-ios-border h-full cursor-pointer">
                        <input type="checkbox" id="po-is-extra" class="w-6 h-6 accent-ios-red shrink-0">
                        <label for="po-is-extra" class="text-white font-medium text-xs sm:text-sm cursor-pointer w-full leading-tight">Marcar como OP EXTRA / URGENTE (Fura fila)</label>
                    </div>
                </div>

                <div id="po-output-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-ios-orange/10 p-4 sm:p-5 rounded-xl border border-ios-orange/30 hidden">
                    <div>
                        <label class="form-label text-ios-orange text-xs sm:text-sm">Lote de Sa칤da Gerado Auto</label>
                        <input type="text" id="po-output-batch" class="form-input bg-ios-bg border-ios-orange/50 font-mono text-white text-sm">
                    </div>
                    <div>
                        <label class="form-label text-ios-orange text-xs sm:text-sm">Rendimento F칤sico Total Previsto</label>
                        <input type="text" id="po-total-output" readonly class="form-input bg-ios-bg border-ios-orange/50 font-bold text-white text-lg">
                    </div>
                </div>
                
                <div class="border-t border-ios-border pt-4">
                    <h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3 flex items-center"><i class="fa-solid fa-calculator mr-2"></i>Previs칚o F칤sico</h3>
                    <div class="table-container max-h-64 overflow-y-auto">
                        <table class="base-table w-full">
                            <thead class="base-thead">
                                <tr>
                                    <th class="base-th">Insumo</th>
                                    <th class="base-th w-24">Saldo F칤sico</th>
                                    <th class="base-th w-32">Necess치rio na OP</th>
                                    <th class="base-th">Reservados (PEPS)</th>
                                </tr>
                            </thead>
                            <tbody id="po-ingredients-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4 border-t border-ios-border mt-6">
                    <button type="button" class="btn-secondary close-modal px-6 w-full sm:w-auto" data-target="production-order-modal">Cancelar</button>
                    <button type="submit" class="btn-primary px-8 shadow-lg shadow-ios-blue/20 w-full sm:w-auto"><i class="fa-solid fa-plus-circle mr-2"></i>Adicionar OP</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal Editar Endere칞o -->
    <div id="edit-location-modal" class="modal z-[6000]">
        <div class="modal-content max-w-sm w-[90%]">
            <h2 class="title-md mb-4 text-ios-blue">Editar Endere칞o</h2>
            <form id="edit-location-form" class="space-y-4">
                <input type="hidden" id="edit-loc-old-code">
                <div>
                    <label class="form-label">C칩digo (Rua/Posi칞칚o)</label>
                    <input type="text" id="edit-loc-new-code" required class="form-input font-mono text-ios-blue">
                </div>
                <div>
                    <label class="form-label">Nome Vis칤vel</label>
                    <input type="text" id="edit-loc-new-name" required class="form-input">
                </div>
                <div class="flex flex-col-reverse sm:flex-row justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary close-modal w-full sm:w-auto" data-target="edit-location-modal">Cancelar</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto">Atualizar Lotes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Prazo Fornecedor -->
    <div id="edit-supplier-modal" class="modal z-[6000]">
        <div class="modal-content max-w-sm w-[90%]">
            <h2 class="title-md mb-2 text-ios-blue">Editar Fornecedor</h2>
            <p class="text-sm text-white mb-4" id="edit-supplier-name"></p>
            <form id="edit-supplier-form" class="space-y-4">
                <input type="hidden" id="edit-supplier-old-name">
                <div><label class="form-label">Prazo Padr칚o (Dias 칔teis)</label><input type="number" id="edit-supplier-lead" min="0" required class="form-input"></div>
                <div class="flex flex-col-reverse sm:flex-row justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary close-modal w-full sm:w-auto" data-target="edit-supplier-modal">Cancelar</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto">Salvar para Todos</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Fazer Pedido (Compras) -->
    <div id="place-order-modal" class="modal z-[6000]">
        <div class="modal-content max-w-sm w-[90%]">
            <h2 class="title-md mb-2 text-ios-blue">Registrar Pedido</h2>
            <p class="text-sm text-white mb-4" id="order-product-name"></p>
            <form id="place-order-form" class="space-y-4">
                <input type="hidden" id="order-product-id">
                <div><label class="form-label">Qtd Solicitada</label><input type="number" id="order-qty" step="0.01" required class="form-input text-ios-blue font-bold"></div>
                <div><label class="form-label">Previs칚o de Entrega</label><input type="date" id="order-date" required class="form-input"></div>
                <div class="flex flex-col-reverse sm:flex-row justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary close-modal w-full sm:w-auto" data-target="place-order-modal">Cancelar</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto">Confirmar Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scanner C칙mera Modal Global -->
    <div id="scanner-modal" class="modal z-[99999]">
        <div class="modal-content max-w-2xl w-[95%] flex flex-col p-4 sm:p-6 relative pt-12 sm:pt-6">
            <button type="button" class="absolute top-2 right-2 sm:-top-4 sm:-right-4 bg-ios-red text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold border-2 border-ios-bg shadow-xl close-scanner cursor-pointer z-50">&times;</button>
            <div class="flex justify-between items-center mb-4">
                <h2 class="title-md mb-0 text-white text-base sm:text-xl"><i class="fa-solid fa-camera mr-2"></i>Leitor de C칩digo</h2>
            </div>
            <div class="bg-black rounded-xl overflow-hidden shadow-inner border border-ios-border flex items-center justify-center min-h-[300px] sm:min-h-[500px] mb-4 relative">
                <div id="reader" class="w-full h-full absolute inset-0"></div>
            </div>
            <div class="flex gap-2 flex-col sm:flex-row">
                <input type="text" id="scanner-manual-input" class="form-input flex-1 font-mono text-center text-base sm:text-lg" placeholder="Ou digite o c칩digo aqui..." autocomplete="off">
                <button type="button" id="btn-scanner-manual-confirm" class="btn-primary px-8 w-full sm:w-auto"><i class="fa-solid fa-check"></i> OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Entrada Qtde Separa칞칚o (Picking via C칙mera) -->
    <div id="picking-scan-qty-modal" class="modal z-[6000]">
        <div class="modal-content max-w-sm w-[90%]">
            <h2 class="title-md mb-2 text-ios-orange">Qtd Encontrada</h2>
            <p class="text-sm text-white mb-4" id="picking-scan-qty-name"></p>
            <form id="picking-scan-qty-form" class="space-y-4">
                <div>
                    <label class="form-label">Quantidade F칈SICA Coletada:</label>
                    <input type="number" id="picking-scan-qty" step="0.001" required class="form-input text-ios-blue text-2xl sm:text-3xl font-bold text-center py-4">
                </div>
                <div class="flex flex-col-reverse sm:flex-row justify-end gap-2 pt-2">
                    <button type="button" class="btn-secondary close-modal w-full sm:w-auto" data-target="picking-scan-qty-modal">Cancelar</button>
                    <button type="submit" class="btn-primary px-6 w-full sm:w-auto">Confirmar Real</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Adicionar Lote a Endere칞o -->
    <div id="modal-add-loc-batch" class="modal z-[6000]">
        <div class="modal-content max-w-md w-[90%]">
            <h2 class="title-md mb-4 text-ios-blue">Alocar Lote</h2>
            <form id="add-loc-batch-form" class="space-y-4">
                <input type="hidden" id="add-loc-target-code">
                
                <div class="z-50 relative">
                    <label class="form-label">1. Buscar Produto</label>
                    <div id="add-loc-searchable-container" class="searchable-container"></div>
                </div>
                <div>
                    <label class="form-label">2. Lote F칤sico Existente</label>
                    <select id="add-loc-batch-select" required class="form-input bg-ios-input">
                        <option value="">Aguardando produto...</option>
                    </select>
                </div>

                <div class="flex flex-col-reverse sm:flex-row justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary close-modal w-full sm:w-auto" data-target="modal-add-loc-batch">Cancelar</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto">Confirmar Movimenta칞칚o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Picking (Separa칞칚o Agrupada - Sem Cron칪metro) -->
    <div id="picking-modal" class="modal z-[6000]">
        <div class="modal-content max-w-5xl h-[95vh] w-[95%] sm:w-full overflow-hidden flex flex-col p-0 bg-ios-bg border border-ios-border">
            <div class="flex justify-between items-start shrink-0 p-4 sm:p-6 border-b border-ios-border bg-ios-cardHover">
                <div>
                    <h2 id="picking-modal-title" class="title-md mb-1 text-ios-orange flex items-center text-lg sm:text-xl"><i class="fa-solid fa-dolly mr-2 sm:mr-3 text-xl sm:text-2xl"></i><span>Check-list Setor</span></h2>
                    <p id="picking-modal-subtitle" class="text-xs sm:text-sm text-ios-textMuted font-medium"></p>
                </div>
                <button type="button" class="text-ios-textMuted hover:text-white text-3xl sm:text-4xl ml-2 sm:ml-4 close-modal leading-none" data-target="picking-modal">&times;</button>
            </div>
            
            <div id="picking-setup-view" class="p-6 sm:p-10 flex flex-col items-center justify-center bg-ios-card h-full">
                <i class="fa-solid fa-clipboard-user text-5xl sm:text-6xl text-ios-orange mb-6"></i>
                <h3 class="text-xl sm:text-2xl font-bold text-white mb-2 text-center">Quem vai separar?</h3>
                <p class="text-ios-textMuted text-xs sm:text-sm mb-6 sm:mb-8 text-center max-w-md">Insira o seu nome para registrar a responsabilidade.</p>
                <input type="text" id="picking-responsible" class="form-input w-full max-w-xs text-center text-lg sm:text-xl py-3 sm:py-4 mb-6 shadow-inner border border-ios-border" placeholder="Seu nome" autocomplete="off">
                <button type="button" id="btn-start-picking" class="btn-success py-3 sm:py-4 px-6 sm:px-10 text-base sm:text-lg w-full max-w-xs rounded-full shadow-lg shadow-ios-green/20 hover:-translate-y-1 transform transition"><i class="fa-solid fa-dolly mr-2"></i> Iniciar Check-list</button>
            </div>

            <div id="picking-active-view" class="hidden flex-col flex-1 overflow-hidden h-full">
                <div class="bg-ios-bg p-3 sm:p-4 flex flex-col sm:flex-row justify-between items-center shrink-0 border-b border-ios-border shadow-inner gap-3 sm:gap-4">
                    <div class="flex justify-between w-full sm:w-auto items-center">
                        <div>
                            <p class="text-[9px] sm:text-[10px] text-ios-textMuted uppercase font-bold tracking-widest mb-0.5 sm:mb-1">Resp.</p>
                            <p class="font-bold text-white text-sm sm:text-lg flex items-center"><i class="fa-solid fa-user-check text-ios-blue mr-2"></i><span id="picking-active-resp" class="truncate max-w-[100px] sm:max-w-[200px]">---</span></p>
                        </div>
                        <button type="button" id="btn-picking-scan" class="bg-ios-cardHover border border-ios-blue text-ios-blue hover:bg-ios-blue hover:text-white py-2 px-3 sm:px-4 rounded-xl transition font-bold flex items-center shadow-lg text-xs sm:text-sm"><i class="fa-solid fa-camera mr-2"></i>Bipar Item</button>
                    </div>
                    <button type="button" id="btn-finish-picking" class="btn-primary py-3 px-4 sm:px-6 w-full sm:w-auto shadow-lg shadow-ios-blue/20 rounded-xl text-sm sm:text-base"><i class="fa-solid fa-flag-checkered mr-2"></i>Finalizar OPs</button>
                </div>

                <div class="overflow-y-auto flex-1 bg-ios-bg p-2 sm:p-6">
                    <div class="table-container shadow-xl">
                        <table class="base-table w-full text-left min-w-[500px]">
                            <thead class="base-thead sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="base-th rounded-tl-lg text-xs sm:text-sm">Item (Consolidado)</th>
                                    <th class="base-th text-right text-xs sm:text-sm">Necess치rio</th>
                                    <th class="base-th text-center w-40 sm:w-56 text-xs sm:text-sm">Qtd Real</th>
                                    <th class="base-th text-center rounded-tr-lg text-xs sm:text-sm">OK</th>
                                </tr>
                            </thead>
                            <tbody id="picking-checklist-body" class="divide-y divide-ios-border"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes Item (Estoque) -->
    <div id="item-details-modal" class="modal z-[6000]">
        <div class="modal-content max-w-5xl h-[95vh] sm:max-h-[90vh] w-[95%] sm:w-full overflow-y-auto">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3">
                <div class="flex-1 w-full">
                    <h2 class="title-md flex items-center mb-1 text-xl sm:text-2xl tracking-tight break-words pr-8 sm:pr-0"><span id="details-product-name"></span></h2>
                    <span id="details-product-type-badge" class="badge bg-ios-cardHover text-ios-textMuted border border-ios-border"></span>
                </div>
                <div class="flex items-center gap-2 absolute sm:relative top-4 right-4 sm:top-auto sm:right-auto">
                    <button type="button" id="btn-edit-item" class="text-ios-blue bg-ios-blue/10 p-2 sm:p-3 rounded-full hover:bg-ios-blue/20 transition-colors"><i class="fa-solid fa-pen"></i></button>
                    <button type="button" id="btn-delete-item" class="text-ios-red bg-ios-red/10 p-2 sm:p-3 rounded-full hover:bg-ios-red/20 transition-colors"><i class="fa-solid fa-trash"></i></button>
                    <button type="button" class="text-ios-textMuted hover:text-white text-3xl ml-1 sm:ml-2 close-modal leading-none" data-target="item-details-modal">&times;</button>
                </div>
            </div>
            
            <div id="item-details-view" class="grid grid-cols-2 md:grid-cols-6 gap-3 sm:gap-4 text-xs sm:text-sm bg-ios-bg p-4 sm:p-5 rounded-2xl mb-6 shadow-inner border border-ios-border">
                <div class="col-span-1"><span class="text-ios-textMuted block mb-0.5 sm:mb-1">C칩d. Interno</span><span id="details-product-code" class="text-white font-medium"></span></div>
                <div class="col-span-1 md:col-span-2"><span class="text-ios-textMuted block mb-0.5 sm:mb-1">Fornecedor</span><span id="details-supplier" class="text-white font-medium truncate"></span></div>
                <div class="col-span-2 md:col-span-1"><span class="text-ios-textMuted block mb-0.5 sm:mb-1">Estoque M칤n.</span><span id="details-min-stock" class="text-ios-orange font-medium"></span></div>
                <div class="col-span-2"><span class="text-ios-textMuted block mb-0.5 sm:mb-1">EANs</span><span id="details-product-barcode" class="text-white font-mono break-all text-[10px] sm:text-xs"></span></div>
                <div class="col-span-2 md:col-span-6 bg-ios-cardHover p-3 rounded-xl mt-1"><span class="text-ios-textMuted block mb-1 uppercase font-bold text-[10px]">Saldo F칤sico Total</span><span id="details-total-quantity" class="text-ios-green font-bold text-2xl sm:text-3xl"></span></div>
            </div>
            
            <div id="item-details-edit" class="hidden mb-6 bg-ios-bg p-4 sm:p-5 rounded-2xl border border-ios-border shadow-inner">
                <form id="edit-item-form" class="grid grid-cols-1 md:grid-cols-6 gap-4 sm:gap-5">
                    <input type="hidden" id="edit-item-id">
                    <div class="md:col-span-6"><label class="form-label">Classifica칞칚o</label><select id="edit-product-type" required class="form-input"><option value="insumo">Insumo</option><option value="semi_acabado">Semi-acabado</option></select></div>
                    <div class="md:col-span-6"><label class="form-label">Nome</label><input type="text" id="edit-product-name" required class="form-input"></div>
                    <div class="md:col-span-2"><label class="form-label">C칩d Interno</label><input type="text" id="edit-product-code" class="form-input"></div>
                    <div class="md:col-span-3"><label class="form-label">Fornecedor</label><input type="text" id="edit-supplier" class="form-input"></div>
                    <div class="md:col-span-1"><label class="form-label">Estoque M칤n.</label><input type="number" step="0.01" id="edit-min-stock" class="form-input text-ios-orange font-bold"></div>
                    <div class="md:col-span-6"><label class="form-label">EANs (Separe por v칤rgula)</label><input type="text" id="edit-product-barcode" class="form-input font-mono"></div>
                    <div class="md:col-span-6 flex flex-col sm:flex-row justify-end gap-3 mt-2"><button type="button" id="btn-cancel-edit" class="btn-secondary w-full sm:w-auto">Cancelar</button><button type="submit" class="btn-primary w-full sm:w-auto">Salvar Edi칞칚o</button></div>
                </form>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
                <div>
                    <h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3">Lotes F칤sicos na Prateleira</h3>
                    <div class="table-container mb-8 max-h-64 sm:max-h-96 overflow-y-auto">
                        <table class="base-table min-w-[400px]">
                            <thead class="base-thead"><tr><th class="base-th">Lote</th><th class="base-th">Status</th><th class="base-th">Local</th><th class="base-th">Volume</th><th class="base-th text-center">A칞칫es</th></tr></thead>
                            <tbody id="details-batches-table"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3 flex justify-between items-center">
                        Extrato
                        <button type="button" id="btn-clear-hist-filters" class="text-xs text-ios-blue hover:text-blue-300 font-normal underline hidden">Limpar Filtros</button>
                    </h3>
                    <div class="flex flex-col sm:flex-row flex-wrap gap-2 mb-3 bg-ios-bg p-3 rounded-xl border border-ios-border shadow-inner">
                        <div class="w-full text-xs text-ios-textMuted font-medium mb-1">Filtrar por Per칤odo e Tipo:</div>
                        <div class="flex gap-2 w-full sm:w-auto items-center">
                            <input type="date" id="hist-filter-start" class="form-input py-1 px-2 text-xs w-full sm:w-auto border-ios-border flex-1">
                            <span class="text-ios-textMuted flex items-center text-xs">at칠</span>
                            <input type="date" id="hist-filter-end" class="form-input py-1 px-2 text-xs w-full sm:w-auto border-ios-border flex-1">
                        </div>
                        <select id="hist-filter-type" class="form-input py-1 px-2 text-xs w-full sm:w-auto border-ios-border sm:ml-auto mt-2 sm:mt-0">
                            <option value="">Todas Movimenta칞칫es</option>
                            <option value="entrada">Entradas</option>
                            <option value="sa칤da">Sa칤das (OP)</option>
                            <option value="requisi칞칚o">Baixa Avulsa</option>
                            <option value="ajuste">Ajustes</option>
                        </select>
                    </div>
                    <div class="table-container max-h-64 sm:max-h-72 overflow-y-auto bg-ios-bg p-2" id="details-history-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Lote -->
    <div id="edit-batch-modal" class="modal z-[7000]">
        <div class="modal-content max-w-sm w-[90%]">
            <h2 class="title-md mb-4">Editar Lote</h2>
            <form id="edit-batch-form" class="space-y-4">
                <input type="hidden" id="edit-batch-id">
                <input type="hidden" id="edit-batch-product-id">
                <div><label class="form-label">C칩digo do Lote</label><input type="text" id="edit-batch-code" required class="form-input bg-ios-bg border-ios-border"></div>
                <div><label class="form-label">Quantidade</label><input type="number" step="0.001" id="edit-batch-qty" required class="form-input text-ios-blue font-bold bg-ios-bg border-ios-border"></div>
                <div><label class="form-label">Validade</label><input type="date" id="edit-batch-expiry" class="form-input bg-ios-bg border-ios-border"></div>
                <div class="flex flex-col-reverse sm:flex-row justify-end gap-2 mt-4">
                    <button type="button" class="btn-secondary close-modal w-full sm:w-auto" data-target="edit-batch-modal">Cancelar</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Seletor Manual de Lotes -->
    <div id="batch-selector-modal" class="modal z-[7000]">
        <div class="modal-content max-w-xl w-[95%]">
            <h2 id="batch-selector-title" class="title-md mb-4 text-lg sm:text-xl">Descontar de quais lotes?</h2>
            <div class="bg-ios-bg border border-ios-border p-3 sm:p-4 rounded-xl flex justify-between mb-4 sm:mb-5 items-center flex-col sm:flex-row gap-2">
                <span class="text-ios-textMuted text-xs sm:text-sm w-full sm:w-auto text-center sm:text-left">Alvo OP: <span id="batch-selector-needed" class="text-white font-semibold"></span></span>
                <span class="text-ios-textMuted text-xs sm:text-sm w-full sm:w-auto text-center sm:text-right bg-ios-input py-1 px-3 rounded-lg">Marcado: <span id="batch-selector-selected" class="font-bold text-base sm:text-lg text-ios-blue"></span></span>
            </div>
            <div id="batch-selector-list" class="max-h-64 overflow-y-auto mb-4 sm:mb-6 pr-2 space-y-2"></div>
            <div class="flex flex-col-reverse sm:flex-row justify-end gap-2 sm:gap-3">
                <button type="button" class="btn-secondary close-modal w-full sm:w-auto" data-target="batch-selector-modal">Cancelar</button>
                <button type="button" id="confirm-batch-selection" class="btn-primary w-full sm:w-auto">Aplicar Sele칞칚o Real</button>
            </div>
        </div>
    </div>

    <!-- Modal Alertas Complexos (Sininho) -->
    <div id="low-stock-modal" class="modal z-[6000]">
        <div class="modal-content max-w-4xl h-[85vh] w-[95%] sm:w-full flex flex-col p-0 overflow-hidden bg-ios-bg">
            <div class="flex justify-between items-start shrink-0 p-4 sm:p-6 border-b border-ios-border bg-ios-cardHover">
                <div>
                    <h2 class="title-md mb-1 text-white flex items-center text-lg sm:text-xl"><i class="fa-solid fa-bell mr-2 sm:mr-3 text-xl sm:text-2xl text-ios-red"></i><span>Alertas do Sistema</span></h2>
                    <p class="text-xs sm:text-sm text-ios-textMuted font-medium">Acompanhamento autom치tico.</p>
                </div>
                <button type="button" class="text-ios-textMuted hover:text-white text-3xl sm:text-4xl ml-2 sm:ml-4 close-modal leading-none" data-target="low-stock-modal">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 sm:p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
                <div>
                    <h3 class="text-ios-orange font-bold mb-3 sm:mb-4 uppercase text-xs sm:text-sm tracking-wider flex items-center bg-ios-orange/10 p-2 rounded-lg border border-ios-orange/20"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Abaixo do M칤nimo</h3>
                    <ul id="low-stock-list" class="space-y-3"></ul>
                </div>
                <div>
                    <h3 class="text-ios-red font-bold mb-3 sm:mb-4 uppercase text-xs sm:text-sm tracking-wider flex items-center bg-ios-red/10 p-2 rounded-lg border border-ios-red/20"><i class="fa-solid fa-clock mr-2"></i>Validades (Pr칩x. 45 dias)</h3>
                    <ul id="expiring-list" class="space-y-3"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirma칞칚o Base -->
    <div id="confirm-action-modal" class="modal z-[9999]">
        <div class="modal-content max-w-md w-[90%] text-center flex flex-col items-center p-6">
            <div class="w-14 sm:w-16 h-14 sm:h-16 rounded-full bg-ios-cardHover border border-ios-border flex items-center justify-center mb-4 sm:mb-5 shrink-0"><i class="fa-solid fa-circle-question text-2xl sm:text-3xl text-ios-blue"></i></div>
            <h3 id="confirm-title" class="title-md mb-2 text-lg sm:text-xl"></h3>
            <p id="confirm-message" class="text-ios-textMuted text-xs sm:text-sm mb-6 sm:mb-8 leading-relaxed px-2"></p>
            <div class="flex flex-col-reverse sm:flex-row gap-3 w-full justify-center">
                <button type="button" id="cancel-action-btn" class="btn-secondary w-full sm:w-1/2">Cancelar</button>
                <button type="button" id="confirm-action-btn" class="btn-primary w-full sm:w-1/2">Sim, Continuar</button>
            </div>
        </div>
    </div>
    
<script type="module">
    const id = n => document.getElementById(n);
    const show = el => { if(el) { el.style.display = 'flex'; el.classList.remove('hidden'); } };
    const hide = el => { if(el) { el.style.display = 'none'; el.classList.add('hidden'); } };

    const addEvt = (elementId, eventType, handler) => {
        const el = document.getElementById(elementId);
        if(el) el.addEventListener(eventType, handler);
    };

    window.showNotif = function(msg, isError = false) {
        const el = id('notification-modal');
        if(!el) return;
        el.innerHTML = isError ? `<i class="fa-solid fa-triangle-exclamation mr-2"></i> ${msg}` : `<i class="fa-solid fa-check mr-2"></i> ${msg}`;
        el.className = `fixed top-10 sm:top-6 left-1/2 transform -translate-x-1/2 z-[9999999] py-3 px-6 rounded-full shadow-2xl font-semibold text-white transition-all text-xs sm:text-sm backdrop-blur-md w-max max-w-[90vw] text-center ${isError ? 'bg-ios-red/95' : 'bg-ios-green/95'}`;
        show(el);
        setTimeout(() => hide(el), 4000);
    };

    function addBusinessDays(startDate, daysToAdd) {
        let date = new Date(startDate);
        let added = 0;
        while (added < daysToAdd) {
            date.setDate(date.getDate() + 1);
            if (date.getDay() !== 0 && date.getDay() !== 6) { added++; }
        }
        return date;
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, deleteDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDev8spgKoKZi2pOohmk0r9SFLtLMcePa8",
        authDomain: "estoque-b50df.firebaseapp.com",
        projectId: "estoque-b50df",
        storageBucket: "estoque-b50df.firebasestorage.app",
        messagingSenderId: "634756791567",
        appId: "1:634756791567:web:993e61243b57b7e057d27a",
        measurementId: "G-JFHTWJJQE9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    const DB = (() => {
        return {
            add: async (coll, data) => {
                const docRef = await addDoc(collection(db, coll), data);
                await setDoc(docRef, { id: docRef.id }, { merge: true });
                return docRef.id;
            },
            update: async (coll, data) => {
                if(!data.id) return;
                await setDoc(doc(db, coll, data.id), data, { merge: true });
            },
            remove: async (coll, idStr) => {
                if(!idStr) return;
                await deleteDoc(doc(db, coll, idStr));
            },
            get: async (coll, idStr) => {
                if(!idStr) return null;
                const docSnap = await getDoc(doc(db, coll, idStr));
                return docSnap.exists() ? docSnap.data() : null;
            },
            getAll: async (coll) => {
                const qs = await getDocs(collection(db, coll));
                return qs.docs.map(d => d.data());
            },
            getByIndex: async (coll, idx, val) => {
                const q = query(collection(db, coll), where(idx, "==", val));
                const qs = await getDocs(q);
                return qs.empty ? null : qs.docs[0].data();
            },
            clear: async (coll) => {
                const qs = await getDocs(collection(db, coll));
                for (const d of qs.docs) { await deleteDoc(d.ref); }
            }
        };
    })();

    let html5QrCode;
    let scannerCallback = null;
    
    function openScanner(onScanSuccess) {
        scannerCallback = onScanSuccess;
        const inputFallback = id('scanner-manual-input');
        if(inputFallback) inputFallback.value = '';
        show(id('scanner-modal'));
        if(inputFallback) inputFallback.focus();
        
        setTimeout(() => {
            if(id('scanner-modal').classList.contains('hidden')) return; 
            if(html5QrCode && html5QrCode.isScanning) return;
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { 
                    fps: 10,
                    qrbox: function(viewfinderWidth, viewfinderHeight) {
                        return { width: Math.min(viewfinderWidth * 0.9, 600), height: Math.min(viewfinderHeight * 0.6, 280) };
                    }
                },
                (decodedText) => {
                    const tempCb = scannerCallback;
                    closeScanner();
                    if(tempCb) tempCb(decodedText);
                },
                (err) => { }
            ).catch(err => {
                console.error("Erro c칙mera:", err);
                window.showNotif("C칙mera indispon칤vel. Utilize a caixa de texto.", true);
            });
        }, 300);
    }

    function closeScanner() {
        hide(id('scanner-modal'));
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; }).catch(()=>{});
        }
        scannerCallback = null;
    }

    document.querySelectorAll('.close-scanner').forEach(btn => { btn.addEventListener('click', closeScanner); });
    
    addEvt('btn-scanner-manual-confirm', 'click', () => {
        const val = id('scanner-manual-input').value.trim();
        if(val && scannerCallback) {
            const tempCb = scannerCallback;
            closeScanner();
            tempCb(val);
        } else {
            window.showNotif('Digite um c칩digo v치lido.', true);
        }
    });

    addEvt('scanner-manual-input', 'keydown', e => {
        if(e.key === 'Enter') { e.preventDefault(); id('btn-scanner-manual-confirm').click(); }
    });

    // --- LOGIN ---
    addEvt('btn-login-google', 'click', () => {
        const msg = id('mensagem-erro');
        if(msg) { msg.innerText = "Abrindo Google..."; show(msg); }
        signInWithPopup(auth, provider).catch((error) => {
            if(msg) { msg.innerHTML = "Erro de login. Tente 'Testar sem Login'."; show(msg); }
        });
    });

    addEvt('btn-bypass-login', 'click', () => {
        hide(id('login-wrapper')); show(id('app-wrapper'));
        const nu = id('nome-usuario'); if(nu) nu.innerText = 'Modo Visualiza칞칚o';
        window.navTo('home'); refreshData();
    });

    const logoutAction = () => { signOut(auth).then(() => { window.showNotif('Sess칚o encerrada.'); }).catch(err => console.error(err)); };
    addEvt('btn-sair', 'click', logoutAction);
    addEvt('btn-sair-mobile', 'click', logoutAction);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            hide(id('login-wrapper')); show(id('app-wrapper'));
            const nu = id('nome-usuario'); if(nu) nu.innerText = user.displayName || 'Estoquista';
            
            show(id('loading-overlay'));
            window.navTo('home');
            try { await refreshData(); } catch(e) { if(id('loading-text')) id('loading-text').innerText = "Erro na Nuvem"; }
            hide(id('loading-overlay'));
        } else {
            show(id('login-wrapper')); hide(id('app-wrapper')); hide(id('loading-overlay'));
        }
    });

    let localInventory=[], localBatches=[], localHistory=[], localRecipes=[], localProductionOrders=[], localMonthlyConsumption=[], localLocations=[];
    let currentRecipeCategory='Todos';
    let currentBatchTarget=null;
    let invSort = { col: 'name', asc: true };
    let currentHistoryProductId = null;
    let activePickingLine = null;
    let activePickingOpIds = [];
    let pickingScanProductId = null;
    let bulkEntryItems = [];

    const typeLabels = { insumo: 'Insumo', semi_acabado: 'Semi-acabado' };

    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => { hide(id(btn.dataset.target)); });
    });

    const screens = ['home','consulta','entry','inventory','recipes','production','requisitions','adjustments','consumption','locations','barcodes','picking','purchasing','settings'];
    window.navTo = function(target) {
        screens.forEach(s => { id('screen-'+s)?.classList.add('hidden'); });
        
        // Update Desktop Sidebar
        document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('bg-ios-card', 'text-white'); n.classList.add('text-ios-textMuted'); });
        const activeLink = document.querySelector(`.nav-item[data-target="${target}"]`);
        if(activeLink) { activeLink.classList.remove('text-ios-textMuted'); activeLink.classList.add('bg-ios-card', 'text-white'); }
        
        // Update Mobile Bottom Nav
        document.querySelectorAll('.nav-item-mobile').forEach(n => { n.classList.remove('text-ios-blue'); n.classList.add('text-ios-textMuted'); });
        const activeLinkMobile = document.querySelector(`.nav-item-mobile[data-target="${target}"]`);
        if(activeLinkMobile) { activeLinkMobile.classList.remove('text-ios-textMuted'); activeLinkMobile.classList.add('text-ios-blue'); }

        const screenEl = id('screen-'+target); if(screenEl) screenEl.classList.remove('hidden');
        
        if(target==='adjustments') { createSearchableSelect(id('adjustment-searchable-container'), localInventory, 'Buscar inteligente...', p => { const batchEl = id('adjustment-batch'); if(batchEl) batchEl.innerHTML = '<option value="">Selecione Lote...</option>' + localBatches.filter(b=>b.productId===p.id && b.quantity>0).map(b=>`<option value="${b.id}">${b.code}</option>`).join(''); }); }
        if(target==='requisitions') { const reqCont = id('requisition-items-container'); if (reqCont) { reqCont.innerHTML=''; addIngRowReq(reqCont); } }
        if(target==='picking') { renderPickingScreen(); }
        if(target==='purchasing') { renderPurchasing(); }
        if(target==='barcodes') { renderBarcodesList(); createSearchableSelect(id('barcode-searchable-container'), localInventory, 'Selecione produto...'); }
        if(target==='consulta') { id('consulta-input').value = ''; id('consulta-results').innerHTML = '<div class="card flex flex-col items-center justify-center py-20 text-center border-dashed"><i class="fa-solid fa-magnifying-glass text-6xl text-ios-cardHover mb-4"></i><p class="text-ios-textMuted">Aguardando leitura...</p></div>'; setTimeout(()=>id('consulta-input').focus(), 100); }
        if(target==='entry') { 
            createSearchableSelect(id('entry-searchable-container'), localInventory, 'Pesquisar...', p => { document.querySelector('#entry-form input[name="quantity"]').focus(); }); 
            renderBulkEntry(); 
        }
    }
    
    document.querySelectorAll('.nav-item, .nav-item-mobile, .nav-btn').forEach(link => { 
        link.addEventListener('click', e => { e.preventDefault(); window.navTo(link.dataset.target || link.closest('.nav-btn').dataset.target); }); 
    });

    function showConfirmationModal(title, message, onConfirm) {
        const titleEl = id('confirm-title'); if(titleEl) titleEl.textContent = title; 
        const msgEl = id('confirm-message'); if(msgEl) msgEl.innerHTML = message; 
        const modal = id('confirm-action-modal'); if(modal) modal.style.display = 'flex';
        
        const cancelBtn = id('cancel-action-btn'); const confirmBtn = id('confirm-action-btn');
        if(cancelBtn && confirmBtn && modal) {
            const cleanup = () => { modal.style.display='none'; confirmBtn.replaceWith(confirmBtn.cloneNode(true)); cancelBtn.replaceWith(cancelBtn.cloneNode(true)); };
            cancelBtn.addEventListener('click', cleanup, { once: true }); confirmBtn.addEventListener('click', () => { onConfirm(); cleanup(); }, { once: true });
        }
    }

    function createSearchableSelect(container, items, placeholder, onSelect) {
        if(!container) return;
        container.innerHTML = `<div class="searchable-container"><input type="text" class="form-input bg-ios-input text-white border-ios-border w-full text-sm sm:text-base" placeholder="${placeholder}" autocomplete="off"><div class="searchable-dropdown hidden"></div></div>`;
        const input = container.querySelector('input'); const dropdown = container.querySelector('.searchable-dropdown');
        if(!input || !dropdown) return;
        
        const renderList = (searchTerm) => {
            let filtered = items;
            if(searchTerm) { 
                const term = searchTerm.toLowerCase(); 
                filtered = filtered.filter(i => 
                    (i.searchName || i.name).toLowerCase().includes(term) || 
                    (i.code && i.code.toLowerCase().includes(term)) || 
                    (i.barcodes && i.barcodes.some(b => b.toLowerCase().includes(term)))
                ); 
            }
            if(filtered.length) { dropdown.innerHTML = filtered.map(i => `<div class="searchable-item flex justify-between items-center text-sm" data-id="${i.id}"><span class="font-medium truncate pr-2">${i.searchName || i.name}</span>${i.type ? `<span class="text-[10px] text-ios-textMuted bg-black/30 px-2 py-1 rounded shrink-0">${typeLabels[i.type]||''}</span>` : ''}</div>`).join(''); dropdown.classList.remove('hidden'); } 
            else { dropdown.innerHTML = `<div class="p-3 text-ios-textMuted text-xs">Sem resultados...</div>`; dropdown.classList.remove('hidden'); }
        };
        input.addEventListener('focus', () => renderList(input.value)); input.addEventListener('input', () => renderList(input.value));
        dropdown.addEventListener('click', e => { const row = e.target.closest('.searchable-item'); if(row) { const item = items.find(i => i.id == row.dataset.id); input.value = item.searchName || item.name; input.dataset.selectedId = item.id; dropdown.classList.add('hidden'); if(onSelect) onSelect(item); } });
        document.addEventListener('click', e => { if(!container.contains(e.target)) dropdown.classList.add('hidden'); });
    }

    function getFIFOPlan(productId, qtyNeeded) {
        const batches = localBatches.filter(b => b.productId === productId && b.quantity > 0 && b.isReleased !== false).sort((a,b) => new Date(a.expiryDate || '9999-01-01') - new Date(b.expiryDate || '9999-01-01'));
        let remaining = qtyNeeded; let plan = [];
        for (let b of batches) { if (remaining <= 0) break; const take = Math.min(b.quantity, remaining); plan.push({ batchId: b.id, batchCode: b.code, quantity: take }); remaining -= take; }
        return { plan, isSufficient: remaining <= 0.0001 };
    }

    async function refreshData() {
        try {
            [localInventory, localBatches, localHistory, localRecipes, localProductionOrders, localMonthlyConsumption, localLocations] = await Promise.all([
                DB.getAll('inventory'), DB.getAll('batches'), DB.getAll('history'), DB.getAll('recipes'), DB.getAll('productionOrders'), DB.getAll('monthlyConsumption'), DB.getAll('locations')
            ]);
            
            let changed = false;
            for(let i of localInventory) {
                if(i.barcode && !i.barcodes) { i.barcodes = [i.barcode]; delete i.barcode; changed = true; }
                else if(!i.barcodes) { i.barcodes = []; changed = true; }
                if(!i.type || i.type === 'acabado') { i.type = 'insumo'; changed = true; } 
                const batches = localBatches.filter(b => b.productId === i.id); const batchSum = batches.reduce((sum, b) => sum + Math.max(0, b.quantity), 0);
                if (Math.abs((i.totalQuantity || 0) - batchSum) > 0.001) { i.totalQuantity = batchSum; changed = true; }
                if(changed) await DB.update('inventory', i);
            }
            if(changed) { localInventory = await DB.getAll('inventory'); }

            for(let op of localProductionOrders) {
                let opChanged = false;
                if(!op.picking) { op.picking = { status: 'pendente', responsible: '', start: null, end: null, duration: 0, pickedItems: {} }; opChanged = true; }
                if(!op.recipeCategory) { const rec = localRecipes.find(r=>r.id===op.recipeId); if(rec) { op.recipeCategory = rec.category; opChanged = true; } }
                if(typeof op.isExtra === 'undefined') { op.isExtra = false; opChanged = true; } 
                if(opChanged) await DB.update('productionOrders', op);
            }

            populateFilters(); renderHome(); renderInv(); renderRecipes(); renderPO(); renderConsum(); updateSidebarBadges();
            
            const activeNav = document.querySelector('.nav-item.bg-ios-card') || document.querySelector('.nav-item-mobile.text-ios-blue');
            if(activeNav) {
                const target = activeNav.dataset.target;
                if(target === 'picking') renderPickingScreen();
                if(target === 'barcodes') renderBarcodesList();
                if(target === 'purchasing') renderPurchasing();
            }
            if(currentHistoryProductId) renderItemDetailsHistory();
            
        } catch(e) { window.showNotif('Erro ao carregar dados.', true); console.error(e); }
    }

    function populateFilters() {
        const curSup = id('supplier-filter')?.value; const suppliers = [...new Set(localInventory.map(i=>i.supplier))].filter(Boolean).sort();
        const sf = id('supplier-filter'); if(sf) { sf.innerHTML = '<option value="">Fornecedores</option>' + suppliers.map(s=>`<option value="${s}">${s}</option>`).join(''); sf.value = curSup; }
        
        const cy = id('consumption-year-filter')?.value || new Date().getFullYear().toString(); const cm = id('consumption-month-filter')?.value || (new Date().getMonth()+1).toString();
        const cYears = [...new Set(localMonthlyConsumption.map(c=>c.period.substring(0,4)))].filter(Boolean).sort((a,b)=>b-a); if(!cYears.includes(cy)) cYears.push(cy);
        
        const yf = id('consumption-year-filter'); if(yf) { yf.innerHTML = cYears.map(y=>`<option value="${y}">${y}</option>`).join(''); yf.value = cy; }
        const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const mf = id('consumption-month-filter'); if(mf) { mf.innerHTML = months.map((m,i)=>`<option value="${i+1}">${m}</option>`).join(''); mf.value = cm; }
    }

    function renderHome() {
        const todayStr = new Date().toISOString().split('T')[0];
        const incoming = localInventory.filter(i => i.pendingOrder && i.pendingOrder.active && i.pendingOrder.expectedDate <= todayStr);
        const cont = id('home-incoming-orders'); if(!cont) return;
        
        if(incoming.length === 0) {
            cont.innerHTML = '<div class="col-span-full text-ios-textMuted text-sm bg-ios-cardHover p-4 rounded-xl text-center border border-ios-border">Nenhuma entrega prevista.</div>'; return;
        }
        
        const bySup = {}; incoming.forEach(i => { const sup = i.supplier || 'Diversos'; if(!bySup[sup]) bySup[sup] = []; bySup[sup].push(i); });
        
        let html = '';
        Object.keys(bySup).forEach(sup => {
            const items = bySup[sup]; const itemIds = JSON.stringify(items.map(x=>x.id));
            html += `<div class="bg-ios-cardHover p-4 rounded-xl border border-ios-blue shadow-lg shadow-ios-blue/10 cursor-pointer active:bg-ios-blue/20 sm:hover:bg-ios-blue/10 transition flex justify-between items-center btn-receive-incoming" data-ids='${itemIds}'>
                <div><h3 class="font-bold text-white text-base sm:text-lg"><i class="fa-solid fa-truck-fast text-ios-blue mr-2"></i>${sup}</h3><p class="text-[10px] sm:text-xs text-ios-textMuted mt-1">${items.length} item(ns) aguardando.</p></div>
                <i class="fa-solid fa-chevron-right text-ios-textMuted"></i>
            </div>`;
        });
        cont.innerHTML = html;
    }

    addEvt('home-incoming-orders', 'click', e => {
        const btn = e.target.closest('.btn-receive-incoming');
        if(btn) {
            const ids = JSON.parse(btn.dataset.ids);
            ids.forEach(idStr => {
                const item = localInventory.find(x=>x.id===idStr);
                if(item && !bulkEntryItems.some(b => b.productId === item.id)) {
                    bulkEntryItems.push({ productId: item.id, qty: item.pendingOrder.qty || 0, batchCode: 'LT-' + new Date().getTime().toString(36).toUpperCase() + Math.floor(Math.random()*1000), expiryDate: '', locationCode: '' });
                }
            });
            window.navTo('entry');
        }
    });

    function updateSidebarBadges() {
        const isPickingActive = localProductionOrders.some(op => op.picking?.status === 'em_andamento');
        const badgeProd = id('badge-nav-prod'); const badgePicking = id('badge-nav-picking');
        const badgePickingMobile = id('badge-nav-picking-mobile');
        if (isPickingActive) { 
            if(badgeProd) badgeProd.classList.remove('hidden'); 
            if(badgePicking) badgePicking.classList.remove('hidden'); 
            if(badgePickingMobile) badgePickingMobile.classList.remove('hidden');
        } else { 
            if(badgeProd) badgeProd.classList.add('hidden'); 
            if(badgePicking) badgePicking.classList.add('hidden'); 
            if(badgePickingMobile) badgePickingMobile.classList.add('hidden');
        }

        const lowStockItems = localInventory.filter(i => (i.minStock || 0) > 0 && (i.totalQuantity || 0) <= i.minStock);
        const quarentaECincoDias = new Date(); quarentaECincoDias.setDate(quarentaECincoDias.getDate() + 45);
        const expiringBatches = localBatches.filter(b => b.quantity > 0 && b.expiryDate && new Date(b.expiryDate) <= quarentaECincoDias);

        const totalAlerts = lowStockItems.length + expiringBatches.length;
        const badgeAlerts = id('badge-nav-alerts'); const badgeAlertsMobile = id('badge-nav-alerts-mobile');
        
        if (totalAlerts > 0) { 
            if(badgeAlerts) { badgeAlerts.innerText = totalAlerts; badgeAlerts.classList.remove('hidden'); }
            if(badgeAlertsMobile) { badgeAlertsMobile.innerText = totalAlerts > 99 ? '99+' : totalAlerts; badgeAlertsMobile.classList.remove('hidden'); }
        } else { 
            if(badgeAlerts) badgeAlerts.classList.add('hidden'); 
            if(badgeAlertsMobile) badgeAlertsMobile.classList.add('hidden');
        }

        const listAlerts = id('low-stock-list');
        if (listAlerts) {
            if(lowStockItems.length > 0) {
                listAlerts.innerHTML = lowStockItems.map(item => `
                    <li class="bg-ios-cardHover p-3 sm:p-4 rounded-xl border-l-4 border-l-ios-orange flex flex-col sm:flex-row justify-between sm:items-center gap-2 sm:gap-4 cursor-pointer hover:bg-ios-border transition alert-item" data-id="${item.id}">
                        <div><h4 class="font-bold text-white text-base sm:text-lg leading-tight">${item.name}</h4><p class="text-[10px] sm:text-xs text-ios-textMuted mt-1">C칩d: ${item.code || '-'} | Fornecedor: ${item.supplier || '-'}</p></div>
                        <div class="text-left sm:text-right bg-ios-bg sm:bg-transparent p-2 sm:p-0 rounded-lg"><p class="text-[9px] sm:text-[10px] uppercase text-ios-textMuted mb-0.5 sm:mb-1 font-bold">Atual / M칤nimo</p><p class="font-mono"><span class="text-ios-orange font-bold text-lg sm:text-xl">${(item.totalQuantity || 0).toFixed(2)}</span> <span class="text-ios-textMuted text-xs sm:text-sm">/ ${item.minStock.toFixed(2)}</span></p></div>
                    </li>
                `).join('');
            } else { listAlerts.innerHTML = '<li class="text-center text-ios-textMuted py-8 text-sm"><i class="fa-solid fa-check-circle text-3xl sm:text-4xl text-ios-green mb-2 sm:mb-3 block"></i>Todos acima do estoque m칤nimo.</li>'; }
        }

        const expList = id('expiring-list');
        if (expList) {
            if(expiringBatches.length > 0) {
                expList.innerHTML = expiringBatches.map(b => {
                    const p = localInventory.find(i => i.id === b.productId);
                    const diffTime = new Date(b.expiryDate) - new Date();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    let color = diffDays <= 7 ? 'text-ios-red' : 'text-ios-orange';
                    return `
                    <li class="bg-ios-cardHover p-3 sm:p-4 rounded-xl border-l-4 border-l-ios-red flex flex-col sm:flex-row justify-between sm:items-center gap-2 sm:gap-4 cursor-pointer hover:bg-ios-border transition alert-item" data-id="${p?.id}">
                        <div><h4 class="font-bold text-white text-base sm:text-lg leading-tight">${p?.name || 'Desconhecido'}</h4><p class="text-[10px] sm:text-xs text-ios-textMuted mt-1">Lote: ${b.code} | Qtd: ${b.quantity.toFixed(2)}</p></div>
                        <div class="text-left sm:text-right bg-ios-bg sm:bg-transparent p-2 sm:p-0 rounded-lg"><span class="font-bold ${color} text-base sm:text-lg">${diffDays} dias</span><br><span class="text-[10px] sm:text-xs text-ios-textMuted">${new Date(b.expiryDate+'T00:00:00').toLocaleDateString('pt-BR')}</span></div>
                    </li>`;
                }).join('');
            } else { expList.innerHTML = '<li class="text-center text-ios-textMuted py-8 text-sm">Nenhum lote vencendo nos pr칩ximos 45 dias.</li>'; }
        }
    }
    
    addEvt('btn-show-alerts', 'click', () => { show(id('low-stock-modal')); });
    addEvt('btn-show-alerts-mobile', 'click', () => { show(id('low-stock-modal')); });
    addEvt('low-stock-list', 'click', e => { const item = e.target.closest('.alert-item'); if (item) { hide(id('low-stock-modal')); window.navTo('inventory'); openDetails(item.dataset.id); } });
    addEvt('expiring-list', 'click', e => { const item = e.target.closest('.alert-item'); if (item) { hide(id('low-stock-modal')); window.navTo('inventory'); openDetails(item.dataset.id); } });

    // --- CONSULTA UNIVERSAL ---
    function searchUniversal(q) {
        if(!q) return window.showNotif("Digite ou leia um c칩digo v치lido", true);
        q = q.trim().toLowerCase();
        const resEl = id('consulta-results'); resEl.innerHTML = ''; let foundAny = false;
        
        const pMatches = localInventory.filter(i => (i.code && i.code.toLowerCase() === q) || (i.barcodes && i.barcodes.some(b => b.toLowerCase() === q)));
        if(pMatches.length > 0) {
            foundAny = true;
            pMatches.forEach(p => {
                const batches = localBatches.filter(b => b.productId === p.id && b.quantity > 0);
                let html = `<div class="card border-l-4 border-l-ios-blue mb-4"><h2 class="title-md text-ios-blue mb-1 text-sm sm:text-base"><i class="fa-solid fa-box mr-2"></i>Produto Encontrado</h2>
                    <p class="text-white font-bold text-xl sm:text-2xl mb-2 leading-tight">${p.name}</p>
                    <div class="grid grid-cols-2 gap-3 text-[10px] sm:text-sm text-ios-textMuted mb-6 bg-ios-bg p-3 sm:p-4 rounded-xl border border-ios-border">
                        <div><strong class="block uppercase">C칩d Interno</strong><span class="text-white">${p.code||'-'}</span></div>
                        <div class="break-all"><strong class="block uppercase">EANs</strong><span class="text-white">${p.barcodes?.join(', ')||'-'}</span></div>
                        <div><strong class="block uppercase">Estoque M칤n</strong><span class="text-ios-orange">${p.minStock||0}</span></div>
                        <div class="text-right bg-ios-blue/10 p-2 rounded-lg border border-ios-blue/20 -mt-2 -mr-2"><strong class="block uppercase">Saldo F칤sico</strong><span class="text-ios-blue font-bold text-xl">${(p.totalQuantity||0).toFixed(2)}</span></div>
                    </div>
                    <h3 class="text-xs sm:text-sm font-bold text-ios-textMuted uppercase mb-3">Lotes e Locais</h3>
                    <div class="table-container max-h-64 overflow-y-auto">
                        <table class="base-table min-w-[300px]"><thead class="base-thead"><tr><th class="base-th text-[10px] sm:text-xs">Lote/Local</th><th class="base-th text-[10px] sm:text-xs">Validade</th><th class="base-th text-right text-[10px] sm:text-xs">Qtd</th></tr></thead><tbody>`;
                batches.forEach(b => {
                    const locName = b.locationCode ? (localLocations.find(l=>l.code === b.locationCode)?.name || b.locationCode) : '-';
                    const exp = b.expiryDate ? new Date(b.expiryDate+'T00:00:00').toLocaleDateString('pt-BR') : '-';
                    html += `<tr class="base-tr"><td class="base-td font-medium text-white text-xs sm:text-sm">${b.code}<br><span class="text-[10px] text-ios-blue font-normal">${locName}</span></td><td class="base-td text-xs sm:text-sm">${exp}</td><td class="base-td text-right font-bold text-ios-green text-xs sm:text-sm">${b.quantity.toFixed(2)}</td></tr>`;
                });
                if(!batches.length) html += `<tr><td colspan="3" class="base-td text-center py-6 text-xs sm:text-sm">Sem lotes f칤sicos.</td></tr>`;
                html += `</tbody></table></div></div>`;
                resEl.innerHTML += html;
            });
        }

        const lMatches = localLocations.filter(l => l.code.toLowerCase() === q);
        if(lMatches.length > 0) {
            foundAny = true;
            lMatches.forEach(loc => {
                const locBatches = localBatches.filter(b => b.locationCode === loc.code && b.quantity > 0);
                let html = `<div class="card border-l-4 border-l-ios-green mb-4"><h2 class="title-md text-ios-green mb-1 text-sm sm:text-base"><i class="fa-solid fa-map-location-dot mr-2"></i>Endere칞o Encontrado</h2>
                    <p class="text-white font-bold text-xl sm:text-2xl mb-1">${loc.name}</p>
                    <p class="text-xs sm:text-sm text-ios-textMuted mb-6 bg-ios-bg inline-block px-3 py-1 rounded border border-ios-border font-mono">C칍DIGO: ${loc.code}</p>
                    <h3 class="text-xs sm:text-sm font-bold text-ios-textMuted uppercase mb-3">Itens Guardados</h3>
                    <div class="table-container max-h-64 overflow-y-auto">
                        <table class="base-table min-w-[300px]"><thead class="base-thead"><tr><th class="base-th text-[10px] sm:text-xs">Produto/Lote</th><th class="base-th text-right text-[10px] sm:text-xs">Qtd</th></tr></thead><tbody>`;
                locBatches.forEach(b => {
                    const prod = localInventory.find(i=>i.id === b.productId);
                    html += `<tr class="base-tr"><td class="base-td font-medium text-white text-xs sm:text-sm truncate max-w-[150px]">${prod?prod.name:'Desconhecido'}<br><span class="text-[10px] text-ios-textMuted font-normal">${b.code}</span></td><td class="base-td text-right font-bold text-ios-blue text-xs sm:text-sm">${b.quantity.toFixed(2)}</td></tr>`;
                });
                if(!locBatches.length) html += `<tr><td colspan="2" class="base-td text-center py-6 text-xs sm:text-sm">Endere칞o Vazio.</td></tr>`;
                html += `</tbody></table></div></div>`;
                resEl.innerHTML += html;
            });
        }

        if(!foundAny) {
            resEl.innerHTML = `<div class="card border border-ios-red/50 text-center py-10 bg-ios-red/5"><i class="fa-solid fa-circle-xmark text-4xl sm:text-5xl text-ios-red mb-3"></i><h2 class="title-md text-ios-red mb-1 text-base sm:text-lg">N칚o identificado!</h2><p class="text-xs sm:text-sm text-ios-textMuted max-w-md mx-auto">O c칩digo <strong>"${q}"</strong> n칚o corresponde a nenhum produto ou endere칞o.</p></div>`;
        }
    }

    addEvt('btn-consulta-search', 'click', () => { searchUniversal(id('consulta-input').value); });
    addEvt('btn-consulta-scan', 'click', () => { openScanner(code => { id('consulta-input').value = code; searchUniversal(code); }); });
    addEvt('consulta-input', 'keydown', e => { if(e.key==='Enter'){ e.preventDefault(); searchUniversal(e.target.value); id('consulta-input').blur(); } });

    // --- ESTOQUE GERAL ---
    addEvt('search-inventory', 'input', renderInv); addEvt('supplier-filter', 'change', renderInv); addEvt('type-filter', 'change', renderInv);
    document.querySelectorAll('#screen-inventory .table-header-sortable').forEach(th => { th.addEventListener('click', () => { if (invSort.col === th.dataset.sort) invSort.asc = !invSort.asc; else { invSort.col = th.dataset.sort; invSort.asc = true; } renderInv(); }); });
    
    function renderInv() {
        const tbody = id('inventory-table-body'); if(!tbody) return;
        const term = id('search-inventory')?.value.toLowerCase() || ''; const sup = id('supplier-filter')?.value || ''; const typ = id('type-filter')?.value || '';
        document.querySelectorAll('#screen-inventory .table-header-sortable').forEach(th => { const icon = th.querySelector('i'); if(icon) { if (th.dataset.sort === invSort.col) icon.className = invSort.asc ? 'fa-solid fa-sort-up ml-1 text-ios-blue' : 'fa-solid fa-sort-down ml-1 text-ios-blue'; else icon.className = 'fa-solid fa-sort ml-1 text-ios-textMuted'; } });
        let list = localInventory.filter(i => (i.name.toLowerCase().includes(term) || (i.barcodes && i.barcodes.some(b=>b.toLowerCase().includes(term)))) && (!sup || i.supplier === sup) && (!typ || i.type === typ));
        const getExp = item => localBatches.filter(bt=>bt.productId===item.id && bt.quantity>0 && bt.expiryDate).sort((x,y)=>new Date(x.expiryDate)-new Date(y.expiryDate))[0]?.expiryDate || '9999-12-31';
        list.sort((a,b) => { let valA, valB; if(invSort.col === 'name') { valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); } else if(invSort.col === 'supplier') { valA = (a.supplier||'').toLowerCase(); valB = (b.supplier||'').toLowerCase(); } else if(invSort.col === 'totalQuantity') { valA = a.totalQuantity||0; valB = b.totalQuantity||0; } else if(invSort.col === 'expiry') { valA = getExp(a); valB = getExp(b); } if(valA < valB) return invSort.asc ? -1 : 1; if(valA > valB) return invSort.asc ? 1 : -1; return 0; });
        if(!list.length) { tbody.innerHTML = `<tr><td colspan="5" class="base-td text-center text-ios-textMuted py-8">Nenhum item em estoque.</td></tr>`; return; }
        tbody.innerHTML = list.map(item => {
            const exp = getExp(item); const expFormat = exp !== '9999-12-31' ? new Date(exp+'T00:00:00').toLocaleDateString('pt-BR').substring(0,5) : '-'; // Shorter date for mobile
            const typeClass = item.type==='semi_acabado' ? 'bg-ios-orange/20 text-ios-orange border-ios-orange/30' : 'bg-gray-800 text-gray-300 border-gray-600';
            // Combined supplier/name for mobile
            return `<tr class="base-tr cursor-pointer" data-id="${item.id}">
                <td class="base-td text-white font-medium break-words max-w-[150px] sm:max-w-none">
                    ${item.name}
                    <div class="sm:hidden text-[10px] text-ios-textMuted mt-1">Forn: ${item.supplier || '-'}</div>
                    <div class="sm:hidden mt-1"><span class="badge border ${typeClass} text-[9px] px-1 py-0">${typeLabels[item.type] || 'Insumo'}</span></div>
                </td>
                <td class="base-td hidden sm:table-cell"><span class="badge border ${typeClass}">${typeLabels[item.type] || 'Insumo'}</span></td>
                <td class="base-td hidden md:table-cell text-ios-textMuted truncate max-w-[120px]">${item.supplier || '-'}</td>
                <td class="base-td text-right font-bold text-white text-base sm:text-sm">${(item.totalQuantity||0).toFixed(2)}</td>
                <td class="base-td text-ios-textMuted text-xs sm:text-sm">${expFormat}</td>
            </tr>`;
        }).join('');
    }
    
    addEvt('inventory-table-body', 'click', e => { const row = e.target.closest('tr'); if(row && row.dataset.id) openDetails(row.dataset.id); });

    addEvt('btn-export-excel', 'click', () => {
        if(!localInventory.length) return window.showNotif('Nenhum item para exportar.', true);
        const data = localInventory.map(i => ({ 'Produto': i.name, 'Tipo': typeLabels[i.type] || i.type, 'C칩d Interno': i.code || '-', 'Fornecedor': i.supplier || '-', 'Saldo F칤sico': i.totalQuantity || 0, 'Estoque M칤nimo': i.minStock || 0 }));
        const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Estoque"); XLSX.writeFile(wb, `Estoque_${new Date().toISOString().split('T')[0]}.xlsx`); window.showNotif('Exportado com sucesso!');
    });

    addEvt('hist-filter-start', 'change', renderItemDetailsHistory); addEvt('hist-filter-end', 'change', renderItemDetailsHistory); addEvt('hist-filter-type', 'change', renderItemDetailsHistory);
    addEvt('btn-clear-hist-filters', 'click', () => { if(id('hist-filter-start')) id('hist-filter-start').value = ''; if(id('hist-filter-end')) id('hist-filter-end').value = ''; if(id('hist-filter-type')) id('hist-filter-type').value = ''; renderItemDetailsHistory(); });

    function renderItemDetailsHistory() {
        const pId = currentHistoryProductId; if(!pId) return; const p = localInventory.find(i=>i.id===pId); if(!p) return;
        const cont = id('details-history-container'); if(!cont) return;
        let hist = localHistory.filter(h=>h.productId===pId).sort((a,b)=>new Date(b.date)-new Date(a.date));
        
        const start = id('hist-filter-start')?.value; const end = id('hist-filter-end')?.value; const type = id('hist-filter-type')?.value;
        if (start || end || type) show(id('btn-clear-hist-filters')); else hide(id('btn-clear-hist-filters'));
        if(start) hist = hist.filter(h => h.date >= start); if(end) hist = hist.filter(h => h.date <= end);
        if(type) { if(type === 'entrada') hist = hist.filter(h => h.type.includes('entrada')); else if(type === 'sa칤da') hist = hist.filter(h => h.type === 'sa칤da'); else hist = hist.filter(h => h.type === type); }
        
        if(!hist.length) { cont.innerHTML = '<div class="py-5 text-center text-ios-textMuted text-xs">Nenhuma movimenta칞칚o.</div>'; return; }
        cont.innerHTML = hist.map(h=>`<div class="py-3 border-b border-ios-border text-sm flex justify-between items-center hover:bg-ios-card transition-colors px-2 rounded"><div><span class="font-bold text-[10px] sm:text-xs uppercase ${h.type.includes('entrada')?'text-ios-green':h.type==='sa칤da'||h.type==='requisi칞칚o'?'text-ios-red':'text-ios-blue'}">${h.type}</span><p class="text-[10px] sm:text-xs text-ios-textMuted mt-1 w-32 sm:w-48 truncate" title="${h.reason||'Movimenta칞칚o'}">${h.reason||'Movimenta칞칚o'}</p></div><div class="text-right"><span class="font-bold text-white text-sm ${h.type.includes('entrada')?'':'text-ios-red'}">${h.type.includes('entrada')?'+':'-'} ${h.quantity.toFixed(2)}</span><br><span class="text-[9px] sm:text-[10px] text-ios-textMuted"><i class="fa-regular fa-calendar mr-1"></i>${new Date(h.date+'T00:00:00').toLocaleDateString('pt-BR')}</span></div></div>`).join('');
    }

    function openDetails(pId) {
        currentHistoryProductId = pId; const p = localInventory.find(i=>i.id===pId); if(!p) return;
        if(id('details-product-name')) id('details-product-name').innerText = p.name; 
        if(id('details-product-type-badge')) id('details-product-type-badge').innerText = typeLabels[p.type||'insumo']; 
        if(id('details-product-code')) id('details-product-code').innerText = p.code||'-'; 
        if(id('details-supplier')) id('details-supplier').innerText = p.supplier||'-'; 
        if(id('details-product-barcode')) id('details-product-barcode').innerText = p.barcodes?.join(', ')||'-'; 
        if(id('details-min-stock')) id('details-min-stock').innerText = (p.minStock||0).toFixed(2);
        if(id('details-total-quantity')) id('details-total-quantity').innerText = (p.totalQuantity||0).toFixed(2);
        
        if(id('edit-item-id')) id('edit-item-id').value = p.id; 
        if(id('edit-product-name')) id('edit-product-name').value = p.name; 
        if(id('edit-product-type')) id('edit-product-type').value = p.type||'insumo'; 
        if(id('edit-product-code')) id('edit-product-code').value = p.code||''; 
        if(id('edit-supplier')) id('edit-supplier').value = p.supplier||'';
        if(id('edit-product-barcode')) id('edit-product-barcode').value = p.barcodes?.join(', ')||'';
        if(id('edit-min-stock')) id('edit-min-stock').value = p.minStock||0;
        
        const is8110 = p.code === '8110';
        const batchesTable = id('details-batches-table');
        if(batchesTable) {
            batchesTable.innerHTML = localBatches.filter(b=>b.productId===pId && b.quantity>0).map(b=>{
                let statusHtml = `<span class="text-[10px] sm:text-xs text-ios-green font-bold"><i class="fa-solid fa-check mr-1 hidden sm:inline"></i>Lib</span>`;
                if(is8110) { statusHtml = `<div class="flex flex-col sm:flex-row items-center sm:gap-2"><input type="checkbox" class="toggle-status toggle-release-batch scale-75 sm:scale-100" data-bid="${b.id}" ${b.isReleased?'checked':''}><span class="text-[9px] sm:text-xs font-bold ${b.isReleased?'text-ios-green':'text-ios-orange'} w-12 sm:w-16 text-center sm:text-left mt-1 sm:mt-0">${b.isReleased?'Lib.':'Quar.'}</span></div>`; } 
                else if (b.isReleased === false) { statusHtml = `<div class="flex flex-col sm:flex-row items-center sm:gap-2"><input type="checkbox" class="toggle-status toggle-release-batch scale-75 sm:scale-100" data-bid="${b.id}"><span class="text-[9px] sm:text-xs font-bold text-ios-orange w-12 sm:w-16 text-center sm:text-left mt-1 sm:mt-0">Bloq.</span></div>`; }
                
                const locName = b.locationCode ? (localLocations.find(l=>l.code === b.locationCode)?.name || b.locationCode) : '-';
                
                return `<tr class="base-tr"><td class="base-td font-medium text-white text-xs sm:text-sm">${b.code}</td><td class="base-td">${statusHtml}</td><td class="base-td text-ios-textMuted text-[10px] sm:text-xs break-all">${locName}</td><td class="base-td font-bold text-ios-blue text-sm">${b.quantity.toFixed(2)}</td><td class="base-td text-center flex flex-nowrap justify-center gap-1 sm:gap-2"><button type="button" class="text-ios-blue hover:text-blue-400 p-1 sm:p-2 edit-batch-btn bg-ios-bg rounded-lg border border-ios-border" data-id="${b.id}"><i class="fa-solid fa-pen text-[10px] sm:text-sm"></i></button><button type="button" class="text-ios-red hover:text-red-400 p-1 sm:p-2 del-batch-btn bg-ios-bg rounded-lg border border-ios-border" data-id="${b.id}"><i class="fa-solid fa-trash text-[10px] sm:text-sm"></i></button></td></tr>`
            }).join('');
        }
        renderItemDetailsHistory(); show(id('item-details-view')); hide(id('item-details-edit')); show(id('item-details-modal'));
    }

    addEvt('details-batches-table', 'change', async e => {
        if(e.target.classList.contains('toggle-release-batch')) {
            const bId = e.target.dataset.bid; const b = await DB.get('batches', bId);
            if(b) { b.isReleased = e.target.checked; await DB.update('batches', b); window.showNotif(b.isReleased ? 'Lote Liberado' : 'Lote Bloqueado', !b.isReleased); await refreshData(); openDetails(id('edit-item-id').value); }
        }
    });

    addEvt('details-batches-table', 'click', e => {
        const delBtn = e.target.closest('.del-batch-btn');
        if(delBtn) showConfirmationModal('Excluir Lote?', 'Aten칞칚o: Apagar o lote remove a quantidade sem registrar sa칤da.', async () => { await DB.remove('batches', delBtn.dataset.id); await refreshData(); openDetails(id('edit-item-id').value); window.showNotif('Lote apagado'); });
        const editBtn = e.target.closest('.edit-batch-btn');
        if(editBtn) { const b = localBatches.find(x => x.id === editBtn.dataset.id); if(b) { if(id('edit-batch-id')) id('edit-batch-id').value = b.id; if(id('edit-batch-product-id')) id('edit-batch-product-id').value = b.productId; if(id('edit-batch-code')) id('edit-batch-code').value = b.code; if(id('edit-batch-qty')) id('edit-batch-qty').value = b.quantity; if(id('edit-batch-expiry')) id('edit-batch-expiry').value = b.expiryDate || ''; show(id('edit-batch-modal')); } }
    });

    addEvt('edit-batch-form', 'submit', async e => {
        e.preventDefault(); const bId = id('edit-batch-id')?.value; const pId = id('edit-batch-product-id')?.value;
        if(!bId || !pId) return;
        const b = await DB.get('batches', bId); if(b) { b.code = id('edit-batch-code').value; b.quantity = parseFloat(id('edit-batch-qty').value); b.expiryDate = id('edit-batch-expiry').value; await DB.update('batches', b); hide(id('edit-batch-modal')); await refreshData(); openDetails(pId); window.showNotif('Lote atualizado!'); }
    });

    addEvt('btn-edit-item', 'click', () => { hide(id('item-details-view')); show(id('item-details-edit')); }); 
    addEvt('btn-cancel-edit', 'click', () => { show(id('item-details-view')); hide(id('item-details-edit')); });
    
    addEvt('edit-item-form', 'submit', async e => { 
        e.preventDefault(); 
        show(id('loading-overlay'));
        try {
            const p = await DB.get('inventory', id('edit-item-id').value); 
            if(!p) return;
            p.name = id('edit-product-name').value; p.type = id('edit-product-type').value; p.code = id('edit-product-code').value; p.supplier = id('edit-supplier').value; 
            const barcodesStr = id('edit-product-barcode').value.trim();
            p.barcodes = barcodesStr ? barcodesStr.split(',').map(b=>b.trim()) : [];
            p.minStock = parseFloat(id('edit-min-stock').value) || 0;
            await DB.update('inventory', p); 
            await refreshData(); 
            openDetails(p.id); 
            window.showNotif('Atualizado!'); 
            hide(id('item-details-edit')); 
            show(id('item-details-view')); 
        } finally { hide(id('loading-overlay')); }
    });
    
    addEvt('btn-delete-item', 'click', () => { const pId = id('edit-item-id').value; showConfirmationModal('Excluir?', 'Hist칩rico e lotes ser칚o perdidos.', async () => { await DB.remove('inventory', pId); refreshData(); hide(id('item-details-modal')); window.showNotif('Exclu칤do'); }); });

    // --- NOVA ENTRADA ---
    addEvt('btn-scan-entry-code', 'click', () => { 
        openScanner(c => { 
            const inp = document.querySelector('#entry-searchable-container input'); 
            if(inp){ inp.value=c; inp.dispatchEvent(new Event('input')); } 
        }); 
    });

    addEvt('entry-form', 'submit', e => {
        e.preventDefault();
        const searchInput = document.querySelector('#entry-searchable-container input');
        const pId = searchInput ? searchInput.dataset.selectedId : null;
        if(!pId) return window.showNotif('Selecione um produto primeiro.', true);
        
        const qty = parseFloat(document.querySelector('#entry-form input[name="quantity"]').value);
        if(!qty || qty <= 0) return window.showNotif('Quantidade inv치lida.', true);

        const item = localInventory.find(i=>i.id===pId);
        if(item) {
            bulkEntryItems.push({
                productId: item.id, qty: qty, batchCode: 'LT-' + new Date().getTime().toString(36).toUpperCase().substring(4) + Math.floor(Math.random()*100), expiryDate: '', locationCode: ''
            });
            e.target.reset(); searchInput.value = ''; delete searchInput.dataset.selectedId; renderBulkEntry();
        }
    });

    function renderBulkEntry() {
        const tbody = id('bulk-entry-list'); if(!tbody) return;
        if(!bulkEntryItems.length) { tbody.innerHTML = '<tr><td colspan="6" class="base-td text-center text-ios-textMuted py-8">Nenhum item na lista. Busque e adicione acima.</td></tr>'; return; }

        tbody.innerHTML = bulkEntryItems.map((bItem, idx) => {
            const prod = localInventory.find(i=>i.id===bItem.productId);
            return `
            <tr class="base-tr" data-idx="${idx}">
                <td class="base-td font-medium text-white text-xs sm:text-sm whitespace-normal">
                    ${prod?.name || '?'}
                    ${prod?.pendingOrder?.active ? '<br><span class="badge bg-ios-blue text-white shadow shadow-ios-blue text-[8px] mt-1"><i class="fa-solid fa-truck-fast"></i> Pedido em Tr칙nsito</span>' : ''}
                </td>
                <td class="base-td"><input type="number" step="0.01" class="form-input py-1 px-1 sm:px-2 w-16 sm:w-20 bulk-qty text-xs sm:text-sm" value="${bItem.qty}"></td>
                <td class="base-td"><input type="text" class="form-input py-1 px-1 sm:px-2 w-20 sm:w-full bulk-batch font-mono text-[10px] sm:text-xs" value="${bItem.batchCode}"></td>
                <td class="base-td"><input type="date" class="form-input py-1 px-1 sm:px-2 w-28 sm:w-full bulk-exp text-xs" value="${bItem.expiryDate}"></td>
                <td class="base-td">
                    <div class="flex gap-1">
                        <input type="text" class="form-input py-1 px-1 sm:px-2 w-16 sm:w-full bulk-loc font-mono text-[10px] sm:text-xs" placeholder="RUA..." value="${bItem.locationCode}">
                        <button type="button" class="bg-ios-cardHover text-ios-blue px-2 rounded border border-ios-border btn-scan-bulk-loc shrink-0"><i class="fa-solid fa-camera"></i></button>
                    </div>
                </td>
                <td class="base-td text-center"><button type="button" class="text-ios-red hover:text-red-400 btn-remove-bulk p-2 bg-ios-cardHover rounded-lg"><i class="fa-solid fa-trash"></i></button></td>
            </tr>`;
        }).join('');
    }

    addEvt('bulk-entry-list', 'input', e => {
        const tr = e.target.closest('tr'); if(!tr) return; const idx = parseInt(tr.dataset.idx);
        if(e.target.classList.contains('bulk-qty')) bulkEntryItems[idx].qty = parseFloat(e.target.value) || 0;
        if(e.target.classList.contains('bulk-batch')) bulkEntryItems[idx].batchCode = e.target.value;
        if(e.target.classList.contains('bulk-exp')) bulkEntryItems[idx].expiryDate = e.target.value;
        if(e.target.classList.contains('bulk-loc')) bulkEntryItems[idx].locationCode = e.target.value;
    });

    addEvt('bulk-entry-list', 'click', e => {
        const tr = e.target.closest('tr'); if(!tr) return; const idx = parseInt(tr.dataset.idx);
        const btnRemove = e.target.closest('.btn-remove-bulk');
        if(btnRemove) { bulkEntryItems.splice(idx, 1); renderBulkEntry(); }
        const btnScanLoc = e.target.closest('.btn-scan-bulk-loc');
        if(btnScanLoc) { openScanner(c => { bulkEntryItems[idx].locationCode = c; renderBulkEntry(); }); }
    });

    addEvt('btn-save-bulk-entry', 'click', async () => {
        if(!bulkEntryItems.length) return window.showNotif('A lista est치 vazia.', true);
        for(let item of bulkEntryItems) {
            if(!item.qty || item.qty <= 0) return window.showNotif('Todas as quantidades devem ser maiores que 0.', true);
            if(!item.batchCode) return window.showNotif('Todos os itens precisam de um c칩digo de lote.', true);
        }
        show(id('loading-overlay'));
        try {
            const todayStr = new Date().toISOString().split('T')[0];
            for(let bItem of bulkEntryItems) {
                let p = await DB.get('inventory', bItem.productId); if(!p) continue;
                if(p.pendingOrder && p.pendingOrder.active) { p.pendingOrder.active = false; }
                p.totalQuantity += bItem.qty; await DB.update('inventory', p);
                if(bItem.locationCode) { const l = localLocations.find(loc => loc.code === bItem.locationCode); if(!l) await DB.add('locations', {code: bItem.locationCode, name: `Gerado Auto: ${bItem.locationCode}`}); }
                const isReleased = (p.code !== '8110');
                await DB.add('batches', {productId: p.id, code: bItem.batchCode, quantity: bItem.qty, expiryDate: bItem.expiryDate, isReleased: isReleased, locationCode: bItem.locationCode});
                await DB.add('history', {productId: p.id, batchCode: bItem.batchCode, type:'entrada', quantity: bItem.qty, date: todayStr, reason: `Entrada Massa`});
            }
            window.showNotif('Todas as entradas foram registradas com sucesso!'); bulkEntryItems = []; renderBulkEntry(); await refreshData();
        } catch(e) { window.showNotif('Erro cr칤tico ao salvar entradas.', true); } finally { hide(id('loading-overlay')); }
    });

    // --- BARRAS ---
    function renderBarcodesList() {
        const tb = id('barcodes-table-body'); if(!tb) return;
        const list = localInventory.filter(i => i.barcodes && i.barcodes.length > 0);
        if(!list.length) { tb.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-ios-textMuted">Nenhum c칩digo vinculado.</td></tr>'; return; }
        let html = '';
        list.forEach(i => {
            i.barcodes.forEach(b => {
                html += `<tr class="base-tr">
                    <td class="base-td font-medium text-white text-xs sm:text-sm whitespace-normal">${i.name}</td>
                    <td class="base-td text-xs sm:text-sm">${i.code || '-'}</td>
                    <td class="base-td font-mono text-ios-blue break-all text-[10px] sm:text-sm">${b}</td>
                    <td class="base-td text-center"><button type="button" class="btn-unlink-barcode text-ios-red bg-ios-red/10 px-3 py-1 rounded hover:bg-ios-red/20" data-pid="${i.id}" data-bcode="${b}"><i class="fa-solid fa-unlink"></i></button></td>
                </tr>`;
            });
        });
        tb.innerHTML = html;
    }

    addEvt('btn-scan-barcode', 'click', () => { openScanner(code => { id('barcode-input').value = code; window.showNotif("C칩digo lido com sucesso!"); }); });

    addEvt('barcode-form', 'submit', async (e) => {
        e.preventDefault();
        const searchInput = id('barcode-searchable-container')?.querySelector('input'); const pId = searchInput?.dataset?.selectedId; const bcode = id('barcode-input').value.trim();
        if(!pId || !bcode) return window.showNotif("Selecione o produto e informe o c칩digo", true);
        const p = await DB.get('inventory', pId);
        if(p) {
            if(!p.barcodes) p.barcodes = [];
            if(!p.barcodes.includes(bcode)) { p.barcodes.push(bcode); await DB.update('inventory', p); window.showNotif('C칩digo vinculado ao produto!'); } else { window.showNotif('Este c칩digo j치 est치 mapeado.', true); }
            e.target.reset(); searchInput.value=''; delete searchInput.dataset.selectedId; refreshData();
        }
    });

    addEvt('barcodes-table-body', 'click', async (e) => {
        const btn = e.target.closest('.btn-unlink-barcode');
        if(btn) {
            const pId = btn.dataset.pid; const bcodeToRemove = btn.dataset.bcode; const p = await DB.get('inventory', pId);
            if(p && p.barcodes) { p.barcodes = p.barcodes.filter(b => b !== bcodeToRemove); await DB.update('inventory', p); window.showNotif('V칤nculo removido'); refreshData(); }
        }
    });

    // --- COMPRAS ---
    addEvt('search-purchasing', 'input', renderPurchasing);

    function renderPurchasing() {
        const cont = id('purchasing-container'); if(!cont) return;
        const term = (id('search-purchasing')?.value || '').toLowerCase();
        const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); const startDateStr = thirtyDaysAgo.toISOString().split('T')[0];
        
        const consumptionMap = {};
        localHistory.filter(h => (h.type === 'sa칤da' || h.type === 'requisi칞칚o') && h.date >= startDateStr).forEach(h => { if(!consumptionMap[h.productId]) consumptionMap[h.productId] = 0; consumptionMap[h.productId] += h.quantity; });

        const suppliers = {};
        localInventory.filter(i => i.type !== 'semi_acabado').forEach(i => {
            const sup = i.supplier || 'Sem Fornecedor / Outros';
            if(term && !sup.toLowerCase().includes(term) && !i.name.toLowerCase().includes(term)) return;
            if(!suppliers[sup]) suppliers[sup] = [];
            const dailyAvg = (consumptionMap[i.id] || 0) / 30; const minStock = i.minStock || 0; const leadTime = i.leadTime || 0; const balance = i.totalQuantity || 0;
            let daysLeft = 999;
            if (dailyAvg > 0) daysLeft = Math.floor(balance / dailyAvg); else if (balance <= minStock && minStock > 0) daysLeft = 0;
            suppliers[sup].push({ ...i, dailyAvg, daysLeft, leadTime });
        });

        let html = '';
        Object.keys(suppliers).sort().forEach(sup => {
            const items = suppliers[sup].sort((a,b) => a.daysLeft - b.daysLeft);
            html += `<div class="card p-0 overflow-hidden mb-6">
                <div class="bg-ios-cardHover px-4 sm:px-5 py-3 border-b border-ios-border flex justify-between items-center">
                    <h2 class="font-bold text-base sm:text-lg text-white truncate pr-2"><i class="fa-solid fa-truck-field mr-2 text-ios-textMuted"></i>${sup}</h2>
                    <button type="button" class="btn-edit-sup text-ios-blue text-[10px] sm:text-xs bg-ios-blue/10 px-2 py-1 sm:px-3 sm:py-1 rounded-lg hover:bg-ios-blue/20 shrink-0"><i class="fa-solid fa-pen sm:mr-1"></i><span class="hidden sm:inline">Editar Prazo</span></button>
                </div>
                <div class="p-3 sm:p-5 grid grid-cols-1 gap-4">`;
            
            items.forEach(i => {
                const minStock = i.minStock || 0; const balance = i.totalQuantity || 0; const maxTank = Math.max(balance, minStock * 3, 1); 
                const fillPct = Math.min(100, (balance / maxTank) * 100); const minPct = Math.min(100, (minStock / maxTank) * 100);
                
                let tankColor = 'bg-ios-green'; let statusColor = 'bg-ios-green'; let statusText = 'Adequado';
                if(balance <= minStock) { tankColor = 'bg-ios-red'; statusColor = 'bg-ios-red'; statusText = 'Reserva'; } else if(balance <= minStock * 1.5) { tankColor = 'bg-ios-orange'; statusColor = 'bg-ios-orange'; statusText = 'Pedir'; }

                let orderHtml = `<button type="button" class="btn-primary py-2 px-3 text-xs w-full mt-3 btn-place-order" data-id="${i.id}"><i class="fa-solid fa-cart-plus mr-1"></i>Fazer Pedido</button>`;
                if(i.pendingOrder && i.pendingOrder.active) { orderHtml = `<div class="bg-ios-blue/20 border border-ios-blue text-ios-blue p-2 rounded-lg text-xs font-bold text-center mt-3 leading-tight"><i class="fa-solid fa-truck-fast mr-1"></i>Em Tr칙nsito<br><span class="font-normal text-[9px] text-white break-words">Chega: ${new Date(i.pendingOrder.expectedDate+'T00:00:00').toLocaleDateString('pt-BR')} (Qtd: ${i.pendingOrder.qty})</span></div>`; }

                html += `<div class="bg-ios-bg p-3 sm:p-4 rounded-xl border border-ios-border flex flex-col md:flex-row gap-3 sm:gap-4 items-center justify-between">
                    <div class="flex-1 w-full">
                        <div class="flex justify-between mb-1 gap-2">
                            <span class="font-bold text-white text-sm sm:text-base leading-tight">${i.name}</span>
                            <span class="text-[9px] sm:text-xs font-bold px-2 py-1 rounded ${statusColor}/20 text-${statusColor.split('-')[1]} uppercase shrink-0 h-max">${statusText}</span>
                        </div>
                        <div class="text-[10px] sm:text-xs text-ios-textMuted flex justify-between mt-2">
                            <div>Prazo Fornecedor: <strong class="text-ios-blue">${i.leadTime} dias</strong></div>
                            <div class="text-right">Dura aprox: <strong class="font-mono text-white">${i.daysLeft===999 ? '> 99 dias' : i.daysLeft + ' d'}</strong></div>
                        </div>
                        <div class="relative w-full h-5 sm:h-6 bg-ios-input rounded-full overflow-hidden border border-ios-border mt-3 shadow-inner">
                            <div class="absolute left-0 top-0 bottom-0 bg-ios-red/30" style="width: ${minPct}%"></div>
                            <div class="absolute left-0 top-0 bottom-0 ${tankColor} transition-all" style="width: ${fillPct}%"></div>
                            <div class="absolute top-0 bottom-0 border-r-2 border-dashed border-white z-10 drop-shadow-md" style="left: ${minPct}%;" title="Reserva (M칤nimo)"></div>
                            <div class="absolute inset-0 flex justify-between items-center px-2 sm:px-3 z-20 text-[9px] sm:text-[10px] font-bold text-white drop-shadow-md">
                                <span>0</span>
                                <span class="absolute" style="left: calc(${minPct}% - 12px);">M칈N</span>
                                <span class="absolute right-2 sm:right-3">${balance.toFixed(2)} Atual</span>
                            </div>
                        </div>
                    </div>
                    <div class="w-full md:w-40 shrink-0 border-t md:border-t-0 md:border-l border-ios-border pt-3 md:pt-0 md:pl-4">
                        <div class="flex md:flex-col justify-between items-center md:items-start">
                            <div><p class="text-[9px] sm:text-[10px] text-ios-textMuted uppercase mb-0.5">Consumo M칠dio</p><p class="text-sm sm:text-lg font-bold text-white">${i.dailyAvg.toFixed(2)} / dia</p></div>
                            <div class="w-32 md:w-full">${orderHtml}</div>
                        </div>
                    </div>
                </div>`;
            });
            html += `</div></div>`;
        });
        if(!html) html = '<p class="text-ios-textMuted text-center py-10">Nenhum insumo encontrado para gest칚o de compras.</p>'; cont.innerHTML = html;
    }

    addEvt('purchasing-container', 'click', e => {
        const editSupBtn = e.target.closest('.btn-edit-sup');
        if(editSupBtn) {
            const sup = editSupBtn.dataset.sup; const items = localInventory.filter(i => (i.supplier || 'Sem Fornecedor / Outros') === sup);
            const currentLead = items.length ? (items[0].leadTime || 0) : 0;
            id('edit-supplier-old-name').value = sup; id('edit-supplier-name').innerText = sup; id('edit-supplier-lead').value = currentLead; show(id('edit-supplier-modal'));
            return;
        }

        const btn = e.target.closest('.btn-place-order');
        if(btn) {
            const pId = btn.dataset.id; const p = localInventory.find(i=>i.id===pId);
            if(p) {
                id('order-product-id').value = p.id; id('order-product-name').innerText = p.name; id('order-qty').value = '';
                const expDate = addBusinessDays(new Date(), (p.leadTime || 0)); const expStr = expDate.toISOString().split('T')[0];
                id('order-date').value = expStr; id('order-date').dataset.estimated = expStr; show(id('place-order-modal'));
            }
        }
    });

    addEvt('edit-supplier-form', 'submit', async e => {
        e.preventDefault(); const supName = id('edit-supplier-old-name').value; const newLead = parseInt(id('edit-supplier-lead').value) || 0;
        show(id('loading-overlay'));
        try { const items = localInventory.filter(i => (i.supplier || 'Sem Fornecedor / Outros') === supName); for(let item of items) { item.leadTime = newLead; await DB.update('inventory', item); } hide(id('edit-supplier-modal')); await refreshData(); window.showNotif('Prazo do fornecedor atualizado!'); } finally { hide(id('loading-overlay')); }
    });

    addEvt('place-order-form', 'submit', async (e) => {
        e.preventDefault(); const pId = id('order-product-id').value; const qty = parseFloat(id('order-qty').value); const expDate = id('order-date').value; const estimatedDate = id('order-date').dataset.estimated;
        const executeOrder = async () => { show(id('loading-overlay')); try { const p = await DB.get('inventory', pId); if(p) { p.pendingOrder = { active: true, qty: qty, expectedDate: expDate }; await DB.update('inventory', p); window.showNotif('Pedido Registrado!'); hide(id('place-order-modal')); await refreshData(); } } finally { hide(id('loading-overlay')); } };
        if(expDate < estimatedDate) { showConfirmationModal("Aten칞칚o - Prazo Curto!", "A data informada 칠 MENOR que o prazo estimado em sistema para o fornecedor. Confirmar?", executeOrder); } else { executeOrder(); }
    });

    // --- LOCATIONS ---
    function searchLocation(code) {
        const loc = localLocations.find(l => l.code === code);
        if(loc) {
            id('loc-detail-name').innerText = loc.name; id('loc-detail-code').innerText = loc.code;
            const locBatches = localBatches.filter(b => b.locationCode === code && b.quantity > 0);
            const tb = id('loc-batches-body');
            tb.innerHTML = locBatches.map(b => {
                const prod = localInventory.find(i => i.id === b.productId);
                return `<tr class="base-tr"><td class="base-td font-medium text-white text-xs sm:text-sm whitespace-normal">${prod?prod.name:'?'}</td><td class="base-td text-xs sm:text-sm">${b.code}</td><td class="base-td font-bold text-xs sm:text-sm">${b.quantity.toFixed(2)}</td><td class="base-td text-center"><button type="button" class="btn-remove-batch-loc text-ios-red p-2 bg-ios-cardHover rounded-lg" data-id="${b.id}"><i class="fa-solid fa-minus-circle"></i></button></td></tr>`;
            }).join('');
            if(!locBatches.length) tb.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-ios-textMuted text-sm">Endere칞o Vazio</td></tr>`;
            id('add-loc-target-code').value = code;
            hide(id('location-empty-state')); hide(id('location-create-panel')); show(id('location-details-panel'));
        } else {
            id('loc-form-code').value = code; id('loc-form-name').value = '';
            hide(id('location-empty-state')); hide(id('location-details-panel')); show(id('location-create-panel'));
        }
    }

    addEvt('btn-search-location', 'click', () => { const c = id('location-search-input').value.trim(); if(c) searchLocation(c); else window.showNotif("Digite o c칩digo do local", true); });
    addEvt('btn-scan-location', 'click', () => { openScanner(code => { id('location-search-input').value = code; searchLocation(code); }); });
    addEvt('location-form', 'submit', async (e) => { e.preventDefault(); const code = id('loc-form-code').value; const name = id('loc-form-name').value; await DB.add('locations', {code, name}); window.showNotif('Endere칞o criado!'); await refreshData(); searchLocation(code); });
    addEvt('btn-cancel-loc', 'click', () => { hide(id('location-create-panel')); show(id('location-empty-state')); id('location-search-input').value=''; });
    addEvt('btn-delete-location', 'click', () => { const code = id('loc-detail-code').innerText; const loc = localLocations.find(l => l.code === code); if(loc) { showConfirmationModal("Excluir Local", "Deseja remover este endere칞o? Lotes continuar칚o existindo (mas sem local definido).", async () => { await DB.remove('locations', loc.id); window.showNotif('Local removido'); hide(id('location-details-panel')); show(id('location-empty-state')); id('location-search-input').value=''; refreshData(); }); } });
    addEvt('btn-edit-location', 'click', () => { const code = id('loc-detail-code').innerText; const name = id('loc-detail-name').innerText; id('edit-loc-old-code').value = code; id('edit-loc-new-code').value = code; id('edit-loc-new-name').value = name; show(id('edit-location-modal')); });
    addEvt('edit-location-form', 'submit', async (e) => {
        e.preventDefault(); const oldCode = id('edit-loc-old-code').value; const newCode = id('edit-loc-new-code').value.trim(); const newName = id('edit-loc-new-name').value.trim(); const loc = localLocations.find(l => l.code === oldCode); if(!loc) return;
        show(id('loading-overlay'));
        try { loc.code = newCode; loc.name = newName; await DB.update('locations', loc); if(oldCode !== newCode) { const batchesInLoc = localBatches.filter(b => b.locationCode === oldCode); for(const b of batchesInLoc) { b.locationCode = newCode; await DB.update('batches', b); } } window.showNotif('Endere칞o Atualizado!'); hide(id('edit-location-modal')); await refreshData(); searchLocation(newCode); } catch(err) { window.showNotif('Erro ao atualizar.', true); } finally { hide(id('loading-overlay')); }
    });
    addEvt('btn-add-batch-to-loc', 'click', () => { const ctn = id('add-loc-searchable-container'); createSearchableSelect(ctn, localInventory, 'Pesquise pelo Produto...', p => { const batches = localBatches.filter(b => b.productId === p.id && b.quantity > 0); const sel = id('add-loc-batch-select'); if(sel) { sel.innerHTML = '<option value="">Escolha um Lote...</option>' + batches.map(b => `<option value="${b.code}">${b.code} (Saldo: ${b.quantity.toFixed(2)})</option>`).join(''); } }); id('add-loc-batch-select').innerHTML = '<option value="">Aguardando produto...</option>'; show(id('modal-add-loc-batch')); });
    addEvt('add-loc-batch-form', 'submit', async (e) => { e.preventDefault(); const batchCode = id('add-loc-batch-select').value; const locCode = id('add-loc-target-code').value; const batch = localBatches.find(b => b.code === batchCode && b.quantity > 0); if(!batch) return window.showNotif('Selecione um lote v치lido', true); batch.locationCode = locCode; await DB.update('batches', batch); window.showNotif('Lote Mapeado!'); hide(id('modal-add-loc-batch')); await refreshData(); searchLocation(locCode); });
    addEvt('loc-batches-body', 'click', async (e) => { const btn = e.target.closest('.btn-remove-batch-loc'); if(btn) { const batch = await DB.get('batches', btn.dataset.id); if(batch) { batch.locationCode = ''; await DB.update('batches', batch); window.showNotif('Lote removido do local'); await refreshData(); searchLocation(id('loc-detail-code').innerText); } } });

    // --- RECEITAS / FICHAS ---
    function addIngRowReq(container, prefillId=null, prefillQty='') {
        if(!container) return; const div = document.createElement('div'); div.className='req-item flex flex-col gap-2 bg-ios-bg p-3 rounded-xl border border-ios-border z-50';
        div.innerHTML = `
            <div class="flex gap-2 sm:gap-3 items-center w-full">
                <div class="searchable-container flex-1"></div>
                <input type="number" step="0.0001" value="${prefillQty}" class="form-input w-20 sm:w-24 py-2 px-2 text-center req-qty-input font-bold text-sm" placeholder="Qtd" required>
                <button type="button" class="text-ios-red p-2 bg-ios-cardHover hover:bg-ios-red/20 rounded-lg transition-colors remove-ing shrink-0"><i class="fa fa-times"></i></button>
            </div>
            <div class="flex justify-between items-center text-[10px] sm:text-xs text-ios-textMuted px-1 req-plan-wrapper hidden mt-1 border-t border-ios-border pt-2 gap-2">
                <span class="plan-display font-medium leading-tight"></span>
                <button type="button" class="text-ios-blue open-batch-selector hidden bg-ios-card px-2 py-1 rounded shrink-0 whitespace-nowrap border border-ios-border"><i class="fa-solid fa-pen mr-1"></i> Mudar Lote</button>
            </div>
        `;
        container.appendChild(div); const isRecipe = container.id === 'ingredients-container'; const planWrap = div.querySelector('.req-plan-wrapper'); const planDisplay = div.querySelector('.plan-display'); const editBtn = div.querySelector('.open-batch-selector'); const qtyInput = div.querySelector('.req-qty-input');
        if(!isRecipe) planWrap.classList.remove('hidden'); 
        const updatePlan = () => {
            if(isRecipe) return;
            const inputS = div.querySelector('.searchable-container input'); const pId = inputS ? inputS.dataset.selectedId : null; const qty = parseFloat(qtyInput.value);
            if(pId && qty > 0) {
                const { plan, isSufficient } = getFIFOPlan(pId, qty); div.dataset.productId = pId; div.dataset.plan = JSON.stringify(plan);
                planDisplay.innerHTML = isSufficient ? '<i class="fa-solid fa-check mr-1"></i> ' + plan.map(x => `<strong>${x.batchCode}</strong>(${x.quantity.toFixed(2)})`).join(', ') : '<i class="fa-solid fa-triangle-exclamation mr-1"></i> Insuficiente/Bloqueado!';
                planDisplay.className = isSufficient ? 'plan-display text-ios-green' : 'plan-display text-ios-red'; if(isSufficient) show(editBtn); else hide(editBtn);
            } else { planDisplay.innerText = 'Aguardando item e qtd...'; hide(editBtn); }
        };
        createSearchableSelect(div.querySelector('.searchable-container'), localInventory, 'Buscar item...', item => { updatePlan(); }); qtyInput.addEventListener('input', updatePlan); div.querySelector('.remove-ing').addEventListener('click', () => div.remove());
        if(prefillId) { const ingProd = localInventory.find(p => p.id === prefillId); if(ingProd) { const inp = div.querySelector('.searchable-container input'); if(inp) { inp.value = ingProd.name; inp.dataset.selectedId = ingProd.id; updatePlan(); } } }
    }
    
    addEvt('add-requisition-item-btn', 'click', () => { const c = id('requisition-items-container'); if(c) addIngRowReq(c); });
    addEvt('btn-export-recipe-book', 'click', () => {
        if(!localRecipes.length) return window.showNotif('Nenhuma receita para exportar.', true);
        const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(16); doc.text('Livro de Fichas T칠cnicas', 14, 20); let y = 30;
        localRecipes.forEach((r, idx) => {
            if(y > 260) { doc.addPage(); y = 20; }
            doc.setFontSize(14); doc.setTextColor(10, 132, 255); doc.text(`${idx+1}. ${r.name} (${r.category})`, 14, y); y += 8;
            doc.setFontSize(10); doc.setTextColor(50, 50, 50); if(r.isSemi) { doc.text(`Rendimento Padr칚o: ${r.outputYield}`, 14, y); y += 6; }
            const ings = (r.ingredients||[]).map(i => { const p = localInventory.find(x=>x.id===i.productId); return [p?p.name:'Desconhecido', i.quantity]; });
            doc.autoTable({ startY: y, head: [['Insumo', 'Quantidade']], body: ings, margin: { left: 14 }, theme: 'grid', headStyles: { fillColor: [10, 132, 255] } });
            y = doc.lastAutoTable.finalY + 15;
        });
        doc.save(`Livro_Receitas_${new Date().toISOString().split('T')[0]}.pdf`); window.showNotif('Livro PDF exportado com sucesso!');
    });

    addEvt('search-recipe', 'input', renderRecipes);
    function renderRecipes() {
        const grid = id('recipes-grid'); if(!grid) return; const term = id('search-recipe')?.value.toLowerCase() || '';
        let f = localRecipes.filter(r => currentRecipeCategory==='Todos' || r.category===currentRecipeCategory); if(term) f = f.filter(r => r.name.toLowerCase().includes(term) || r.category.toLowerCase().includes(term));
        const catList = id('recipe-categories-list');
        if(catList) {
            catList.innerHTML = ['Todos', ...new Set(localRecipes.map(r=>r.category))].map(c => 
                `<li><a href="#" class="block p-2 sm:p-3 rounded-lg text-xs sm:text-sm text-ios-textMuted whitespace-nowrap sm:whitespace-normal bg-ios-bg sm:bg-transparent border sm:border-0 border-ios-border ${c===currentRecipeCategory?'!bg-ios-card text-white font-semibold !border-ios-blue':''}" data-cat="${c}">${c}</a></li>`
            ).join('');
        }
        grid.innerHTML = f.map(r => {
            const isSemi = r.isSemi; const ingredientsHTML = (r.ingredients || []).map(i=>`<li class="flex justify-between py-1 border-b border-ios-border/30 last:border-0"><span class="truncate pr-2">${localInventory.find(p=>p.id===i.productId)?.name||'?'}</span><span class="font-bold text-ios-blue bg-ios-bg px-2 rounded text-xs">${i.quantity}</span></li>`).join('');
            return `
            <div class="card relative flex flex-col border border-transparent ${isSemi ? 'border-ios-orange/30' : 'border-ios-cardHover'} transition-all">
                <div class="absolute top-3 right-3 flex gap-1 sm:gap-2">
                    <button type="button" class="edit-rec-btn text-ios-blue bg-ios-bg p-2 w-8 h-8 rounded-full hover:bg-ios-blue/20 flex items-center justify-center border border-ios-border" data-id="${r.id}"><i class="fa-solid fa-pen text-xs"></i></button>
                    <button type="button" class="del-rec-btn text-ios-red bg-ios-bg p-2 w-8 h-8 rounded-full hover:bg-ios-red/20 flex items-center justify-center border border-ios-border" data-id="${r.id}"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>
                <h3 class="text-base sm:text-lg font-bold text-white mb-1 pr-16 leading-tight">${r.name}</h3>
                <div class="mb-4 mt-1 inline-flex">
                    ${isSemi ? `<span class="bg-ios-orange/10 border border-ios-orange/50 text-ios-orange text-[10px] sm:text-xs px-2 py-1 rounded-md"><i class="fa-solid fa-box mr-1"></i>Semi-Acabado (Rende: ${r.outputYield||1})</span>` : `<span class="bg-gray-800 border border-gray-600 text-gray-300 text-[10px] sm:text-xs px-2 py-1 rounded-md"><i class="fa-solid fa-utensils mr-1"></i>Produto Acabado</span>`}
                </div>
                <div class="mt-auto border-t border-ios-border pt-3 sm:pt-4 bg-ios-bg -mx-4 sm:-mx-6 -mb-4 sm:-mb-6 px-4 sm:px-6 pb-4 sm:pb-6 rounded-b-2xl">
                    <p class="text-[9px] sm:text-[10px] text-ios-textMuted uppercase font-bold mb-2 sm:mb-3 tracking-wider"><i class="fa-solid fa-list-ul mr-1"></i> Ingredientes</p>
                    <ul class="text-xs sm:text-sm text-ios-textMuted">${ingredientsHTML}</ul>
                </div>
            </div>`;
        }).join('');
    }

    addEvt('recipe-categories-list', 'click', e => { if(e.target.tagName==='A') { e.preventDefault(); currentRecipeCategory = e.target.dataset.cat; renderRecipes(); }});
    addEvt('recipes-grid', 'click', e => { const delBtn = e.target.closest('.del-rec-btn'); const editBtn = e.target.closest('.edit-rec-btn'); if(delBtn) showConfirmationModal('Apagar Ficha?', 'Confirma a exclus칚o da receita?', async () => { await DB.remove('recipes', delBtn.dataset.id); refreshData(); window.showNotif('Exclu칤da'); }); if(editBtn) openEditRecipe(editBtn.dataset.id); });
    addEvt('recipe-is-semi', 'change', e => { if(e.target.checked) show(id('yield-wrapper')); else hide(id('yield-wrapper')); });

    function openEditRecipe(rId) {
        const r = localRecipes.find(x => x.id === rId); if(!r) return;
        if(id('edit-recipe-id')) id('edit-recipe-id').value = r.id; if(id('recipe-name')) id('recipe-name').value = r.name; if(id('recipe-category')) id('recipe-category').value = r.category;
        const chkSemi = id('recipe-is-semi'); if(chkSemi) { chkSemi.checked = !!r.isSemi; chkSemi.dispatchEvent(new Event('change')); }
        if(r.isSemi && id('recipe-yield')) id('recipe-yield').value = r.outputYield || 1; 
        const ingCont = id('ingredients-container'); if(ingCont) { ingCont.innerHTML = ''; (r.ingredients || []).forEach(ing => { addIngRowReq(ingCont, ing.productId, ing.quantity); }); }
        if(id('recipe-modal-title')) id('recipe-modal-title').innerHTML = '<i class="fa-solid fa-book-bookmark mr-3"></i>Editar Receita'; show(id('recipe-modal'));
    }

    addEvt('btn-new-recipe', 'click', () => {
        const rf = id('recipe-form'); if(rf) rf.reset(); if(id('edit-recipe-id')) id('edit-recipe-id').value=''; const ingCont = id('ingredients-container'); if(ingCont) ingCont.innerHTML=''; 
        const chkSemi = id('recipe-is-semi'); if(chkSemi) { chkSemi.checked = false; chkSemi.dispatchEvent(new Event('change')); }
        if(id('recipe-yield')) id('recipe-yield').value = 1; if(ingCont) addIngRowReq(ingCont); if(id('recipe-modal-title')) id('recipe-modal-title').innerHTML = '<i class="fa-solid fa-book-bookmark mr-3"></i>Nova Receita'; show(id('recipe-modal'));
    });
    
    addEvt('add-ingredient-btn', 'click', () => { const c = id('ingredients-container'); if(c) addIngRowReq(c); });
    
    addEvt('recipe-form', 'submit', async e => {
        e.preventDefault(); const rId = id('edit-recipe-id')?.value; const isSemi = id('recipe-is-semi')?.checked; const yieldQty = isSemi ? (parseFloat(id('recipe-yield')?.value) || 1) : null; const recName = id('recipe-name')?.value.trim();
        let outId = null; if (isSemi) { let prod = localInventory.find(i => i.name.toLowerCase() === recName.toLowerCase() && i.type === 'semi_acabado'); if(!prod) outId = await DB.add('inventory', { name: recName, type: 'semi_acabado', totalQuantity: 0, code: '', supplier: 'Produ칞칚o Interna' }); else outId = prod.id; } 
        const ingCont = id('ingredients-container'); if(!ingCont) return; const ings = [...ingCont.children].map(r => ({ productId: r.querySelector('input[type="text"]').dataset.selectedId, quantity: parseFloat(r.querySelector('input[type="number"]').value) }));
        const data = {name:recName, category:id('recipe-category')?.value, outputProductId:outId, outputYield: yieldQty, isSemi: isSemi, ingredients:ings};
        if(rId) { data.id = rId; await DB.update('recipes', data); window.showNotif('Ficha atualizada'); } else { await DB.add('recipes', data); window.showNotif('Ficha salva'); } hide(id('recipe-modal')); refreshData();
    });

    // --- PICKING E PRODU칂츾O ---
    function renderPickingScreen() {
        const container = id('picking-lines-container'); if(!container) return;
        const pendingOps = localProductionOrders.filter(po => po.status === 'pendente');
        if(!pendingOps.length) { container.innerHTML = `<div class="card text-center py-16"><i class="fa-solid fa-clipboard-check text-5xl sm:text-6xl text-ios-cardHover mb-4"></i><p class="text-ios-textMuted text-sm sm:text-base">N칚o h치 Ordens de Produ칞칚o pendentes.</p></div>`; return; }

        const opsByDate = {};
        pendingOps.forEach(op => { const date = op.date || 'Sem Data'; if(!opsByDate[date]) opsByDate[date] = {}; const line = op.recipeCategory || 'Diversos'; if(!opsByDate[date][line]) opsByDate[date][line] = []; opsByDate[date][line].push(op); });

        let finalHTML = '';
        Object.keys(opsByDate).sort().forEach(date => {
            const dateObj = new Date(date + 'T00:00:00'); const dateFormatted = isNaN(dateObj.getTime()) ? date : dateObj.toLocaleDateString('pt-BR');
            finalHTML += `<div class="mb-10"><h2 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-5 flex items-center border-b border-ios-border pb-3"><i class="fa-regular fa-calendar-check text-ios-blue mr-3"></i>Prog: ${dateFormatted}</h2><div class="space-y-4 sm:space-y-6">`;
            const opsByLine = opsByDate[date];
            finalHTML += Object.keys(opsByLine).sort().map(line => {
                const ops = opsByLine[line]; const concluidas = ops.filter(o => o.picking?.status === 'concluido').length; const emAndamento = ops.filter(o => o.picking?.status === 'em_andamento').length; const extrasPendentes = ops.filter(o => o.isExtra === true && o.picking?.status !== 'concluido'); const pct = ops.length > 0 ? (concluidas / ops.length) * 100 : 0;
                let lineStatusHTML = ''; let isLineActive = emAndamento > 0; let allConcluido = concluidas === ops.length;
                if(allConcluido) lineStatusHTML = `<span class="badge bg-ios-green/20 text-ios-green"><i class="fa-solid fa-check-double sm:mr-1"></i><span class="hidden sm:inline">Linha Separada</span></span>`; else if(isLineActive) lineStatusHTML = `<span class="badge bg-ios-blue/20 text-ios-blue animate-pulse"><i class="fa-solid fa-spinner fa-spin sm:mr-1"></i><span class="hidden sm:inline">Em Separa칞칚o</span></span>`; else lineStatusHTML = `<span class="badge bg-ios-orange/20 text-ios-orange"><i class="fa-solid fa-clock sm:mr-1"></i><span class="hidden sm:inline">A Separar</span></span>`;
                const opIdsStr = JSON.stringify(ops.map(o=>o.id));

                return `
                <div class="card p-0 overflow-hidden border ${isLineActive ? 'border-ios-blue' : 'border-ios-border'} transition-all ml-0 sm:ml-4">
                    <div class="bg-ios-cardHover px-4 sm:px-5 py-3 sm:py-4 flex flex-col gap-2 ${isLineActive ? 'bg-ios-blue/10' : ''}">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                            <div>
                                <h3 class="font-bold text-white text-lg sm:text-xl flex items-center flex-wrap gap-2">
                                    <span><i class="fa-solid fa-layer-group text-ios-blue mr-2"></i>Setor: ${line.toUpperCase()}</span>
                                    ${extrasPendentes.length > 0 ? `<span class="badge bg-ios-red text-white shadow shadow-ios-red">游뚿 ${extrasPendentes.length} EXTRA(s)</span>` : ''}
                                </h3>
                                <p class="text-[10px] sm:text-xs text-ios-textMuted mt-1">${ops.length} OP(s) nesta linha | ${concluidas} Separada(s)</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 sm:gap-4 w-full sm:w-auto">
                                ${lineStatusHTML}
                                ${extrasPendentes.length > 0 ? `<button type="button" class="btn-secondary py-2 px-3 sm:px-4 text-xs text-ios-red border-ios-red/50 hover:bg-ios-red/10 btn-print-extras flex-1 sm:flex-none" data-line="${line}"><i class="fa-solid fa-print sm:mr-1"></i><span class="hidden sm:inline">Imprimir Extras</span></button>` : ''}
                                ${!allConcluido ? `<button type="button" class="btn-primary py-2 px-3 sm:px-4 shadow-lg shadow-ios-blue/20 btn-open-line-picking text-sm flex-1 sm:flex-none" data-line="${line}" data-opids='${opIdsStr}'><i class="fa-solid fa-dolly mr-2"></i>Separar</button>` : ''}
                            </div>
                        </div>
                        <div class="w-full h-1.5 sm:h-2 bg-ios-bg rounded-full mt-2 overflow-hidden border border-ios-border"><div class="h-full bg-ios-green transition-all" style="width: ${pct}%"></div></div>
                    </div>
                    <div class="p-3 sm:p-4 bg-ios-bg grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-2 sm:gap-3 border-t border-ios-border/50">
                        ${ops.map(op => {
                            let statusIcon = op.picking?.status === 'concluido' ? '<span class="text-[10px] sm:text-xs text-ios-green font-bold"><i class="fa-solid fa-check mr-1"></i>OK</span>' : '<span class="text-[10px] sm:text-xs text-ios-textMuted"><i class="fa-solid fa-clock sm:mr-1"></i><span class="hidden sm:inline">Pendente</span></span>';
                            if(op.picking?.status === 'em_andamento') statusIcon = `<span class="text-[10px] sm:text-xs text-ios-blue font-bold animate-pulse"><i class="fa-solid fa-spinner fa-spin mr-1"></i>Andamento</span>`;
                            return `<div class="bg-ios-card p-2 sm:p-3 rounded-lg border border-ios-border text-xs sm:text-sm flex justify-between items-center relative overflow-hidden">${op.isExtra ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-ios-red"></div>' : ''}<div class="${op.isExtra ? 'pl-2' : ''} truncate pr-2"><span class="font-bold text-white">${op.recipeName}</span> <span class="text-ios-blue">(${op.multiplier}x)</span></div><div class="ml-1 shrink-0">${statusIcon}</div></div>`;
                        }).join('')}
                    </div>
                </div>`;
            }).join('');
            finalHTML += `</div></div>`;
        });
        container.innerHTML = finalHTML;
    }

    addEvt('picking-lines-container', 'click', e => {
        const btnPick = e.target.closest('.btn-open-line-picking'); if(btnPick) openGroupedPickingModal(btnPick.dataset.line, JSON.parse(btnPick.dataset.opids));
        const btnPrint = e.target.closest('.btn-print-extras'); if(btnPrint) printExtras(btnPrint.dataset.line);
    });

    function getAggregatedIngredients(opIds) {
        const ops = localProductionOrders.filter(op => opIds.includes(op.id)); const agg = {};
        ops.forEach(op => { op.ingredients.forEach(ing => { if (!agg[ing.productId]) agg[ing.productId] = { productId: ing.productId, adjustedQuantity: 0 }; agg[ing.productId].adjustedQuantity += ing.adjustedQuantity; }); });
        return Object.values(agg);
    }

    function printExtras(lineName) {
        const ops = localProductionOrders.filter(o => o.recipeCategory === lineName && o.status === 'pendente' && o.isExtra === true && o.picking?.status !== 'concluido');
        if(!ops.length) return window.showNotif('Nenhuma OP Extra pendente para imprimir.', true);
        const agg = {}; ops.forEach(op => { op.ingredients.forEach(ing => { if (!agg[ing.productId]) agg[ing.productId] = 0; agg[ing.productId] += ing.adjustedQuantity; }); });
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(20); doc.setTextColor(255, 69, 58); doc.text(`Folha de Separa칞칚o: EXTRAS / URGENTES`, 14, 20);
        doc.setFontSize(12); doc.setTextColor(50, 50, 55); doc.text(`Setor: ${lineName.toUpperCase()}`, 14, 28); doc.setFontSize(10); doc.setTextColor(150, 150, 150); doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')} | Inclui ${ops.length} OPs`, 14, 34); doc.setLineWidth(0.5); doc.line(14, 38, 196, 38);
        const tableData = Object.keys(agg).map(pidStr => { const pName = localInventory.find(p => p.id === pidStr)?.name || 'Desconhecido'; return [pName, agg[pidStr].toFixed(4)]; });
        doc.autoTable({ startY: 45, head: [['Insumo a Separar', 'Quantidade Total F칈SICA Necess치ria']], body: tableData, theme: 'striped', headStyles: { fillColor: [255, 69, 58], textColor: [255, 255, 255] }, alternateRowStyles: { fillColor: [255, 245, 245] }, margin: { left: 14, right: 14 } }); doc.save(`Separacao_Extras_${lineName.replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.pdf`); window.showNotif('Folha de Extras gerada para impress칚o!');
    }

    function openGroupedPickingModal(lineName, opIds) {
        activePickingLine = lineName; activePickingOpIds = opIds; const ops = localProductionOrders.filter(op => opIds.includes(op.id)); const sampleOp = ops[0];
        const picking = sampleOp.picking || { status: 'pendente', responsible: '', start: null, end: null, pickedItems: {} };

        const titleEl = id('picking-modal-title'); if(titleEl) titleEl.innerHTML = `<i class="fa-solid fa-dolly mr-2 sm:mr-3 text-xl sm:text-2xl"></i><span>Setor: ${lineName.toUpperCase()}</span>`;
        const subEl = id('picking-modal-subtitle'); if(subEl) subEl.innerText = `${ops.length} OP(s) unificadas.`;
        const respEl = id('picking-responsible'); if(respEl) respEl.value = picking.responsible || '';

        if(picking.status === 'em_andamento' && picking.start) { hide(id('picking-setup-view')); show(id('picking-active-view')); const actResp = id('picking-active-resp'); if(actResp) actResp.innerText = picking.responsible; } 
        else { show(id('picking-setup-view')); hide(id('picking-active-view')); if(respEl) respEl.focus(); }

        const aggregatedItems = getAggregatedIngredients(opIds); const checklistBody = id('picking-checklist-body');
        if(checklistBody) {
            checklistBody.innerHTML = aggregatedItems.map((ing) => {
                const product = localInventory.find(p => p.id === ing.productId); const needed = ing.adjustedQuantity; let totalPicked = 0;
                ops.forEach(op => { if(op.picking && op.picking.pickedItems && op.picking.pickedItems[ing.productId] !== undefined) totalPicked += op.picking.pickedItems[ing.productId]; });
                const hasPicked = ops.some(op => op.picking && op.picking.pickedItems && op.picking.pickedItems[ing.productId] !== undefined); const isChecked = hasPicked && totalPicked > 0;
                return `
                <tr class="border-b border-ios-border/50 hover:bg-ios-cardHover transition-colors ${isChecked ? 'opacity-50' : ''}" data-pid="${ing.productId}">
                    <td class="px-2 sm:px-6 py-3 sm:py-4 font-medium text-white text-xs sm:text-sm ${isChecked ? 'line-through text-ios-textMuted' : ''} max-w-[120px] sm:max-w-xs break-words">
                        ${product ? product.name : 'Insumo Exclu칤do'}
                        <div class="text-[9px] sm:text-[10px] text-ios-textMuted font-mono mt-1 break-all">EAN: ${product?.barcodes?.join(', ') || 'N/A'}</div>
                    </td>
                    <td class="px-2 sm:px-6 py-3 sm:py-4 text-right font-bold text-ios-blue text-sm sm:text-lg">${needed.toFixed(4)}</td>
                    <td class="px-2 sm:px-6 py-3 sm:py-4 text-center">
                        <div class="flex items-center justify-center gap-1 sm:gap-2 flex-col sm:flex-row">
                            <input type="number" step="0.001" value="${hasPicked ? totalPicked : ''}" class="form-input py-1 sm:py-2 px-1 sm:px-3 w-16 sm:w-28 text-center font-bold text-white picking-qty-input bg-ios-bg border-ios-border text-xs sm:text-lg" placeholder="0">
                            <button type="button" class="bg-ios-cardHover border border-ios-border p-2 sm:px-3 sm:py-2 rounded-lg hover:text-white btn-fill-all shadow" title="Preencher Total"><i class="fa-solid fa-check-double text-xs sm:text-base"></i></button>
                        </div>
                    </td>
                    <td class="px-2 sm:px-6 py-3 sm:py-4 text-center"><input type="checkbox" class="ui-checkbox ui-checkbox-success picking-row-check scale-75 sm:scale-100" ${isChecked ? 'checked' : ''}></td>
                </tr>`;
            }).join('');
        }
        show(id('picking-modal'));
    }

    addEvt('btn-start-picking', 'click', async () => {
        const respEl = id('picking-responsible'); const resp = respEl ? respEl.value.trim() : '';
        if(!resp) return window.showNotif('Informe o nome para iniciar.', true);
        const now = Date.now();
        for(let opId of activePickingOpIds) { let op = localProductionOrders.find(x => x.id === opId); if(op) { op.picking.status = 'em_andamento'; op.picking.start = now; op.picking.responsible = resp; await DB.update('productionOrders', op); } }
        hide(id('picking-setup-view')); show(id('picking-active-view')); const actResp = id('picking-active-resp'); if(actResp) actResp.innerText = resp; window.showNotif('Check-list Iniciado!'); refreshData(); 
    });

    addEvt('btn-picking-scan', 'click', () => {
        openScanner(code => {
            const prod = localInventory.find(p => p.code === code || (p.barcodes && p.barcodes.includes(code)));
            if (!prod) return window.showNotif('C칩digo n칚o reconhecido no sistema.', true);
            const row = document.querySelector(`#picking-checklist-body tr[data-pid="${prod.id}"]`);
            if (!row) return window.showNotif('Este item N츾O faz parte desta separa칞칚o!', true);
            pickingScanProductId = prod.id; id('picking-scan-qty-name').innerText = prod.name; id('picking-scan-qty').value = ''; show(id('picking-scan-qty-modal')); setTimeout(()=>id('picking-scan-qty').focus(), 100);
        });
    });

    addEvt('picking-scan-qty-form', 'submit', (e) => {
        e.preventDefault(); const qty = parseFloat(id('picking-scan-qty').value);
        if(qty > 0 && pickingScanProductId) {
            const row = document.querySelector(`#picking-checklist-body tr[data-pid="${pickingScanProductId}"]`);
            if(row) { const input = row.querySelector('.picking-qty-input'); const chk = row.querySelector('.picking-row-check'); input.value = qty.toFixed(4); chk.checked = true; row.classList.add('opacity-50'); row.cells[0].classList.add('line-through', 'text-ios-textMuted'); window.showNotif('Item marcado!'); }
        }
        hide(id('picking-scan-qty-modal'));
    });

    addEvt('picking-checklist-body', 'click', e => {
        const btnFill = e.target.closest('.btn-fill-all');
        if(btnFill) { const row = btnFill.closest('tr'); const neededStr = row.cells[1].innerText; const input = row.querySelector('.picking-qty-input'); const chk = row.querySelector('.picking-row-check'); if(input && chk) { input.value = parseFloat(neededStr).toFixed(4); chk.checked = true; } row.classList.add('opacity-50'); row.cells[0].classList.add('line-through', 'text-ios-textMuted'); }
        if(e.target.classList.contains('picking-row-check')) {
            const row = e.target.closest('tr');
            if(e.target.checked) { const input = row.querySelector('.picking-qty-input'); if(input && (!input.value || parseFloat(input.value) === 0)) input.value = parseFloat(row.cells[1].innerText).toFixed(4); row.classList.add('opacity-50'); row.cells[0].classList.add('line-through', 'text-ios-textMuted'); } 
            else { row.classList.remove('opacity-50'); row.cells[0].classList.remove('line-through', 'text-ios-textMuted'); }
        }
    });

    addEvt('btn-finish-picking', 'click', async () => {
        const pickedTotals = {}; let allChecked = true; const bodyEl = id('picking-checklist-body'); if(!bodyEl) return;
        bodyEl.querySelectorAll('tr').forEach(row => { const pid = row.dataset.pid; const input = row.querySelector('.picking-qty-input'); const qty = input ? (parseFloat(input.value) || 0) : 0; const chk = row.querySelector('.picking-row-check'); const isChecked = chk ? chk.checked : false; pickedTotals[pid] = qty; if(!isChecked || qty <= 0) allChecked = false; });
        const finishTask = async () => {
            const now = Date.now(); let opsToUpdate = localProductionOrders.filter(op => activePickingOpIds.includes(op.id));
            Object.keys(pickedTotals).forEach(pidStr => {
                const pid = pidStr; let remainingPicked = pickedTotals[pid];
                opsToUpdate.forEach(op => { const ing = op.ingredients.find(i => i.productId === pid); if(ing) { const take = Math.min(ing.adjustedQuantity, remainingPicked); if(!op.picking.pickedItems) op.picking.pickedItems = {}; op.picking.pickedItems[pid] = take; remainingPicked -= take; } });
                if (remainingPicked > 0 && opsToUpdate.length > 0) { const op = opsToUpdate.find(o => o.ingredients.some(i => i.productId === pid)); if (op) op.picking.pickedItems[pid] += remainingPicked; }
            });
            for(let op of opsToUpdate) { op.picking.end = now; op.picking.status = 'concluido'; op.picking.duration = Math.floor((op.picking.end - op.picking.start) / 1000); await DB.update('productionOrders', op); }
            hide(id('picking-modal')); await refreshData(); window.showNotif('Check-list Conclu칤do!');
        };
        if(!allChecked) showConfirmationModal('Existem pend칡ncias!', 'A Linha n칚o foi separada 100%. Deseja finalizar mesmo assim?', finishTask); else finishTask();
    });

    // --- ORDEM DE PRODU칂츾O ---
    addEvt('po-date', 'change', e => { const selectedDate = new Date(e.target.value); const diffDays = Math.ceil((selectedDate - new Date()) / (1000 * 60 * 60 * 24)); const extraChk = id('po-is-extra'); if (extraChk) extraChk.checked = diffDays <= 2; });
    addEvt('search-po-by-date', 'change', renderPO);
    function renderPO() {
        const dateInput = id('search-po-by-date'); if(!dateInput) return; const d = dateInput.value; const list = localProductionOrders.filter(po => po.date === d); const container = id('production-orders-list'); if(!container) return;
        if(!list.length) { container.innerHTML = `<div class="col-span-full text-center text-ios-textMuted py-10 bg-ios-card rounded-2xl border border-ios-border text-sm sm:text-base">Fila vazia nesta data.</div>`; return; }
        container.innerHTML = list.map(po => {
            const p = po.picking || { status: 'pendente' }; let pickBadge = '';
            if(p.status === 'concluido') pickBadge = `<span class="badge bg-ios-green/20 text-ios-green text-[9px] sm:text-[10px] mt-1 inline-block"><i class="fa-solid fa-dolly mr-1"></i>Separado (Qtd Real)</span>`; else if(p.status === 'em_andamento') pickBadge = `<span class="badge bg-ios-blue/20 text-ios-blue text-[9px] sm:text-[10px] mt-1 inline-block"><i class="fa-solid fa-spinner fa-spin mr-1"></i>Em Separa칞칚o</span>`; else pickBadge = `<span class="badge bg-ios-orange/20 text-ios-orange text-[9px] sm:text-[10px] mt-1 inline-block"><i class="fa-solid fa-clock mr-1"></i>A Separar</span>`;
            return `
            <div class="card relative flex flex-col pl-10 sm:pl-14 border-l-4 ${po.status==='pendente'?'border-l-ios-orange':'border-l-ios-green'}">
                <div class="absolute top-4 sm:top-5 left-2 sm:left-3"><input type="checkbox" class="ui-checkbox po-select-checkbox scale-75 sm:scale-100" data-id="${po.id}" ${po.status!=='pendente'?'disabled':''}></div>
                <div class="flex justify-between items-start mb-2 sm:mb-3">
                    <div>
                        <h3 class="text-white font-bold text-base sm:text-lg leading-tight pr-10 sm:pr-0">${po.recipeName} <span class="text-ios-blue">(${po.multiplier}x)</span></h3>
                        <p class="text-[10px] sm:text-xs text-ios-textMuted mt-1"><i class="fa-regular fa-calendar mr-1"></i>Prog: <strong class="text-white">${new Date(po.date+'T00:00:00').toLocaleDateString('pt-BR')}</strong></p>
                        ${pickBadge}
                    </div>
                    <span class="badge uppercase tracking-wider hidden sm:inline-block ${po.status==='pendente'?'bg-ios-orange/20 text-ios-orange':'bg-ios-green/20 text-ios-green'}">${po.status}</span>
                </div>
                <div class="bg-ios-bg rounded-lg p-2 sm:p-3 mt-auto border border-ios-border">
                    <p class="text-[9px] sm:text-[10px] text-ios-textMuted uppercase font-bold mb-1 sm:mb-2">Desconto F칤sico Necess치rio</p>
                    <ul class="text-xs sm:text-sm text-gray-300 space-y-1">${(po.ingredients || []).map(i=>{
                        const pName = localInventory.find(pd=>pd.id===i.productId)?.name||'?'; let actualDisplay = i.adjustedQuantity.toFixed(4); let isDiff = false;
                        if(po.picking?.status === 'concluido' && po.picking.pickedItems && po.picking.pickedItems[i.productId] !== undefined) { actualDisplay = po.picking.pickedItems[i.productId].toFixed(4); if(Math.abs(po.picking.pickedItems[i.productId] - i.adjustedQuantity) > 0.001) isDiff = true; }
                        const pLotes = (i.consumptionPlan||[]).map(x=>x.batchCode).join(', ') || 'PEPS Autom치tico (Ou Real)';
                        return `<li class="flex flex-col border-b border-ios-border/50 pb-1 sm:pb-2 mb-1 sm:mb-1 last:border-0 last:pb-0 last:mb-0"><div class="flex justify-between gap-2"><span class="truncate text-xs">${pName}</span><span class="font-bold shrink-0 text-xs sm:text-sm ${isDiff ? 'text-ios-orange' : 'text-ios-blue'}">${actualDisplay}</span></div><span class="text-[8px] sm:text-[10px] text-ios-textMuted mt-0.5"><i class="fa-solid fa-box mr-1"></i>${pLotes}</span></li>`;
                    }).join('')}</ul>
                </div>
                ${po.status==='pendente'?`<div class="absolute bottom-3 right-3 flex gap-2"><button type="button" class="del-po-btn text-ios-red bg-ios-red/10 w-8 h-8 rounded-full hover:bg-ios-red/20 flex items-center justify-center border border-ios-border" data-id="${po.id}"><i class="fa-solid fa-trash text-[10px] sm:text-xs"></i></button></div>`:''}
            </div>`
        }).join('');
    }
    
    addEvt('production-orders-list', 'click', e => { const delBtn = e.target.closest('.del-po-btn'); if(delBtn) showConfirmationModal('Cancelar OP?', 'Remover a ordem da fila?', async () => { await DB.remove('productionOrders', delBtn.dataset.id); refreshData(); window.showNotif('OP Exclu칤da'); }); });

    function updatePOIngredients() {
        const searchInput = id('po-recipe-searchable-container')?.querySelector('input'); if(!searchInput) return; const rId = searchInput.dataset.selectedId; const rec = localRecipes.find(r=>r.id===rId); 
        const qtyEl = id('po-quantity'); const mult = qtyEl ? (parseFloat(qtyEl.value) || 1) : 1; const bodyEl = id('po-ingredients-body'); const outEl = id('po-total-output');
        if(!rec) { if(bodyEl) bodyEl.innerHTML = ''; if(outEl) outEl.value = '0.0000'; return; }
        if (rec.isSemi) { if(outEl) outEl.value = ((rec.outputYield || 1) * mult).toFixed(4); } else { if(outEl) outEl.value = '-'; }
        if(bodyEl) {
            bodyEl.innerHTML = (rec.ingredients || []).map(i => {
                const p = localInventory.find(x=>x.id===i.productId); const reqQty = i.quantity * mult; const { plan, isSufficient } = getFIFOPlan(i.productId, reqQty);
                const planText = plan.map(x => `<strong>${x.batchCode}</strong>(${x.quantity.toFixed(2)})`).join(', ');
                return `<tr class="base-tr" data-product-id="${i.productId}" data-plan='${JSON.stringify(plan)}'>
                    <td class="base-td font-medium text-white text-xs sm:text-sm whitespace-normal break-words">${p?p.name:'?'}</td><td class="base-td text-xs sm:text-sm hidden sm:table-cell">${(p?.totalQuantity||0).toFixed(2)}</td>
                    <td class="base-td"><input type="number" value="${reqQty.toFixed(4)}" class="form-input py-1 px-1 sm:px-2 text-center font-bold text-ios-blue po-ing-qty bg-ios-bg border-ios-border text-xs sm:text-sm w-16 sm:w-full" readonly></td>
                    <td class="base-td text-ios-textMuted text-[10px] sm:text-xs whitespace-normal"><div class="plan-display ${isSufficient ? 'text-ios-green' : 'text-ios-red font-bold'}">${isSufficient ? '<i class="fa-solid fa-check mr-1 hidden sm:inline"></i>'+planText : '<i class="fa-solid fa-triangle-exclamation mr-1"></i>Falta/Bloqueado'}</div>
                        ${isSufficient ? `<button type="button" class="text-ios-blue mt-1 sm:mt-2 open-batch-selector bg-ios-bg p-1 rounded border border-ios-border"><i class="fa-solid fa-pen sm:mr-1"></i><span class="hidden sm:inline"> Trocar Lote</span></button>` : ''}
                    </td></tr>`;
            }).join('');
        }
    }

    addEvt('po-quantity', 'input', updatePOIngredients);
    addEvt('btn-new-production-order', 'click', () => {
        const form = id('production-order-form'); if(form) form.reset(); const bodyEl = id('po-ingredients-body'); if(bodyEl) bodyEl.innerHTML = '';
        const mappedRecipes = localRecipes.map(r => { return { ...r, searchName: `${r.name}` }; }); const cont = id('po-recipe-searchable-container');
        if(cont) { createSearchableSelect(cont, mappedRecipes, 'Busque pela receita...', r => { if(r.isSemi) { show(id('po-output-fields')); const d = id('po-date')?.value.replace(/-/g,'').slice(2); if(id('po-output-batch')) id('po-output-batch').value = `OP${d}-${r.id.substring(0,4)}`; } else hide(id('po-output-fields')); updatePOIngredients(); }); }
        const d = new Date(); d.setDate(d.getDate() + 2); if(id('po-date')) id('po-date').value = d.toISOString().split('T')[0]; const extraChk = id('po-is-extra'); if (extraChk) extraChk.checked = false; hide(id('po-output-fields')); show(id('production-order-modal'));
    });
    
    addEvt('production-order-form', 'submit', async e => {
        e.preventDefault(); const searchInput = id('po-recipe-searchable-container')?.querySelector('input'); if(!searchInput) return;
        const rId = searchInput.dataset.selectedId; const rec = localRecipes.find(r=>r.id===rId); if(!rec) return window.showNotif('Receita inv치lida', true);
        const mult = parseFloat(id('po-quantity')?.value || 1); const totalOut = rec.isSemi ? parseFloat(id('po-total-output')?.value || 0) : null;
        const bodyEl = id('po-ingredients-body'); if(!bodyEl) return;
        const ingredients = [...bodyEl.children].map(tr => { return { productId: tr.dataset.productId, adjustedQuantity: parseFloat(tr.querySelector('.po-ing-qty').value), consumptionPlan: JSON.parse(tr.dataset.plan || '[]') }; });
        for(const ing of ingredients) { const sumPlan = ing.consumptionPlan.reduce((s, x) => s + x.quantity, 0); if(sumPlan < ing.adjustedQuantity - 0.001) return window.showNotif(`Insumo insuficiente para OP.`, true); }
        const op = { recipeId: rId, recipeName: rec.name, recipeCategory: rec.category, date: id('po-date')?.value, multiplier: mult, quantityProduced: totalOut, status: 'pendente', outputBatch: rec.isSemi ? id('po-output-batch')?.value : null, ingredients: ingredients, isExtra: id('po-is-extra')?.checked || false, picking: { status: 'pendente', responsible: '', start: null, end: null, duration: 0, pickedItems: {} } };
        await DB.add('productionOrders', op); window.showNotif('OP salva na fila!'); hide(id('production-order-modal')); refreshData();
    });

    addEvt('btn-confirm-production', 'click', async () => {
        const checked = document.querySelectorAll('.po-select-checkbox:checked'); if(!checked.length) return window.showNotif('Selecione pelo menos uma OP!', true);
        const selectedIds = Array.from(checked).map(cb => cb.dataset.id); const pendentes = localProductionOrders.filter(po => selectedIds.includes(po.id) && po.status === 'pendente'); if(!pendentes.length) return;
        const opsNaoSeparadas = pendentes.filter(po => po.picking && po.picking.status !== 'concluido'); let warnMsg = ''; if(opsNaoSeparadas.length > 0) { warnMsg = `<p class="text-ios-red mb-3 font-bold text-xs sm:text-sm"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Aten칞칚o: ${opsNaoSeparadas.length} OP(s) ainda N츾O tiveram a separa칞칚o conclu칤da!</p>`; }
        showConfirmationModal('Executar Baixa', `${warnMsg}Gerar baixas de <strong>${pendentes.length} OP(s)</strong> baseadas nas quantidades reais de separa칞칚o?`, async () => {
            show(id('loading-overlay'));
            try {
                for(const op of pendentes) {
                    for(const ing of op.ingredients) {
                        let actualQty = ing.adjustedQuantity; if(op.picking?.status === 'concluido' && op.picking.pickedItems && op.picking.pickedItems[ing.productId] !== undefined) { actualQty = op.picking.pickedItems[ing.productId]; }
                        if(actualQty > 0) { const product = await DB.get('inventory', ing.productId); if(!product || (product.totalQuantity || 0) < actualQty - 0.001) throw new Error(`Sem saldo suficiente: ${product ? product.name : 'Insumo'} (Requer ${actualQty.toFixed(2)}).`); const checkFIFO = getFIFOPlan(ing.productId, actualQty); if(!checkFIFO.isSufficient) throw new Error(`Lotes insuficientes/bloqueados para ${product.name}!`); }
                    }
                }
                for(const op of pendentes) {
                    for(const ing of op.ingredients) {
                        let actualQty = ing.adjustedQuantity; if(op.picking?.status === 'concluido' && op.picking.pickedItems && op.picking.pickedItems[ing.productId] !== undefined) { actualQty = op.picking.pickedItems[ing.productId]; }
                        if(actualQty > 0) {
                            const product = await DB.get('inventory', ing.productId); const freshFIFO = getFIFOPlan(ing.productId, actualQty);
                            for(const pl of freshFIFO.plan) { const b = await DB.get('batches', pl.batchId); b.quantity -= pl.quantity; await DB.update('batches', b); }
                            product.totalQuantity -= actualQty; await DB.update('inventory', product); await DB.add('history', { productId: product.id, type: 'sa칤da', quantity: actualQty, date: op.date, reason: `Prod: OP-${op.id.substring(0,4)}` });
                            const p = op.date.substring(0,7); let consumptions = await DB.getAll('monthlyConsumption'); let record = consumptions.find(x => x.period === p && x.productId === product.id);
                            if(record) { record.totalConsumed += actualQty; record.id = record.id; await DB.update('monthlyConsumption', record); } else await DB.add('monthlyConsumption', { period: p, productId: product.id, totalConsumed: actualQty });
                        }
                    }
                    if(op.quantityProduced) {
                        const rec = localRecipes.find(r => r.id === op.recipeId);
                        if(rec && rec.outputProductId) {
                            const outProduct = await DB.get('inventory', rec.outputProductId);
                            if(outProduct) { outProduct.totalQuantity += op.quantityProduced; await DB.update('inventory', outProduct); const lote = op.outputBatch || `OP-${op.id.substring(0,4)}`; await DB.add('batches', { productId: rec.outputProductId, code: lote, quantity: op.quantityProduced, expiryDate: op.outputExpiry||null, isReleased: true }); await DB.add('history', { productId: rec.outputProductId, batchCode: lote, type: 'entrada', quantity: op.quantityProduced, date: op.date, reason: `Gerado OP-${op.id.substring(0,4)}` }); }
                        }
                    }
                    op.status = 'concluido'; await DB.update('productionOrders', op);
                }
                window.showNotif('Sucesso! Movimenta칞칫es baseadas nas qtds reais.'); 
            } catch(e) { window.showNotif(e.message || 'Erro cr칤tico', true); } finally { hide(id('loading-overlay')); await refreshData(); }
        });
    });

    // --- REQUISICOES AVULSAS ---
    addEvt('requisition-form', 'submit', async e => {
        e.preventDefault(); const reason = id('requisition-reason')?.value; const resp = id('requisition-responsible')?.value;
        const reqCont = id('requisition-items-container'); if(!reqCont) return;
        const ings = [...reqCont.children].map(r => ({ productId: r.dataset.productId, quantity: parseFloat(r.querySelector('.req-qty-input').value), plan: JSON.parse(r.dataset.plan || '[]') }));
        if(ings.some(i=>!i.productId || isNaN(i.quantity) || !i.plan.length)) return window.showNotif('Preencha quantidades e verifique se h치 f칤sico.', true);
        show(id('loading-overlay'));
        try {
            for(const i of ings) {
                const p = await DB.get('inventory', i.productId); let sumPlan = i.plan.reduce((s, x) => s + x.quantity, 0);
                if(sumPlan < i.quantity - 0.001) throw new Error(`Sem saldo suficiente ou bloqueado: ${p.name}`);
                for(const pl of i.plan) { const b = await DB.get('batches', pl.batchId); b.quantity -= pl.quantity; await DB.update('batches', b); }
                p.totalQuantity -= i.quantity; await DB.update('inventory', p); await DB.add('history', { productId: p.id, type: 'requisi칞칚o', quantity: i.quantity, date: new Date().toISOString().split('T')[0], reason: reason, responsible: resp }); 
            }
            window.showNotif('Requisi칞칚o processada!'); e.target.reset(); reqCont.innerHTML=''; await refreshData();
        } catch (err) { window.showNotif(err.message, true); } finally { hide(id('loading-overlay')); }
    });

    // --- CONSUMO ---
    ['search-consumption', 'consumption-month-filter', 'consumption-year-filter'].forEach(el => { addEvt(el, el === 'search-consumption' ? 'input' : 'change', renderConsum); });
    function renderConsum() {
        const p = `${id('consumption-year-filter')?.value}-${String(id('consumption-month-filter')?.value).padStart(2,'0')}`; const term = id('search-consumption')?.value.toLowerCase() || '';
        let list = localMonthlyConsumption.filter(c => c.period === p); if(term) list = list.filter(c => localInventory.find(i=>i.id===c.productId)?.name.toLowerCase().includes(term));
        const tbody = id('consumption-table-body'); if(!tbody) return; if(!list.length) return tbody.innerHTML = `<tr><td colspan="2" class="base-td text-center border-none py-10 text-sm">Nada registrado.</td></tr>`;
        tbody.innerHTML = list.map(c => `<tr class="base-tr"><td class="base-td text-white text-xs sm:text-sm whitespace-normal">${localInventory.find(i=>i.id===c.productId)?.name||'?'}</td><td class="base-td text-right font-bold text-ios-blue text-sm">${c.totalConsumed.toFixed(2)}</td></tr>`).join('');
    }

    // --- AJUSTES MANUAIS ---
    addEvt('adjustment-form', 'submit', async e => {
        e.preventDefault(); const bId = id('adjustment-batch')?.value; const newQtd = parseFloat(id('adjustment-new-quantity')?.value); if(!bId || isNaN(newQtd)) return;
        try { const batch = await DB.get('batches', bId); batch.quantity = newQtd; await DB.update('batches', batch); await DB.add('history', { productId: batch.productId, type: 'ajuste', quantity: newQtd, date: new Date().toISOString().split('T')[0], reason: id('adjustment-reason')?.value, responsible: id('adjustment-responsible')?.value }); window.showNotif('Lote ajustado com sucesso'); e.target.reset(); await refreshData(); } catch(err) { window.showNotif('Erro no ajuste', true); }
    });

    document.addEventListener('click', e => {
        const btn = e.target.closest('.open-batch-selector');
        if(btn) { currentBatchTarget = btn.closest('.req-item') || btn.closest('tr'); const pId = currentBatchTarget.dataset.productId; const qtyStr = currentBatchTarget.querySelector('input[type="number"]').value; const qty = parseFloat(qtyStr) || 0; const currentPlan = JSON.parse(currentBatchTarget.dataset.plan || '[]'); openBatchSelector(pId, qty, currentPlan); }
    });

    function openBatchSelector(pId, qtyNeeded, currentPlan) {
        if(id('batch-selector-needed')) id('batch-selector-needed').innerText = qtyNeeded.toFixed(4); const batches = localBatches.filter(b => b.productId === pId && b.quantity > 0 && b.isReleased !== false); const listEl = id('batch-selector-list');
        if(listEl) {
            listEl.innerHTML = batches.map(b => {
                const inPlan = currentPlan.find(p => p.batchId === b.id); const val = inPlan ? inPlan.quantity : '';
                return `<div class="flex justify-between items-center mb-2 sm:mb-3 bg-ios-input p-2 sm:p-3 rounded-xl border border-ios-border"><span class="text-white font-medium text-xs sm:text-sm"><i class="fa-solid fa-box mr-1 sm:mr-2 text-ios-textMuted"></i>${b.code} <br><span class="text-[9px] sm:text-[10px] text-ios-textMuted ml-4 sm:ml-6">Disp: ${b.quantity.toFixed(2)}</span></span><input type="number" class="form-input w-20 sm:w-28 text-right batch-input font-bold text-xs sm:text-sm py-2 px-2" data-bid="${b.id}" data-bcode="${b.code}" max="${b.quantity + (inPlan?inPlan.quantity:0)}" value="${val}" placeholder="0"></div>`;
            }).join('');
        }
        updateBatchSelectorSum(); show(id('batch-selector-modal'));
    }

    addEvt('batch-selector-list', 'input', updateBatchSelectorSum);
    function updateBatchSelectorSum() {
        if(event && event.target.classList.contains('batch-input')) {
            const listEl = id('batch-selector-list'); if(!listEl) return;
            const inputs = [...listEl.querySelectorAll('.batch-input')]; const sum = inputs.reduce((a, b) => a + (parseFloat(b.value) || 0), 0);
            const selEl = id('batch-selector-selected'); const needEl = id('batch-selector-needed');
            if(selEl && needEl) { selEl.innerText = sum.toFixed(4); const needed = parseFloat(needEl.innerText); selEl.className = Math.abs(sum - needed) < 0.001 ? 'font-bold text-base sm:text-lg text-ios-green' : 'font-bold text-base sm:text-lg text-ios-red'; }
        }
    }

    addEvt('confirm-batch-selection', 'click', () => {
        if (!currentBatchTarget) return; const needed = parseFloat(id('batch-selector-needed')?.innerText || 0); const sum = parseFloat(id('batch-selector-selected')?.innerText || 0);
        if(sum < needed - 0.001) return window.showNotif('A quantidade marcada 칠 menor que a necess치ria!', true);
        const listEl = id('batch-selector-list'); if(!listEl) return; const inputs = [...listEl.querySelectorAll('.batch-input')]; const newPlan = inputs.map(inp => ({ batchId: inp.dataset.bid, batchCode: inp.dataset.bcode, quantity: parseFloat(inp.value) || 0 })).filter(p => p.quantity > 0);
        currentBatchTarget.dataset.plan = JSON.stringify(newPlan); const planDisplay = currentBatchTarget.querySelector('.plan-display');
        if(planDisplay) planDisplay.innerHTML = '<i class="fa-solid fa-hand mr-1"></i> Lotes Manuais: ' + newPlan.map(p => `<strong>${p.batchCode}</strong>(${p.quantity})`).join(', '); hide(id('batch-selector-modal'));
    });

    addEvt('btn-download-db', 'click', async () => {
        show(id('loading-overlay'));
        try {
            const data = { inventory: await DB.getAll('inventory'), batches: await DB.getAll('batches'), history: await DB.getAll('history'), recipes: await DB.getAll('recipes'), productionOrders: await DB.getAll('productionOrders'), monthlyConsumption: await DB.getAll('monthlyConsumption'), locations: await DB.getAll('locations') };
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], { type: 'application/json' })); a.download = `EstoqueOS_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); window.showNotif('Backup salvo no seu dispositivo!');
        } catch(e) { window.showNotif('Erro ao gerar arquivo.', true); } finally { hide(id('loading-overlay')); }
    });

    addEvt('btn-clear-db', 'click', () => {
        showConfirmationModal('Cuidado Cr칤tico!', 'Esta a칞칚o vai APAGAR TUDO definitivamente da Nuvem. Tem certeza?', async () => {
            show(id('loading-overlay')); try { await DB.clear('inventory'); await DB.clear('batches'); await DB.clear('history'); await DB.clear('recipes'); await DB.clear('productionOrders'); await DB.clear('monthlyConsumption'); await DB.clear('locations'); await refreshData(); window.showNotif('Sistema Formatado com Sucesso!'); } catch(e) { window.showNotif('Erro ao zerar.', true); } finally { hide(id('loading-overlay')); }
        });
    });

</script>
</body>
</html>
