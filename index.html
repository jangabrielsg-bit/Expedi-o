<!DOCTYPE html>
<html lang="pt-BR" class="dark" style="color-scheme: dark;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Meta tags essenciais para PWA -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Estoque OS">
    <meta name="application-name" content="Estoque OS">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Controle de Estoque e Produ√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                    colors: {
                        ios: { bg: '#000000', card: '#1c1c1e', cardHover: '#2c2c2e', blue: '#0a84ff', green: '#30d158', red: '#ff453a', orange: '#ff9f0a', text: '#ffffff', textMuted: 'rgba(235, 235, 245, 0.6)', border: '#38383a', input: '#2c2c2e' }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer components {
            body { @apply bg-ios-bg text-ios-text font-sans antialiased; }
            .card { @apply bg-ios-card p-4 sm:p-6 rounded-2xl shadow-sm border border-ios-border; }
            .title-lg { @apply text-2xl sm:text-3xl font-bold text-white mb-4 sm:mb-6 tracking-tight; }
            .title-md { @apply text-lg sm:text-xl font-semibold text-white mb-3 sm:mb-4 tracking-tight; }
            .form-label { @apply block text-sm font-medium text-ios-textMuted mb-1; }
            .form-input { @apply block w-full bg-ios-input text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-ios-blue transition-all border border-ios-border/50; }
            .btn-primary { @apply bg-ios-blue hover:opacity-90 text-white font-semibold py-3 px-5 rounded-xl transition-all flex items-center justify-center; }
            .btn-secondary { @apply bg-ios-cardHover hover:bg-gray-700 text-white font-semibold py-3 px-5 rounded-xl transition-all border border-ios-border flex items-center justify-center; }
            .btn-danger { @apply bg-ios-red hover:opacity-90 text-white font-semibold py-3 px-5 rounded-xl transition-all flex items-center justify-center; }
            .btn-success { @apply bg-ios-green hover:opacity-90 text-white font-semibold py-3 px-5 rounded-xl transition-all flex items-center justify-center; }
            .table-container { @apply overflow-x-auto rounded-xl border border-ios-border bg-ios-card w-full; }
            .base-table { @apply min-w-full w-full text-sm text-left text-ios-textMuted; }
            .base-thead { @apply text-xs uppercase bg-ios-cardHover text-gray-400 border-b border-ios-border; }
            .base-tr { @apply border-b border-ios-border hover:bg-ios-cardHover transition-colors; }
            .base-th { @apply px-4 sm:px-5 py-3 sm:py-4 font-semibold whitespace-nowrap; }
            .base-td { @apply px-4 sm:px-5 py-3 sm:py-4 whitespace-nowrap sm:whitespace-normal; }
            .modal-content { @apply bg-ios-card border border-ios-border rounded-3xl shadow-2xl p-4 sm:p-6 w-full transform transition-all max-h-[90vh] overflow-y-auto; }
            .badge { @apply text-xs font-semibold px-2 py-1 rounded-md; }
            .menu-window { @apply flex flex-col items-center justify-center p-4 sm:p-8 bg-ios-card border border-ios-border rounded-3xl shadow-lg hover:bg-ios-cardHover active:scale-95 sm:hover:scale-105 transition-all duration-300 cursor-pointer text-center; }
            .menu-window i { @apply text-3xl sm:text-5xl mb-2 sm:mb-4 text-ios-blue drop-shadow-md; }
            .menu-window span { @apply font-bold text-white text-xs sm:text-lg tracking-wide leading-tight; }
            .ui-checkbox { @apply w-6 h-6 sm:w-8 sm:h-8 appearance-none bg-ios-input border-2 border-ios-border rounded-lg checked:bg-ios-blue checked:border-ios-blue relative cursor-pointer transition-all; }
            .ui-checkbox:checked::after { content: ''; @apply absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-2 sm:w-3 h-3 sm:h-5 border-white border-b-2 border-r-2 rotate-45; margin-top: -2px; }
            .ui-checkbox-success:checked { @apply bg-ios-green border-ios-green; }
        }
    </style>
    <style>
        .sidebar { transition: width 0.3s ease-in-out; }
        .modal { display: none; position: fixed; z-index: 50; inset: 0; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); padding: 1rem; }
        .table-header-sortable { cursor: pointer; user-select: none; } .table-header-sortable:hover { color: #ffffff; }
        .searchable-container { position: relative; width: 100%; }
        .searchable-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 9999; max-height: 280px; overflow-y: auto; background-color: #2c2c2e; border: 1px solid #38383a; border-radius: 0.75rem; box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-top: 4px; }
        .searchable-item { padding: 0.85rem 1rem; cursor: pointer; color: #ffffff; border-bottom: 1px solid #38383a; transition: background-color 0.2s; }
        .searchable-item:last-child { border-bottom: none; } .searchable-item:hover { background-color: #0a84ff; }
        ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #48484a; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #636366; }
        .toggle-status { appearance: none; width: 40px; height: 20px; background: #38383a; border-radius: 20px; position: relative; cursor: pointer; outline: none; transition: background 0.3s; }
        .toggle-status::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-status:checked { background: #30d158; } .toggle-status:checked::after { transform: translateX(20px); }
        #reader video { border-radius: 0.75rem; object-fit: cover; }
        @media all and (display-mode: standalone) { body { padding-bottom: max(1rem, env(safe-area-inset-bottom)); } #mobile-nav { padding-bottom: max(1rem, env(safe-area-inset-bottom)); } }
    </style>
</head>
<body class="bg-ios-bg text-ios-text font-sans antialiased flex h-screen overflow-hidden w-full relative">

    <div id="loading-overlay" class="fixed inset-0 z-[99999] hidden flex-col items-center justify-center bg-black bg-opacity-80 backdrop-blur-md transition-opacity">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-ios-cardHover border-t-ios-blue mb-4"></div>
        <p class="text-ios-textMuted font-medium" id="loading-text">Processando...</p>
    </div>
    
    <div id="notification-modal" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[999999] hidden py-3 px-6 rounded-full shadow-2xl font-semibold text-white transition-all text-sm backdrop-blur-md text-center max-w-sm"></div>

    <div id="login-wrapper" class="absolute inset-0 z-[999] flex flex-col items-center justify-center bg-ios-bg text-center px-4 hidden">
        <div class="card max-w-md w-full py-10 px-6 border border-ios-border/50 shadow-2xl">
            <div class="w-20 h-20 rounded-2xl bg-ios-blue flex items-center justify-center text-white font-bold text-4xl mx-auto mb-6"><i class="fa-solid fa-layer-group"></i></div>
            <h2 class="title-lg mb-2 text-white">Acesso Restrito</h2>
            <p class="text-ios-textMuted mb-8 text-sm">Fa√ßa login para ter acesso ao seu banco de dados privado.</p>
            <button type="button" id="btn-login-google" class="btn-primary w-full py-4 text-lg font-bold"><i class="fa-brands fa-google mr-2"></i>Entrar com o Google</button>
            <button type="button" id="btn-bypass-login" class="btn-secondary w-full py-3 mt-4 text-sm"><i class="fa-solid fa-flask mr-2"></i>Testar sem Login (An√¥nimo)</button>
            <div id="mensagem-erro" class="text-ios-red mt-4 font-medium text-sm text-left bg-ios-red/10 p-3 rounded-lg hidden"></div>
        </div>
    </div>

    <div id="app-wrapper" class="flex flex-col md:flex-row h-screen overflow-hidden w-full hidden">
        <header class="md:hidden flex items-center justify-between p-4 bg-ios-bg border-b border-ios-border z-40 shrink-0">
            <div class="flex items-center gap-2"><div class="w-8 h-8 rounded-xl bg-ios-blue flex items-center justify-center text-white font-bold text-sm"><i class="fa-solid fa-layer-group"></i></div><span class="font-bold text-lg text-white tracking-tight">Estoque OS</span></div>
            <button type="button" id="btn-sair-mobile" class="text-ios-red hover:text-red-400 p-2 shrink-0 bg-ios-red/10 rounded-lg transition-colors"><i class="fa-solid fa-right-from-bracket"></i></button>
        </header>

        <aside class="hidden md:flex w-20 lg:w-64 bg-[#000000] border-r border-ios-border flex-col py-6 transition-all duration-300 z-40 shrink-0">
            <div class="px-4 mb-8 flex items-center justify-center lg:justify-start cursor-pointer" onclick="navTo('home')"><div class="w-10 h-10 rounded-xl bg-ios-blue flex items-center justify-center text-white font-bold text-xl"><i class="fa-solid fa-layer-group"></i></div><span class="ml-3 font-bold text-xl text-white hidden lg:block tracking-tight">Estoque OS</span></div>
            <nav class="flex-1 w-full px-3 space-y-2 overflow-y-auto">
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-white bg-ios-card transition-all" data-target="home"><i class="fa-solid fa-house w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">In√≠cio</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="consulta"><i class="fa-solid fa-magnifying-glass w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Consulta R√°pida</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="inventory"><i class="fa-solid fa-boxes-stacked w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Estoque Geral</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="barcodes"><i class="fa-solid fa-barcode w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">C√≥d. Barras</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="locations"><i class="fa-solid fa-map-location-dot w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Endere√ßamento</span></a>
                <div class="border-t border-ios-border my-2 mx-2"></div>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all relative" data-target="picking"><i class="fa-solid fa-dolly w-6 text-center text-lg text-ios-orange"></i><span class="ml-3 hidden lg:block font-medium text-ios-orange">Separa√ß√£o (Picking)</span><span id="badge-nav-picking" class="absolute top-3 right-3 w-2.5 h-2.5 bg-ios-orange rounded-full animate-pulse hidden"></span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all relative" data-target="production"><i class="fa-solid fa-hammer w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Produ√ß√£o (OP)</span><span id="badge-nav-prod" class="absolute top-3 right-3 w-2.5 h-2.5 bg-ios-blue rounded-full animate-pulse hidden"></span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="traceability"><i class="fa-solid fa-route w-6 text-center text-lg" style="color:#bf5af2;"></i><span class="ml-3 hidden lg:block font-medium">Rastreabilidade</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="divergences"><i class="fa-solid fa-scale-unbalanced w-6 text-center text-lg" style="color:#ff375f;"></i><span class="ml-3 hidden lg:block font-medium">Diverg√™ncias</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="purchasing"><i class="fa-solid fa-cart-shopping w-6 text-center text-lg" style="color:#32ade6;"></i><span class="ml-3 hidden lg:block font-medium">Compras/Pedidos</span></a>
                <div class="border-t border-ios-border my-2 mx-2"></div>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="settings"><i class="fa-solid fa-database w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Banco de Dados</span></a>
            </nav>
            <div class="mt-auto w-full px-3 pt-4 border-t border-ios-border">
                <button type="button" id="btn-show-alerts" class="p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all relative text-left"><i class="fa-solid fa-bell w-6 text-center text-lg text-ios-red"></i><span class="ml-3 hidden lg:block font-medium">Alertas</span><span id="badge-nav-alerts" class="absolute top-3 right-3 bg-ios-red text-white text-[10px] px-2 py-0.5 rounded-full hidden font-bold">0</span></button>
                <div class="flex items-center justify-between mt-4 px-2 py-3 bg-ios-card rounded-xl border border-ios-border/50"><div class="flex items-center gap-3 overflow-hidden"><div class="w-8 h-8 rounded-full bg-ios-blue/20 text-ios-blue flex items-center justify-center shrink-0"><i class="fa-solid fa-user text-xs"></i></div><span id="nome-usuario" class="text-xs text-white font-bold truncate">...</span></div><button type="button" id="btn-sair" class="text-ios-red hover:text-red-400 p-2 shrink-0 bg-ios-red/10 rounded-lg transition-colors"><i class="fa-solid fa-right-from-bracket"></i></button></div>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-10 pb-24 md:pb-6 relative w-full h-full">
            <!-- Home -->
            <div id="screen-home" class="screen-panel w-full max-w-6xl mx-auto">
                <h1 class="title-lg mb-6 text-center text-white hidden md:block">Menu Principal</h1>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-6 mb-8 sm:mb-10">
                    <button type="button" class="menu-window nav-btn" data-target="consulta"><i class="fa-solid fa-magnifying-glass" style="color:#32ade6;"></i><span>Consulta R√°pida</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="entry"><i class="fa-solid fa-box-open"></i><span>Entrada (Massa)</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="inventory"><i class="fa-solid fa-boxes-stacked" style="color:#30d158;"></i><span>Estoque Atual</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="locations"><i class="fa-solid fa-map-location-dot" style="color:#5e5ce6;"></i><span>Endere√ßamento</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="barcodes"><i class="fa-solid fa-barcode" style="color:#bf5af2;"></i><span>C√≥d. Barras</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="purchasing"><i class="fa-solid fa-cart-shopping" style="color:#32ade6;"></i><span>Compras</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="recipes"><i class="fa-solid fa-book-bookmark" style="color:#ff375f;"></i><span>Fichas T√©cnicas</span></button>
                    <button type="button" class="menu-window nav-btn relative" data-target="picking"><i class="fa-solid fa-dolly text-ios-orange"></i><span class="text-ios-orange">Separa√ß√£o</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="production"><i class="fa-solid fa-hammer" style="color:#ff9f0a;"></i><span>Ordens Prod.</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="traceability"><i class="fa-solid fa-route" style="color:#bf5af2;"></i><span>Rastreabilidade</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="divergences"><i class="fa-solid fa-scale-unbalanced" style="color:#ff375f;"></i><span>Diverg√™ncias</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="requisitions"><i class="fa-solid fa-arrow-right-from-bracket" style="color:#ff453a;"></i><span>Baixa Avulsa</span></button>
                    <button type="button" class="menu-window nav-btn" data-target="adjustments"><i class="fa-solid fa-sliders" style="color:#64d2ff;"></i><span>Ajuste Lotes</span></button>
                </div>
                <div class="border-t border-ios-border pt-6 sm:pt-8 mb-6">
                    <h2 class="title-md mb-4 text-ios-blue"><i class="fa-solid fa-truck-ramp-box mr-2"></i>üì¶ Entregas Previstas Hoje</h2>
                    <div id="home-incoming-orders" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4"></div>
                </div>
            </div>

            <!-- Consulta R√°pida -->
            <div id="screen-consulta" class="screen-panel hidden max-w-4xl mx-auto">
                <h1 class="title-lg">Consulta R√°pida</h1>
                <div class="card mb-6"><div class="flex gap-2 w-full"><input type="text" id="consulta-input" class="form-input flex-1 font-mono text-lg" placeholder="Bipar c√≥digo..." autocomplete="off"><button type="button" id="btn-consulta-scan" class="bg-ios-blue text-white p-3 rounded-xl"><i class="fa-solid fa-camera"></i></button></div><button type="button" id="btn-consulta-search" class="btn-secondary w-full px-8 mt-2">Consultar</button></div>
                <div id="consulta-results" class="space-y-6"><div class="card flex flex-col items-center justify-center py-20 text-center border-dashed"><i class="fa-solid fa-magnifying-glass text-6xl text-ios-cardHover mb-4"></i><p class="text-ios-textMuted">Aguardando leitura...</p></div></div>
            </div>

            <!-- Cod Barras -->
            <div id="screen-barcodes" class="screen-panel hidden max-w-4xl mx-auto">
                <h1 class="title-lg">C√≥d. Barras</h1>
                <div class="card mb-8"><form id="barcode-form" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative"><div class="z-50"><label class="form-label">Produto</label><div id="barcode-searchable-container" class="searchable-container"></div></div><div class="z-40"><label class="form-label">C√≥d Barras</label><div class="flex gap-2"><input type="text" id="barcode-input" required class="form-input font-mono"><button type="button" id="btn-scan-barcode" class="bg-ios-blue text-white p-3 rounded-xl"><i class="fa-solid fa-camera"></i></button></div></div></div><div class="flex justify-end pt-4"><button type="submit" class="btn-primary w-full md:w-auto">Vincular C√≥digo</button></div></form></div>
                <div class="table-container"><table class="base-table"><thead class="base-thead"><tr><th class="base-th">Produto</th><th class="base-th">C√≥d</th><th class="base-th">EANs</th><th class="base-th text-center">Gest√£o</th></tr></thead><tbody id="barcodes-table-body"></tbody></table></div>
            </div>

            <!-- Compras -->
            <div id="screen-purchasing" class="screen-panel hidden">
                <h1 class="title-lg mb-0 text-ios-blue"><i class="fa-solid fa-cart-shopping mr-3"></i>Compras</h1>
                <div class="mb-6 mt-4"><input type="text" id="search-purchasing" class="form-input w-full md:w-1/2" placeholder="Buscar fornecedor ou item..."></div>
                <div id="purchasing-container" class="space-y-6"></div>
            </div>

            <!-- Endere√ßamento -->
            <div id="screen-locations" class="screen-panel hidden max-w-5xl mx-auto">
                <h1 class="title-lg">Endere√ßamento</h1>
                <div class="flex flex-col md:flex-row gap-6 mb-8">
                    <div class="w-full md:w-1/3 card self-start"><h2 class="title-md mb-4 text-lg">Buscar Local</h2><div class="flex gap-2 mb-4"><input type="text" id="location-search-input" class="form-input font-mono" placeholder="C√≥d..." list="locations-datalist" autocomplete="off"><button type="button" id="btn-scan-location" class="bg-ios-blue text-white p-3 rounded-xl"><i class="fa-solid fa-camera"></i></button></div><button type="button" id="btn-search-location" class="btn-secondary w-full">Pesquisar</button></div>
                    <div class="w-full md:w-2/3">
                        <div id="location-details-panel" class="card hidden mb-6"><div class="flex justify-between items-start mb-6 border-b border-ios-border pb-4"><div><h2 class="text-2xl font-bold text-white mb-1" id="loc-detail-name">Nome</h2><p class="text-ios-blue font-mono bg-ios-blue/10 px-2 py-1 rounded" id="loc-detail-code">COD</p></div><div class="flex gap-2"><button type="button" id="btn-edit-location" class="text-ios-blue bg-ios-blue/10 p-2 rounded-xl"><i class="fa-solid fa-pen"></i></button><button type="button" id="btn-delete-location" class="text-ios-red bg-ios-red/10 p-2 rounded-xl"><i class="fa-solid fa-trash"></i></button></div></div><div class="flex justify-between items-center mb-4"><h3 class="text-sm font-semibold text-ios-textMuted uppercase">Lotes</h3><button type="button" id="btn-add-batch-to-loc" class="text-ios-green bg-ios-green/10 px-4 py-2 rounded-xl font-bold text-sm"><i class="fa-solid fa-plus mr-1"></i>Alocar Lote</button></div><div class="table-container max-h-64 overflow-y-auto"><table class="base-table"><thead class="base-thead"><tr><th class="base-th">Produto</th><th class="base-th">Lote</th><th class="base-th">Qtd</th><th class="base-th text-center">Retirar</th></tr></thead><tbody id="loc-batches-body"></tbody></table></div></div>
                        <div id="location-create-panel" class="card hidden border-ios-orange border-dashed"><h2 class="title-md text-ios-orange">Novo Local</h2><form id="location-form" class="space-y-4"><div><label class="form-label">C√≥digo</label><input type="text" id="loc-form-code" required readonly class="form-input"></div><div><label class="form-label">Nome</label><input type="text" id="loc-form-name" required class="form-input"></div><div class="flex justify-end gap-3 mt-4"><button type="button" id="btn-cancel-loc" class="btn-secondary">Cancelar</button><button type="submit" class="btn-primary">Criar Endere√ßo</button></div></form></div>
                        <div id="location-empty-state" class="card border-dashed"><div class="text-center py-10"><i class="fa-solid fa-map-location-dot text-5xl text-ios-cardHover mb-4"></i><p class="text-ios-textMuted">Busque um local ou selecione abaixo.</p></div><div class="border-t border-ios-border pt-6"><h3 class="text-xs font-semibold text-ios-textMuted uppercase mb-3">Todos os Endere√ßos</h3><div id="all-locations-list" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div></div></div>
                    </div>
                </div>
            </div>

            <!-- Entrada Massa -->
            <div id="screen-entry" class="screen-panel hidden">
                <h1 class="title-lg">Entrada (Massa)</h1>
                <div class="card mb-6"><form id="entry-form"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div class="relative z-50"><label class="form-label">Produto</label><div class="flex gap-2"><div id="entry-searchable-container" class="searchable-container flex-1"></div><button type="button" id="btn-scan-entry-code" class="bg-ios-blue text-white p-3 rounded-xl shrink-0"><i class="fa-solid fa-camera"></i></button></div></div><div><label class="form-label">Qtd</label><input type="number" name="quantity" required min="0.01" step="0.01" class="form-input text-ios-blue font-bold"></div><div><button type="submit" class="btn-secondary w-full"><i class="fa-solid fa-plus mr-2"></i>Adicionar Lote</button></div></div></form></div>
                <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="title-md mb-0">Lista</h2><button type="button" id="btn-save-bulk-entry" class="btn-primary"><i class="fa-solid fa-check-double mr-2"></i>Efetivar Entradas</button></div><div class="table-container overflow-visible"><table class="base-table min-w-full"><thead class="base-thead"><tr><th class="base-th">Produto</th><th class="base-th">Qtd</th><th class="base-th">Lote</th><th class="base-th">Fabrica√ß√£o</th><th class="base-th">Validade</th><th class="base-th">Local</th><th class="base-th text-center"><i class="fa-solid fa-trash"></i></th></tr></thead><tbody id="bulk-entry-list" class="divide-y divide-ios-border"></tbody></table></div></div>
            </div>

            <!-- Estoque Geral -->
            <div id="screen-inventory" class="screen-panel hidden">
                <h1 class="title-lg">Estoque Atual</h1>
                <div class="card p-0 bg-transparent border-none"><div class="flex flex-wrap gap-2 mb-5 p-1"><input type="text" id="search-inventory" placeholder="Pesquisar..." class="form-input w-full md:w-64"><div class="flex gap-2 w-full md:w-auto"><select id="type-filter" class="form-input text-sm"><option value="">Tipos</option><option value="insumo">Insumos</option><option value="semi_acabado">Semi-acabados</option></select><select id="supplier-filter" class="form-input text-sm"><option value="">Fornecedores</option></select></div><button type="button" id="btn-export-excel" class="btn-secondary w-full md:w-auto md:ml-auto"><i class="fa-solid fa-file-excel mr-2 text-ios-green"></i>Exportar</button></div><div class="table-container"><table class="base-table"><thead class="base-thead"><tr><th class="base-th table-header-sortable" data-sort="name">Produto <i class="fa-solid fa-sort ml-1"></i></th><th class="base-th hidden sm:table-cell">Tipo</th><th class="base-th hidden md:table-cell table-header-sortable" data-sort="supplier">Fornecedor <i class="fa-solid fa-sort ml-1"></i></th><th class="base-th text-right table-header-sortable" data-sort="totalQuantity">Saldo <i class="fa-solid fa-sort ml-1"></i></th><th class="base-th table-header-sortable" data-sort="expiry">Validade <i class="fa-solid fa-sort ml-1"></i></th></tr></thead><tbody id="inventory-table-body"></tbody></table></div></div>
            </div>

            <!-- Receitas -->
            <div id="screen-recipes" class="screen-panel hidden">
                <div class="flex justify-between items-center gap-4 mb-6"><h1 class="title-lg mb-0">Fichas T√©cnicas</h1><div class="flex gap-2"><input type="text" id="search-recipe" placeholder="Buscar..." class="form-input w-full sm:w-64"><button type="button" id="btn-export-recipe-book" class="btn-secondary"><i class="fa-solid fa-file-pdf text-ios-red"></i></button><button type="button" id="btn-new-recipe" class="btn-primary"><i class="fa-solid fa-plus mr-2"></i>Criar</button></div></div>
                <div class="flex flex-col lg:flex-row gap-6"><div class="w-full lg:w-1/4 card"><h2 class="text-sm font-semibold text-ios-textMuted uppercase mb-3">Categorias</h2><ul id="recipe-categories-list" class="flex lg:flex-col gap-2 w-max lg:w-full"></ul></div><div id="recipes-grid" class="w-full lg:w-3/4 grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
            </div>

            <!-- Picking -->
            <div id="screen-picking" class="screen-panel hidden">
                <h1 class="title-lg mb-6 text-ios-orange"><i class="fa-solid fa-dolly mr-3"></i>Separa√ß√£o</h1>
                <div id="picking-lines-container" class="space-y-6"></div>
            </div>

            <!-- Produ√ß√£o OP -->
            <div id="screen-production" class="screen-panel hidden">
                <div class="flex justify-between items-center mb-6"><h1 class="title-lg mb-0">Ordens de Produ√ß√£o</h1><div class="flex gap-3"><button type="button" id="btn-confirm-production" class="btn-success"><i class="fa-solid fa-check-double mr-2"></i>Efetivar OPs</button><button type="button" id="btn-new-production-order" class="btn-primary"><i class="fa-solid fa-plus mr-2"></i>Nova OP</button></div></div>
                <div class="card mb-5 flex gap-4 items-center border-l-4 border-l-ios-blue"><label class="text-sm font-medium text-ios-textMuted"><i class="fa-solid fa-filter mr-2"></i>Data OP:</label><input type="date" id="search-po-by-date" class="form-input w-auto py-2"></div>
                <div id="production-orders-list" class="grid grid-cols-1 xl:grid-cols-2 gap-4"></div>
            </div>
            
            <!-- Rastreabilidade -->
            <div id="screen-traceability" class="screen-panel hidden">
                <h1 class="title-lg">Rastreabilidade de Produ√ß√£o</h1>
                <div class="card p-4 mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label class="form-label">Data de Conclus√£o</label><input type="date" id="trace-date-filter" class="form-input"></div>
                    <div><label class="form-label">Linha / Setor</label><select id="trace-line-filter" class="form-input"><option value="">Todas</option></select></div>
                    <div><label class="form-label">Buscar Insumo ou OP...</label><input type="text" id="trace-search-filter" class="form-input" placeholder="Ex: Farinha..."></div>
                </div>
                <div id="traceability-list" class="space-y-4"></div>
            </div>

            <!-- Diverg√™ncias -->
            <div id="screen-divergences" class="screen-panel hidden">
                <h1 class="title-lg mb-0 text-ios-red"><i class="fa-solid fa-scale-unbalanced mr-3"></i>Relat√≥rio de Diverg√™ncias</h1>
                <p class="text-ios-textMuted text-sm mb-6 mt-1 italic">"N√£o se gerencia o que n√£o se mede, n√£o se mede o que n√£o se define..."</p>
                <div class="card mb-6">
                    <label class="form-label">Filtrar por Data da OP:</label>
                    <input type="date" id="divergences-date-filter" class="form-input w-full md:w-1/3">
                </div>
                <div id="divergences-list" class="space-y-4"></div>
            </div>

            <!-- Baixa Avulsa -->
            <div id="screen-requisitions" class="screen-panel hidden">
                <h1 class="title-lg">Baixa Avulsa</h1>
                <div class="card max-w-4xl mx-auto"><form id="requisition-form"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div><label class="form-label">Motivo</label><input type="text" id="requisition-reason" required class="form-input"></div><div><label class="form-label">Solicitante</label><input type="text" id="requisition-responsible" required class="form-input"></div></div><div class="border-t border-ios-border pt-4"><h3 class="title-md text-sm text-ios-textMuted mb-4">Itens</h3><div id="requisition-items-container" class="space-y-3 mb-5"></div><button type="button" id="add-requisition-item-btn" class="text-ios-blue bg-ios-bg px-3 py-2 rounded-lg border border-ios-border"><i class="fa-solid fa-plus mr-2"></i>Adicionar Insumo</button></div><div class="mt-8 flex justify-end"><button type="submit" class="btn-primary w-full md:w-auto">Confirmar Baixa</button></div></form></div>
            </div>

            <!-- Ajustes -->
            <div id="screen-adjustments" class="screen-panel hidden">
                <h1 class="title-lg">Ajuste de Lote</h1>
                <div class="card max-w-2xl mx-auto"><form id="adjustment-form" class="space-y-5"><div class="z-50 relative"><label class="form-label">Buscar Produto</label><div id="adjustment-searchable-container"></div></div><div><label class="form-label">Lote</label><select id="adjustment-batch" required class="form-input"><option value="">Aguardando...</option></select></div><div><label class="form-label">Nova Qtd Real</label><input type="number" id="adjustment-new-quantity" required min="0" step="0.01" class="form-input text-ios-blue font-bold"></div><div><label class="form-label">Motivo</label><input type="text" id="adjustment-reason" required class="form-input"></div><div><label class="form-label">Respons√°vel</label><input type="text" id="adjustment-responsible" required class="form-input"></div><div class="mt-8 flex justify-end"><button type="submit" class="btn-primary">Registrar Ajuste</button></div></form></div>
            </div>

            <!-- Configura√ß√µes -->
            <div id="screen-settings" class="screen-panel hidden max-w-3xl mx-auto">
                <h1 class="title-lg">Banco de Dados</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card border-ios-blue">
                        <h2 class="title-md text-ios-blue"><i class="fa-solid fa-download mr-2"></i>Backup</h2>
                        <button type="button" id="btn-download-db" class="btn-primary w-full mt-4">Backup Seguro</button>
                    </div>
                    <div class="card border-ios-red">
                        <h2 class="title-md text-ios-red"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Zerar Sistema</h2>
                        <button type="button" id="btn-clear-db" class="btn-danger w-full mt-4">Formatar Tudo</button>
                    </div>
                    <div class="card border-ios-green md:col-span-2" id="pwa-install-card">
                        <h2 class="title-md text-ios-green"><i class="fa-brands fa-android mr-2"></i>Instalar App no Android</h2>
                        <p class="text-sm text-ios-textMuted mb-4">Adicione o Estoque OS √† sua tela inicial para acessar como um aplicativo nativo.</p>
                        <button type="button" id="btn-install-pwa" class="btn-success w-full mt-2">Instalar Agora</button>
                    </div>
                    <div class="card border-ios-blue hidden md:col-span-2" id="ios-pwa-hint">
                        <h2 class="title-md text-ios-blue"><i class="fa-brands fa-apple mr-2"></i>Instalar no iOS</h2>
                        <p class="text-sm mt-2 text-white">Toque no √≠cone de Partilhar e depois em Ecr√£ Principal.</p>
                    </div>
                </div>
            </div>
        </main>
        
        <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-[#000000]/95 backdrop-blur-xl border-t border-ios-border flex justify-around items-center pt-2 pb-[max(1rem,env(safe-area-inset-bottom))] px-1 z-[45]"><a href="#" class="nav-item-mobile flex flex-col items-center py-2 px-3 text-ios-blue w-1/4 text-center transition-colors" data-target="home"><i class="fa-solid fa-house text-xl mb-1"></i><span class="text-[10px] font-bold">In√≠cio</span></a><a href="#" class="nav-item-mobile flex flex-col items-center py-2 px-3 text-ios-textMuted w-1/4 text-center" data-target="consulta"><i class="fa-solid fa-magnifying-glass text-xl mb-1"></i><span class="text-[10px] font-bold">Consulta</span></a><a href="#" class="nav-item-mobile flex flex-col items-center py-2 px-3 text-ios-textMuted w-1/4 text-center relative" data-target="picking"><i class="fa-solid fa-dolly text-xl mb-1"></i><span class="text-[10px] font-bold">Picking</span><span id="badge-nav-picking-mobile" class="absolute top-1 right-3 w-2.5 h-2.5 bg-ios-orange rounded-full hidden"></span></a><button type="button" id="btn-show-alerts-mobile" class="flex flex-col items-center py-2 px-3 text-ios-textMuted w-1/4 text-center relative"><i class="fa-solid fa-bell text-xl mb-1"></i><span class="text-[10px] font-bold">Alertas</span><span id="badge-nav-alerts-mobile" class="absolute top-1 right-2 bg-ios-red text-white text-[9px] px-1.5 py-0.5 rounded-full hidden font-bold border border-black">0</span></button></nav>
    </div>

    <!-- Modais Flutuantes -->
    <div id="recipe-modal" class="modal z-[6000]"><div class="modal-content max-w-2xl"><div class="flex justify-between items-start mb-6 border-b border-ios-border pb-4"><h2 id="recipe-modal-title" class="title-md mb-0 text-ios-blue"><i class="fa-solid fa-book-bookmark mr-3"></i>Nova Receita</h2><button type="button" class="text-white text-4xl ml-2 close-modal" data-target="recipe-modal">&times;</button></div><form id="recipe-form" class="space-y-6"><input type="hidden" id="edit-recipe-id"><div class="grid grid-cols-2 gap-4"><div><label class="form-label">Produto Final</label><input type="text" id="recipe-name" required class="form-input"></div><div><label class="form-label">Categoria</label><input type="text" id="recipe-category" required class="form-input"></div></div><div class="bg-ios-cardHover p-4 rounded-xl border border-ios-border"><div class="flex items-center gap-3"><input type="checkbox" id="recipe-is-semi" class="w-5 h-5 accent-ios-orange"><label for="recipe-is-semi" class="text-white">√â um Semi-acabado</label></div><div id="yield-wrapper" class="hidden mt-2"><label class="form-label text-ios-orange">Rendimento</label><input type="number" step="0.0001" id="recipe-yield" class="form-input w-1/2" value="1"></div></div><div class="border-t border-ios-border pt-4"><div class="flex justify-between items-center mb-4"><h3 class="text-sm text-ios-textMuted">Ingredientes</h3><button type="button" id="add-ingredient-btn" class="text-ios-blue bg-ios-blue/20 px-3 py-2 rounded-lg">Adicionar Insumo</button></div><div id="ingredients-container" class="space-y-3"></div></div><div class="flex justify-end gap-3 pt-4 border-t border-ios-border mt-6"><button type="button" class="btn-secondary close-modal" data-target="recipe-modal">Cancelar</button><button type="submit" class="btn-primary">Salvar</button></div></form></div></div>

    <div id="production-order-modal" class="modal z-[6000]"><div class="modal-content max-w-4xl"><div class="flex justify-between items-start mb-6 border-b border-ios-border pb-4"><h2 class="title-md mb-0 text-white"><i class="fa-solid fa-hammer mr-3 text-ios-orange"></i>Nova OP</h2><button type="button" class="text-white text-4xl ml-2 close-modal" data-target="production-order-modal">&times;</button></div><form id="production-order-form" class="space-y-6"><div class="grid grid-cols-3 gap-4 relative"><div class="z-50 col-span-2"><label class="form-label">Ficha produzida</label><div id="po-recipe-searchable-container"></div></div><div><label class="form-label">Data Programada</label><input type="date" id="po-date" required class="form-input"></div></div><div class="grid grid-cols-4 gap-4 items-end"><div><label class="form-label">Multiplicador</label><input type="number" step="0.01" id="po-quantity" required class="form-input font-bold text-center text-ios-blue py-3" value="1" min="0.01"></div><div class="col-span-3 flex items-center gap-3 bg-ios-cardHover p-3 rounded-xl border border-ios-border"><input type="checkbox" id="po-is-extra" class="w-6 h-6 accent-ios-red"><label for="po-is-extra" class="text-white text-sm">OP EXTRA / URGENTE</label></div></div><div id="po-output-fields" class="grid grid-cols-2 gap-4 bg-ios-orange/10 p-4 rounded-xl border border-ios-orange/30 hidden"><div><label class="form-label text-ios-orange">Lote Gerado Auto</label><input type="text" id="po-output-batch" class="form-input bg-ios-bg border-ios-orange/50 text-white text-sm"></div><div><label class="form-label text-ios-orange">Rend. Previsto</label><input type="text" id="po-total-output" readonly class="form-input bg-ios-bg border-ios-orange/50 font-bold text-white text-lg"></div></div><div class="border-t border-ios-border pt-4"><h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3"><i class="fa-solid fa-calculator mr-2"></i>Previs√£o F√≠sico</h3><div class="table-container max-h-64 overflow-y-auto"><table class="base-table w-full"><thead class="base-thead"><tr><th>Insumo</th><th>Saldo</th><th>Necess√°rio</th><th>PEPS</th></tr></thead><tbody id="po-ingredients-body"></tbody></table></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" class="btn-secondary close-modal" data-target="production-order-modal">Cancelar</button><button type="submit" class="btn-primary">Adicionar OP</button></div></form></div></div>

    <div id="edit-location-modal" class="modal z-[6000]"><div class="modal-content max-w-sm"><h2 class="title-md mb-4 text-ios-blue">Editar Endere√ßo</h2><form id="edit-location-form" class="space-y-4"><input type="hidden" id="edit-loc-old-code"><div><label class="form-label">C√≥digo</label><input type="text" id="edit-loc-new-code" required class="form-input font-mono text-ios-blue"></div><div><label class="form-label">Nome Vis√≠vel</label><input type="text" id="edit-loc-new-name" required class="form-input"></div><div class="flex justify-end gap-2 mt-4"><button type="button" class="btn-secondary close-modal" data-target="edit-location-modal">Cancelar</button><button type="submit" class="btn-primary">Atualizar</button></div></form></div></div>

    <div id="edit-supplier-modal" class="modal z-[6000]"><div class="modal-content max-w-sm"><h2 class="title-md mb-2 text-ios-blue">Editar Fornecedor</h2><p class="text-sm text-ios-textMuted mb-4">Aplica as altera√ß√µes a todos os itens deste fornecedor.</p><form id="edit-supplier-form" class="space-y-4"><input type="hidden" id="edit-supplier-old-name"><div><label class="form-label">Nome do Fornecedor</label><input type="text" id="edit-supplier-new-name" required class="form-input"></div><div><label class="form-label">Prazo Padr√£o (Dias)</label><input type="number" id="edit-supplier-lead" min="0" required class="form-input"></div><div class="flex justify-end gap-2 mt-4"><button type="button" class="btn-secondary close-modal" data-target="edit-supplier-modal">Cancelar</button><button type="submit" class="btn-primary">Salvar</button></div></form></div></div>

    <div id="place-supplier-order-modal" class="modal z-[6000]"><div class="modal-content max-w-sm"><h2 class="title-md mb-2 text-ios-blue">Previs√£o de Entrega</h2><p class="text-sm text-white mb-4" id="order-supplier-name"></p><form id="place-supplier-order-form" class="space-y-4"><input type="hidden" id="order-supplier-id"><div><label class="form-label">Previs√£o para a F√°brica</label><input type="date" id="order-supplier-date" required class="form-input"></div><div class="flex justify-end gap-2 mt-4"><button type="button" class="btn-secondary close-modal" data-target="place-supplier-order-modal">Cancelar</button><button type="submit" class="btn-primary">Confirmar</button></div></form></div></div>

    <div id="scanner-modal" class="modal z-[99999]"><div class="modal-content max-w-2xl relative pt-12"><button type="button" class="absolute top-2 right-2 bg-ios-red text-white w-10 h-10 rounded-full flex items-center justify-center font-bold close-scanner z-50">&times;</button><div class="flex justify-between items-center mb-4"><h2 class="title-md mb-0 text-white"><i class="fa-solid fa-camera mr-2"></i>Leitor</h2></div><div class="bg-black rounded-xl overflow-hidden min-h-[300px] mb-4 relative"><div id="reader" class="w-full h-full absolute inset-0"></div></div><div class="flex gap-2"><input type="text" id="scanner-manual-input" class="form-input flex-1 font-mono text-center text-lg" placeholder="Ou digite aqui..."><button type="button" id="btn-scanner-manual-confirm" class="btn-primary px-8">OK</button></div></div></div>

    <div id="picking-scan-qty-modal" class="modal z-[6000]"><div class="modal-content max-w-sm"><h2 class="title-md mb-2 text-ios-orange">Qtd Encontrada</h2><p class="text-sm text-white mb-4" id="picking-scan-qty-name"></p><form id="picking-scan-qty-form" class="space-y-4"><div><label class="form-label">Qtd F√çSICA Coletada:</label><input type="number" id="picking-scan-qty" step="0.001" required class="form-input text-ios-blue text-3xl font-bold text-center py-4"></div><div class="flex justify-end gap-2"><button type="button" class="btn-secondary close-modal" data-target="picking-scan-qty-modal">Cancelar</button><button type="submit" class="btn-primary">Confirmar Real</button></div></form></div></div>

    <div id="modal-add-loc-batch" class="modal z-[6000]"><div class="modal-content max-w-md"><h2 class="title-md mb-4 text-ios-blue">Alocar Lote</h2><form id="add-loc-batch-form" class="space-y-4"><input type="hidden" id="add-loc-target-code"><div class="z-50 relative"><label class="form-label">Produto</label><div id="add-loc-searchable-container"></div></div><div><label class="form-label">Lote</label><select id="add-loc-batch-select" required class="form-input"><option value="">Aguardando...</option></select></div><div class="flex justify-end gap-2 mt-4"><button type="button" class="btn-secondary close-modal" data-target="modal-add-loc-batch">Cancelar</button><button type="submit" class="btn-primary">Confirmar</button></div></form></div></div>

    <div id="picking-modal" class="modal z-[6000]"><div class="modal-content max-w-5xl h-[95vh] flex flex-col p-0 bg-ios-bg border border-ios-border"><div class="flex justify-between items-start shrink-0 p-4 border-b border-ios-border bg-ios-cardHover"><div><h2 id="picking-modal-title" class="title-md mb-1 text-ios-orange flex items-center text-xl"></h2><p id="picking-modal-subtitle" class="text-sm text-ios-textMuted"></p></div><button type="button" class="text-white text-4xl ml-2 close-modal" data-target="picking-modal">&times;</button></div><div id="picking-setup-view" class="p-10 flex flex-col items-center justify-center bg-ios-card h-full"><i class="fa-solid fa-clipboard-user text-6xl text-ios-orange mb-6"></i><h3 class="text-2xl font-bold text-white mb-2">Quem vai separar?</h3><p class="text-ios-textMuted text-sm mb-8 text-center">Insira o seu nome.</p><input type="text" id="picking-responsible" class="form-input w-full max-w-xs text-center text-xl py-4 mb-6" autocomplete="off"><button type="button" id="btn-start-picking" class="btn-success py-4 px-10 text-lg w-full max-w-xs rounded-full"><i class="fa-solid fa-dolly mr-2"></i> Iniciar Check-list</button></div><div id="picking-active-view" class="hidden flex-col flex-1 overflow-hidden h-full"><div class="bg-ios-bg p-4 flex justify-between items-center shrink-0 border-b border-ios-border"><div class="flex items-center gap-4"><div><p class="text-[10px] text-ios-textMuted uppercase font-bold tracking-widest">Resp.</p><p class="font-bold text-white text-lg flex items-center"><i class="fa-solid fa-user-check text-ios-blue mr-2"></i><span id="picking-active-resp">---</span></p></div></div><button type="button" id="btn-finish-picking" class="btn-primary py-3 px-6 rounded-xl"><i class="fa-solid fa-flag-checkered mr-2"></i>Finalizar OPs</button></div><div class="overflow-y-auto flex-1 bg-ios-bg p-6"><div class="table-container shadow-xl"><table class="base-table w-full"><thead class="base-thead sticky top-0 z-10 shadow-sm"><tr><th class="base-th rounded-tl-lg">Item (Consolidado)</th><th class="base-th text-right">Necess√°rio</th><th class="base-th text-center w-56">Qtd Real</th><th class="base-th text-center rounded-tr-lg">OK</th></tr></thead><tbody id="picking-checklist-body" class="divide-y divide-ios-border"></tbody></table></div></div></div></div></div>

    <div id="item-details-modal" class="modal z-[6000]"><div class="modal-content max-w-5xl h-[95vh] overflow-y-auto"><div class="flex justify-between items-center mb-6 gap-3"><div class="flex-1 w-full"><h2 class="title-md flex items-center mb-1 text-2xl tracking-tight break-words pr-8"><span id="details-product-name"></span></h2><span id="details-product-type-badge" class="badge bg-ios-cardHover text-ios-textMuted border border-ios-border"></span></div><div class="flex items-center gap-2"><button type="button" id="btn-edit-item" class="text-ios-blue bg-ios-blue/10 p-3 rounded-full"><i class="fa-solid fa-pen"></i></button><button type="button" id="btn-delete-item" class="text-ios-red bg-ios-red/10 p-3 rounded-full"><i class="fa-solid fa-trash"></i></button><button type="button" class="text-white text-3xl ml-2 close-modal" data-target="item-details-modal">&times;</button></div></div><div id="item-details-view" class="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm bg-ios-bg p-5 rounded-2xl mb-6 shadow-inner border border-ios-border"><div class="col-span-1"><span class="text-ios-textMuted block mb-1">C√≥d. Interno</span><span id="details-product-code" class="text-white font-medium"></span></div><div class="col-span-1 md:col-span-2"><span class="text-ios-textMuted block mb-1">Fornecedor</span><span id="details-supplier" class="text-white font-medium truncate"></span></div><div class="col-span-2 md:col-span-1"><span class="text-ios-textMuted block mb-1">Estoque M√≠n.</span><span id="details-min-stock" class="text-ios-orange font-medium"></span></div><div class="col-span-2"><span class="text-ios-textMuted block mb-1">EANs</span><span id="details-product-barcode" class="text-white font-mono break-all text-xs"></span></div><div class="col-span-2 md:col-span-6 bg-ios-cardHover p-3 rounded-xl mt-1"><span class="text-ios-textMuted block mb-1 uppercase font-bold text-[10px]">Saldo F√≠sico Total</span><span id="details-total-quantity" class="text-ios-green font-bold text-3xl"></span></div></div><div id="item-details-edit" class="hidden mb-6 bg-ios-bg p-5 rounded-2xl border border-ios-border shadow-inner"><form id="edit-item-form" class="grid grid-cols-1 md:grid-cols-6 gap-5"><input type="hidden" id="edit-item-id"><div class="md:col-span-6"><label class="form-label">Classifica√ß√£o</label><select id="edit-product-type" required class="form-input"><option value="insumo">Insumo</option><option value="semi_acabado">Semi-acabado</option></select></div><div class="md:col-span-6"><label class="form-label">Nome</label><input type="text" id="edit-product-name" required class="form-input"></div><div class="md:col-span-3"><label class="form-label">C√≥d Interno</label><input type="text" id="edit-product-code" class="form-input"></div><div class="md:col-span-3"><label class="form-label">Fornecedor</label><input type="text" id="edit-supplier" class="form-input"></div><div class="md:col-span-2"><label class="form-label">Estoque M√≠n.</label><input type="number" step="0.01" id="edit-min-stock" class="form-input text-ios-orange font-bold"></div><div class="md:col-span-4"><label class="form-label">EANs (Separe por v√≠rgula)</label><input type="text" id="edit-product-barcode" class="form-input font-mono"></div><div class="md:col-span-6 flex justify-end gap-3 mt-2"><button type="button" id="btn-cancel-edit" class="btn-secondary">Cancelar</button><button type="submit" class="btn-primary">Salvar Edi√ß√£o</button></div></form></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div><h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3">Lotes F√≠sicos</h3><div class="table-container mb-8 max-h-96 overflow-y-auto"><table class="base-table min-w-[400px]"><thead class="base-thead"><tr><th>Lote</th><th>Status</th><th>Local</th><th>Validade</th><th>Volume</th><th class="text-center">A√ß√µes</th></tr></thead><tbody id="details-batches-table"></tbody></table></div></div><div><h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3 flex justify-between items-center">Extrato<button type="button" id="btn-clear-hist-filters" class="text-xs text-ios-blue hover:text-blue-300 font-normal underline hidden">Limpar Filtros</button></h3><div class="flex gap-2 mb-3 bg-ios-bg p-3 rounded-xl border border-ios-border shadow-inner items-center"><input type="date" id="hist-filter-start" class="form-input py-1 px-2 text-xs"><span class="text-ios-textMuted text-xs">at√©</span><input type="date" id="hist-filter-end" class="form-input py-1 px-2 text-xs"><select id="hist-filter-type" class="form-input py-1 px-2 text-xs ml-auto"><option value="">Todas</option><option value="entrada">Entradas</option><option value="sa√≠da">Sa√≠das (OP)</option><option value="requisi√ß√£o">Baixa Avulsa</option><option value="ajuste">Ajustes</option></select></div><div class="table-container max-h-72 overflow-y-auto bg-ios-bg p-2" id="details-history-container"></div></div></div></div></div>

    <div id="edit-batch-modal" class="modal z-[7000]"><div class="modal-content max-w-sm"><h2 class="title-md mb-4">Editar Lote</h2><form id="edit-batch-form" class="space-y-4"><input type="hidden" id="edit-batch-id"><input type="hidden" id="edit-batch-product-id"><div><label class="form-label">C√≥digo Lote</label><input type="text" id="edit-batch-code" required class="form-input"></div><div><label class="form-label">Quantidade</label><input type="number" step="0.001" id="edit-batch-qty" required class="form-input text-ios-blue font-bold"></div><div><label class="form-label">Validade</label><input type="date" id="edit-batch-expiry" class="form-input"></div><div class="flex justify-end gap-2 mt-4"><button type="button" class="btn-secondary close-modal" data-target="edit-batch-modal">Cancelar</button><button type="submit" class="btn-primary">Salvar</button></div></form></div></div>

    <div id="batch-selector-modal" class="modal z-[7000]"><div class="modal-content max-w-xl"><h2 id="batch-selector-title" class="title-md mb-4">Descontar de quais lotes?</h2><div class="bg-ios-bg border border-ios-border p-4 rounded-xl flex justify-between mb-5 items-center"><span class="text-ios-textMuted text-sm">Alvo OP: <span id="batch-selector-needed" class="text-white font-semibold"></span></span><span class="text-ios-textMuted text-sm bg-ios-input py-1 px-3 rounded-lg">Marcado: <span id="batch-selector-selected" class="font-bold text-lg text-ios-blue"></span></span></div><div id="batch-selector-list" class="max-h-64 overflow-y-auto mb-6 space-y-2"></div><div class="flex justify-end gap-3"><button type="button" class="btn-secondary close-modal" data-target="batch-selector-modal">Cancelar</button><button type="button" id="confirm-batch-selection" class="btn-primary">Aplicar Sele√ß√£o Real</button></div></div></div>

    <div id="low-stock-modal" class="modal z-[6000]"><div class="modal-content max-w-4xl h-[85vh] flex flex-col p-0 overflow-hidden bg-ios-bg"><div class="flex justify-between items-start shrink-0 p-6 border-b border-ios-border bg-ios-cardHover"><div><h2 class="title-md mb-1 text-white flex items-center text-xl"><i class="fa-solid fa-bell mr-3 text-2xl text-ios-red"></i><span>Alertas do Sistema</span></h2></div><button type="button" class="text-white text-4xl ml-4 close-modal" data-target="low-stock-modal">&times;</button></div><div class="flex-1 overflow-y-auto p-6 grid grid-cols-1 lg:grid-cols-2 gap-8"><div><h3 class="text-ios-orange font-bold mb-4 uppercase text-sm flex items-center bg-ios-orange/10 p-2 rounded-lg"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Abaixo do M√≠nimo</h3><ul id="low-stock-list" class="space-y-3"></ul></div><div><h3 class="text-ios-red font-bold mb-4 uppercase text-sm flex items-center bg-ios-red/10 p-2 rounded-lg"><i class="fa-solid fa-clock mr-2"></i>Validades (Pr√≥x. 45 dias)</h3><ul id="expiring-list" class="space-y-3"></ul></div></div></div></div>

    <div id="confirm-action-modal" class="modal z-[9999]"><div class="modal-content max-w-md text-center flex flex-col items-center p-6"><div class="w-16 h-16 rounded-full bg-ios-cardHover border border-ios-border flex items-center justify-center mb-5 shrink-0"><i class="fa-solid fa-circle-question text-3xl text-ios-blue"></i></div><h3 id="confirm-title" class="title-md mb-2 text-xl"></h3><p id="confirm-message" class="text-ios-textMuted text-sm mb-8 leading-relaxed"></p><div class="flex gap-3 w-full justify-center"><button type="button" id="cancel-action-btn" class="btn-secondary w-1/2">Cancelar</button><button type="button" id="confirm-action-btn" class="btn-primary w-1/2">Sim, Continuar</button></div></div></div>

    <div id="quick-register-modal" class="modal z-[8000]"><div class="modal-content max-w-lg"><h2 class="title-md mb-2 text-ios-orange"><i class="fa-solid fa-box-open mr-2"></i>Cadastrar Produto</h2><form id="global-quick-register-form" class="space-y-4"><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div class="sm:col-span-2"><label class="form-label">Nome / Descri√ß√£o</label><input type="text" id="g-quick-reg-name" required class="form-input"></div><div><label class="form-label">C√≥d. Interno</label><input type="text" id="g-quick-reg-internal-code" class="form-input" placeholder="Opcional"></div><div><label class="form-label">C√≥d. Barras (EAN)</label><div class="flex gap-2"><input type="text" id="g-quick-reg-barcode" class="form-input" placeholder="Opcional"><button type="button" id="btn-scan-quick-reg-barcode" class="bg-ios-blue text-white p-3 rounded-xl shrink-0"><i class="fa-solid fa-camera"></i></button></div></div><div><label class="form-label">Classifica√ß√£o</label><select id="g-quick-reg-type" required class="form-input"><option value="insumo">Insumo</option><option value="semi_acabado">Semi-acabado</option></select></div><div><label class="form-label">Fornecedor</label><input type="text" id="g-quick-reg-supplier" class="form-input" list="supplier-datalist" placeholder="Nome do Fornecedor" autocomplete="off"><datalist id="supplier-datalist"></datalist></div><div><label class="form-label">Prazo Entrega</label><input type="number" id="g-quick-reg-lead" min="0" class="form-input" value="0"></div><div><label class="form-label">Estoque M√≠n.</label><input type="number" step="0.01" id="g-quick-reg-min" min="0" class="form-input" value="0"></div></div><div class="flex justify-end gap-2 pt-4 border-t border-ios-border"><button type="button" class="btn-secondary close-modal" data-target="quick-register-modal">Cancelar</button><button type="submit" class="btn-primary"><i class="fa-solid fa-save mr-2"></i>Salvar e Usar</button></div></form></div></div>

<datalist id="locations-datalist"></datalist>
<script type="module">
// UTILS
const id=n=>document.getElementById(n), show=e=>{if(e){e.style.display='flex';e.classList.remove('hidden');}}, hide=e=>{if(e){e.style.display='none';e.classList.add('hidden');}}, addEvt=(e,t,f)=>{const el=id(e);if(el)el.addEventListener(t,f);};
window.showNotif=(m,e=false)=>{const el=id('notification-modal');if(!el)return;el.innerHTML=e?`<i class="fa-solid fa-triangle-exclamation mr-2"></i> ${m}`:`<i class="fa-solid fa-check mr-2"></i> ${m}`;el.className=`fixed top-6 left-1/2 transform -translate-x-1/2 z-[9999999] py-3 px-6 rounded-full shadow-2xl font-semibold text-white transition-all text-sm backdrop-blur-md w-max max-w-[90vw] text-center ${e?'bg-ios-red/95':'bg-ios-green/95'}`;show(el);setTimeout(()=>hide(el),4000);};
function addBusinessDays(s,d){let dt=new Date(s),a=0;while(a<d){dt.setDate(dt.getDate()+1);if(dt.getDay()!==0&&dt.getDay()!==6)a++;}return dt;}

// NOTIFICATIONS API
function notifyUser(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/2804/2804060.png' });
    }
    window.showNotif(`${title} - ${body}`);
}
if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
    Notification.requestPermission();
}

// PWA
const iconSvg=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%230a84ff"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`;
const manifest={name:"Estoque OS",short_name:"Estoque",start_url:location.href,display:"standalone",background_color:"#000000",theme_color:"#0a84ff",icons:[{src:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(iconSvg),sizes:"512x512",type:"image/svg+xml",purpose:"any maskable"}]};
document.head.insertAdjacentHTML('beforeend',`<link rel="manifest" href="${URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/json'}))}">`);
if('serviceWorker' in navigator)navigator.serviceWorker.register(URL.createObjectURL(new Blob([`self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(clients.claim()));self.addEventListener('fetch',e=>{if(e.request.url.startsWith('http')){e.respondWith(fetch(e.request).catch(()=>new Response('Offline')));}})`],{type:'application/javascript'}))).catch(()=>{});
let dP; window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dP=e;id('pwa-install-card')?.classList.remove('hidden');});
id('btn-install-pwa')?.addEventListener('click',async()=>{if(dP){dP.prompt();const{outcome}=await dP.userChoice;if(outcome==='accepted')id('pwa-install-card').classList.add('hidden');dP=null;} else { window.showNotif('No Android: Toque nos tr√™s pontos do Chrome > Adicionar √† tela inicial.'); }});

// FIREBASE
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import{getAuth,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,signOut,signInAnonymously,signInWithCustomToken}from"https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import{getFirestore,collection,doc,addDoc,setDoc,getDoc,getDocs,deleteDoc,onSnapshot}from"https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const isCanvas = typeof __firebase_config !== 'undefined';
const fC = isCanvas ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyDev8spgKoKZi2pOohmk0r9SFLtLMcePa8",
    authDomain: "estoque-b50df.firebaseapp.com",
    projectId: "estoque-b50df",
    storageBucket: "estoque-b50df.firebasestorage.app",
    messagingSenderId: "634756791567",
    appId: "1:634756791567:web:993e61243b57b7e057d27a"
};

const app = initializeApp(fC);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// MODIFY HERE TO SUPPORT PRIVATE DATABASES PER USER
const getCol = (c) => {
    const uid = auth.currentUser?.uid || 'unknown_user';
    return isCanvas ? collection(db, 'artifacts', appId, 'users', uid, c) : collection(db, 'users', uid, c);
};

const getDocRef = (c, i) => {
    const uid = auth.currentUser?.uid || 'unknown_user';
    return isCanvas ? doc(db, 'artifacts', appId, 'users', uid, c, i) : doc(db, 'users', uid, c, i);
};

const DB = {
    add: async (c, d) => {
        if(!auth.currentUser) throw new Error("Auth missing");
        const r = await addDoc(getCol(c), d);
        await setDoc(r, { id: r.id }, { merge: true });
        return r.id;
    },
    update: async (c, d) => {
        if(!auth.currentUser) throw new Error("Auth missing");
        if (d.id) await setDoc(getDocRef(c, d.id), d, { merge: true });
    },
    remove: async (c, i) => {
        if(!auth.currentUser) throw new Error("Auth missing");
        if (i) await deleteDoc(getDocRef(c, i));
    },
    get: async (c, i) => {
        if(!auth.currentUser) throw new Error("Auth missing");
        if (!i) return null;
        const s = await getDoc(getDocRef(c, i));
        return s.exists() ? s.data() : null;
    },
    getAll: async (c) => {
        if(!auth.currentUser) throw new Error("Auth missing");
        const q = await getDocs(getCol(c));
        return q.docs.map(x => x.data());
    }
};

// SCANNER
let html5QrCode, sCb=null;
function openScanner(cb){
    sCb=cb;
    const i=id('scanner-manual-input');
    if(i){i.value='';i.focus();}
    show(id('scanner-modal'));
    setTimeout(()=>{
        if(id('scanner-modal').classList.contains('hidden')||(html5QrCode&&html5QrCode.isScanning)) return;
        html5QrCode=new Html5Qrcode("reader");
        html5QrCode.start(
            {facingMode:"environment"},
            {fps:10,qrbox:(w,h)=>({width:Math.min(w*.9,600),height:Math.min(h*.6,280)})},
            txt=>{const c=sCb;closeScanner();if(c)c(txt);},
            e=>{}
        ).catch(()=>window.showNotif("C√¢mera indispon√≠vel",true));
    },300);
}
function closeScanner(){
    hide(id('scanner-modal'));
    if(html5QrCode&&html5QrCode.isScanning){html5QrCode.stop().then(()=>{html5QrCode.clear();html5QrCode=null;}).catch(()=>{});}
    sCb=null;
}
document.querySelectorAll('.close-scanner').forEach(b=>b.addEventListener('click',closeScanner));
addEvt('btn-scanner-manual-confirm','click',()=>{
    const v=id('scanner-manual-input').value.trim();
    if(v&&sCb){const c=sCb;closeScanner();c(v);} else window.showNotif('Inv√°lido',true);
});
addEvt('scanner-manual-input','keydown',e=>{
    if(e.key==='Enter'){e.preventDefault();id('btn-scanner-manual-confirm').click();}
});

// AUTH
if(isCanvas) {
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch(e) {
            console.error("Canvas Auth Error:", e);
        }
    };
    initAuth();
}

addEvt('btn-login-google','click',()=>{
    const m=id('mensagem-erro');
    if(m){m.innerText="Abrindo...";show(m);}
    signInWithPopup(auth,provider).catch(()=>{if(m){m.innerHTML="Erro de Login";show(m);}});
});
addEvt('btn-bypass-login','click',async()=>{
    const m=id('mensagem-erro');
    if(m){m.innerText="Entrando anonimamente...";show(m);}
    try{await signInAnonymously(auth);}catch(e){console.error(e);if(m){m.innerHTML="Erro no login an√¥nimo (Ative no Firebase).";show(m);}}
});
const logout=()=>{signOut(auth).then(()=>window.showNotif('Sess√£o encerrada.')).catch(console.error);};
addEvt('btn-sair','click',logout); addEvt('btn-sair-mobile','click',logout);

let opsUnsubscribe = null;

onAuthStateChanged(auth, async u => {
    if(u) {
        hide(id('login-wrapper'));
        show(id('app-wrapper'));
        if(id('nome-usuario')) id('nome-usuario').innerText = u.displayName || 'Estoquista';
        show(id('loading-overlay'));
        window.navTo('home');
        try {
            await refreshData();
            setupRealtimeListeners();
        } catch(e) {
            window.showNotif('Erro de permiss√£o no banco.', true);
            console.error(e);
        }
        hide(id('loading-overlay'));
    } else {
        if(opsUnsubscribe) { opsUnsubscribe(); opsUnsubscribe = null; }
        show(id('login-wrapper'));
        hide(id('app-wrapper'));
        hide(id('loading-overlay'));
    }
});

function setupRealtimeListeners() {
    if(!auth.currentUser) return;
    let isInitialLoad = true;
    
    opsUnsubscribe = onSnapshot(getCol('productionOrders'), (snapshot) => {
        if (!isInitialLoad) {
            snapshot.docChanges().forEach((change) => {
                const op = change.doc.data();
                if (change.type === "added" && op.status === 'pendente') {
                    notifyUser('Nova OP Lan√ßada', `Setor: ${op.recipeCategory} - Receita: ${op.recipeName}`);
                }
                if (change.type === "modified") {
                    const oldOp = localProductionOrders.find(x => x.id === op.id);
                    if (oldOp && oldOp.picking?.status !== 'concluido' && op.picking?.status === 'concluido') {
                        notifyUser('Separa√ß√£o Conclu√≠da', `O setor ${op.recipeCategory} separou itens para OP de ${op.recipeName}`);
                    }
                }
            });
        }
        localProductionOrders = snapshot.docs.map(d => d.data());
        
        const aN=document.querySelector('.nav-item.bg-ios-card') || document.querySelector('.nav-item-mobile.text-ios-blue');
        if(aN) {
            const t=aN.dataset.target;
            if(t==='production') renderPO();
            if(t==='picking') renderPickingScreen();
            if(t==='traceability') renderTraceability();
            if(t==='divergences') renderDivergences();
        }
        updateSidebarBadges();
        isInitialLoad = false;
    }, (error) => {
        console.error("Realtime listener error:", error);
    });
}

// STATE
let localInventory=[],localBatches=[],localHistory=[],localRecipes=[],localProductionOrders=[],localMonthlyConsumption=[],localLocations=[];
let currentRecipeCategory='Todos',currentHistoryProductId=null,activePickingLine=null,activePickingOpIds=[],pickingScanProductId=null,bulkEntryItems=[],quickRegisterCallback=null;
let invSort={col:'name',asc:true}; const typeLabels={insumo:'Insumo',semi_acabado:'Semi-acabado'};
let batchSelectorContext = null; 
let currentPickingPlans = {}; 
let currentBatchTarget = null;
document.querySelectorAll('.close-modal').forEach(b=>b.addEventListener('click',()=>hide(id(b.dataset.target))));

// NAVIGATION
const screens=['home','consulta','entry','inventory','recipes','production','requisitions','adjustments','consumption','locations','barcodes','picking','purchasing','settings','traceability','divergences'];
window.navTo=t=>{
    screens.forEach(s=>id('screen-'+s)?.classList.add('hidden'));
    document.querySelectorAll('.nav-item').forEach(n=>{n.classList.remove('bg-ios-card','text-white');n.classList.add('text-ios-textMuted');});
    document.querySelector(`.nav-item[data-target="${t}"]`)?.classList.add('bg-ios-card','text-white');
    document.querySelector(`.nav-item[data-target="${t}"]`)?.classList.remove('text-ios-textMuted');
    document.querySelectorAll('.nav-item-mobile').forEach(n=>{n.classList.remove('text-ios-blue');n.classList.add('text-ios-textMuted');});
    document.querySelector(`.nav-item-mobile[data-target="${t}"]`)?.classList.add('text-ios-blue');
    document.querySelector(`.nav-item-mobile[data-target="${t}"]`)?.classList.remove('text-ios-textMuted');
    id('screen-'+t)?.classList.remove('hidden');
    
    if(t==='adjustments') createSearchableSelect(id('adjustment-searchable-container'),localInventory,'Buscar...',p=>{const b=id('adjustment-batch');if(b)b.innerHTML='<option value="">Lote...</option>'+localBatches.filter(x=>x.productId===p.id&&x.quantity>0).map(x=>`<option value="${x.id}">${x.code}</option>`).join('');});
    if(t==='requisitions'){const r=id('requisition-items-container');if(r){r.innerHTML='';addIngRowReq(r);}}
    if(t==='picking') renderPickingScreen(); 
    if(t==='purchasing') renderPurchasing(); 
    if(t==='barcodes'){renderBarcodesList();createSearchableSelect(id('barcode-searchable-container'),localInventory,'Produto...');}
    if(t==='locations'){renderAllLocations();id('location-search-input').value='';hide(id('location-details-panel'));hide(id('location-create-panel'));show(id('location-empty-state'));}
    if(t==='traceability') renderTraceability();
    if(t==='divergences') renderDivergences();
    if(t==='production') renderPO();
    if(t==='consulta'){id('consulta-input').value='';id('consulta-results').innerHTML=`<div class="card flex flex-col items-center justify-center py-20 text-center border-dashed"><i class="fa-solid fa-magnifying-glass text-6xl text-ios-cardHover mb-4"></i><p class="text-ios-textMuted">Aguardando leitura...</p></div>`;setTimeout(()=>id('consulta-input').focus(),100);}
    if(t==='entry'){createSearchableSelect(id('entry-searchable-container'),localInventory,'Pesquisar...',p=>{document.querySelector('#entry-form input[name="quantity"]').focus();});renderBulkEntry();}
};
document.querySelectorAll('.nav-item, .nav-item-mobile, .nav-btn').forEach(l=>l.addEventListener('click',e=>{e.preventDefault();window.navTo(l.dataset.target||l.closest('.nav-btn').dataset.target);}));

function showConfirmationModal(t,m,cb){
    id('confirm-title').textContent=t;
    id('confirm-message').innerHTML=m;
    show(id('confirm-action-modal'));
    const bC=id('cancel-action-btn'),bO=id('confirm-action-btn');
    const cl=()=>{hide(id('confirm-action-modal'));bO.replaceWith(bO.cloneNode(true));bC.replaceWith(bC.cloneNode(true));};
    bC.addEventListener('click',cl,{once:true});
    bO.addEventListener('click',()=>{cb();cl();},{once:true});
}

window.openQuickRegisterModal=(t,cb)=>{
    quickRegisterCallback=cb;
    const f=id('global-quick-register-form');
    if(f)f.reset();
    const iE=/^\d{8,14}$/.test(t);
    if(id('g-quick-reg-internal-code'))id('g-quick-reg-internal-code').value=iE?'':t;
    if(id('g-quick-reg-barcode'))id('g-quick-reg-barcode').value=iE?t:'';
    if(id('g-quick-reg-name'))id('g-quick-reg-name').value='';
    const dl=id('supplier-datalist');
    if(dl){const sups=[...new Set(localInventory.map(i=>i.supplier))].filter(Boolean).sort();dl.innerHTML=sups.map(s=>`<option value="${s}">`).join('');}
    show(id('quick-register-modal'));
    setTimeout(()=>id('g-quick-reg-name')?.focus(),100);
};

addEvt('btn-scan-quick-reg-barcode','click',()=>openScanner(c=>{
    const i=id('g-quick-reg-barcode');
    if(i)i.value=c;
    window.showNotif('C√≥digo EAN lido!');
}));

addEvt('g-quick-reg-supplier','change',e=>{
    const m=localInventory.find(i=>i.supplier===e.target.value);
    if(m&&id('g-quick-reg-lead'))id('g-quick-reg-lead').value=m.leadTime||0;
});

addEvt('global-quick-register-form','submit',async e=>{
    e.preventDefault();
    const intC=id('g-quick-reg-internal-code').value.trim();
    const barC=id('g-quick-reg-barcode').value.trim();
    const n=id('g-quick-reg-name').value.trim();
    const t=id('g-quick-reg-type').value;
    const s=id('g-quick-reg-supplier').value.trim()||'Diversos';
    const l=parseInt(id('g-quick-reg-lead').value)||0;
    const m=parseFloat(id('g-quick-reg-min').value)||0;
    
    show(id('loading-overlay'));
    try{
        const p={name:n,type:t,supplier:s,leadTime:l,minStock:m,totalQuantity:0,code:intC,barcodes:barC?barC.split(',').map(b=>b.trim()):[]};
        p.id=await DB.add('inventory',p);
        window.showNotif('Cadastrado!');
        await refreshData();
        hide(id('quick-register-modal'));
        if(quickRegisterCallback){quickRegisterCallback(p);quickRegisterCallback=null;}
    }catch(err){
        window.showNotif('Erro',true);
    }finally{
        hide(id('loading-overlay'));
    }
});

function createSearchableSelect(c,i,p,oS){
    if(!c)return;
    c.innerHTML=`<div class="searchable-container"><input type="text" class="form-input bg-ios-input text-white border-ios-border w-full text-sm sm:text-base" placeholder="${p}" autocomplete="off"><div class="searchable-dropdown hidden"></div></div>`;
    const inp=c.querySelector('input'),dr=c.querySelector('.searchable-dropdown');
    if(!inp||!dr)return;
    
    const rL=t=>{
        let f=i;
        if(t){
            const tm=t.toLowerCase();
            f=f.filter(x=>(x.searchName||x.name).toLowerCase().includes(tm)||(x.code&&x.code.toLowerCase().includes(tm))||(x.barcodes&&x.barcodes.some(b=>b.toLowerCase().includes(tm))));
        }
        if(f.length){
            dr.innerHTML=f.map(x=>`<div class="searchable-item flex justify-between items-center text-sm" data-id="${x.id}"><span class="font-medium truncate pr-2">${x.searchName||x.name}</span>${x.type?`<span class="text-[10px] text-ios-textMuted bg-black/30 px-2 py-1 rounded shrink-0">${typeLabels[x.type]||''}</span>`:''}</div>`).join('');
            dr.classList.remove('hidden');
        }else{
            dr.innerHTML=`<div class="p-3 text-ios-textMuted text-xs flex flex-col gap-2 border-t border-ios-border">Nenhum resultado...<button type="button" class="btn-primary py-2 px-3 text-xs w-full btn-inline-quick-add" data-term="${t}"><i class="fa-solid fa-plus mr-1"></i> Cadastrar "${t}"</button></div>`;
            dr.classList.remove('hidden');
        }
    };
    
    inp.addEventListener('focus',()=>rL(inp.value));
    inp.addEventListener('input',()=>rL(inp.value));
    
    dr.addEventListener('click',e=>{
        const r=e.target.closest('.searchable-item');
        if(r){
            const it=i.find(x=>x.id==r.dataset.id);
            inp.value=it.searchName||it.name;
            inp.dataset.selectedId=it.id;
            dr.classList.add('hidden');
            if(oS)oS(it);
        }
        const qA=e.target.closest('.btn-inline-quick-add');
        if(qA){
            e.preventDefault();
            dr.classList.add('hidden');
            if(window.openQuickRegisterModal){
                window.openQuickRegisterModal(qA.dataset.term,nP=>{
                    inp.value=nP.name;
                    inp.dataset.selectedId=nP.id;
                    if(oS)oS(nP);
                });
            }
        }
    });
    
    document.addEventListener('click',e=>{if(!c.contains(e.target))dr.classList.add('hidden');});
}

function getFIFOPlan(pId,qN){
    const b=localBatches.filter(x=>x.productId===pId&&x.quantity>0&&x.isReleased!==false).sort((a,b)=>new Date(a.expiryDate||'9999-01-01')-new Date(b.expiryDate||'9999-01-01'));
    let r=qN,p=[];
    for(let x of b){
        if(r<=0)break;
        const t=Math.min(x.quantity,r);
        p.push({batchId:x.id,batchCode:x.code,quantity:t});
        r-=t;
    }
    return{plan:p,isSufficient:r<=0.0001};
}

function hasPEPSBreak(productId, chosenPlan) {
    if(!chosenPlan || chosenPlan.length === 0) return false;
    const totalQty = chosenPlan.reduce((s,x)=>s+x.quantity, 0);
    const strictPlan = getFIFOPlan(productId, totalQty).plan;
    const strictCodes = strictPlan.map(x=>x.batchCode).sort();
    const chosenCodes = chosenPlan.map(x=>x.batchCode).sort();
    for(let code of strictCodes) {
        if(!chosenCodes.includes(code)) return true;
    }
    return false;
}

async function refreshData(){
    try{
        [localInventory,localBatches,localHistory,localRecipes,localProductionOrders,localMonthlyConsumption,localLocations]=await Promise.all([DB.getAll('inventory'),DB.getAll('batches'),DB.getAll('history'),DB.getAll('recipes'),DB.getAll('productionOrders'),DB.getAll('monthlyConsumption'),DB.getAll('locations')]);
        
        let cI=false;
        for(let i of localInventory){
            if(i.barcode&&!i.barcodes){i.barcodes=[i.barcode];delete i.barcode;cI=true;}
            else if(!i.barcodes){i.barcodes=[];cI=true;}
            
            if(!i.type||i.type==='acabado'){i.type='insumo';cI=true;}
            
            const bs=localBatches.filter(b=>b.productId===i.id).reduce((s,b)=>s+Math.max(0,b.quantity),0);
            if(Math.abs((i.totalQuantity||0)-bs)>0.001){i.totalQuantity=bs;cI=true;}
            
            if(cI)await DB.update('inventory',i);
        }
        
        if(cI)localInventory=await DB.getAll('inventory');
        
        populateFilters();
        renderHome();
        renderInv();
        renderRecipes();
        renderPO();
        updateSidebarBadges();
        
        const aN=document.querySelector('.nav-item.bg-ios-card')||document.querySelector('.nav-item-mobile.text-ios-blue');
        if(aN){
            const t=aN.dataset.target;
            if(t==='picking')renderPickingScreen();
            if(t==='barcodes')renderBarcodesList();
            if(t==='purchasing')renderPurchasing();
            if(t==='locations')renderAllLocations();
            if(t==='traceability')renderTraceability();
            if(t==='divergences')renderDivergences();
        }
        if(currentHistoryProductId)renderItemDetailsHistory();
    }catch(e){
        window.showNotif('Erro.',true);
        console.error(e);
    }
}

function populateFilters(){
    const cS=id('supplier-filter')?.value;
    const sups=[...new Set(localInventory.map(i=>i.supplier))].filter(Boolean).sort();
    const sf=id('supplier-filter');
    if(sf){sf.innerHTML='<option value="">Fornecedores</option>'+sups.map(s=>`<option value="${s}">${s}</option>`).join('');sf.value=cS;}
    
    const lD=id('locations-datalist');
    if(lD)lD.innerHTML=localLocations.map(l=>`<option value="${l.code}">${l.name}</option>`).join('');
}

function renderHome(){
    const tS=new Date().toISOString().split('T')[0];
    const inc=localInventory.filter(i=>i.pendingOrder?.active&&i.pendingOrder.expectedDate<=tS);
    const c=id('home-incoming-orders');
    if(!c)return;
    
    if(inc.length===0){
        c.innerHTML='<div class="col-span-full text-ios-textMuted text-sm bg-ios-cardHover p-4 rounded-xl text-center border border-ios-border">Nenhuma entrega.</div>';
        return;
    }
    
    const bS={};
    inc.forEach(i=>{const s=i.supplier||'Diversos';if(!bS[s])bS[s]=[];bS[s].push(i);});
    
    c.innerHTML=Object.keys(bS).map(s=>{
        const i=bS[s];
        return `<div class="bg-ios-cardHover p-4 rounded-xl border border-ios-blue shadow-lg shadow-ios-blue/10 cursor-pointer active:bg-ios-blue/20 sm:hover:bg-ios-blue/10 transition flex justify-between items-center btn-receive-incoming" data-ids='${JSON.stringify(i.map(x=>x.id))}'><div><h3 class="font-bold text-white text-base sm:text-lg"><i class="fa-solid fa-truck-fast text-ios-blue mr-2"></i>${s}</h3><p class="text-[10px] sm:text-xs text-ios-textMuted mt-1">${i.length} item(ns)</p></div><i class="fa-solid fa-chevron-right text-ios-textMuted"></i></div>`;
    }).join('');
}

addEvt('home-incoming-orders','click',e=>{
    const b=e.target.closest('.btn-receive-incoming');
    if(b){
        JSON.parse(b.dataset.ids).forEach(i=>{
            const it=localInventory.find(x=>x.id===i);
            if(it&&!bulkEntryItems.some(x=>x.productId===it.id)){
                bulkEntryItems.push({productId:it.id,qty:0,batchCode:'',mfgDate:'',expiryDate:'',locationCode:''});
            }
        });
        window.navTo('entry');
    }
});

function updateSidebarBadges(){
    const iPA=localProductionOrders.some(o=>o.picking?.status==='em_andamento');
    [id('badge-nav-prod'),id('badge-nav-picking'),id('badge-nav-picking-mobile')].forEach(e=>{if(e)iPA?e.classList.remove('hidden'):e.classList.add('hidden');});
    
    const ls=localInventory.filter(i=>(i.minStock||0)>0&&(i.totalQuantity||0)<=i.minStock);
    const qD=new Date();
    qD.setDate(qD.getDate()+45);
    const eb=localBatches.filter(b=>b.quantity>0&&b.expiryDate&&new Date(b.expiryDate)<=qD);
    const tA=ls.length+eb.length;
    
    if(tA>0){
        if(id('badge-nav-alerts')){id('badge-nav-alerts').innerText=tA;id('badge-nav-alerts').classList.remove('hidden');}
        if(id('badge-nav-alerts-mobile')){id('badge-nav-alerts-mobile').innerText=tA>99?'99+':tA;id('badge-nav-alerts-mobile').classList.remove('hidden');}
    }else{
        [id('badge-nav-alerts'),id('badge-nav-alerts-mobile')].forEach(e=>{if(e)e.classList.add('hidden');});
    }
    
    const lsl=id('low-stock-list');
    if(lsl){
        lsl.innerHTML=ls.length?ls.map(i=>`<li class="bg-ios-cardHover p-3 rounded-xl border-l-4 border-l-ios-orange flex justify-between items-center cursor-pointer alert-item" data-id="${i.id}"><div><h4 class="font-bold text-white text-sm">${i.name}</h4><p class="text-[10px] text-ios-textMuted">${i.code||'-'}</p></div><div class="text-right"><p class="font-mono text-ios-orange font-bold">${(i.totalQuantity||0).toFixed(2)}</p><p class="text-[9px] text-ios-textMuted">Min: ${i.minStock}</p></div></li>`).join(''):'<li class="text-center text-ios-textMuted py-4">Tudo OK.</li>';
    }
    
    const el=id('expiring-list');
    if(el){
        el.innerHTML=eb.length?eb.map(b=>{const p=localInventory.find(i=>i.id===b.productId);const d=Math.ceil((new Date(b.expiryDate)-new Date())/(1000*60*60*24));return `<li class="bg-ios-cardHover p-3 rounded-xl border-l-4 border-l-ios-red flex justify-between items-center cursor-pointer alert-item" data-id="${p?.id}"><div><h4 class="font-bold text-white text-sm">${p?.name||'?'}</h4><p class="text-[10px] text-ios-textMuted">Lote: ${b.code}</p></div><div class="text-right"><span class="font-bold ${d<=7?'text-ios-red':'text-ios-orange'}">${d} dias</span><br><span class="text-[9px] text-ios-textMuted">${new Date(b.expiryDate+'T00:00:00').toLocaleDateString()}</span></div></li>`;}).join(''):'<li class="text-center text-ios-textMuted py-4">Tudo OK.</li>';
    }
}

['btn-show-alerts','btn-show-alerts-mobile'].forEach(b=>addEvt(b,'click',()=>show(id('low-stock-modal'))));
['low-stock-list','expiring-list'].forEach(l=>addEvt(l,'click',e=>{const i=e.target.closest('.alert-item');if(i){hide(id('low-stock-modal'));window.navTo('inventory');openDetails(i.dataset.id);}}));

function searchUniversal(q){
    if(!q)return window.showNotif("Vazio",true);
    q=q.trim().toLowerCase();
    const rE=id('consulta-results');
    rE.innerHTML='';
    let fA=false;
    
    const pM=localInventory.filter(i=>(i.code&&i.code.toLowerCase()===q)||(i.barcodes&&i.barcodes.some(b=>b.toLowerCase()===q)));
    if(pM.length){
        fA=true;
        pM.forEach(p=>{
            const bt=localBatches.filter(b=>b.productId===p.id&&b.quantity>0);
            rE.innerHTML+=`<div class="card border-l-4 border-l-ios-blue mb-4"><h2 class="title-md text-ios-blue text-sm"><i class="fa-solid fa-box mr-2"></i>Produto</h2><p class="text-white font-bold text-xl">${p.name}</p><div class="grid grid-cols-2 gap-2 text-xs bg-ios-bg p-3 rounded mt-2"><div><b>C√≥d</b>: ${p.code||'-'}</div><div><b>EANs</b>: ${p.barcodes?.join(', ')||'-'}</div><div class="col-span-2 text-ios-blue font-bold text-lg text-right mt-2 border-t border-ios-border pt-2">Saldo: ${(p.totalQuantity||0).toFixed(2)}</div></div><table class="base-table mt-4"><thead class="base-thead"><tr><th>Lote/Local</th><th>Val</th><th class="text-right">Qtd</th></tr></thead><tbody>${bt.map(b=>`<tr><td class="base-td">${b.code}<br><span class="text-[10px] text-ios-blue">${b.locationCode||'-'}</span></td><td class="base-td">${b.expiryDate?new Date(b.expiryDate+'T00:00:00').toLocaleDateString():'-'}</td><td class="base-td text-right font-bold text-ios-green">${b.quantity.toFixed(2)}</td></tr>`).join('')||`<tr><td colspan="3" class="text-center py-4">Sem lotes</td></tr>`}</tbody></table></div>`;
        });
    }
    
    const lM=localLocations.filter(l=>l.code.toLowerCase()===q);
    if(lM.length){
        fA=true;
        lM.forEach(l=>{
            const bt=localBatches.filter(b=>b.locationCode===l.code&&b.quantity>0);
            rE.innerHTML+=`<div class="card border-l-4 border-l-ios-green mb-4"><h2 class="title-md text-ios-green text-sm"><i class="fa-solid fa-map-location-dot mr-2"></i>Endere√ßo</h2><p class="text-white font-bold text-xl">${l.name}</p><p class="text-xs font-mono text-ios-textMuted bg-ios-bg px-2 py-1 inline-block mt-1">${l.code}</p><table class="base-table mt-4"><thead class="base-thead"><tr><th>Item/Lote</th><th class="text-right">Qtd</th></tr></thead><tbody>${bt.map(b=>{const pr=localInventory.find(x=>x.id===b.productId);return `<tr><td class="base-td">${pr?.name||'?'}<br><span class="text-[10px] text-ios-textMuted">${b.code}</span></td><td class="base-td text-right font-bold text-ios-blue">${b.quantity.toFixed(2)}</td></tr>`;}).join('')||`<tr><td colspan="2" class="text-center py-4">Vazio</td></tr>`}</tbody></table></div>`;
        });
    }
    
    if(!fA){
        rE.innerHTML=`<div class="card text-center py-8 border-dashed border-ios-orange"><i class="fa-solid fa-box-open text-5xl text-ios-orange mb-4"></i><p class="text-ios-textMuted mb-4">"${q}" n√£o existe.</p><button class="btn-primary mx-auto" onclick="window.openQuickRegisterModal('${q}',()=>{id('consulta-input').value='${q}';id('btn-consulta-search').click();})">Cadastrar Produto</button></div>`;
    }
}

addEvt('btn-consulta-search','click',()=>searchUniversal(id('consulta-input').value));
addEvt('btn-consulta-scan','click',()=>openScanner(c=>{id('consulta-input').value=c;searchUniversal(c);}));
addEvt('consulta-input','keydown',e=>{if(e.key==='Enter'){e.preventDefault();searchUniversal(e.target.value);id('consulta-input').blur();}});

['search-inventory','supplier-filter','type-filter'].forEach(i=>addEvt(i,'input',renderInv));
document.querySelectorAll('#screen-inventory .table-header-sortable').forEach(th=>th.addEventListener('click',()=>{if(invSort.col===th.dataset.sort)invSort.asc=!invSort.asc;else{invSort.col=th.dataset.sort;invSort.asc=true;}renderInv();}));

function renderInv(){
    const tb=id('inventory-table-body');
    if(!tb)return;
    const t=id('search-inventory')?.value.toLowerCase()||'';
    const s=id('supplier-filter')?.value||'';
    const tp=id('type-filter')?.value||'';
    
    document.querySelectorAll('#screen-inventory .table-header-sortable i').forEach(i=>i.className='fa-solid fa-sort ml-1 text-ios-textMuted');
    
    let f=localInventory.filter(i=>(i.name.toLowerCase().includes(t)||(i.barcodes&&i.barcodes.some(b=>b.toLowerCase().includes(t))))&&(!s||i.supplier===s)&&(!tp||i.type===tp));
    const gE=i=>localBatches.filter(b=>b.productId===i.id&&b.quantity>0&&b.expiryDate).sort((a,b)=>new Date(a.expiryDate)-new Date(b.expiryDate))[0]?.expiryDate||'9999-12-31';
    
    f.sort((a,b)=>{
        let vA,vB;
        if(invSort.col==='name'){vA=a.name.toLowerCase();vB=b.name.toLowerCase();}
        else if(invSort.col==='supplier'){vA=(a.supplier||'').toLowerCase();vB=(b.supplier||'').toLowerCase();}
        else if(invSort.col==='totalQuantity'){vA=a.totalQuantity||0;vB=b.totalQuantity||0;}
        else if(invSort.col==='expiry'){vA=gE(a);vB=gE(b);}
        return vA<vB?(invSort.asc?-1:1):(vA>vB?(invSort.asc?1:-1):0);
    });
    
    if(!f.length){
        tb.innerHTML=`<tr><td colspan="5" class="text-center py-6 text-ios-textMuted">Vazio</td></tr>`;
        return;
    }
    
    tb.innerHTML=f.map(i=>{
        const ex=gE(i);
        const exF=ex!=='9999-12-31'?new Date(ex+'T00:00:00').toLocaleDateString('pt-BR').substring(0,5):'-';
        const tC=i.type==='semi_acabado'?'bg-ios-orange/20 text-ios-orange border-ios-orange/30':'bg-gray-800 text-gray-300 border-gray-600';
        return `<tr class="base-tr cursor-pointer" data-id="${i.id}"><td class="base-td text-white font-medium break-words">${i.name}<div class="sm:hidden text-[10px] text-ios-textMuted mt-1">${i.supplier||'-'}</div><div class="sm:hidden mt-1"><span class="badge border ${tC} text-[9px] px-1 py-0">${typeLabels[i.type]||'Insumo'}</span></div></td><td class="base-td hidden sm:table-cell"><span class="badge border ${tC}">${typeLabels[i.type]||'Insumo'}</span></td><td class="base-td hidden md:table-cell text-ios-textMuted truncate">${i.supplier||'-'}</td><td class="base-td text-right font-bold text-white">${(i.totalQuantity||0).toFixed(2)}</td><td class="base-td text-ios-textMuted text-xs">${exF}</td></tr>`;
    }).join('');
}

addEvt('inventory-table-body','click',e=>{const r=e.target.closest('tr');if(r&&r.dataset.id)openDetails(r.dataset.id);});
addEvt('btn-export-excel','click',()=>{if(!localInventory.length)return;const d=localInventory.map(i=>({'Produto':i.name,'Tipo':typeLabels[i.type]||i.type,'C√≥d Interno':i.code||'-','Fornecedor':i.supplier||'-','Saldo F√≠sico':i.totalQuantity||0,'Estoque M√≠nimo':i.minStock||0}));XLSX.writeFile(XLSX.utils.book_append_sheet(XLSX.utils.book_new(),XLSX.utils.json_to_sheet(d),"Estoque"),`Estoque_${new Date().toISOString().split('T')[0]}.xlsx`);window.showNotif('Exportado!');});

['hist-filter-start','hist-filter-end','hist-filter-type'].forEach(i=>addEvt(i,'change',renderItemDetailsHistory));
addEvt('btn-clear-hist-filters','click',()=>{if(id('hist-filter-start'))id('hist-filter-start').value='';if(id('hist-filter-end'))id('hist-filter-end').value='';if(id('hist-filter-type'))id('hist-filter-type').value='';renderItemDetailsHistory();});

function renderItemDetailsHistory(){
    if(!currentHistoryProductId)return;
    const p=localInventory.find(i=>i.id===currentHistoryProductId);
    const c=id('details-history-container');
    if(!p||!c)return;
    
    let h=localHistory.filter(x=>x.productId===currentHistoryProductId).sort((a,b)=>new Date(b.date)-new Date(a.date));
    const st=id('hist-filter-start')?.value;
    const en=id('hist-filter-end')?.value;
    const ty=id('hist-filter-type')?.value;
    
    if(st||en||ty)show(id('btn-clear-hist-filters'));
    else hide(id('btn-clear-hist-filters'));
    
    if(st)h=h.filter(x=>x.date>=st);
    if(en)h=h.filter(x=>x.date<=en);
    if(ty){if(ty==='entrada')h=h.filter(x=>x.type.includes('entrada'));else if(ty==='sa√≠da')h=h.filter(x=>x.type==='sa√≠da');else h=h.filter(x=>x.type===ty);}
    
    if(!h.length){c.innerHTML='<div class="text-center py-4 text-xs text-ios-textMuted">Vazio</div>';return;}
    
    c.innerHTML=h.map(x=>`<div class="py-3 border-b border-ios-border text-sm flex justify-between items-center"><div class="truncate pr-2"><span class="font-bold text-[10px] uppercase ${x.type.includes('entrada')?'text-ios-green':x.type==='sa√≠da'||x.type==='requisi√ß√£o'?'text-ios-red':'text-ios-blue'}">${x.type}</span><p class="text-[10px] text-ios-textMuted mt-1 truncate" title="${x.reason||''}">${x.reason||''}</p></div><div class="text-right shrink-0"><span class="font-bold ${x.type.includes('entrada')?'text-white':'text-ios-red'}">${x.type.includes('entrada')?'+':'-'} ${x.quantity.toFixed(2)}</span><br><span class="text-[9px] text-ios-textMuted">${new Date(x.date+'T00:00:00').toLocaleDateString('pt-BR')}</span></div></div>`).join('');
}

function openDetails(pId){
    currentHistoryProductId=pId;
    const p=localInventory.find(i=>i.id===pId);
    if(!p)return;
    
    id('details-product-name').innerText=p.name;
    id('details-product-type-badge').innerText=typeLabels[p.type||'insumo'];
    id('details-product-code').innerText=p.code||'-';
    id('details-supplier').innerText=p.supplier||'-';
    id('details-product-barcode').innerText=p.barcodes?.join(', ')||'-';
    id('details-min-stock').innerText=(p.minStock||0).toFixed(2);
    id('details-total-quantity').innerText=(p.totalQuantity||0).toFixed(2);
    id('edit-item-id').value=p.id;
    id('edit-product-name').value=p.name;
    id('edit-product-type').value=p.type||'insumo';
    id('edit-product-code').value=p.code||'';
    id('edit-supplier').value=p.supplier||'';
    id('edit-product-barcode').value=p.barcodes?.join(', ')||'';
    id('edit-min-stock').value=p.minStock||0;
    
    const t=id('details-batches-table');
    if(t){
        t.innerHTML=localBatches.filter(b=>b.productId===pId&&b.quantity>0).map(b=>{
            const is8110=p.code==='8110';
            let st=is8110?`<input type="checkbox" class="toggle-status toggle-release-batch" data-bid="${b.id}" ${b.isReleased?'checked':''}><span class="text-[9px] ml-2 ${b.isReleased?'text-ios-green':'text-ios-orange'}">${b.isReleased?'Lib.':'Quar.'}</span>`:`<span class="text-[10px] text-ios-green font-bold"><i class="fa-solid fa-check mr-1"></i>Lib</span>`;
            const lN=b.locationCode?(localLocations.find(x=>x.code===b.locationCode)?.name||b.locationCode):'-';
            const exp=b.expiryDate?new Date(b.expiryDate+'T00:00:00').toLocaleDateString('pt-BR'):'-';
            return `<tr class="base-tr"><td class="base-td text-white text-xs">${b.code}</td><td class="base-td">${st}</td><td class="base-td text-ios-textMuted text-[10px]">${lN}</td><td class="base-td text-ios-textMuted text-[10px]">${exp}</td><td class="base-td text-ios-blue font-bold text-sm">${b.quantity.toFixed(2)}</td><td class="base-td text-center"><button class="text-ios-blue edit-batch-btn p-1" data-id="${b.id}"><i class="fa-solid fa-pen"></i></button><button class="text-ios-red del-batch-btn p-1 ml-2" data-id="${b.id}"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        }).join('');
    }
    
    renderItemDetailsHistory();
    show(id('item-details-view'));
    hide(id('item-details-edit'));
    show(id('item-details-modal'));
}

addEvt('details-batches-table','change',async e=>{
    if(e.target.classList.contains('toggle-release-batch')){
        const b=await DB.get('batches',e.target.dataset.bid);
        if(b){
            b.isReleased=e.target.checked;
            await DB.update('batches',b);
            window.showNotif(b.isReleased?'Liberado':'Bloqueado',!b.isReleased);
            await refreshData();
            openDetails(id('edit-item-id').value);
        }
    }
});

addEvt('details-batches-table','click',e=>{
    const d=e.target.closest('.del-batch-btn');
    if(d)showConfirmationModal('Excluir Lote?','Remove quantidade sem sa√≠da.',async()=>{await DB.remove('batches',d.dataset.id);await refreshData();openDetails(id('edit-item-id').value);});
    const ed=e.target.closest('.edit-batch-btn');
    if(ed){
        const b=localBatches.find(x=>x.id===ed.dataset.id);
        if(b){
            id('edit-batch-id').value=b.id;
            id('edit-batch-product-id').value=b.productId;
            id('edit-batch-code').value=b.code;
            id('edit-batch-qty').value=b.quantity;
            id('edit-batch-expiry').value=b.expiryDate||'';
            show(id('edit-batch-modal'));
        }
    }
});

addEvt('edit-batch-form','submit',async e=>{
    e.preventDefault();
    const b=await DB.get('batches',id('edit-batch-id').value);
    if(b){
        b.code=id('edit-batch-code').value;
        b.quantity=parseFloat(id('edit-batch-qty').value);
        b.expiryDate=id('edit-batch-expiry').value;
        await DB.update('batches',b);
        hide(id('edit-batch-modal'));
        await refreshData();
        openDetails(b.productId);
        window.showNotif('Atualizado!');
    }
});

addEvt('btn-edit-item','click',()=>{hide(id('item-details-view'));show(id('item-details-edit'));});
addEvt('btn-cancel-edit','click',()=>{show(id('item-details-view'));hide(id('item-details-edit'));});

addEvt('edit-item-form','submit',async e=>{
    e.preventDefault();
    show(id('loading-overlay'));
    try{
        const p=await DB.get('inventory',id('edit-item-id').value);
        if(!p)return;
        p.name=id('edit-product-name').value;
        p.type=id('edit-product-type').value;
        p.code=id('edit-product-code').value;
        p.supplier=id('edit-supplier').value;
        const b=id('edit-product-barcode').value.trim();
        p.barcodes=b?b.split(',').map(x=>x.trim()):[];
        p.minStock=parseFloat(id('edit-min-stock').value)||0;
        await DB.update('inventory',p);
        await refreshData();
        openDetails(p.id);
        window.showNotif('Salvo!');
        hide(id('item-details-edit'));
        show(id('item-details-view'));
    }finally{
        hide(id('loading-overlay'));
    }
});

addEvt('btn-delete-item','click',()=>{showConfirmationModal('Excluir?','Perder√° hist√≥rico.',async()=>{await DB.remove('inventory',id('edit-item-id').value);refreshData();hide(id('item-details-modal'));});});

// ENTRADA MASSA
addEvt('btn-scan-entry-code','click',()=>openScanner(c=>{
    const i=document.querySelector('#entry-searchable-container input');
    if(i){
        i.value=c;
        const f=localInventory.find(x=>(x.code&&x.code.toLowerCase()===c.toLowerCase())||(x.barcodes&&x.barcodes.includes(c)));
        if(f){
            i.dataset.selectedId=f.id;
            i.value=f.name;
            document.querySelector('#entry-form input[name="quantity"]').focus();
        }else{
            showConfirmationModal('N√£o encontrado',`Cadastrar ${c}?`,()=>{
                if(window.openQuickRegisterModal){
                    window.openQuickRegisterModal(c,nP=>{
                        i.dataset.selectedId=nP.id;
                        i.value=nP.name;
                        document.querySelector('#entry-form input[name="quantity"]').focus();
                    });
                }
            });
        }
    }
}));

addEvt('entry-form','submit',e=>{
    e.preventDefault();
    const i=document.querySelector('#entry-searchable-container input');
    const pId=i?.dataset?.selectedId;
    const t=i?.value.trim();
    const q=parseFloat(document.querySelector('#entry-form input[name="quantity"]').value);
    
    if(!pId){
        if(t)showConfirmationModal('N√£o encontrado',`Cadastrar "${t}"?`,()=>{if(window.openQuickRegisterModal)window.openQuickRegisterModal(t,nP=>{bulkEntryItems.push({productId:nP.id,qty:q,batchCode:'',mfgDate:'',expiryDate:'',locationCode:''});e.target.reset();i.value='';delete i.dataset.selectedId;renderBulkEntry();});});
        return;
    }
    if(!q||q<=0)return;
    bulkEntryItems.push({productId:pId,qty:q,batchCode:'',mfgDate:'',expiryDate:'',locationCode:''});
    e.target.reset();
    i.value='';
    delete i.dataset.selectedId;
    renderBulkEntry();
});

function renderBulkEntry(){
    const t=id('bulk-entry-list');
    if(!t)return;
    if(!bulkEntryItems.length){t.innerHTML='<tr><td colspan="7" class="text-center py-6 text-ios-textMuted">Vazio.</td></tr>';return;}
    t.innerHTML=bulkEntryItems.map((b,idx)=>{
        const p=localInventory.find(x=>x.id===b.productId);
        let sL='',sC='bulk-shelf-life text-[10px] mt-1 block font-bold text-center';
        if(b.mfgDate&&b.expiryDate){
            let m=new Date(b.mfgDate+'T00:00:00').getTime();
            let v=new Date(b.expiryDate+'T00:00:00').getTime();
            let tD=new Date().setHours(0,0,0,0);
            let tot=v-m;
            let rem=v-tD;
            if(tot>0){
                let pct=(rem/tot)*100;
                sL=`Shelf: ${pct.toFixed(1)}%`;
                sC+=pct<50?' text-ios-red':(pct<75?' text-ios-orange':' text-ios-green');
            }else{
                sL='Inv√°lido';
                sC+=' text-ios-red';
            }
        }
        return `<tr data-idx="${idx}" class="base-tr"><td class="base-td text-white text-xs">${p?.name||'?'}</td><td class="base-td"><input type="number" step="0.01" class="form-input py-1 px-1 w-16 bulk-qty text-xs" value="${b.qty}"></td><td class="base-td"><input type="text" class="form-input py-1 px-1 w-20 bulk-batch font-mono text-xs" placeholder="Lote" value="${b.batchCode}"></td><td class="base-td"><input type="date" class="form-input py-1 px-1 w-28 bulk-mfg text-xs" value="${b.mfgDate}"></td><td class="base-td"><input type="date" class="form-input py-1 px-1 w-28 bulk-exp text-xs" value="${b.expiryDate}"><span class="${sC}">${sL}</span></td><td class="base-td"><div class="flex gap-1"><input type="text" class="form-input py-1 px-1 w-16 bulk-loc font-mono text-xs" value="${b.locationCode}" list="locations-datalist"><button type="button" class="btn-scan-bulk-loc text-ios-blue px-2 bg-ios-cardHover"><i class="fa-solid fa-camera"></i></button></div></td><td class="base-td text-center"><button class="btn-remove-bulk text-ios-red p-2 bg-ios-cardHover"><i class="fa-solid fa-trash"></i></button></td></tr>`;
    }).join('');
}

addEvt('bulk-entry-list','input',e=>{
    const tr=e.target.closest('tr');
    if(!tr)return;
    const idx=parseInt(tr.dataset.idx);
    if(e.target.classList.contains('bulk-qty'))bulkEntryItems[idx].qty=parseFloat(e.target.value)||0;
    if(e.target.classList.contains('bulk-batch'))bulkEntryItems[idx].batchCode=e.target.value;
    if(e.target.classList.contains('bulk-loc'))bulkEntryItems[idx].locationCode=e.target.value;
    if(e.target.classList.contains('bulk-mfg')||e.target.classList.contains('bulk-exp')){
        if(e.target.classList.contains('bulk-mfg'))bulkEntryItems[idx].mfgDate=e.target.value;
        if(e.target.classList.contains('bulk-exp'))bulkEntryItems[idx].expiryDate=e.target.value;
        const m=tr.querySelector('.bulk-mfg').value,v=tr.querySelector('.bulk-exp').value,s=tr.querySelector('.bulk-shelf-life');
        if(m&&v&&s){
            let md=new Date(m+'T00:00:00').getTime(),vd=new Date(v+'T00:00:00').getTime(),td=new Date().setHours(0,0,0,0),tot=vd-md,rem=vd-td;
            if(tot>0){
                let pct=(rem/tot)*100;
                s.innerText=`Shelf: ${pct.toFixed(1)}%`;
                s.className='bulk-shelf-life text-[10px] mt-1 block font-bold text-center '+(pct<50?'text-ios-red':(pct<75?'text-ios-orange':'text-ios-green'));
            }else{
                s.innerText='Inv√°lido';
                s.className='bulk-shelf-life text-[10px] mt-1 block font-bold text-center text-ios-red';
            }
        }else if(s)s.innerText='';
    }
});

addEvt('bulk-entry-list','click',e=>{
    const tr=e.target.closest('tr');
    if(!tr)return;
    const idx=parseInt(tr.dataset.idx);
    if(e.target.closest('.btn-remove-bulk')){bulkEntryItems.splice(idx,1);renderBulkEntry();}
    if(e.target.closest('.btn-scan-bulk-loc'))openScanner(c=>{bulkEntryItems[idx].locationCode=c;renderBulkEntry();});
});

addEvt('btn-save-bulk-entry','click',async()=>{
    if(!bulkEntryItems.length)return window.showNotif('Vazia.',true);
    for(let i of bulkEntryItems)if(!i.qty||i.qty<=0)return window.showNotif('Qtd > 0',true);
    show(id('loading-overlay'));
    try{
        const tD=new Date().toISOString().split('T')[0];
        for(let b of bulkEntryItems){
            let p=await DB.get('inventory',b.productId);
            if(!p)continue;
            if(p.pendingOrder?.active)p.pendingOrder.active=false;
            p.totalQuantity+=b.qty;
            await DB.update('inventory',p);
            if(b.locationCode&&!localLocations.find(l=>l.code===b.locationCode))await DB.add('locations',{code:b.locationCode,name:`Auto: ${b.locationCode}`});
            const isR=(p.code!=='8110');
            await DB.add('batches',{productId:p.id,code:b.batchCode||'',quantity:b.qty,expiryDate:b.expiryDate,mfgDate:b.mfgDate,isReleased:isR,locationCode:b.locationCode});
            await DB.add('history',{productId:p.id,batchCode:b.batchCode,type:'entrada',quantity:b.qty,date:tD,reason:'Massa'});
        }
        window.showNotif('Salvo!');
        bulkEntryItems=[];
        renderBulkEntry();
        await refreshData();
    }catch(e){
        window.showNotif('Erro',true);
    }finally{
        hide(id('loading-overlay'));
    }
});

// BARCODES
function renderBarcodesList(){
    const tb=id('barcodes-table-body');
    if(!tb)return;
    const l=localInventory.filter(i=>i.barcodes?.length);
    if(!l.length){tb.innerHTML='<tr><td colspan="4" class="text-center py-4">Vazio</td></tr>';return;}
    tb.innerHTML=l.map(i=>i.barcodes.map(b=>`<tr class="base-tr"><td class="base-td text-white text-xs">${i.name}</td><td class="base-td text-xs">${i.code||'-'}</td><td class="base-td text-ios-blue text-xs font-mono">${b}</td><td class="base-td text-center"><button class="btn-unlink-barcode text-ios-red bg-ios-red/10 px-2 py-1 rounded" data-pid="${i.id}" data-bcode="${b}"><i class="fa-solid fa-unlink"></i></button></td></tr>`).join('')).join('');
}
addEvt('btn-scan-barcode','click',()=>openScanner(c=>id('barcode-input').value=c));
addEvt('barcode-form','submit',async e=>{
    e.preventDefault();
    const i=id('barcode-searchable-container')?.querySelector('input');
    const pI=i?.dataset?.selectedId;
    const bC=id('barcode-input').value.trim();
    if(!pI||!bC)return;
    const p=await DB.get('inventory',pI);
    if(p){
        if(!p.barcodes)p.barcodes=[];
        if(!p.barcodes.includes(bC)){
            p.barcodes.push(bC);
            await DB.update('inventory',p);
            window.showNotif('Vinculado!');
        }else window.showNotif('J√° existe',true);
        e.target.reset();
        i.value='';
        delete i.dataset.selectedId;
        refreshData();
    }
});
addEvt('barcodes-table-body','click',async e=>{
    const b=e.target.closest('.btn-unlink-barcode');
    if(b){
        const p=await DB.get('inventory',b.dataset.pid);
        if(p){
            p.barcodes=p.barcodes.filter(x=>x!==b.dataset.bcode);
            await DB.update('inventory',p);
            window.showNotif('Desvinculado!');
            refreshData();
        }
    }
});

// PURCHASING
addEvt('search-purchasing','input',renderPurchasing);
function renderPurchasing(){
    const c=id('purchasing-container');
    if(!c)return;
    const tr=(id('search-purchasing')?.value||'').toLowerCase();
    const dt=new Date();
    dt.setDate(dt.getDate()-30);
    const dS=dt.toISOString().split('T')[0];
    const cM={};
    localHistory.filter(h=>(h.type==='sa√≠da'||h.type==='requisi√ß√£o')&&h.date>=dS).forEach(h=>{
        if(!cM[h.productId])cM[h.productId]=0;
        cM[h.productId]+=h.quantity;
    });
    const sp={};
    localInventory.filter(i=>i.type!=='semi_acabado').forEach(i=>{
        const s=i.supplier||'Diversos';
        if(tr&&!s.toLowerCase().includes(tr)&&!i.name.toLowerCase().includes(tr))return;
        if(!sp[s])sp[s]=[];
        const da=(cM[i.id]||0)/30, ms=i.minStock||0, lt=i.leadTime||0, bl=i.totalQuantity||0;
        let dl=999;
        if(da>0)dl=Math.floor(bl/da);
        else if(bl<=ms&&ms>0)dl=0;
        sp[s].push({...i,da,dl,lt});
    });
    let h='';
    Object.keys(sp).sort().forEach((s,idx)=>{
        const it=sp[s].sort((a,b)=>a.dl-b.dl);
        const cId=`sup-content-${idx}`;
        h+=`<div class="card p-0 mb-6"><div class="bg-ios-cardHover p-3 flex justify-between items-center cursor-pointer sup-header" data-target="${cId}"><h2 class="font-bold text-white flex items-center"><i class="fa-solid fa-chevron-down text-ios-textMuted mr-3 text-sm accordion-icon"></i><i class="fa-solid fa-truck-field mr-2"></i>${s}</h2><div class="flex gap-2"><button class="btn-place-sup-order text-ios-green bg-ios-green/10 px-2 py-1 rounded text-xs" data-sup="${s}">Reg. Entrega</button><button class="btn-edit-sup text-ios-blue bg-ios-blue/10 px-2 py-1 rounded text-xs" data-sup="${s}">Editar</button></div></div><div id="${cId}" class="p-3 grid gap-3 hidden">`;
        it.forEach(i=>{
            const ms=i.minStock||0, bl=i.totalQuantity||0, mT=Math.max(bl,ms*3,1), fP=Math.min(100,(bl/mT)*100), mP=Math.min(100,(ms/mT)*100);
            let tC='bg-ios-green', sC='text-ios-green';
            if(bl<=ms){tC='bg-ios-red';sC='text-ios-red';}
            else if(bl<=ms*1.5){tC='bg-ios-orange';sC='text-ios-orange';}
            const pO=i.pendingOrder?.active?`<div class="bg-ios-blue/20 text-ios-blue p-1 rounded text-[10px] text-center mt-1">Prev: ${new Date(i.pendingOrder.expectedDate+'T00:00:00').toLocaleDateString()}</div>`:'';
            h+=`<div class="bg-ios-bg p-3 rounded-xl border border-ios-border flex flex-col md:flex-row gap-2"><div class="flex-1"><div class="flex justify-between"><span class="font-bold text-white text-sm">${i.name}</span><span class="${sC} text-[10px] font-bold">${bl<=ms?'Reserva':'OK'}</span></div><div class="flex justify-between text-[10px] text-ios-textMuted mt-1"><span>Prazo: ${i.lt}d</span><span>Dura: ${i.dl===999?'>99d':i.dl+'d'}</span></div><div class="relative h-4 bg-ios-input rounded mt-2 border border-ios-border overflow-hidden"><div class="absolute bg-ios-red/30 h-full" style="width:${mP}%"></div><div class="absolute ${tC} h-full" style="width:${fP}%"></div><div class="absolute flex justify-between px-2 w-full text-[8px] text-white top-0.5"><span>0</span><span style="position:absolute;left:${mP}%">M√çN</span><span style="position:absolute;right:5px">${bl.toFixed(2)}</span></div></div></div><div class="md:w-32 border-t md:border-t-0 md:border-l pl-2 flex flex-col justify-center"><p class="text-[9px] text-ios-textMuted">Cons: ${i.da.toFixed(2)}/d</p>${pO}</div></div>`;
        });
        h+=`</div></div>`;
    });
    c.innerHTML=h||'<p class="text-center text-ios-textMuted">Vazio</p>';
}

addEvt('purchasing-container','click',e=>{
    const eB=e.target.closest('.btn-edit-sup');
    if(eB){
        e.stopPropagation();
        const s=eB.dataset.sup, i=localInventory.filter(x=>(x.supplier||'Diversos')===s);
        id('edit-supplier-old-name').value=s;
        if(id('edit-supplier-new-name'))id('edit-supplier-new-name').value=s;
        id('edit-supplier-lead').value=i.length?(i[0].leadTime||0):0;
        show(id('edit-supplier-modal'));
        return;
    }
    const pB=e.target.closest('.btn-place-sup-order');
    if(pB){
        e.stopPropagation();
        const s=pB.dataset.sup, i=localInventory.filter(x=>(x.supplier||'Diversos')===s);
        const mL=Math.max(...i.map(x=>x.leadTime||0),0);
        const d=addBusinessDays(new Date(),mL).toISOString().split('T')[0];
        id('order-supplier-id').value=s;
        if(id('order-supplier-name'))id('order-supplier-name').innerText=s;
        id('order-supplier-date').value=d;
        id('order-supplier-date').dataset.estimated=d;
        show(id('place-supplier-order-modal'));
        return;
    }
    const h=e.target.closest('.sup-header');
    if(h){
        const ct=id(h.dataset.target),ic=h.querySelector('.accordion-icon');
        if(ct&&ct.classList.contains('hidden')){
            ct.classList.remove('hidden');
            if(ic){ic.classList.remove('fa-chevron-down');ic.classList.add('fa-chevron-up');}
        }else if(ct){
            ct.classList.add('hidden');
            if(ic){ic.classList.remove('fa-chevron-up');ic.classList.add('fa-chevron-down');}
        }
    }
});

addEvt('edit-supplier-form','submit',async e=>{
    e.preventDefault();
    show(id('loading-overlay'));
    const oS=id('edit-supplier-old-name').value, nS=id('edit-supplier-new-name').value.trim(), l=parseInt(id('edit-supplier-lead').value)||0;
    for(let i of localInventory.filter(x=>(x.supplier||'Diversos')===oS)){
        i.supplier=nS;
        i.leadTime=l;
        await DB.update('inventory',i);
    }
    hide(id('edit-supplier-modal'));
    await refreshData();
    hide(id('loading-overlay'));
    window.showNotif('Salvo!');
});

addEvt('place-supplier-order-form','submit',async e=>{
    e.preventDefault();
    const s=id('order-supplier-id').value, d=id('order-supplier-date').value, eD=id('order-supplier-date').dataset.estimated;
    const ex=async()=>{
        show(id('loading-overlay'));
        for(let i of localInventory.filter(x=>(x.supplier||'Diversos')===s)){
            i.pendingOrder={active:true,qty:0,expectedDate:d};
            await DB.update('inventory',i);
        }
        hide(id('place-supplier-order-modal'));
        await refreshData();
        hide(id('loading-overlay'));
        window.showNotif('Registrado!');
    };
    if(d<eD)showConfirmationModal('Aviso','Data menor que o prazo padr√£o. Confirmar?',ex);
    else ex();
});

// LOCATIONS
function searchLocation(c){
    const l=localLocations.find(x=>x.code===c);
    if(l){
        id('loc-detail-name').innerText=l.name;
        id('loc-detail-code').innerText=l.code;
        id('loc-batches-body').innerHTML=localBatches.filter(b=>b.locationCode===c&&b.quantity>0).map(b=>`<tr class="base-tr"><td class="base-td text-white text-xs">${localInventory.find(x=>x.id===b.productId)?.name||'?'}</td><td class="base-td text-xs">${b.code}</td><td class="base-td text-ios-blue font-bold">${b.quantity.toFixed(2)}</td><td class="base-td"><button class="btn-remove-batch-loc text-ios-red bg-ios-cardHover p-2 rounded" data-id="${b.id}"><i class="fa-solid fa-minus"></i></button></td></tr>`).join('')||'<tr><td colspan="4" class="text-center text-xs py-4">Vazio</td></tr>';
        id('add-loc-target-code').value=c;
        hide(id('location-empty-state'));
        hide(id('location-create-panel'));
        show(id('location-details-panel'));
    }else{
        id('loc-form-code').value=c;
        hide(id('location-empty-state'));
        hide(id('location-details-panel'));
        show(id('location-create-panel'));
    }
}

function renderAllLocations(){
    const c=id('all-locations-list');
    if(!c)return;
    if(!localLocations.length){c.innerHTML='<div class="col-span-full text-center text-ios-textMuted py-4">Nenhum endere√ßo cadastrado.</div>';return;}
    c.innerHTML=localLocations.map(l=>`<button type="button" class="bg-ios-cardHover border border-ios-border p-3 rounded-xl hover:bg-ios-blue/10 text-left location-card-btn" data-code="${l.code}"><p class="font-bold text-white text-sm truncate">${l.name}</p><p class="text-[10px] text-ios-blue font-mono mt-1">${l.code}</p></button>`).join('');
}

addEvt('all-locations-list','click',e=>{
    const b=e.target.closest('.location-card-btn');
    if(b){
        id('location-search-input').value=b.dataset.code;
        id('btn-search-location').click();
    }
});

addEvt('btn-search-location','click',()=>searchLocation(id('location-search-input').value.trim()));
addEvt('btn-scan-location','click',()=>openScanner(c=>searchLocation(c)));
addEvt('location-form','submit',async e=>{e.preventDefault();const c=id('loc-form-code').value;await DB.add('locations',{code:c,name:id('loc-form-name').value});await refreshData();searchLocation(c);});
addEvt('btn-cancel-loc','click',()=>{hide(id('location-create-panel'));show(id('location-empty-state'));});
addEvt('btn-delete-location','click',()=>{const c=id('loc-detail-code').innerText,l=localLocations.find(x=>x.code===c);if(l)showConfirmationModal('Excluir?','Lotes ficar√£o sem local',async()=>{await DB.remove('locations',l.id);hide(id('location-details-panel'));show(id('location-empty-state'));refreshData();});});
addEvt('btn-edit-location','click',()=>{id('edit-loc-old-code').value=id('loc-detail-code').innerText;id('edit-loc-new-code').value=id('loc-detail-code').innerText;id('edit-loc-new-name').value=id('loc-detail-name').innerText;show(id('edit-location-modal'));});
addEvt('edit-location-form','submit',async e=>{e.preventDefault();show(id('loading-overlay'));const oC=id('edit-loc-old-code').value,nC=id('edit-loc-new-code').value,nN=id('edit-loc-new-name').value,l=localLocations.find(x=>x.code===oC);if(l){l.code=nC;l.name=nN;await DB.update('locations',l);if(oC!==nC){for(let b of localBatches.filter(x=>x.locationCode===oC)){b.locationCode=nC;await DB.update('batches',b);}}hide(id('edit-location-modal'));await refreshData();searchLocation(nC);}hide(id('loading-overlay'));});
addEvt('btn-add-batch-to-loc','click',()=>{createSearchableSelect(id('add-loc-searchable-container'),localInventory,'Produto...',p=>{id('add-loc-batch-select').innerHTML='<option value="">Lote...</option>'+localBatches.filter(b=>b.productId===p.id&&b.quantity>0).map(b=>`<option value="${b.code}">${b.code}</option>`).join('');});show(id('modal-add-loc-batch'));});
addEvt('add-loc-batch-form','submit',async e=>{e.preventDefault();const b=localBatches.find(x=>x.code===id('add-loc-batch-select').value&&x.quantity>0);if(b){b.locationCode=id('add-loc-target-code').value;await DB.update('batches',b);hide(id('modal-add-loc-batch'));await refreshData();searchLocation(b.locationCode);}});
addEvt('loc-batches-body','click',async e=>{const bt=e.target.closest('.btn-remove-batch-loc');if(bt){const b=await DB.get('batches',bt.dataset.id);if(b){b.locationCode='';await DB.update('batches',b);await refreshData();searchLocation(id('loc-detail-code').innerText);}}});

// RECIPES
function addIngRowReq(c,pI=null,pQ=''){
    if(!c)return;
    const d=document.createElement('div');
    d.className='flex flex-col gap-2 bg-ios-bg p-3 rounded-xl border border-ios-border';
    d.innerHTML=`<div class="flex gap-2 items-center"><div class="searchable-container flex-1"></div><input type="number" step="0.0001" value="${pQ}" class="form-input w-20 py-2 text-center req-qty-input font-bold text-sm" required><button type="button" class="text-ios-red p-2 bg-ios-cardHover rounded remove-ing"><i class="fa fa-times"></i></button></div><div class="flex justify-between items-center text-[10px] text-ios-textMuted px-1 req-plan-wrapper hidden mt-1 border-t border-ios-border pt-2 gap-2"><span class="plan-display"></span><button type="button" class="text-ios-blue open-batch-selector bg-ios-card px-2 py-1 rounded shrink-0 whitespace-nowrap border border-ios-border"><i class="fa-solid fa-pen mr-1"></i> Lotes</button></div>`;
    c.appendChild(d);
    const iR=c.id==='ingredients-container',pW=d.querySelector('.req-plan-wrapper'),pD=d.querySelector('.plan-display'),qI=d.querySelector('.req-qty-input');
    if(!iR)pW.classList.remove('hidden');
    const uP=()=>{
        if(iR)return;
        const iS=d.querySelector('.searchable-container input'),pi=iS?.dataset.selectedId,q=parseFloat(qI.value);
        if(pi&&q>0){
            const{plan,isSufficient}=getFIFOPlan(pi,q);
            d.dataset.productId=pi;
            d.dataset.plan=JSON.stringify(plan).replace(/'/g, "&#39;");
            pD.innerHTML=isSufficient?'<i class="fa fa-check text-ios-green"></i> '+plan.map(x=>`${x.batchCode}(${x.quantity.toFixed(2)})`).join(', '):'<i class="fa fa-triangle-exclamation text-ios-red"></i> Falta!';
        }else pD.innerText='Aguardando...';
    };
    createSearchableSelect(d.querySelector('.searchable-container'),localInventory,'Buscar...',uP);
    qI.addEventListener('input',uP);
    d.querySelector('.remove-ing').addEventListener('click',()=>d.remove());
    if(pI){
        const p=localInventory.find(x=>x.id===pI);
        if(p){const iS=d.querySelector('.searchable-container input');if(iS){iS.value=p.name;iS.dataset.selectedId=p.id;uP();}}
    }
}
addEvt('add-requisition-item-btn','click',()=>addIngRowReq(id('requisition-items-container')));

addEvt('search-recipe','input',renderRecipes);
function renderRecipes(){
    const g=id('recipes-grid');if(!g)return;
    const t=(id('search-recipe')?.value||'').toLowerCase();
    let f=localRecipes.filter(r=>currentRecipeCategory==='Todos'||r.category===currentRecipeCategory);
    if(t)f=f.filter(r=>r.name.toLowerCase().includes(t)||r.category.toLowerCase().includes(t));
    if(id('recipe-categories-list'))id('recipe-categories-list').innerHTML=['Todos',...new Set(localRecipes.map(r=>r.category))].map(c=>`<li><a href="#" class="block p-2 text-xs border border-transparent ${c===currentRecipeCategory?'!border-ios-blue bg-ios-card text-white':'text-ios-textMuted'}" data-cat="${c}">${c}</a></li>`).join('');
    g.innerHTML=f.map(r=>`<div class="card relative border ${r.isSemi?'border-ios-orange/30':'border-ios-cardHover'}"><div class="absolute top-3 right-3 flex gap-1"><button class="edit-rec-btn text-ios-blue bg-ios-bg p-2 rounded-full border border-ios-border" data-id="${r.id}"><i class="fa fa-pen text-xs"></i></button><button class="del-rec-btn text-ios-red bg-ios-bg p-2 rounded-full border border-ios-border" data-id="${r.id}"><i class="fa fa-trash text-xs"></i></button></div><h3 class="text-white font-bold">${r.name}</h3><span class="text-[10px] px-2 py-1 rounded bg-ios-bg mt-2 inline-block ${r.isSemi?'text-ios-orange':'text-ios-textMuted'}">${r.isSemi?`Semi (Rende ${r.outputYield||1})`:'Acabado'}</span><ul class="mt-4 text-xs text-ios-textMuted space-y-1">${(r.ingredients||[]).map(i=>`<li class="flex justify-between border-b border-ios-border/30 pb-1"><span>${localInventory.find(x=>x.id===i.productId)?.name||'?'}</span><span class="text-ios-blue">${i.quantity}</span></li>`).join('')}</ul></div>`).join('');
}
addEvt('recipe-categories-list','click',e=>{if(e.target.tagName==='A'){e.preventDefault();currentRecipeCategory=e.target.dataset.cat;renderRecipes();}});
addEvt('recipes-grid','click',e=>{
    const d=e.target.closest('.del-rec-btn');
    if(d)showConfirmationModal('Apagar?','',async()=>{await DB.remove('recipes',d.dataset.id);refreshData();});
    const ed=e.target.closest('.edit-rec-btn');
    if(ed){
        const r=localRecipes.find(x=>x.id===ed.dataset.id);
        if(r){
            id('edit-recipe-id').value=r.id;
            id('recipe-name').value=r.name;
            id('recipe-category').value=r.category;
            id('recipe-is-semi').checked=!!r.isSemi;
            id('recipe-is-semi').dispatchEvent(new Event('change'));
            id('recipe-yield').value=r.outputYield||1;
            id('ingredients-container').innerHTML='';
            (r.ingredients||[]).forEach(i=>addIngRowReq(id('ingredients-container'),i.productId,i.quantity));
            show(id('recipe-modal'));
        }
    }
});
addEvt('recipe-is-semi','change',e=>e.target.checked?show(id('yield-wrapper')):hide(id('yield-wrapper')));
addEvt('btn-new-recipe','click',()=>{id('recipe-form').reset();id('edit-recipe-id').value='';id('ingredients-container').innerHTML='';id('recipe-is-semi').checked=false;id('recipe-is-semi').dispatchEvent(new Event('change'));addIngRowReq(id('ingredients-container'));show(id('recipe-modal'));});
addEvt('add-ingredient-btn','click',()=>addIngRowReq(id('ingredients-container')));
addEvt('recipe-form','submit',async e=>{
    e.preventDefault();
    const isS=id('recipe-is-semi').checked,nm=id('recipe-name').value;
    let oId=null;
    if(isS){
        let p=localInventory.find(x=>x.name.toLowerCase()===nm.toLowerCase()&&x.type==='semi_acabado');
        oId=p?p.id:await DB.add('inventory',{name:nm,type:'semi_acabado',totalQuantity:0,supplier:'Interna'});
    }
    const d={
        name:nm,
        category:id('recipe-category').value,
        outputProductId:oId,
        outputYield:isS?(parseFloat(id('recipe-yield').value)||1):null,
        isSemi:isS,
        ingredients:[...id('ingredients-container').children].map(r=>({
            productId:r.querySelector('input[type="text"]').dataset.selectedId,
            quantity:parseFloat(r.querySelector('input[type="number"]').value)
        }))
    };
    if(id('edit-recipe-id').value){
        d.id=id('edit-recipe-id').value;
        await DB.update('recipes',d);
    }else{
        await DB.add('recipes',d);
    }
    hide(id('recipe-modal'));
    refreshData();
});

// PICKING
function renderPickingScreen(){
    const c=id('picking-lines-container');
    if(!c)return;
    const pOps=localProductionOrders.filter(o=>o.status==='pendente');
    if(!pOps.length){c.innerHTML=`<div class="text-center py-16"><i class="fa-solid fa-check text-6xl text-ios-cardHover mb-4"></i><p class="text-ios-textMuted">Tudo separado!</p></div>`;return;}
    const bD={};
    pOps.forEach(o=>{
        const d=o.date||'';
        if(!bD[d])bD[d]={};
        const l=o.recipeCategory||'Div';
        if(!bD[d][l])bD[d][l]=[];
        bD[d][l].push(o);
    });
    c.innerHTML=Object.keys(bD).sort().map(d=>`
        <div class="mb-8">
            <h2 class="text-xl text-white font-bold mb-4 border-b border-ios-border pb-2">${d}</h2>
            <div class="space-y-4">
                ${Object.keys(bD[d]).map(l=>{
                    const ops=bD[d][l],cc=ops.filter(x=>x.picking?.status==='concluido').length,ea=ops.filter(x=>x.picking?.status==='em_andamento').length,pct=(cc/ops.length)*100,ex=ops.filter(x=>x.isExtra&&x.picking?.status!=='concluido');
                    let sH='';
                    if(cc===ops.length)sH=`<span class="badge bg-ios-green/20 text-ios-green">OK</span>`;
                    else if(ea>0)sH=`<span class="badge bg-ios-blue/20 text-ios-blue animate-pulse">Andamento</span>`;
                    else sH=`<span class="badge bg-ios-orange/20 text-ios-orange">A Separar</span>`;
                    return `
                    <div class="card p-0 overflow-hidden border ${ea>0?'border-ios-blue':''}">
                        <div class="p-4 bg-ios-cardHover flex justify-between items-center">
                            <div><h3 class="font-bold text-white text-lg">${l.toUpperCase()} ${ex.length?`<span class="badge bg-ios-red text-white">üö® ${ex.length} EXTRA</span>`:''}</h3><p class="text-xs text-ios-textMuted">${cc}/${ops.length} OK</p></div>
                            <div class="flex gap-2 items-center">${sH}${cc<ops.length?`<button class="btn-primary py-1 px-3 text-xs btn-open-line-picking" data-line="${l}" data-opids='${JSON.stringify(ops.map(x=>x.id))}'>Separar</button>`:''}</div>
                        </div>
                        <div class="h-1 bg-ios-bg"><div class="h-full bg-ios-green transition-all" style="width:${pct}%"></div></div>
                        <div class="p-3 grid grid-cols-2 md:grid-cols-3 gap-2">
                            ${ops.map(o=>`<div class="bg-ios-card p-2 rounded border border-ios-border text-xs flex justify-between ${o.isExtra?'border-l-4 border-l-ios-red':''}"><span class="text-white truncate">${o.recipeName} (${o.multiplier}x)</span>${o.picking?.status==='concluido'?'<span class="text-ios-green"><i class="fa fa-check"></i></span>':'<span class="text-ios-textMuted"><i class="fa fa-clock"></i></span>'}</div>`).join('')}
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>
    `).join('');
}

addEvt('picking-lines-container','click',e=>{
    const b=e.target.closest('.btn-open-line-picking');
    if(b){
        activePickingLine=b.dataset.line;
        activePickingOpIds=JSON.parse(b.dataset.opids);
        const ops=localProductionOrders.filter(x=>activePickingOpIds.includes(x.id));
        const pk=ops[0].picking||{status:'pendente',responsible:'',pickedItems:{}};
        
        id('picking-modal-title').innerHTML=`Setor: ${activePickingLine}`;
        id('picking-responsible').value=pk.responsible||'';
        
        if(pk.status==='em_andamento'){
            hide(id('picking-setup-view'));
            show(id('picking-active-view'));
            id('picking-active-resp').innerText=pk.responsible;
        }else{
            show(id('picking-setup-view'));
            hide(id('picking-active-view'));
        }
        
        currentPickingPlans = {};
        const ag={};
        ops.forEach(o=>o.ingredients.forEach(i=>{
            if(!ag[i.productId])ag[i.productId]={p:i.productId,q:0};
            ag[i.productId].q+=i.adjustedQuantity;
        }));
        
        id('picking-checklist-body').innerHTML=Object.values(ag).map(i=>{
            const p=localInventory.find(x=>x.id===i.p);
            let tP=0;
            let allPlans = [];
            
            ops.forEach(o=>{
                if(o.picking?.pickedItems?.[i.p]) tP+=o.picking.pickedItems[i.p];
                const ing = o.ingredients.find(x=>x.productId===i.p);
                if(ing && ing.consumptionPlan) allPlans = allPlans.concat(ing.consumptionPlan);
            });
            
            const cK=tP>0; 
            if(cK) {
                currentPickingPlans[i.p] = [];
                allPlans.forEach(x => {
                    const existing = currentPickingPlans[i.p].find(y => y.batchId === x.batchId);
                    if(existing) existing.quantity += x.quantity;
                    else currentPickingPlans[i.p].push({...x});
                });
            } else {
                currentPickingPlans[i.p] = getFIFOPlan(i.p, i.q).plan; 
            }
            const planText = currentPickingPlans[i.p].map(x => `${x.batchCode}`).join(', ');

            return `
            <tr class="border-b border-ios-border/50 ${cK?'opacity-50':''}" data-pid="${i.p}">
                <td class="py-3 px-4 text-white text-xs ${cK?'line-through':''}">${p?.name||'?'}</td>
                <td class="py-3 px-4 text-right text-ios-blue font-bold">${i.q.toFixed(2)}</td>
                <td class="py-3 px-4 text-center">
                    <div class="flex flex-col items-center">
                        <input type="number" step="0.001" value="${cK?tP:''}" class="form-input w-20 text-center py-1 text-xs picking-qty-input inline-block bg-ios-input border border-ios-border" placeholder="0">
                        <button type="button" class="btn-pick-select-batch mt-1 text-[10px] text-ios-blue bg-ios-cardHover px-2 py-1 rounded border border-ios-border w-full hover:bg-ios-blue/20"><i class="fa-solid fa-box"></i> Lotes</button>
                        <div class="picking-plan-display text-[8px] text-ios-textMuted mt-1">${planText?planText:'PEPS'}</div>
                    </div>
                </td>
                <td class="py-3 px-4 text-center"><input type="checkbox" class="ui-checkbox scale-75 picking-row-check" ${cK?'checked':''}></td>
            </tr>`;
        }).join('');
        show(id('picking-modal'));
    }
});

addEvt('btn-start-picking','click',async()=>{
    const r=id('picking-responsible').value.trim();
    if(!r)return;
    for(let i of activePickingOpIds){
        let o=localProductionOrders.find(x=>x.id===i);
        if(o){
            o.picking.status='em_andamento';
            o.picking.responsible=r;
            o.picking.start=Date.now();
            await DB.update('productionOrders',o);
        }
    }
    hide(id('picking-setup-view'));
    show(id('picking-active-view'));
    id('picking-active-resp').innerText=r;
});

addEvt('picking-checklist-body','input',e=>{
    if(e.target.classList.contains('picking-qty-input')){
        const r=e.target.closest('tr');
        const chk=r.querySelector('.picking-row-check');
        if(chk&&chk.checked){
            chk.checked=false;
            r.classList.remove('opacity-50');
            r.cells[0].classList.remove('line-through');
        }
    }
});

addEvt('picking-checklist-body','click',e=>{
    const btnBatch = e.target.closest('.btn-pick-select-batch');
    if(btnBatch) {
        batchSelectorContext = 'picking';
        currentBatchTarget = btnBatch.closest('tr');
        const pId = currentBatchTarget.dataset.pid;
        
        let typedQty = parseFloat(currentBatchTarget.querySelector('.picking-qty-input').value);
        if(isNaN(typedQty) || typedQty <= 0) {
            typedQty = parseFloat(currentBatchTarget.cells[1].innerText) || 0;
            currentBatchTarget.querySelector('.picking-qty-input').value = typedQty.toFixed(4);
        }
        
        if(id('batch-selector-needed')) id('batch-selector-needed').innerText = typedQty.toFixed(4);
        
        const batches = localBatches.filter(b => b.productId === pId && b.quantity > 0 && b.isReleased !== false);
        const listEl = id('batch-selector-list');
        const activePlan = currentPickingPlans[pId] || [];

        if(listEl) {
            listEl.innerHTML = batches.map(b => {
                const inPlan = activePlan.find(p => p.batchId === b.id);
                const val = inPlan ? inPlan.quantity : '';
                return `<div class="flex justify-between items-center mb-2 sm:mb-3 bg-ios-input p-2 sm:p-3 rounded-xl border border-ios-border"><span class="text-white font-medium text-xs sm:text-sm"><i class="fa-solid fa-box mr-1 sm:mr-2 text-ios-textMuted"></i>${b.code} <br><span class="text-[9px] sm:text-[10px] text-ios-textMuted ml-4 sm:ml-6">Disp: ${b.quantity.toFixed(2)}</span></span><input type="number" class="form-input w-20 sm:w-28 text-right batch-input font-bold text-xs sm:text-sm py-2 px-2" data-bid="${b.id}" data-bcode="${b.code}" max="${b.quantity + (inPlan?inPlan.quantity:0)}" value="${val}" placeholder="0"></div>`;
            }).join('');
        }
        updateBatchSelectorSum();
        show(id('batch-selector-modal'));
        return;
    }

    if(e.target.classList.contains('picking-row-check')){
        const r=e.target.closest('tr');
        const pid = r.dataset.pid;
        if(e.target.checked){
            const i=r.querySelector('.picking-qty-input');
            let typedQty = parseFloat(i.value);
            const totalNeeded = parseFloat(r.cells[1].innerText);
            
            if (isNaN(typedQty) || typedQty <= 0) {
                typedQty = totalNeeded;
                i.value = typedQty.toFixed(4);
            }
            
            let planSum = currentPickingPlans[pid] ? currentPickingPlans[pid].reduce((s,x)=>s+x.quantity,0) : 0;
            if (!currentPickingPlans[pid] || Math.abs(planSum - typedQty) > 0.001) {
                currentPickingPlans[pid] = getFIFOPlan(pid, typedQty).plan;
            }
            
            const actualSum = currentPickingPlans[pid].reduce((s,x)=>s+x.quantity, 0);
            if (Math.abs(actualSum - typedQty) > 0.001) {
                i.value = actualSum.toFixed(4);
            }

            r.classList.add('opacity-50');
            r.cells[0].classList.add('line-through');
            const display = r.querySelector('.picking-plan-display');
            if (display) display.innerText = currentPickingPlans[pid].map(x=>x.batchCode).join(', ');
        }else{
            r.classList.remove('opacity-50');
            r.cells[0].classList.remove('line-through');
        }
    }
});

addEvt('btn-finish-picking','click',async()=>{
    const ops=localProductionOrders.filter(x=>activePickingOpIds.includes(x.id));
    const finalPlans = {};
    const finalQtys = {};
    
    id('picking-checklist-body').querySelectorAll('tr').forEach(r=>{
        if(r.querySelector('.picking-row-check')?.checked) {
            const pid = r.dataset.pid;
            const typedQty = parseFloat(r.querySelector('.picking-qty-input').value) || 0;
            finalQtys[pid] = typedQty;
            
            let planSum = currentPickingPlans[pid] ? currentPickingPlans[pid].reduce((s,x)=>s+x.quantity,0) : 0;
            if(!currentPickingPlans[pid] || Math.abs(planSum - typedQty) > 0.001) {
                currentPickingPlans[pid] = getFIFOPlan(pid, typedQty).plan;
            }
            finalPlans[pid] = currentPickingPlans[pid] ? JSON.parse(JSON.stringify(currentPickingPlans[pid])) : [];
        }
    });

    Object.keys(finalPlans).forEach(pid => {
        let planRemaining = finalPlans[pid];
        let totalPickedForPid = finalQtys[pid]; 
        
        ops.forEach(op => {
            const ing = op.ingredients.find(x => x.productId === pid);
            if(ing) {
                let needed = ing.adjustedQuantity;
                let takeQty = Math.min(needed, totalPickedForPid);
                
                let assignedPlan = [];
                let planNeeded = takeQty;
                
                while(planNeeded > 0 && planRemaining.length > 0) {
                    let available = planRemaining[0].quantity;
                    let takePlan = Math.min(planNeeded, available);
                    assignedPlan.push({batchId: planRemaining[0].batchId, batchCode: planRemaining[0].batchCode, quantity: takePlan});
                    planRemaining[0].quantity -= takePlan;
                    planNeeded -= takePlan;
                    if(planRemaining[0].quantity <= 0) planRemaining.shift();
                }
                
                op.picking.pickedItems = op.picking.pickedItems || {};
                op.picking.pickedItems[pid] = takeQty;
                ing.consumptionPlan = assignedPlan; 
                
                totalPickedForPid -= takeQty;
            }
        });

        if(totalPickedForPid > 0.001) {
            for(let i = ops.length - 1; i >= 0; i--) {
                let op = ops[i];
                const ing = op.ingredients.find(x => x.productId === pid);
                if(ing) {
                    op.picking.pickedItems[pid] += totalPickedForPid;
                    while(planRemaining.length > 0) {
                        let tPlan = planRemaining.shift();
                        ing.consumptionPlan.push({batchId: tPlan.batchId, batchCode: tPlan.batchCode, quantity: tPlan.quantity});
                    }
                    totalPickedForPid = 0;
                    break;
                }
            }
        }
    });

    for(let o of ops){
        o.picking.end=Date.now();
        o.picking.status='concluido';
        await DB.update('productionOrders',o);
    }
    hide(id('picking-modal'));
    refreshData();
    window.showNotif('Conclu√≠do!');
});

// PRODUCTION ORDERS
addEvt('search-po-by-date','change',renderPO);
function renderPO(){
    const d=id('search-po-by-date')?.value,c=id('production-orders-list');if(!c)return;
    const l=localProductionOrders.filter(x=>x.date===d);
    c.innerHTML=l.length?l.map(o=>`
        <div class="card relative pl-12 border-l-4 ${o.status==='pendente'?'border-l-ios-orange':'border-l-ios-green'}">
            <div class="absolute left-3 top-5"><input type="checkbox" class="ui-checkbox scale-75 po-select-checkbox" data-id="${o.id}" ${o.status!=='pendente'?'disabled':''}></div>
            <div class="flex justify-between items-start">
                <div><h3 class="text-white font-bold text-lg">${o.recipeName} <span class="text-ios-blue">(${o.multiplier}x)</span></h3><p class="text-[10px] text-ios-textMuted">${new Date(o.date+'T00:00:00').toLocaleDateString()}</p></div>
                <span class="badge ${o.status==='pendente'?'bg-ios-orange/20 text-ios-orange':'bg-ios-green/20 text-ios-green'}">${o.status}</span>
            </div>
            <div class="bg-ios-bg rounded p-2 mt-3 text-xs">
                <p class="text-[10px] text-ios-textMuted uppercase">Insumos (Real)</p>
                <ul class="space-y-1 mt-1">${o.ingredients.map(i=>{
                    const pN=localInventory.find(x=>x.id===i.productId)?.name||'?';
                    let aQ=i.adjustedQuantity; 
                    let usedPlan = i.consumptionPlan || getFIFOPlan(i.productId, aQ).plan;
                    let hasPEPSBreakVar = hasPEPSBreak(i.productId, usedPlan);

                    if(o.picking?.status==='concluido'&&o.picking.pickedItems?.[i.productId]!==undefined) {
                        aQ=o.picking.pickedItems[i.productId];
                    }

                    const badgeWarning = hasPEPSBreakVar && o.status==='pendente' ? `<span class="badge bg-ios-red/20 text-ios-red ml-2 text-[8px]"><i class="fa-solid fa-triangle-exclamation"></i> Quebra PVPS</span>` : '';

                    return `<li class="flex justify-between text-gray-300 border-b border-ios-border/50 pb-1 items-center">
                        <span>${pN} ${badgeWarning}</span>
                        <span class="font-bold ${aQ!==i.adjustedQuantity?'text-ios-orange':'text-ios-blue'}">${aQ.toFixed(4)}</span>
                    </li>`;
                }).join('')}</ul>
            </div>
            ${o.status==='pendente'?`<div class="absolute bottom-2 right-2"><button class="text-ios-red p-2 del-po-btn" data-id="${o.id}"><i class="fa-solid fa-trash"></i></button></div>`:''}
        </div>`).join(''):'<div class="col-span-full text-center p-4">Vazio</div>';
}
addEvt('production-orders-list','click',e=>{const d=e.target.closest('.del-po-btn');if(d)showConfirmationModal('Excluir OP?','',async()=>{await DB.remove('productionOrders',d.dataset.id);refreshData();});});

addEvt('po-quantity','input',()=>{
    const s=id('po-recipe-searchable-container')?.querySelector('input');
    if(s?.dataset.selectedId){
        const r=localRecipes.find(x=>x.id===s.dataset.selectedId),m=parseFloat(id('po-quantity').value)||1;
        if(r&&r.isSemi)id('po-total-output').value=((r.outputYield||1)*m).toFixed(4);
        id('po-ingredients-body').innerHTML=(r?.ingredients||[]).map(i=>{
            const p=localInventory.find(x=>x.id===i.productId),q=i.quantity*m,f=getFIFOPlan(i.productId,q);
            return `<tr class="base-tr" data-product-id="${i.productId}" data-plan='${JSON.stringify(f.plan).replace(/'/g, "&#39;")}'>
                <td class="base-td text-white text-xs">${p?.name||'?'}</td>
                <td class="base-td hidden sm:table-cell text-xs">${(p?.totalQuantity||0).toFixed(2)}</td>
                <td class="base-td"><input type="number" value="${q.toFixed(4)}" class="form-input py-1 px-1 w-20 text-center text-xs po-ing-qty bg-ios-bg border-ios-border" readonly></td>
                <td class="base-td text-[10px] ${f.isSufficient?'text-ios-green':'text-ios-red font-bold'}">
                    <div class="plan-display">${f.isSufficient?'Lotes OK':'Falta'}</div>
                    ${f.isSufficient?`<button type="button" class="text-ios-blue mt-1 open-batch-selector bg-ios-bg p-1 rounded border border-ios-border text-[10px] w-full"><i class="fa-solid fa-pen"></i> Escolher Lotes</button>`:''}
                </td>
            </tr>`;
        }).join('');
    }
});

addEvt('btn-new-production-order','click',()=>{
    id('production-order-form').reset();
    id('po-ingredients-body').innerHTML='';
    createSearchableSelect(id('po-recipe-searchable-container'),localRecipes,'Receita...',r=>{
        if(r.isSemi){
            show(id('po-output-fields'));
            const d = new Date();
            id('po-output-batch').value=`OP${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}${d.getFullYear().toString().slice(-2)}-${Math.floor(Math.random()*1000).toString().padStart(3,'0')}`;
        }else hide(id('po-output-fields'));
        id('po-quantity').dispatchEvent(new Event('input'));
    });
    id('po-date').value=addBusinessDays(new Date(),2).toISOString().split('T')[0];
    hide(id('po-output-fields'));
    show(id('production-order-modal'));
});

addEvt('production-order-form','submit',async e=>{
    e.preventDefault();
    const s=id('po-recipe-searchable-container')?.querySelector('input');if(!s?.dataset.selectedId)return;
    const r=localRecipes.find(x=>x.id===s.dataset.selectedId),m=parseFloat(id('po-quantity').value)||1;
    const ings=[...id('po-ingredients-body').children].map(tr=>{
        let plan = [];
        try { plan = JSON.parse(tr.dataset.plan || '[]'); } catch(err) { console.error(err); }
        return {
            productId:tr.dataset.productId,
            adjustedQuantity:parseFloat(tr.querySelector('.po-ing-qty').value),
            consumptionPlan:plan
        };
    });
    await DB.add('productionOrders',{recipeId:r.id,recipeName:r.name,recipeCategory:r.category,date:id('po-date').value,multiplier:m,quantityProduced:r.isSemi?(parseFloat(id('po-total-output').value)||0):null,status:'pendente',outputBatch:r.isSemi?id('po-output-batch').value:null,ingredients:ings,isExtra:id('po-is-extra').checked,picking:{status:'pendente',pickedItems:{}}});
    hide(id('production-order-modal'));
    refreshData();
});

addEvt('btn-confirm-production','click',async()=>{
    const c=document.querySelectorAll('.po-select-checkbox:checked');if(!c.length)return window.showNotif('Selecione OP!',true);
    const sIds=Array.from(c).map(x=>x.dataset.id),p=localProductionOrders.filter(x=>sIds.includes(x.id)&&x.status==='pendente');if(!p.length)return;
    showConfirmationModal('Efetivar Baixa',`Gerar baixas para ${p.length} OP(s)? Ser√° debitado o lote e a quantidade exata informada na etapa de separa√ß√£o.`,async()=>{
        show(id('loading-overlay'));
        try {
            for(const op of p){
                for(const ing of op.ingredients){
                    let actualQty = ing.adjustedQuantity;
                    if(op.picking?.status==='concluido' && op.picking.pickedItems?.[ing.productId] !== undefined) { actualQty = op.picking.pickedItems[ing.productId]; }
                    
                    if(actualQty > 0) {
                        const pr = await DB.get('inventory', ing.productId);
                        if(!pr) continue;
                        
                        let planToUse = (ing.consumptionPlan && ing.consumptionPlan.length > 0) ? JSON.parse(JSON.stringify(ing.consumptionPlan)) : getFIFOPlan(ing.productId, actualQty).plan;
                        let totalPlan = planToUse.reduce((s,x)=>s+x.quantity, 0);
                        
                        if(actualQty < totalPlan) {
                            let diff = totalPlan - actualQty;
                            for(let i=planToUse.length-1; i>=0; i--) {
                                if(planToUse[i].quantity >= diff) { planToUse[i].quantity -= diff; diff = 0; break; }
                                else { diff -= planToUse[i].quantity; planToUse[i].quantity = 0; }
                            }
                            planToUse = planToUse.filter(x => x.quantity > 0);
                        } else if(actualQty > totalPlan) {
                            let extra = actualQty - totalPlan;
                            let extraPlan = getFIFOPlan(ing.productId, extra).plan;
                            planToUse = planToUse.concat(extraPlan);
                        }

                        ing.consumptionPlan = planToUse;
                        ing.actualQtyUsed = actualQty;
                        
                        for(let t of planToUse) {
                            const b = await DB.get('batches', t.batchId);
                            if(b) {
                                b.quantity -= t.quantity;
                                await DB.update('batches', b);
                                await DB.add('history',{productId:pr.id,batchCode:b.code,type:'sa√≠da',quantity:t.quantity,date:new Date().toISOString().split('T')[0],reason:`OP: ${op.recipeName}`});
                            }
                        }
                        pr.totalQuantity -= actualQty;
                        await DB.update('inventory', pr);
                    } else {
                        ing.actualQtyUsed = 0;
                        ing.consumptionPlan = [];
                    }
                }
                if(op.quantityProduced>0 && op.outputBatch){
                    const oP=localInventory.find(x=>x.name===op.recipeName&&x.type==='semi_acabado');
                    if(oP){
                        oP.totalQuantity+=op.quantityProduced;
                        await DB.update('inventory',oP);
                        await DB.add('batches',{productId:oP.id,code:op.outputBatch,quantity:op.quantityProduced,expiryDate:'',isReleased:true,locationCode:''});
                        await DB.add('history',{productId:oP.id,batchCode:op.outputBatch,type:'entrada (produ√ß√£o)',quantity:op.quantityProduced,date:new Date().toISOString().split('T')[0],reason:`OP: ${op.recipeName}`});
                    }
                }
                op.status='conclu√≠da';
                op.executionDate = new Date().toISOString().split('T')[0];
                await DB.update('productionOrders', op);
            }
            window.showNotif('Baixas conclu√≠das com sucesso!');
            await refreshData();
        } catch(e) { window.showNotif('Erro na efetiva√ß√£o.',true); } finally { hide(id('loading-overlay')); }
    });
});

// --- RASTREABILIDADE ---
addEvt('trace-date-filter', 'change', renderTraceability);
addEvt('trace-line-filter', 'change', renderTraceability);
addEvt('trace-search-filter', 'input', renderTraceability);

function renderTraceability() {
    const date = id('trace-date-filter').value;
    const line = id('trace-line-filter').value;
    const search = (id('trace-search-filter').value || '').toLowerCase();
    const listEl = id('traceability-list');
    if(!listEl) return;

    let ops = localProductionOrders.filter(o => o.status === 'conclu√≠da' || o.status === 'concluido');
    
    if(date) ops = ops.filter(o => o.executionDate === date || o.date === date);
    if(line) ops = ops.filter(o => o.recipeCategory === line);
    if(search) {
        ops = ops.filter(o => 
            o.recipeName.toLowerCase().includes(search) || 
            o.ingredients.some(ing => {
                const p = localInventory.find(x=>x.id===ing.productId);
                return p && p.name.toLowerCase().includes(search);
            })
        );
    }

    const lineFilter = id('trace-line-filter');
    if(lineFilter.options.length === 1) {
        const uniqueLines = [...new Set(localProductionOrders.map(o=>o.recipeCategory))].filter(Boolean);
        uniqueLines.forEach(l => lineFilter.innerHTML += `<option value="${l}">${l}</option>`);
    }

    if(!ops.length) {
        listEl.innerHTML = '<div class="text-center py-10 text-ios-textMuted">Nenhuma OP encontrada com estes filtros.</div>';
        return;
    }

    ops.sort((a,b) => new Date(b.executionDate || b.date) - new Date(a.executionDate || a.date));

    listEl.innerHTML = ops.map(op => {
        const execDate = op.executionDate ? new Date(op.executionDate+'T00:00:00').toLocaleDateString('pt-BR') : new Date(op.date+'T00:00:00').toLocaleDateString('pt-BR');
        const outLote = op.outputBatch ? `<span class="badge bg-ios-blue text-white ml-2 mt-1 inline-block">Lote Gerado: ${op.outputBatch}</span>` : '';
        
        const ingsHtml = (op.ingredients || []).map(ing => {
            const p = localInventory.find(x=>x.id===ing.productId);
            const planText = (ing.consumptionPlan || []).map(x => `${x.batchCode} (${x.quantity.toFixed(4)})`).join(', ');
            return `<li class="flex justify-between border-b border-ios-border/30 pb-1 mt-1 items-center"><span class="text-xs text-white">${p?.name||'?'}</span><span class="text-xs text-ios-textMuted text-right">${ing.actualQtyUsed !== undefined ? ing.actualQtyUsed.toFixed(4) : ing.adjustedQuantity.toFixed(4)} <i class="fa-solid fa-arrow-right mx-1 text-[8px]"></i> <span class="text-ios-blue">${planText || 'PEPS Autom√°tico'}</span></span></li>`;
        }).join('');

        return `
        <div class="card bg-ios-card p-4 border-l-4 border-l-ios-blue">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-bold text-white text-base sm:text-lg">${op.recipeName} <span class="text-sm text-ios-textMuted">(${op.multiplier}x)</span></h3>
                    <p class="text-[10px] text-ios-textMuted"><i class="fa-regular fa-calendar-check mr-1"></i>Efetivada: ${execDate} | Linha: ${op.recipeCategory||'N/A'}</p>
                    ${outLote}
                </div>
            </div>
            <div class="mt-4 bg-ios-bg p-3 rounded border border-ios-border">
                <p class="text-[9px] text-ios-textMuted uppercase font-bold mb-2">Lotes Utilizados</p>
                <ul>${ingsHtml}</ul>
            </div>
            <div class="mt-4">
                <label class="text-[9px] text-ios-textMuted uppercase font-bold mb-1 block">Ocorr√™ncias / Observa√ß√µes da Produ√ß√£o</label>
                <div class="flex gap-2">
                    <input type="text" class="form-input py-2 px-3 text-sm trace-obs-input w-full" data-opid="${op.id}" placeholder="Registrar quebra, atraso..." value="${op.observations || ''}">
                    <button type="button" class="btn-primary py-2 px-4 btn-save-obs text-xs sm:text-sm shrink-0" data-opid="${op.id}">Salvar</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

addEvt('traceability-list', 'click', async e => {
    const btn = e.target.closest('.btn-save-obs');
    if(btn) {
        const opId = btn.dataset.opid;
        const input = document.querySelector(`.trace-obs-input[data-opid="${opId}"]`);
        if(input) {
            const op = localProductionOrders.find(o => o.id === opId);
            if(op) {
                op.observations = input.value;
                await DB.update('productionOrders', op);
                window.showNotif('Observa√ß√£o salva!');
            }
        }
    }
});

// --- DIVERG√äNCIAS ---
addEvt('divergences-date-filter', 'change', renderDivergences);
function renderDivergences() {
    const listEl = id('divergences-list');
    if(!listEl) return;
    let d = id('divergences-date-filter').value;
    if(!d) {
        d = new Date().toISOString().split('T')[0];
        id('divergences-date-filter').value = d;
    }

    let ops = localProductionOrders.filter(o => o.date === d && (o.picking?.status === 'concluido' || o.status === 'conclu√≠da'));
    
    let html = '';
    let hasDivergence = false;

    ops.forEach(op => {
        let opDivs = '';
        op.ingredients.forEach(ing => {
            const needed = ing.adjustedQuantity;
            let real = needed;
            if(op.picking?.pickedItems && op.picking.pickedItems[ing.productId] !== undefined) {
                real = op.picking.pickedItems[ing.productId];
            }
            
            if(Math.abs(needed - real) > 0.001) {
                hasDivergence = true;
                const pName = localInventory.find(x=>x.id===ing.productId)?.name || '?';
                const diff = real - needed;
                const diffClass = diff > 0 ? 'text-ios-green' : 'text-ios-red';
                const diffSign = diff > 0 ? '+' : '';
                opDivs += `
                <div class="flex justify-between items-center border-b border-ios-border/50 py-2 last:border-0">
                    <span class="text-white text-sm w-1/3 truncate">${pName}</span>
                    <span class="text-ios-textMuted text-xs w-1/6 text-center">Prev: ${needed.toFixed(2)}</span>
                    <span class="text-white font-bold text-sm w-1/6 text-center">Real: ${real.toFixed(2)}</span>
                    <span class="${diffClass} font-bold text-sm w-1/6 text-right">${diffSign}${diff.toFixed(2)}</span>
                </div>`;
            }
        });

        if(opDivs) {
            html += `
            <div class="card p-4 border-l-4 border-l-ios-red mb-4">
                <div class="flex justify-between mb-2">
                    <h3 class="font-bold text-white">${op.recipeName} <span class="text-ios-blue">(${op.multiplier}x)</span></h3>
                    <span class="text-xs text-ios-textMuted">${op.recipeCategory}</span>
                </div>
                <div class="bg-ios-bg p-3 rounded-lg border border-ios-border">
                    ${opDivs}
                </div>
            </div>`;
        }
    });

    if(!hasDivergence) {
        listEl.innerHTML = `<div class="card text-center py-10 border-dashed border-ios-border"><i class="fa-solid fa-check-circle text-5xl text-ios-green mb-4"></i><p class="text-ios-textMuted text-sm">Nenhuma diverg√™ncia registrada para esta data.</p></div>`;
    } else {
        listEl.innerHTML = html;
    }
}

// --- REQUISICOES ---
addEvt('requisition-form','submit',async e=>{e.preventDefault();const c=id('requisition-items-container');const ings=[...c.children].map(r=>{
    let plan = [];
    try { plan = JSON.parse(r.dataset.plan || '[]'); } catch(err) { console.error(err); }
    return {productId:r.querySelector('input[type="text"]').dataset.selectedId,qty:parseFloat(r.querySelector('input[type="number"]').value), plan: plan};
});
if(ings.some(x=>!x.productId||x.qty<=0))return;const rS=id('requisition-reason').value,rP=id('requisition-responsible').value;showConfirmationModal('Confirmar?',`Baixar ${ings.length} item(ns)?`,async()=>{show(id('loading-overlay'));try{for(let i of ings){const p=await DB.get('inventory',i.productId);if(!p)continue;for(let x of i.plan){const b=await DB.get('batches',x.batchId);if(b){b.quantity-=x.quantity;await DB.update('batches',b);await DB.add('history',{productId:p.id,batchCode:b.code,type:'requisi√ß√£o',quantity:x.quantity,date:new Date().toISOString().split('T')[0],reason:`${rS} (${rP})`});}}p.totalQuantity-=i.qty;await DB.update('inventory',p);}window.showNotif('Baixado!');id('requisition-form').reset();c.innerHTML='';addIngRowReq(c);await refreshData();}catch(e){}finally{hide(id('loading-overlay'));}});});

addEvt('adjustment-form','submit',async e=>{e.preventDefault();const pId=id('adjustment-searchable-container').querySelector('input').dataset.selectedId,bId=id('adjustment-batch').value,nQ=parseFloat(id('adjustment-new-quantity').value),rS=id('adjustment-reason').value;if(!pId||!bId||isNaN(nQ))return;showConfirmationModal('Ajustar?','Sobrescreve saldo.',async()=>{show(id('loading-overlay'));try{const b=await DB.get('batches',bId),p=await DB.get('inventory',pId);if(b&&p){const df=nQ-b.quantity;b.quantity=nQ;p.totalQuantity+=df;await DB.update('batches',b);await DB.update('inventory',p);await DB.add('history',{productId:p.id,batchCode:b.code,type:'ajuste',quantity:df,date:new Date().toISOString().split('T')[0],reason:`Aj: ${rS}`});window.showNotif('Ajustado!');id('adjustment-form').reset();id('adjustment-searchable-container').querySelector('input').value='';id('adjustment-batch').innerHTML='';await refreshData();}}catch(e){}finally{hide(id('loading-overlay'));}});});

// MUDAR LOTE MANUALMENTE (USADO NA REQUISI√á√ÉO, OP E PICKING)
document.addEventListener('click', e => {
    const btn = e.target.closest('.open-batch-selector');
    if(btn) { 
        batchSelectorContext = 'op';
        currentBatchTarget = btn.closest('.req-item') || btn.closest('tr'); 
        const pId = currentBatchTarget.dataset.productId; 
        const qtyInput = currentBatchTarget.querySelector('.req-qty-input') || currentBatchTarget.querySelector('.po-ing-qty');
        const qty = parseFloat(qtyInput.value) || 0; 
        
        let currentPlan = []; 
        try { currentPlan = JSON.parse(currentBatchTarget.dataset.plan || '[]'); } catch(err) { console.error(err); }
        
        if(id('batch-selector-needed')) id('batch-selector-needed').innerText = qty.toFixed(4); 
        const batches = localBatches.filter(b => b.productId === pId && b.quantity > 0 && b.isReleased !== false); 
        const listEl = id('batch-selector-list');
        if(listEl) {
            listEl.innerHTML = batches.map(b => {
                const inPlan = currentPlan.find(p => p.batchId === b.id); const val = inPlan ? inPlan.quantity : '';
                return `<div class="flex justify-between items-center mb-2 sm:mb-3 bg-ios-input p-2 sm:p-3 rounded-xl border border-ios-border"><span class="text-white font-medium text-xs sm:text-sm"><i class="fa-solid fa-box mr-1 sm:mr-2 text-ios-textMuted"></i>${b.code} <br><span class="text-[9px] sm:text-[10px] text-ios-textMuted ml-4 sm:ml-6">Disp: ${b.quantity.toFixed(2)}</span></span><input type="number" class="form-input w-20 sm:w-28 text-right batch-input font-bold text-xs sm:text-sm py-2 px-2" data-bid="${b.id}" data-bcode="${b.code}" max="${b.quantity + (inPlan?inPlan.quantity:0)}" value="${val}" placeholder="0"></div>`;
            }).join('');
        }
        updateBatchSelectorSum(); show(id('batch-selector-modal')); 
    }
});

addEvt('batch-selector-list', 'input', updateBatchSelectorSum);
function updateBatchSelectorSum() {
    const listEl = id('batch-selector-list'); if(!listEl) return;
    const inputs = [...listEl.querySelectorAll('.batch-input')]; const sum = inputs.reduce((a, b) => a + (parseFloat(b.value) || 0), 0);
    const selEl = id('batch-selector-selected'); const needEl = id('batch-selector-needed');
    if(selEl && needEl) { selEl.innerText = sum.toFixed(4); const needed = parseFloat(needEl.innerText); selEl.className = Math.abs(sum - needed) < 0.001 ? 'font-bold text-base sm:text-lg text-ios-green' : 'font-bold text-base sm:text-lg text-ios-red'; }
}

addEvt('confirm-batch-selection', 'click', () => {
    if (!currentBatchTarget) return; 
    
    const listEl = id('batch-selector-list'); if(!listEl) return; 
    const inputs = [...listEl.querySelectorAll('.batch-input')]; 
    const newPlan = inputs.map(inp => ({ batchId: inp.dataset.bid, batchCode: inp.dataset.bcode, quantity: parseFloat(inp.value) || 0 })).filter(p => p.quantity > 0);

    if (batchSelectorContext === 'picking') {
        const pId = currentBatchTarget.dataset.pid;
        currentPickingPlans[pId] = newPlan;
        
        const sum = newPlan.reduce((a,b) => a + b.quantity, 0);
        const input = currentBatchTarget.querySelector('.picking-qty-input');
        if(input) input.value = sum.toFixed(4);
        
        const chk = currentBatchTarget.querySelector('.picking-row-check');
        if(chk) chk.checked = true;
        
        currentBatchTarget.classList.add('opacity-50');
        currentBatchTarget.cells[0].classList.add('line-through');
        
        const display = currentBatchTarget.querySelector('.picking-plan-display');
        if(display) display.innerText = newPlan.map(x=>x.batchCode).join(', ');
        
        hide(id('batch-selector-modal'));
        return;
    }

    const needed = parseFloat(id('batch-selector-needed')?.innerText || 0); const sum = parseFloat(id('batch-selector-selected')?.innerText || 0);
    if(sum < needed - 0.001) return window.showNotif('A quantidade marcada √© menor que a necess√°ria!', true);
    
    currentBatchTarget.dataset.plan = JSON.stringify(newPlan).replace(/'/g, "&#39;"); 
    const planDisplay = currentBatchTarget.querySelector('.plan-display');
    if(planDisplay) planDisplay.innerHTML = '<i class="fa-solid fa-hand mr-1"></i> Manual: ' + newPlan.map(p => `<strong>${p.batchCode}</strong>(${p.quantity})`).join(', '); 
    hide(id('batch-selector-modal'));
});

addEvt('btn-download-db','click',async()=>{show(id('loading-overlay'));try{const dt={inventory:await DB.getAll('inventory'),batches:await DB.getAll('batches'),history:await DB.getAll('history'),recipes:await DB.getAll('recipes'),productionOrders:await DB.getAll('productionOrders'),monthlyConsumption:await DB.getAll('monthlyConsumption'),locations:await DB.getAll('locations')};const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(dt)],{type:'application/json'}));a.download=`EstoqueOS_Backup_${new Date().toISOString().split('T')[0]}.json`;a.click();window.showNotif('Backup salvo!');}catch(e){}finally{hide(id('loading-overlay'));}});addEvt('btn-clear-db','click',()=>{showConfirmationModal('Cuidado!','APAGA TUDO!',async()=>{show(id('loading-overlay'));try{await DB.clear('inventory');await DB.clear('batches');await DB.clear('history');await DB.clear('recipes');await DB.clear('productionOrders');await DB.clear('monthlyConsumption');await DB.clear('locations');await refreshData();window.showNotif('Formatado!');}catch(e){}finally{hide(id('loading-overlay'));}});});

</script>
</body>
</html>
